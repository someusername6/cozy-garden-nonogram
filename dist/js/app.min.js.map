{
  "version": 3,
  "sources": ["app.src.js"],
  "sourcesContent": ["// ============================================================\n// FILE: src/js/utils.js\n// ============================================================\n\n// Cozy Garden - Shared Utilities\n// This module provides common utilities and configuration constants\n// used across multiple modules. Loads first to avoid circular dependencies.\n\n(function() {\n  'use strict';\n\n  // === Configuration Constants ===\n  // Centralized to ensure consistency and single source of truth\n  const CONFIG = {\n    // Canvas sizes\n    STAMP_CANVAS_SIZE: 180,      // Flying stamp preview (matches victory screen)\n    VICTORY_CANVAS_SIZE: 180,   // Victory screen puzzle preview\n    MINI_CANVAS_SIZE: 80,       // Collection thumbnail size\n\n    // Mini canvas outline (for thumbnails and stamps)\n    OUTLINE_THICKNESS: 2,       // Outline width in pixels\n\n    // Limits\n    MAX_PUZZLE_DIMENSION: 32,   // Maximum puzzle width/height (security limit)\n    MAX_HISTORY: 50,            // Undo/redo history depth\n    MAX_SCREEN_HISTORY: 10,     // Browser history states to track\n    MAX_SEARCH_LENGTH: 100,     // Search input character limit\n\n    // Timing\n    TOAST_DURATION: 2500,       // Toast notification display time (ms)\n    LONG_PRESS_DELAY: 400,      // Touch long-press threshold (ms)\n    SEARCH_DEBOUNCE: 150,       // Search input debounce (ms)\n\n    // Zoom\n    MAX_ZOOM: 3.0,              // Maximum pinch-to-zoom level\n    COMFORTABLE_ZOOM: 2.0,      // Suggested zoom for comfortable touch targets\n    AUTO_ZOOM_MIN_SIZE: 10,     // Skip auto-zoom for puzzles \u2264 this dimension\n\n    // Visual thresholds\n    BRIGHTNESS_MIDPOINT: 128,   // Light/dark threshold for text contrast (0-255 scale)\n    BADGE_MAX_DISPLAY: 99       // Show \"99+\" for counts above this\n  };\n\n  // === Shared Utilities ===\n\n  /**\n   * Generate a consistent puzzle ID from puzzle data\n   * Used for storage keys and DOM data attributes\n   * @param {Object} puzzle - Puzzle object with title (t or title property)\n   * @returns {string} Normalized puzzle ID (lowercase, underscores)\n   */\n  function getPuzzleId(puzzle) {\n    const title = puzzle.t || puzzle.title;\n    return title.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');\n  }\n\n  /**\n   * Get puzzle title, handling both concise (t) and verbose (title) formats\n   * @param {Object} puzzle - Puzzle object\n   * @returns {string} Puzzle title\n   */\n  function getPuzzleTitle(puzzle) {\n    return puzzle.t || puzzle.title;\n  }\n\n  /**\n   * Parse puzzle metadata from title string\n   * Title format: \"Name (WxH, difficulty)\"\n   * @param {string} title - Puzzle title string\n   * @returns {Object} Parsed metadata {name, width, height, difficulty}\n   */\n  function parsePuzzleTitle(title) {\n    const match = title.match(/^(.+?)\\s*\\((\\d+)x(\\d+),\\s*(\\w+)\\)$/i);\n    if (match) {\n      return {\n        name: match[1].trim(),\n        width: parseInt(match[2], 10),\n        height: parseInt(match[3], 10),\n        difficulty: match[4].toLowerCase()\n      };\n    }\n    return {\n      name: title,\n      width: 0,\n      height: 0,\n      difficulty: 'unknown'\n    };\n  }\n\n  /**\n   * Initialize an event listener on an element only once.\n   * Uses data-initialized attribute to prevent duplicate listeners.\n   * @param {Element|null} element - DOM element to attach listener to\n   * @param {string} event - Event type (e.g., 'click', 'change')\n   * @param {Function} handler - Event handler function\n   * @param {Object} options - Optional addEventListener options\n   * @returns {boolean} True if listener was added, false if skipped\n   */\n  function initOnce(element, event, handler, options = {}) {\n    if (!element || element.hasAttribute('data-initialized')) return false;\n    element.addEventListener(event, handler, options);\n    element.setAttribute('data-initialized', 'true');\n    return true;\n  }\n\n  /**\n   * Create a flying stamp canvas from a source canvas, positioned within a container.\n   * Used for stamp animations when navigating between screens.\n   * @param {HTMLCanvasElement} sourceCanvas - Canvas to copy content from\n   * @param {DOMRect} containerRect - Bounding rect to position and size within\n   * @param {Object} options - Optional settings\n   * @param {boolean} options.useScale - Use transform:scale for sizing (default: false)\n   * @returns {HTMLCanvasElement} The flying stamp element (already appended to body)\n   */\n  function createFlyingStamp(sourceCanvas, containerRect, options = {}) {\n    // Create canvas and copy content\n    const stamp = document.createElement('canvas');\n    stamp.width = sourceCanvas.width;\n    stamp.height = sourceCanvas.height;\n    const ctx = stamp.getContext('2d');\n    ctx.drawImage(sourceCanvas, 0, 0);\n\n    // Calculate aspect ratios\n    const canvasAspect = sourceCanvas.width / sourceCanvas.height;\n    const containerAspect = containerRect.width / containerRect.height;\n\n    let cssWidth, cssHeight;\n    if (options.useScale) {\n      // Use canvas pixel dimensions with scale transform (for victory screen)\n      cssWidth = sourceCanvas.width;\n      cssHeight = sourceCanvas.height;\n      const containerSize = Math.min(containerRect.width, containerRect.height);\n      const targetSize = canvasAspect > 1 ? containerSize : containerSize * canvasAspect;\n      const scale = targetSize / cssWidth;\n      stamp.style.transform = 'scale(' + scale + ')';\n    } else {\n      // Calculate CSS dimensions to fit within container (for back button)\n      if (canvasAspect > containerAspect) {\n        cssWidth = containerRect.width;\n        cssHeight = containerRect.width / canvasAspect;\n      } else {\n        cssHeight = containerRect.height;\n        cssWidth = containerRect.height * canvasAspect;\n      }\n    }\n\n    // Center within container\n    const centerX = containerRect.left + containerRect.width / 2;\n    const centerY = containerRect.top + containerRect.height / 2;\n\n    stamp.className = 'flying-stamp';\n    stamp.style.left = (centerX - cssWidth / 2) + 'px';\n    stamp.style.top = (centerY - cssHeight / 2) + 'px';\n    stamp.style.width = cssWidth + 'px';\n    stamp.style.height = cssHeight + 'px';\n    document.body.appendChild(stamp);\n\n    return stamp;\n  }\n\n  /**\n   * Render pixel art to a canvas with outlined edges\n   * @param {number} width - Grid width in cells\n   * @param {number} height - Grid height in cells\n   * @param {number} targetSize - Target canvas size in pixels\n   * @param {Function} getColorAt - Callback (row, col) => [r,g,b] or null for empty\n   * @returns {HTMLCanvasElement} Canvas with outlined pixel art\n   */\n  function renderOutlinedCanvas(width, height, targetSize, getColorAt) {\n    const maxDim = Math.max(width, height);\n    const cellSize = Math.max(2, Math.floor(targetSize / maxDim));\n    const padding = CONFIG.OUTLINE_THICKNESS * 2;\n    const offset = CONFIG.OUTLINE_THICKNESS;\n\n    const canvas = document.createElement('canvas');\n    canvas.width = width * cellSize + padding;\n    canvas.height = height * cellSize + padding;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) {\n      console.warn('[Utils] Failed to get 2D context for canvas');\n      return canvas;\n    }\n\n    try {\n      // Get theme-aware outline color from CSS variable\n      const outlineColor = getComputedStyle(document.documentElement)\n        .getPropertyValue('--color-text-muted').trim() || '#8a8a7a';\n\n      // Draw outlines first\n      ctx.fillStyle = outlineColor;\n      for (let row = 0; row < height; row++) {\n        for (let col = 0; col < width; col++) {\n          const color = getColorAt(row, col);\n          if (color) {\n            const px = offset + col * cellSize;\n            const py = offset + row * cellSize;\n            ctx.fillRect(\n              px - CONFIG.OUTLINE_THICKNESS,\n              py - CONFIG.OUTLINE_THICKNESS,\n              cellSize + padding,\n              cellSize + padding\n            );\n          }\n        }\n      }\n\n      // Draw all fills on top\n      for (let row = 0; row < height; row++) {\n        for (let col = 0; col < width; col++) {\n          const color = getColorAt(row, col);\n          if (color) {\n            ctx.fillStyle = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;\n            const px = offset + col * cellSize;\n            const py = offset + row * cellSize;\n            ctx.fillRect(px, py, cellSize, cellSize);\n          }\n        }\n      }\n    } catch (e) {\n      console.error('[Utils] Failed to render canvas:', e);\n    }\n\n    return canvas;\n  }\n\n  // === Export ===\n  // Create the global Cozy namespace (other modules add themselves to it)\n  window.Cozy = window.Cozy || {};\n  window.Cozy.Utils = {\n    CONFIG,\n    getPuzzleId,\n    getPuzzleTitle,\n    parsePuzzleTitle,\n    initOnce,\n    createFlyingStamp,\n    renderOutlinedCanvas\n  };\n})();\n\n\n// ============================================================\n// FILE: src/js/storage.js\n// ============================================================\n\n// Cozy Garden - Storage Module\n// Handles progress persistence using localStorage with IndexedDB fallback\n\n(function() {\n  'use strict';\n\n  const STORAGE_KEY = 'cozy_garden_data';\n  const STORAGE_VERSION = 1;\n\n  // Validate that parsed data has the expected structure\n  function isValidStorageData(data) {\n    if (!data || typeof data !== 'object') return false;\n    // Must have version number\n    if (typeof data.version !== 'number') return false;\n    // Core objects must exist and be objects (or null for optional fields)\n    if (data.progress !== null && typeof data.progress !== 'object') return false;\n    if (data.settings !== null && typeof data.settings !== 'object') return false;\n    if (data.stats !== null && typeof data.stats !== 'object') return false;\n    return true;\n  }\n\n  // Default data structure\n  function getDefaultData() {\n    return {\n      version: STORAGE_VERSION,\n      progress: {}, // puzzleId -> { completed: bool, bestTime: ms, attempts: int }\n      settings: {\n        vibration: true,\n        theme: 'light'\n      },\n      stats: {\n        totalCompleted: 0,\n        totalAttempts: 0,\n        totalPlayTime: 0, // milliseconds\n        streak: 0,\n        lastPlayDate: null\n      },\n      currentSession: {\n        puzzleIndex: 0,\n        difficulty: 'easy',\n        grid: null, // Saved grid state for current puzzle\n        startTime: null\n      },\n      // One-time UI flags (things shown once to user)\n      flags: {\n        tutorialCompleted: false,\n        helpShown: false,\n        zoomHintShown: false\n      },\n      // Persistent UI state\n      uiState: {\n        collapsedSections: [] // Collection screen collapsed categories\n      }\n    };\n  }\n\n  // Storage class\n  class GameStorage {\n    constructor() {\n      this.data = null;\n      this.listeners = [];\n    }\n\n    // Initialize storage\n    init() {\n      try {\n        const stored = localStorage.getItem(STORAGE_KEY);\n        if (stored) {\n          const parsed = JSON.parse(stored);\n          // Validate structure before using\n          if (!isValidStorageData(parsed)) {\n            console.warn('[Storage] Invalid data structure, using defaults');\n            this.data = getDefaultData();\n            this.save();\n          } else {\n            this.data = parsed;\n          }\n        } else {\n          this.data = getDefaultData();\n          this.save();\n        }\n      } catch (e) {\n        console.warn('[Storage] Failed to load, using defaults:', e);\n        this.data = getDefaultData();\n        // Save defaults to overwrite corrupted data\n        this.save();\n      }\n      return this;\n    }\n\n    // Save to localStorage\n    save() {\n      try {\n        localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));\n        this.notifyListeners('save');\n        return true;\n      } catch (e) {\n        console.error('[Storage] Failed to save:', e);\n        return false;\n      }\n    }\n\n    // Add change listener\n    onChange(callback) {\n      this.listeners.push(callback);\n      return () => {\n        this.listeners = this.listeners.filter(l => l !== callback);\n      };\n    }\n\n    notifyListeners(event) {\n      this.listeners.forEach(l => l(event, this.data));\n    }\n\n    // === Progress Methods ===\n\n    // Get puzzle progress\n    getPuzzleProgress(puzzleId) {\n      return this.data.progress[puzzleId] || {\n        completed: false,\n        bestTime: null,\n        attempts: 0,\n        lastPlayed: null,\n        savedGrid: null\n      };\n    }\n\n    // Save grid state for a puzzle (for resuming later)\n    // Grid format: array of rows, each row is array of {value, certain} objects\n    savePuzzleGrid(puzzleId, grid) {\n      // Ensure progress object exists\n      if (!this.data.progress) {\n        this.data.progress = {};\n      }\n      // Create progress entry if it doesn't exist\n      if (!this.data.progress[puzzleId]) {\n        this.data.progress[puzzleId] = {\n          completed: false,\n          bestTime: null,\n          attempts: 0,\n          lastPlayed: null,\n          savedGrid: null\n        };\n      }\n      // Save the grid (deep copy)\n      if (grid) {\n        this.data.progress[puzzleId].savedGrid = grid.map(row =>\n          row.map(cell => ({ value: cell.value, certain: cell.certain }))\n        );\n      } else {\n        this.data.progress[puzzleId].savedGrid = null;\n      }\n      this.save();\n    }\n\n    // Get saved grid for a puzzle\n    // Returns grid as array of {value, certain} objects\n    getPuzzleGrid(puzzleId) {\n      if (!this.data.progress) return null;\n      const progress = this.data.progress[puzzleId];\n      if (!progress || !progress.savedGrid) return null;\n\n      // Deep copy\n      return progress.savedGrid.map(row =>\n        row.map(cell => ({ value: cell.value, certain: cell.certain }))\n      );\n    }\n\n    // Mark puzzle as completed\n    completePuzzle(puzzleId) {\n      const progress = this.getPuzzleProgress(puzzleId);\n      const wasNew = !progress.completed;\n\n      progress.completed = true;\n      progress.attempts += 1;\n      progress.lastPlayed = Date.now();\n      progress.savedGrid = null; // Clear saved grid on completion\n\n      this.data.progress[puzzleId] = progress;\n\n      // Update stats\n      if (wasNew) {\n        this.data.stats.totalCompleted += 1;\n      }\n      this.data.stats.totalAttempts += 1;\n      this.updateStreak();\n\n      this.save();\n      return { wasNew, progress };\n    }\n\n    // Check if puzzle is completed\n    isPuzzleCompleted(puzzleId) {\n      return this.data.progress[puzzleId]?.completed || false;\n    }\n\n    // Get completion count by difficulty\n    getCompletionStats() {\n      const stats = {\n        easy: { completed: 0, total: 0 },\n        medium: { completed: 0, total: 0 },\n        hard: { completed: 0, total: 0 },\n        challenging: { completed: 0, total: 0 },\n        expert: { completed: 0, total: 0 }\n      };\n\n      // This will be populated when puzzles are loaded\n      return stats;\n    }\n\n    // === Session Methods ===\n\n    // Save current session state\n    // Grid format: array of rows, each row is array of {value, certain} objects\n    saveSession(puzzleIndex, difficulty, grid) {\n      let savedGrid = null;\n      if (grid) {\n        savedGrid = grid.map(row =>\n          row.map(cell => ({ value: cell.value, certain: cell.certain }))\n        );\n      }\n\n      this.data.currentSession = {\n        puzzleIndex,\n        difficulty,\n        grid: savedGrid\n      };\n      this.save();\n    }\n\n    // Get current session\n    getSession() {\n      return this.data.currentSession;\n    }\n\n    // Clear current session\n    clearSession() {\n      this.data.currentSession = {\n        puzzleIndex: 0,\n        difficulty: 'easy',\n        grid: null\n      };\n      this.save();\n    }\n\n    // === Settings Methods ===\n\n    // Get a setting\n    getSetting(key) {\n      return this.data.settings[key];\n    }\n\n    // Set a setting\n    setSetting(key, value) {\n      this.data.settings[key] = value;\n      this.save();\n      this.notifyListeners('settings');\n    }\n\n    // Get all settings\n    getSettings() {\n      return { ...this.data.settings };\n    }\n\n    // === Stats Methods ===\n\n    getStats() {\n      return { ...this.data.stats };\n    }\n\n    addPlayTime(ms) {\n      this.data.stats.totalPlayTime += ms;\n      this.save();\n    }\n\n    updateStreak() {\n      const today = new Date().toDateString();\n      const lastPlay = this.data.stats.lastPlayDate;\n\n      if (lastPlay === today) {\n        // Same day, no change\n        return;\n      }\n\n      const yesterday = new Date(Date.now() - 86400000).toDateString();\n\n      if (lastPlay === yesterday) {\n        // Consecutive day, increment streak\n        this.data.stats.streak += 1;\n      } else if (lastPlay !== today) {\n        // Streak broken\n        this.data.stats.streak = 1;\n      }\n\n      this.data.stats.lastPlayDate = today;\n    }\n\n    // === Flags Methods (one-time UI flags) ===\n\n    getFlag(key) {\n      return this.data.flags?.[key] || false;\n    }\n\n    setFlag(key, value = true) {\n      if (!this.data.flags) this.data.flags = {};\n      this.data.flags[key] = value;\n      this.save();\n    }\n\n    // === UI State Methods ===\n\n    getUIState(key) {\n      return this.data.uiState?.[key];\n    }\n\n    setUIState(key, value) {\n      if (!this.data.uiState) this.data.uiState = {};\n      this.data.uiState[key] = value;\n      this.save();\n    }\n\n    // === Export/Import ===\n\n    exportData() {\n      return JSON.stringify(this.data, null, 2);\n    }\n\n    importData(jsonString) {\n      try {\n        const imported = JSON.parse(jsonString);\n        if (isValidStorageData(imported)) {\n          this.data = imported;\n          this.save();\n          return true;\n        }\n        return false;\n      } catch (e) {\n        console.error('[Storage] Import failed:', e);\n        return false;\n      }\n    }\n\n    // Reset all data\n    reset() {\n      this.data = getDefaultData();\n      this.save();\n      this.notifyListeners('reset');\n    }\n  }\n\n  // Create singleton instance\n  const storage = new GameStorage().init();\n\n  // Expose globally\n  window.Cozy.Storage = storage;\n})();\n\n\n// ============================================================\n// FILE: src/js/history.js\n// ============================================================\n\n// Cozy Garden - History Module\n// Handles undo/redo functionality with action grouping for drag operations\n\n(function() {\n  'use strict';\n\n  // === Shared Utilities ===\n  const { CONFIG } = window.Cozy.Utils;\n\n  let undoStack = [];\n  let redoStack = [];\n  let pendingAction = null;  // For grouping drag operations\n\n  /**\n   * Action structure:\n   * {\n   *   type: 'fill' | 'batch-clear' | 'batch-confirm' | 'reset',\n   *   changes: Array<{\n   *     row: number,\n   *     col: number,\n   *     before: { value: number|null, certain: boolean },\n   *     after: { value: number|null, certain: boolean }\n   *   }>,\n   *   timestamp: number\n   * }\n   */\n\n  const History = {\n    /**\n     * Start a new action group (call on mousedown/touchstart)\n     * @param {string} type - Action type identifier\n     */\n    beginAction(type = 'fill') {\n      // If there's an uncommitted action, commit it first\n      if (pendingAction && pendingAction.changes.length > 0) {\n        this.commitAction();\n      }\n\n      pendingAction = {\n        type: type,\n        changes: [],\n        timestamp: Date.now()\n      };\n    },\n\n    /**\n     * Record a cell change within current action\n     * @param {number} row - Cell row\n     * @param {number} col - Cell column\n     * @param {Object} before - Previous cell state {value, certain}\n     * @param {Object} after - New cell state {value, certain}\n     */\n    recordChange(row, col, before, after) {\n      // Skip if no actual change\n      if (before.value === after.value && before.certain === after.certain) {\n        return;\n      }\n\n      if (!pendingAction) {\n        // Single-click: create action on the fly\n        this.beginAction('fill');\n      }\n\n      // Check if this cell was already modified in this action\n      // If so, update the 'after' state instead of adding duplicate\n      const existingChange = pendingAction.changes.find(\n        c => c.row === row && c.col === col\n      );\n\n      if (existingChange) {\n        existingChange.after = { value: after.value, certain: after.certain };\n      } else {\n        // Deep copy the states\n        pendingAction.changes.push({\n          row,\n          col,\n          before: { value: before.value, certain: before.certain },\n          after: { value: after.value, certain: after.certain }\n        });\n      }\n    },\n\n    /**\n     * Commit the current action group (call on mouseup/touchend)\n     */\n    commitAction() {\n      if (pendingAction && pendingAction.changes.length > 0) {\n        // Filter out no-op changes (before === after)\n        pendingAction.changes = pendingAction.changes.filter(c =>\n          c.before.value !== c.after.value || c.before.certain !== c.after.certain\n        );\n\n        if (pendingAction.changes.length > 0) {\n          undoStack.push(pendingAction);\n\n          // Trim history if too long\n          if (undoStack.length > CONFIG.MAX_HISTORY) {\n            undoStack.shift();\n          }\n\n          // Clear redo stack on new action\n          redoStack = [];\n        }\n\n        this.updateUI();\n      }\n      pendingAction = null;\n    },\n\n    /**\n     * Cancel current action without committing\n     */\n    cancelAction() {\n      pendingAction = null;\n    },\n\n    /**\n     * Record a batch operation as single action\n     * Used for \"clear all pencil marks\", \"confirm all\", \"reset\"\n     * @param {string} type - Action type\n     * @param {Array} changes - Array of cell changes\n     */\n    recordBatchAction(type, changes) {\n      if (changes.length === 0) return;\n\n      const action = {\n        type: type,\n        changes: changes.map(c => ({\n          row: c.row,\n          col: c.col,\n          before: { value: c.before.value, certain: c.before.certain },\n          after: { value: c.after.value, certain: c.after.certain }\n        })),\n        timestamp: Date.now()\n      };\n\n      undoStack.push(action);\n      if (undoStack.length > CONFIG.MAX_HISTORY) {\n        undoStack.shift();\n      }\n      redoStack = [];\n      this.updateUI();\n    },\n\n    /**\n     * Undo last action\n     * @returns {Array|null} Changes to apply, or null if nothing to undo\n     */\n    undo() {\n      if (undoStack.length === 0) return null;\n\n      const action = undoStack.pop();\n      redoStack.push(action);\n      this.updateUI();\n\n      // Return changes to apply (restore 'before' states)\n      return action.changes.map(c => ({\n        row: c.row,\n        col: c.col,\n        state: { value: c.before.value, certain: c.before.certain }\n      }));\n    },\n\n    /**\n     * Redo last undone action\n     * @returns {Array|null} Changes to apply, or null if nothing to redo\n     */\n    redo() {\n      if (redoStack.length === 0) return null;\n\n      const action = redoStack.pop();\n      undoStack.push(action);\n      this.updateUI();\n\n      // Return changes to apply (restore 'after' states)\n      return action.changes.map(c => ({\n        row: c.row,\n        col: c.col,\n        state: { value: c.after.value, certain: c.after.certain }\n      }));\n    },\n\n    /**\n     * Check if undo is available\n     * @returns {boolean}\n     */\n    canUndo() {\n      return undoStack.length > 0;\n    },\n\n    /**\n     * Check if redo is available\n     * @returns {boolean}\n     */\n    canRedo() {\n      return redoStack.length > 0;\n    },\n\n    /**\n     * Clear all history (on puzzle switch)\n     */\n    clear() {\n      undoStack = [];\n      redoStack = [];\n      pendingAction = null;\n      this.updateUI();\n    },\n\n    /**\n     * Update undo/redo button states\n     */\n    updateUI() {\n      const undoBtn = document.getElementById('undo-btn');\n      const redoBtn = document.getElementById('redo-btn');\n\n      if (undoBtn) undoBtn.disabled = !this.canUndo();\n      if (redoBtn) redoBtn.disabled = !this.canRedo();\n    },\n\n    /**\n     * Get history statistics (for debugging/stats)\n     * @returns {Object}\n     */\n    getStats() {\n      return {\n        undoDepth: undoStack.length,\n        redoDepth: redoStack.length,\n        hasPending: pendingAction !== null,\n        pendingChanges: pendingAction ? pendingAction.changes.length : 0\n      };\n    }\n  };\n\n  // Expose globally\n  window.Cozy.History = History;\n})();\n\n\n// ============================================================\n// FILE: src/js/screens.js\n// ============================================================\n\n/**\n * Screen Manager for Cozy Garden\n * Handles navigation between screens with transitions\n */\nconst ScreenManager = (function() {\n  'use strict';\n\n  // === Shared Utilities ===\n  const { CONFIG, initOnce, createFlyingStamp, renderOutlinedCanvas } = window.Cozy.Utils;\n\n  // Screen definitions\n  const SCREENS = {\n    SPLASH: 'splash',\n    HOME: 'home',\n    COLLECTION: 'collection',\n    PUZZLE: 'puzzle',\n    VICTORY: 'victory',\n    SETTINGS: 'settings',\n    TUTORIAL: 'tutorial'\n  };\n\n  // Current state\n  let currentScreen = null;\n  let screenHistory = [];\n  let screenData = {}; // Data passed between screens\n\n  // Screen elements cache\n  let screenElements = {};\n\n  // Confirm modal state\n  let confirmModalCallback = null;\n\n  // === Confirm/Alert Modal Functions ===\n\n  /**\n   * Show a confirmation modal\n   * @param {Object} options - Modal options\n   * @param {string} options.title - Modal title\n   * @param {string} options.message - Modal message\n   * @param {string} [options.confirmText='Confirm'] - Confirm button text\n   * @param {string} [options.cancelText='Cancel'] - Cancel button text\n   * @param {boolean} [options.danger=false] - Use danger styling for confirm button\n   * @param {Function} options.onConfirm - Callback when confirmed\n   * @param {Function} [options.onCancel] - Callback when cancelled\n   */\n  function showConfirmModal(options) {\n    const modal = document.getElementById('confirm-modal');\n    const title = document.getElementById('confirm-modal-title');\n    const message = document.getElementById('confirm-modal-message');\n    const confirmBtn = document.getElementById('confirm-modal-confirm');\n    const cancelBtn = document.getElementById('confirm-modal-cancel');\n\n    if (!modal) return;\n\n    // Set content\n    title.textContent = options.title || 'Confirm';\n    message.textContent = options.message || 'Are you sure?';\n    confirmBtn.textContent = options.confirmText || 'Confirm';\n    cancelBtn.textContent = options.cancelText || 'Cancel';\n\n    // Set danger styling if needed\n    confirmBtn.classList.toggle('confirm-modal-btn-danger', !!options.danger);\n    confirmBtn.classList.toggle('confirm-modal-btn-primary', !options.danger);\n\n    // Remove alert mode\n    modal.classList.remove('alert-mode');\n\n    // Store callback\n    confirmModalCallback = options;\n\n    // Show modal\n    modal.classList.add('visible');\n\n    // Focus confirm button for accessibility\n    setTimeout(() => confirmBtn.focus(), 100);\n  }\n\n  /**\n   * Show an alert modal (single OK button)\n   * @param {Object} options - Modal options\n   * @param {string} options.title - Modal title\n   * @param {string} options.message - Modal message\n   * @param {string} [options.buttonText='OK'] - Button text\n   * @param {Function} [options.onClose] - Callback when closed\n   */\n  function showAlertModal(options) {\n    const modal = document.getElementById('confirm-modal');\n    const title = document.getElementById('confirm-modal-title');\n    const message = document.getElementById('confirm-modal-message');\n    const confirmBtn = document.getElementById('confirm-modal-confirm');\n\n    if (!modal) return;\n\n    // Set content\n    title.textContent = options.title || 'Notice';\n    message.textContent = options.message || '';\n    confirmBtn.textContent = options.buttonText || 'OK';\n\n    // Reset to primary styling\n    confirmBtn.classList.remove('confirm-modal-btn-danger');\n    confirmBtn.classList.add('confirm-modal-btn-primary');\n\n    // Set alert mode (hides cancel button)\n    modal.classList.add('alert-mode');\n\n    // Store callback\n    confirmModalCallback = { onConfirm: options.onClose };\n\n    // Show modal\n    modal.classList.add('visible');\n\n    // Focus button for accessibility\n    setTimeout(() => confirmBtn.focus(), 100);\n  }\n\n  /**\n   * Hide the confirm modal\n   */\n  function hideConfirmModal() {\n    const modal = document.getElementById('confirm-modal');\n    if (modal) {\n      modal.classList.remove('visible');\n    }\n    confirmModalCallback = null;\n  }\n\n  /**\n   * Initialize confirm modal event listeners\n   */\n  function initConfirmModal() {\n    const modal = document.getElementById('confirm-modal');\n    const backdrop = modal?.querySelector('.confirm-modal-backdrop');\n    const confirmBtn = document.getElementById('confirm-modal-confirm');\n    const cancelBtn = document.getElementById('confirm-modal-cancel');\n\n    if (!modal) return;\n\n    // Confirm button\n    confirmBtn?.addEventListener('click', () => {\n      const callback = confirmModalCallback?.onConfirm;\n      hideConfirmModal();\n      // Delay callback to allow hide transition to complete before showing another modal\n      if (callback) setTimeout(callback, 200);\n    });\n\n    // Cancel button\n    cancelBtn?.addEventListener('click', () => {\n      const callback = confirmModalCallback?.onCancel;\n      hideConfirmModal();\n      if (callback) callback();\n    });\n\n    // Backdrop click (only for non-destructive actions)\n    backdrop?.addEventListener('click', () => {\n      const callback = confirmModalCallback?.onCancel;\n      hideConfirmModal();\n      if (callback) callback();\n    });\n\n    // Escape key\n    document.addEventListener('keydown', (e) => {\n      if (e.key === 'Escape' && modal.classList.contains('visible')) {\n        const callback = confirmModalCallback?.onCancel;\n        hideConfirmModal();\n        if (callback) callback();\n      }\n\n      // Focus trap: keep Tab within modal when visible\n      if (e.key === 'Tab' && modal.classList.contains('visible')) {\n        const isAlertMode = modal.classList.contains('alert-mode');\n        const focusableElements = isAlertMode ? [confirmBtn] : [cancelBtn, confirmBtn];\n        const firstEl = focusableElements[0];\n        const lastEl = focusableElements[focusableElements.length - 1];\n\n        // Check if focus is within the modal\n        const focusInModal = focusableElements.includes(document.activeElement);\n\n        if (!focusInModal) {\n          // Focus escaped, bring it back\n          e.preventDefault();\n          firstEl.focus();\n        } else if (e.shiftKey) {\n          // Shift+Tab: if on first element, go to last\n          if (document.activeElement === firstEl) {\n            e.preventDefault();\n            lastEl.focus();\n          }\n        } else {\n          // Tab: if on last element, go to first\n          if (document.activeElement === lastEl) {\n            e.preventDefault();\n            firstEl.focus();\n          }\n        }\n      }\n    });\n  }\n\n  /**\n   * Initialize screen manager\n   */\n  function init() {\n    // Apply saved theme immediately to prevent flash\n    initTheme();\n\n    // Initialize confirm modal\n    initConfirmModal();\n\n    // Cache all screen elements and set initial inert state\n    Object.values(SCREENS).forEach(screenId => {\n      const screen = document.getElementById(`screen-${screenId}`);\n      screenElements[screenId] = screen;\n      // All screens start as inert; showScreen will remove inert from active screen\n      if (screen) {\n        screen.setAttribute('inert', '');\n      }\n    });\n\n    // Handle browser back button\n    window.addEventListener('popstate', handlePopState);\n\n    // Global Escape key handler for back navigation\n    document.addEventListener('keydown', handleGlobalEscape);\n\n    // Start with splash screen\n    showScreen(SCREENS.SPLASH, {}, false);\n  }\n\n  /**\n   * Handle global Escape key for back navigation\n   */\n  function handleGlobalEscape(e) {\n    if (e.key !== 'Escape') return;\n\n    // Don't handle if typing in an input\n    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;\n\n    // Let modals handle their own Escape (confirm modal, help modal)\n    const confirmModal = document.getElementById('confirm-modal');\n    const helpModal = document.getElementById('help-modal');\n    if (confirmModal?.classList.contains('visible') || helpModal?.classList.contains('visible')) {\n      return; // Modal handlers will deal with it\n    }\n\n    // Navigate based on current screen\n    switch (currentScreen) {\n      case SCREENS.HOME:\n        // Already at home, do nothing\n        break;\n      case SCREENS.COLLECTION:\n        showScreen(SCREENS.HOME);\n        break;\n      case SCREENS.PUZZLE:\n        // Handled by game.js\n        break;\n      case SCREENS.VICTORY:\n        showScreen(SCREENS.COLLECTION);\n        break;\n      case SCREENS.SETTINGS:\n        showScreen(SCREENS.HOME);\n        break;\n      case SCREENS.TUTORIAL:\n        // Skip tutorial\n        if (window.Cozy.Storage) {\n          window.Cozy.Storage.setFlag('tutorialComplete', true);\n        }\n        showScreen(SCREENS.HOME);\n        break;\n    }\n  }\n\n  /**\n   * Show a screen with optional transition\n   * @param {string} screenId - Screen to show\n   * @param {object} data - Data to pass to screen\n   * @param {boolean} addToHistory - Whether to add to navigation history\n   */\n  function showScreen(screenId, data = {}, addToHistory = true) {\n    const targetScreen = screenElements[screenId];\n    if (!targetScreen) {\n      console.error(`Screen not found: ${screenId}`);\n      return;\n    }\n\n    // Store data for the screen\n    screenData = data;\n\n    // Handle leaving the current screen\n    if (currentScreen && screenElements[currentScreen]) {\n      // Clean up zoom system when leaving puzzle screen\n      if (currentScreen === SCREENS.PUZZLE && window.Cozy.Zoom) {\n        window.Cozy.Zoom.destroy();\n      }\n\n      screenElements[currentScreen].classList.remove('screen-active');\n      screenElements[currentScreen].classList.add('screen-hidden');\n      // Make hidden screen inert (removes from tab order and accessibility tree)\n      screenElements[currentScreen].setAttribute('inert', '');\n    }\n\n    // Show target screen\n    targetScreen.classList.remove('screen-hidden');\n    targetScreen.classList.add('screen-active');\n    // Remove inert from active screen\n    targetScreen.removeAttribute('inert');\n\n    // Track history for back navigation (with limit to prevent unbounded growth)\n    if (addToHistory && currentScreen !== null) {\n      screenHistory.push(currentScreen);\n      // Trim history if it exceeds max length\n      if (screenHistory.length > CONFIG.MAX_SCREEN_HISTORY) {\n        screenHistory = screenHistory.slice(-CONFIG.MAX_SCREEN_HISTORY);\n      }\n      history.pushState({ screen: screenId }, '', `#${screenId}`);\n    }\n\n    const previousScreen = currentScreen;\n    currentScreen = screenId;\n\n    // Trigger screen-specific initialization\n    onScreenEnter(screenId, data, previousScreen);\n  }\n\n  /**\n   * Go back to previous screen\n   */\n  function goBack() {\n    if (screenHistory.length > 0) {\n      const previousScreen = screenHistory.pop();\n      showScreen(previousScreen, {}, false);\n      history.back();\n    }\n  }\n\n  /**\n   * Handle browser back/forward buttons\n   */\n  function handlePopState(event) {\n    if (event.state && event.state.screen) {\n      showScreen(event.state.screen, {}, false);\n    } else if (screenHistory.length > 0) {\n      const previousScreen = screenHistory.pop();\n      showScreen(previousScreen, {}, false);\n    }\n  }\n\n  /**\n   * Called when entering a screen - trigger screen-specific logic\n   */\n  function onScreenEnter(screenId, data, previousScreen) {\n    switch (screenId) {\n      case SCREENS.SPLASH:\n        initSplashScreen();\n        break;\n      case SCREENS.HOME:\n        initHomeScreen();\n        break;\n      case SCREENS.COLLECTION:\n        initCollectionScreen(data);\n        break;\n      case SCREENS.PUZZLE:\n        initPuzzleScreen(data);\n        break;\n      case SCREENS.VICTORY:\n        initVictoryScreen(data);\n        break;\n      case SCREENS.SETTINGS:\n        initSettingsScreen();\n        break;\n      case SCREENS.TUTORIAL:\n        initTutorialScreen();\n        break;\n    }\n  }\n\n  /**\n   * Get current screen data\n   */\n  function getScreenData() {\n    return screenData;\n  }\n\n  /**\n   * Get current screen ID\n   */\n  function getCurrentScreen() {\n    return currentScreen;\n  }\n\n  // ============================================\n  // Screen Initialization Functions\n  // ============================================\n\n  /**\n   * Splash Screen - Loading and branding\n   */\n  function initSplashScreen() {\n    // Simulate loading (in real app, load assets here)\n    setTimeout(() => {\n      // Check for ?action=continue URL parameter (PWA shortcut)\n      const urlParams = new URLSearchParams(window.location.search);\n      const action = urlParams.get('action');\n\n      if (action === 'continue') {\n        // Clear URL parameter to avoid repeating on refresh\n        const cleanUrl = window.location.pathname + window.location.hash;\n        history.replaceState(null, '', cleanUrl);\n\n        // Try to resume last session\n        const storage = window.Cozy.Storage;\n        if (storage) {\n          const session = storage.getSession();\n          if (session && typeof session.puzzleIndex === 'number') {\n            showScreen(SCREENS.PUZZLE, { puzzleId: session.puzzleIndex });\n            return;\n          }\n        }\n        // No session to resume, fall through to normal flow\n      }\n\n      // Check if first time user\n      const hasPlayedBefore = window.Cozy.Storage?.getFlag('tutorialCompleted');\n\n      if (!hasPlayedBefore) {\n        showScreen(SCREENS.TUTORIAL);\n      } else {\n        showScreen(SCREENS.HOME);\n      }\n    }, 1500); // Show splash for 1.5 seconds\n  }\n\n  /**\n   * Home Screen - Main menu\n   */\n  function initHomeScreen() {\n    // Attach event listeners (only once)\n    const playBtn = document.getElementById('home-play-btn');\n    const settingsBtn = document.getElementById('home-settings-btn');\n    const progressEl = document.getElementById('home-progress');\n\n    initOnce(playBtn, 'click', () => showScreen(SCREENS.COLLECTION));\n    initOnce(settingsBtn, 'click', () => showScreen(SCREENS.SETTINGS));\n\n    // Update progress display using CozyStorage\n    if (progressEl && window.PUZZLE_DATA) {\n      const puzzles = window.PUZZLE_DATA;\n      const totalPuzzles = Array.isArray(puzzles) ? puzzles.length : 0;\n      let solvedCount = 0;\n\n      if (window.Cozy.Storage && window.Cozy.Garden?.getPuzzleId) {\n        puzzles.forEach(puzzle => {\n          const puzzleId = window.Cozy.Garden.getPuzzleId(puzzle);\n          if (window.Cozy.Storage.isPuzzleCompleted(puzzleId)) {\n            solvedCount++;\n          }\n        });\n      }\n\n      progressEl.textContent = `${solvedCount} / ${totalPuzzles} puzzles solved`;\n    }\n\n    // Focus management: focus on Play button\n    if (playBtn) {\n      setTimeout(() => playBtn.focus(), 100);\n    }\n  }\n\n  /**\n   * Collection Screen - Level select\n   */\n  function initCollectionScreen(data) {\n    // Collection screen initialization is handled by game.js\n    // Trigger a custom event so game.js can respond\n    window.dispatchEvent(new CustomEvent('screen:collection', { detail: data }));\n\n    // Focus management: focus on search input\n    const searchInput = document.getElementById('collection-search-input');\n    if (searchInput) {\n      setTimeout(() => searchInput.focus(), 100);\n    }\n  }\n\n  /**\n   * Puzzle Screen - Gameplay\n   */\n  function initPuzzleScreen(data) {\n    // Initialize zoom system for the puzzle screen\n    if (window.Cozy.Zoom) {\n      window.Cozy.Zoom.init();\n    }\n\n    // Puzzle screen initialization is handled by game.js\n    // data should contain { puzzleId: string }\n    window.dispatchEvent(new CustomEvent('screen:puzzle', { detail: data }));\n  }\n\n  // Store current victory puzzle ID for the continue button\n  let victoryPuzzleId = null;\n\n  /**\n   * Victory Screen - Puzzle completion\n   */\n  function initVictoryScreen(data) {\n    // data should contain { puzzleId, puzzleName, solution, palette }\n    const titleEl = document.getElementById('victory-puzzle-name');\n    const imageEl = document.getElementById('victory-image');\n    const continueBtn = document.getElementById('victory-continue-btn');\n\n    // Store puzzleId for the continue button handler\n    victoryPuzzleId = data.puzzleId;\n\n    if (titleEl && data.puzzleName) {\n      titleEl.textContent = data.puzzleName;\n    }\n\n    if (imageEl && data.solution) {\n      renderVictoryImage(imageEl, data.solution, data.palette);\n    }\n\n    // Set up continue button (only once)\n    initOnce(continueBtn, 'click', () => {\n      // Get the victory canvas for the flying animation\n      const victoryCanvas = imageEl ? imageEl.querySelector('canvas') : null;\n\n      if (victoryCanvas) {\n        const containerRect = imageEl.getBoundingClientRect();\n        const flyingStamp = createFlyingStamp(victoryCanvas, containerRect, { useScale: true });\n\n        // Go to collection with animation flag\n        showScreen(SCREENS.COLLECTION, {\n          scrollToPuzzleId: victoryPuzzleId,\n          animateStamp: true,\n          flyingStamp: flyingStamp\n        });\n      } else {\n        // Fallback: just navigate without animation\n        showScreen(SCREENS.COLLECTION, { scrollToPuzzleId: victoryPuzzleId });\n      }\n    });\n\n    // Focus management: focus on Continue button\n    if (continueBtn) {\n      setTimeout(() => continueBtn.focus(), 100);\n    }\n  }\n\n  /**\n   * Render completed puzzle image on victory screen\n   */\n  function renderVictoryImage(container, solution, palette) {\n    container.innerHTML = '';\n    const height = solution.length;\n    const width = solution[0] ? solution[0].length : height;\n\n    const canvas = renderOutlinedCanvas(\n      width,\n      height,\n      CONFIG.VICTORY_CANVAS_SIZE,\n      (row, col) => {\n        const colorIndex = solution[row][col];\n        if (colorIndex > 0 && palette[colorIndex]) {\n          return palette[colorIndex];\n        }\n        return null;\n      }\n    );\n\n    container.appendChild(canvas);\n  }\n\n  // ============================================\n  // Settings Screen Helper Functions\n  // ============================================\n\n  /**\n   * Initialize the theme selector UI.\n   * Marks the current theme as active and sets up click handlers.\n   */\n  function initThemeSelector() {\n    const themeOptions = document.querySelectorAll('.theme-option');\n\n    // Get current theme, defaulting to system preference if not set\n    let currentTheme = window.Cozy.Storage?.getSetting('theme');\n    if (!currentTheme || currentTheme === 'system') {\n      currentTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';\n    }\n\n    // Mark current theme as active\n    themeOptions.forEach(option => {\n      const theme = option.dataset.theme;\n      const isActive = theme === currentTheme;\n      option.classList.toggle('active', isActive);\n      option.setAttribute('aria-pressed', isActive ? 'true' : 'false');\n    });\n\n    // Add click handlers\n    themeOptions.forEach(option => {\n      initOnce(option, 'click', () => {\n        const theme = option.dataset.theme;\n\n        // Update active state and aria-pressed\n        themeOptions.forEach(opt => {\n          opt.classList.remove('active');\n          opt.setAttribute('aria-pressed', 'false');\n        });\n        option.classList.add('active');\n        option.setAttribute('aria-pressed', 'true');\n\n        // Save and apply theme\n        if (window.Cozy.Storage) {\n          window.Cozy.Storage.setSetting('theme', theme);\n        }\n        applyTheme(theme);\n      });\n    });\n  }\n\n  /**\n   * Initialize the reset progress button with confirmation modal.\n   */\n  function initResetProgressButton() {\n    const resetBtn = document.getElementById('settings-reset-btn');\n\n    initOnce(resetBtn, 'click', () => {\n      showConfirmModal({\n        title: 'Reset Progress',\n        message: 'Are you sure you want to reset all progress? This cannot be undone.',\n        confirmText: 'Reset',\n        cancelText: 'Cancel',\n        danger: true,\n        onConfirm: () => {\n          // Clear game state (in-memory grid, etc.)\n          if (window.Cozy.Garden?.clearAllState) {\n            window.Cozy.Garden.clearAllState();\n          }\n\n          // Use CozyStorage reset (clears all progress, flags, and UI state)\n          if (window.Cozy.Storage?.reset) {\n            window.Cozy.Storage.reset();\n          }\n\n          // Refresh collection if visible\n          if (window.Cozy.Collection) {\n            window.Cozy.Collection.refresh();\n          }\n\n          showAlertModal({\n            title: 'Progress Reset',\n            message: 'All progress has been cleared.'\n          });\n        }\n      });\n    });\n  }\n\n  /**\n   * Initialize the debug \"Solve All\" button with confirmation modal.\n   */\n  function initDebugSolveAll() {\n    const solveAllBtn = document.getElementById('settings-solve-all-btn');\n\n    initOnce(solveAllBtn, 'click', () => {\n      showConfirmModal({\n        title: 'Debug: Solve All',\n        message: 'Mark all puzzles as solved? This is a debug feature.',\n        confirmText: 'Solve All',\n        cancelText: 'Cancel',\n        onConfirm: () => {\n          const puzzles = window.PUZZLE_DATA || [];\n          const storage = window.Cozy.Storage;\n\n          if (storage) {\n            puzzles.forEach(puzzle => {\n              // Use shared utility from CozyGarden if available for consistency\n              let puzzleId;\n              if (window.Cozy.Garden?.getPuzzleId) {\n                puzzleId = window.Cozy.Garden.getPuzzleId(puzzle);\n              } else {\n                // Fallback - handle both concise (t) and verbose (title) formats\n                const title = puzzle.t || puzzle.title;\n                puzzleId = title.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');\n              }\n              storage.completePuzzle(puzzleId);\n            });\n          }\n\n          // Refresh collection if visible\n          if (window.Cozy.Collection) {\n            window.Cozy.Collection.refresh();\n          }\n\n          showAlertModal({\n            title: 'All Puzzles Solved',\n            message: `Marked ${puzzles.length} puzzles as solved!`\n          });\n        }\n      });\n    });\n  }\n\n  /**\n   * Settings Screen - Main initialization\n   */\n  function initSettingsScreen() {\n    const backBtn = document.getElementById('settings-back-btn');\n    const vibrationToggle = document.getElementById('settings-vibration');\n    const tutorialBtn = document.getElementById('settings-tutorial-btn');\n\n    // Load current settings\n    const storage = window.Cozy.Storage;\n    if (vibrationToggle) vibrationToggle.checked = storage?.getSetting('vibration') ?? true;\n\n    // Navigation\n    initOnce(backBtn, 'click', goBack);\n    initOnce(tutorialBtn, 'click', () => showScreen(SCREENS.TUTORIAL));\n\n    // Setting toggles\n    initOnce(vibrationToggle, 'change', () => storage?.setSetting('vibration', vibrationToggle.checked));\n\n    // Feature-specific initialization\n    initThemeSelector();\n    initResetProgressButton();\n    initDebugSolveAll();\n\n    // Focus management\n    if (vibrationToggle) {\n      setTimeout(() => vibrationToggle.focus(), 100);\n    }\n  }\n\n  /**\n   * Tutorial Screen\n   */\n  // Tutorial state (module-level so it persists across re-initializations)\n  let tutorialCurrentStep = 0;\n\n  function initTutorialScreen() {\n    const skipBtn = document.getElementById('tutorial-skip-btn');\n    const nextBtn = document.getElementById('tutorial-next-btn');\n    const steps = document.querySelectorAll('.tutorial-step');\n    const dots = document.querySelectorAll('.tutorial-dot');\n\n    function showStep(index) {\n      steps.forEach((step, i) => {\n        step.classList.toggle('active', i === index);\n      });\n\n      // Update dots\n      dots.forEach((dot, i) => {\n        dot.classList.toggle('active', i === index);\n      });\n\n      // Update button text on last step\n      if (nextBtn) {\n        nextBtn.textContent = index === steps.length - 1 ? 'Start Playing' : 'Next';\n      }\n    }\n\n    function completeTutorial() {\n      window.Cozy.Storage?.setFlag('tutorialCompleted', true);\n      showScreen(SCREENS.HOME);\n    }\n\n    initOnce(skipBtn, 'click', completeTutorial);\n\n    initOnce(nextBtn, 'click', () => {\n      if (tutorialCurrentStep < steps.length - 1) {\n        tutorialCurrentStep++;\n        showStep(tutorialCurrentStep);\n      } else {\n        completeTutorial();\n      }\n    });\n\n    // Reset to first step when entering\n    tutorialCurrentStep = 0;\n    showStep(0);\n\n    // Focus management: focus on Next button\n    if (nextBtn) {\n      setTimeout(() => nextBtn.focus(), 100);\n    }\n  }\n\n  // ============================================\n  // Theme Management\n  // ============================================\n\n  /**\n   * Apply theme to the document\n   * @param {string} theme - 'light' or 'dark'\n   */\n  function applyTheme(theme) {\n    document.documentElement.setAttribute('data-theme', theme);\n\n    // Update theme-color meta tag for browser/PWA chrome\n    const themeColorMeta = document.getElementById('theme-color-meta');\n    if (themeColorMeta) {\n      themeColorMeta.setAttribute('content', theme === 'dark' ? '#0a1018' : '#4a7c3f');\n    }\n  }\n\n  /**\n   * Initialize theme from saved preference or system default\n   */\n  function initTheme() {\n    let savedTheme = window.Cozy.Storage?.getSetting('theme');\n    // Default to system preference if no saved theme (or legacy 'system' value)\n    if (!savedTheme || savedTheme === 'system') {\n      savedTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';\n    }\n    applyTheme(savedTheme);\n  }\n\n  // Public API\n  return {\n    init,\n    showScreen,\n    goBack,\n    getScreenData,\n    getCurrentScreen,\n    applyTheme,\n    initTheme,\n    showConfirmModal,\n    SCREENS\n  };\n})();\n\n// Expose globally\nwindow.Cozy.Screens = ScreenManager;\n\n// Initialize when DOM is ready\ndocument.addEventListener('DOMContentLoaded', () => {\n  ScreenManager.init();\n});\n\n\n// ============================================================\n// FILE: src/js/collection.js\n// ============================================================\n\n// Cozy Garden - Collection Screen\n// Displays puzzles grouped by difficulty level\n\n(function() {\n  'use strict';\n\n  // === Shared Utilities ===\n  const { CONFIG, getPuzzleId, getPuzzleTitle, parsePuzzleTitle, renderOutlinedCanvas } = window.Cozy.Utils;\n\n  // Difficulty display order (derived from puzzles, but with preferred ordering)\n  const DIFFICULTY_ORDER = ['easy', 'medium', 'hard', 'challenging', 'expert'];\n\n  // Get collapsed sections from CozyStorage\n  function getCollapsedSections() {\n    const stored = window.Cozy.Storage?.getUIState('collapsedSections');\n    if (stored && typeof stored === 'object') {\n      return stored;\n    }\n    return null;\n  }\n\n  // Save collapsed sections to CozyStorage\n  function saveCollapsedSections(collapsed) {\n    window.Cozy.Storage?.setUIState('collapsedSections', collapsed);\n  }\n\n  // Toggle section collapsed state\n  function toggleSection(difficulty, collapsed) {\n    const section = document.querySelector(`.collection-section[data-difficulty=\"${difficulty}\"]`);\n    if (!section) return;\n\n    const isCollapsed = collapsed[difficulty];\n    const newCollapsed = !isCollapsed;\n    collapsed[difficulty] = newCollapsed;\n    saveCollapsedSections(collapsed);\n\n    // Update UI\n    section.classList.toggle('collapsed', newCollapsed);\n    const grid = section.querySelector('.collection-grid');\n    const chevron = section.querySelector('.section-chevron');\n    const header = section.querySelector('.collection-section-header');\n\n    if (grid) {\n      grid.style.display = newCollapsed ? 'none' : 'flex';\n    }\n    if (chevron) {\n      chevron.textContent = newCollapsed ? '\\u25B6' : '\\u25BC';\n    }\n\n    // Update accessibility attributes\n    if (header) {\n      header.setAttribute('aria-expanded', !newCollapsed);\n      // Update aria-label to reflect new state\n      const stats = header.querySelector('.collection-section-stats');\n      const statsText = stats ? stats.textContent : '';\n      const [completed, total] = statsText.split('/');\n      header.setAttribute('aria-label',\n        `${formatDifficulty(difficulty)}, ${completed} of ${total} completed, ${newCollapsed ? 'collapsed' : 'expanded'}`);\n    }\n\n    // Update roving tabindex after section visibility changes\n    if (window.Cozy.Collection) {\n      window.Cozy.Collection.updateRovingTabindex();\n    }\n  }\n\n  // Get storage instance\n  function getStorage() {\n    return window.Cozy.Storage || null;\n  }\n\n  // Group puzzles by difficulty\n  function groupPuzzlesByDifficulty(puzzles) {\n    const groups = {};\n\n    puzzles.forEach((puzzle, index) => {\n      const meta = parsePuzzleTitle(getPuzzleTitle(puzzle));\n      const difficulty = meta.difficulty;\n\n      if (!groups[difficulty]) {\n        groups[difficulty] = [];\n      }\n\n      groups[difficulty].push({\n        index: index,\n        puzzle: puzzle,\n        meta: meta,\n        id: getPuzzleId(puzzle)\n      });\n    });\n\n    return groups;\n  }\n\n  // Group puzzles by difficulty, using pre-computed original indices\n  // puzzleItems is array of {puzzle, originalIndex}\n  function groupPuzzlesByDifficultyWithIndex(puzzleItems) {\n    const groups = {};\n\n    puzzleItems.forEach(item => {\n      const meta = parsePuzzleTitle(getPuzzleTitle(item.puzzle));\n      const difficulty = meta.difficulty;\n\n      if (!groups[difficulty]) {\n        groups[difficulty] = [];\n      }\n\n      groups[difficulty].push({\n        index: item.originalIndex,\n        puzzle: item.puzzle,\n        meta: meta,\n        id: getPuzzleId(item.puzzle)\n      });\n    });\n\n    return groups;\n  }\n\n  // Sort difficulties in preferred order\n  function getSortedDifficulties(groups) {\n    const difficulties = Object.keys(groups);\n\n    return difficulties.sort((a, b) => {\n      const indexA = DIFFICULTY_ORDER.indexOf(a);\n      const indexB = DIFFICULTY_ORDER.indexOf(b);\n\n      // Known difficulties come first in order\n      if (indexA !== -1 && indexB !== -1) return indexA - indexB;\n      if (indexA !== -1) return -1;\n      if (indexB !== -1) return 1;\n\n      // Unknown difficulties sorted alphabetically\n      return a.localeCompare(b);\n    });\n  }\n\n  // Format difficulty name for display\n  function formatDifficulty(difficulty) {\n    return difficulty.charAt(0).toUpperCase() + difficulty.slice(1);\n  }\n\n  // Get completion stats for a difficulty group\n  function getGroupStats(puzzleItems) {\n    const storage = getStorage();\n    let completed = 0;\n\n    if (storage) {\n      puzzleItems.forEach(item => {\n        if (storage.isPuzzleCompleted(item.id)) {\n          completed++;\n        }\n      });\n    }\n\n    return {\n      completed: completed,\n      total: puzzleItems.length\n    };\n  }\n\n  // Check if a saved grid has any filled cells\n  function hasProgress(savedGrid) {\n    if (!savedGrid) return false;\n    for (const row of savedGrid) {\n      for (const cell of row) {\n        const value = (typeof cell === 'object' && cell !== null) ? cell.value : cell;\n        if (value !== null) return true;\n      }\n    }\n    return false;\n  }\n\n  // Create a puzzle card element\n  // options.forceBlank: if true, show blank placeholder instead of completed thumbnail\n  function createPuzzleCard(item, onClick, options = {}) {\n    const storage = getStorage();\n    const isCompleted = storage ? storage.isPuzzleCompleted(item.id) : false;\n    const savedGrid = storage ? storage.getPuzzleGrid(item.id) : null;\n    const hasPartialProgress = !isCompleted && hasProgress(savedGrid);\n\n    const card = document.createElement('div');\n    card.className = 'puzzle-card' + (isCompleted ? ' completed' : '') + (hasPartialProgress ? ' in-progress' : '');\n    card.dataset.puzzleIndex = item.index;\n    card.dataset.puzzleId = item.id;\n    // Accessibility: make cards keyboard accessible (roving tabindex - manager sets focused to 0)\n    card.tabIndex = -1;\n    card.setAttribute('role', 'button');\n    card.setAttribute('aria-label', `${item.meta.name}, ${item.meta.width} by ${item.meta.height}${isCompleted ? ', completed' : ''}`);\n\n    // Keyboard handler for accessibility (Enter/Space to select, arrows to navigate)\n    card.addEventListener('keydown', (e) => {\n      if (e.key === 'Enter' || e.key === ' ') {\n        e.preventDefault();\n        // Track this card as focused so we return to it\n        if (window.Cozy.Collection) {\n          window.Cozy.Collection.focusedCardId = item.id;\n        }\n        onClick(item.index);\n        return;\n      }\n      // Arrow key navigation - delegate to collection manager (unified with headers)\n      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {\n        e.preventDefault();\n        e.stopPropagation();\n        if (window.Cozy.Collection) {\n          window.Cozy.Collection.navigateFromElement(card, e.key);\n        }\n      }\n    });\n\n    // Puzzle preview (mini grid or icon)\n    const preview = document.createElement('div');\n    preview.className = 'puzzle-card-preview';\n\n    // Force blank placeholder for stamp animation\n    if (options.forceBlank) {\n      preview.classList.add('awaiting-stamp');\n      const placeholder = document.createElement('div');\n      placeholder.className = 'puzzle-card-placeholder';\n      placeholder.textContent = '?';\n      preview.appendChild(placeholder);\n    } else if (isCompleted) {\n      // Show solved thumbnail\n      preview.appendChild(createMiniSolution(item.puzzle));\n    } else if (hasPartialProgress) {\n      // Show partial progress\n      preview.appendChild(createMiniProgress(item.puzzle, savedGrid));\n    } else {\n      // Show question mark placeholder (puzzle not yet started)\n      const placeholder = document.createElement('div');\n      placeholder.className = 'puzzle-card-placeholder';\n      placeholder.textContent = '?';\n      preview.appendChild(placeholder);\n    }\n\n    card.appendChild(preview);\n\n    // Puzzle name\n    const name = document.createElement('div');\n    name.className = 'puzzle-card-name';\n    name.textContent = item.meta.name;\n    card.appendChild(name);\n\n    // Dimensions and color count badge\n    const colors = Object.keys(item.puzzle.color_map).length;\n    const badge = document.createElement('div');\n    badge.className = 'puzzle-card-badge';\n    badge.textContent = `${item.meta.width}\u00D7${item.meta.height} \u00B7 ${colors}c`;\n    card.appendChild(badge);\n\n    // Click handler\n    card.addEventListener('click', () => {\n      // Track this card as focused so we return to it\n      if (window.Cozy.Collection) {\n        window.Cozy.Collection.focusedCardId = item.id;\n      }\n      onClick(item.index);\n    });\n\n    return card;\n  }\n\n  // Create mini solution preview (scaled down)\n  function createMiniSolution(puzzle) {\n    try {\n      const canvas = renderOutlinedCanvas(\n        puzzle.width,\n        puzzle.height,\n        CONFIG.MINI_CANVAS_SIZE,\n        (row, col) => {\n          const value = puzzle.solution?.[row]?.[col];\n          if (value > 0) {\n            const color = puzzle.color_map?.[value];\n            if (color && Array.isArray(color) && color.length >= 3) {\n              return color;\n            }\n          }\n          return null;\n        }\n      );\n      canvas.className = 'puzzle-mini-canvas';\n      return canvas;\n    } catch (e) {\n      console.error('[Collection] Error creating mini solution:', e);\n      return null;\n    }\n  }\n\n  // Create mini progress preview (partial grid state)\n  function createMiniProgress(puzzle, savedGrid) {\n    try {\n      const canvas = renderOutlinedCanvas(\n        puzzle.width,\n        puzzle.height,\n        CONFIG.MINI_CANVAS_SIZE,\n        (row, col) => {\n          const cell = savedGrid?.[row]?.[col];\n          const value = (typeof cell === 'object' && cell !== null) ? cell.value : cell;\n          if (value !== null && value > 0) {\n            const color = puzzle.color_map?.[value];\n            if (color && Array.isArray(color) && color.length >= 3) {\n              return color;\n            }\n          }\n          return null;\n        }\n      );\n      canvas.className = 'puzzle-mini-canvas';\n      return canvas;\n    } catch (e) {\n      console.error('[Collection] Error creating mini progress:', e);\n      return null;\n    }\n  }\n\n  // Render the collection screen\n  // options.blankPuzzleId: puzzle ID to render with blank placeholder (for stamp animation)\n  // options.searchFilter: string to filter puzzles by name prefix\n  function renderCollection(container, puzzles, onPuzzleSelect, options = {}) {\n    container.innerHTML = '';\n\n    // Filter puzzles by search term if provided, preserving original indices\n    // Limit search length to prevent DoS via extremely long strings\n    const searchFilter = (options.searchFilter || '').toLowerCase().trim().slice(0, CONFIG.MAX_SEARCH_LENGTH);\n\n    // Create array of {puzzle, originalIndex} to preserve indices through filtering\n    let puzzleItems = puzzles.map((puzzle, index) => ({ puzzle, originalIndex: index }));\n\n    if (searchFilter) {\n      puzzleItems = puzzleItems.filter(item => {\n        const meta = parsePuzzleTitle(getPuzzleTitle(item.puzzle));\n        const name = meta.name.toLowerCase();\n        return name.includes(searchFilter);\n      });\n    }\n\n    const groups = groupPuzzlesByDifficultyWithIndex(puzzleItems);\n    const sortedDifficulties = getSortedDifficulties(groups);\n    const storage = getStorage();\n\n    // Show empty state if search returned no results\n    if (sortedDifficulties.length === 0 && searchFilter) {\n      const emptyState = document.createElement('div');\n      emptyState.className = 'collection-empty-state';\n\n      const message = document.createElement('p');\n      message.className = 'collection-empty-message';\n      message.textContent = `No puzzles match \"${searchFilter}\"`;\n      emptyState.appendChild(message);\n\n      container.appendChild(emptyState);\n      return;\n    }\n\n    // Get or calculate collapsed state\n    // When searching, expand all sections to show results\n    let collapsed;\n    if (searchFilter) {\n      collapsed = {};\n      sortedDifficulties.forEach(difficulty => {\n        collapsed[difficulty] = false;\n      });\n    } else {\n      collapsed = getCollapsedSections();\n      if (!collapsed) {\n        // Default: collapse all except first difficulty with incomplete puzzles\n        collapsed = {};\n        let foundIncomplete = false;\n\n        sortedDifficulties.forEach(difficulty => {\n          const stats = getGroupStats(groups[difficulty]);\n          if (!foundIncomplete && stats.completed < stats.total) {\n            // First incomplete section - expand it\n            collapsed[difficulty] = false;\n            foundIncomplete = true;\n          } else {\n            // Collapse others\n            collapsed[difficulty] = true;\n          }\n        });\n\n        // If all complete, expand the first one\n        if (!foundIncomplete && sortedDifficulties.length > 0) {\n          collapsed[sortedDifficulties[0]] = false;\n        }\n\n        saveCollapsedSections(collapsed);\n      }\n    }\n\n    // Render each difficulty section\n    sortedDifficulties.forEach(difficulty => {\n      const section = renderDifficultySection(\n        difficulty,\n        groups[difficulty],\n        collapsed,\n        onPuzzleSelect,\n        options\n      );\n      container.appendChild(section);\n    });\n  }\n\n  /**\n   * Render a single difficulty section with header and puzzle grid.\n   * @param {string} difficulty - Difficulty level name\n   * @param {Array} puzzleItems - Array of {puzzle, originalIndex, id} for this difficulty\n   * @param {Object} collapsed - Map of difficulty -> collapsed state\n   * @param {Function} onPuzzleSelect - Callback when puzzle is selected\n   * @param {Object} options - Render options (e.g., blankPuzzleId)\n   * @returns {HTMLElement} The section element\n   */\n  function renderDifficultySection(difficulty, puzzleItems, collapsed, onPuzzleSelect, options) {\n    const stats = getGroupStats(puzzleItems);\n    const isCollapsed = collapsed[difficulty];\n\n    const section = document.createElement('div');\n    section.className = 'collection-section' + (isCollapsed ? ' collapsed' : '');\n    section.dataset.difficulty = difficulty;\n\n    // Grid ID for aria-controls\n    const gridId = `collection-grid-${difficulty}`;\n\n    // Section header (clickable and keyboard accessible)\n    const sectionHeader = document.createElement('div');\n    sectionHeader.className = 'collection-section-header';\n    sectionHeader.style.cursor = 'pointer';\n    sectionHeader.dataset.difficulty = difficulty;\n\n    // Accessibility: make headers part of unified keyboard navigation\n    sectionHeader.tabIndex = -1;  // Part of roving tabindex group\n    sectionHeader.setAttribute('role', 'button');\n    sectionHeader.setAttribute('aria-expanded', !isCollapsed);\n    sectionHeader.setAttribute('aria-controls', gridId);\n    sectionHeader.setAttribute('aria-label',\n      `${formatDifficulty(difficulty)}, ${stats.completed} of ${stats.total} completed, ${isCollapsed ? 'collapsed' : 'expanded'}`);\n\n    // Chevron indicator\n    const chevron = document.createElement('span');\n    chevron.className = 'section-chevron';\n    chevron.setAttribute('aria-hidden', 'true');\n    chevron.textContent = isCollapsed ? '\\u25B6' : '\\u25BC';\n    sectionHeader.appendChild(chevron);\n\n    const sectionTitle = document.createElement('h3');\n    sectionTitle.className = 'collection-section-title';\n    sectionTitle.textContent = formatDifficulty(difficulty);\n    sectionHeader.appendChild(sectionTitle);\n\n    const sectionStats = document.createElement('span');\n    sectionStats.className = 'collection-section-stats';\n    sectionStats.textContent = `${stats.completed}/${stats.total}`;\n    if (stats.completed === stats.total && stats.total > 0) {\n      sectionStats.classList.add('complete');\n    }\n    sectionHeader.appendChild(sectionStats);\n\n    // Click to toggle\n    sectionHeader.addEventListener('click', () => {\n      toggleSection(difficulty, collapsed);\n    });\n\n    // Keyboard handler for accessibility (Enter/Space to toggle, arrows to navigate)\n    sectionHeader.addEventListener('keydown', (e) => {\n      if (e.key === 'Enter' || e.key === ' ') {\n        e.preventDefault();\n        toggleSection(difficulty, collapsed);\n        return;\n      }\n      // Arrow key navigation - delegate to collection manager\n      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {\n        e.preventDefault();\n        e.stopPropagation();\n        if (window.Cozy.Collection) {\n          window.Cozy.Collection.navigateFromElement(sectionHeader, e.key);\n        }\n      }\n    });\n\n    section.appendChild(sectionHeader);\n\n    // Puzzle grid\n    const grid = document.createElement('div');\n    grid.className = 'collection-grid';\n    grid.id = gridId;\n    grid.style.display = isCollapsed ? 'none' : 'flex';\n\n    puzzleItems.forEach(item => {\n      const cardOptions = {};\n      if (options.blankPuzzleId && item.id === options.blankPuzzleId) {\n        cardOptions.forceBlank = true;\n      }\n      const card = createPuzzleCard(item, onPuzzleSelect, cardOptions);\n      grid.appendChild(card);\n    });\n\n    section.appendChild(grid);\n    return section;\n  }\n\n  // Collection manager class\n  class CollectionManager {\n    constructor() {\n      this.container = null;\n      this.puzzles = [];\n      this.onPuzzleSelect = null;\n      this.visible = true;\n      this.searchFilter = '';\n      this.searchInput = null;\n      this.searchInputHandler = null;  // Store handler reference for cleanup\n      this.searchDebounceTimeout = null;  // Debounce timer for search\n      // Track focused element for roving tabindex (either card or header)\n      this.focusedCardId = null;\n      this.focusedHeaderDifficulty = null;\n      // Track ideal X position for consistent column navigation during up/down\n      // This persists across vertical navigation, updated only on left/right\n      this.idealX = null;\n    }\n\n    init(containerId, puzzles, onPuzzleSelect) {\n      this.container = document.getElementById(containerId);\n      this.puzzles = puzzles;\n      this.onPuzzleSelect = onPuzzleSelect;\n\n      // Set up search input (with cleanup to prevent memory leaks)\n      this.searchInput = document.getElementById('collection-search-input');\n      if (this.searchInput) {\n        // Remove old handler if exists (prevents stacking on re-init)\n        if (this.searchInputHandler) {\n          this.searchInput.removeEventListener('input', this.searchInputHandler);\n        }\n        // Create and store new handler (debounced to avoid excessive re-renders)\n        this.searchInputHandler = (e) => {\n          this.searchFilter = e.target.value;\n          // Debounce render to avoid re-rendering on every keystroke\n          if (this.searchDebounceTimeout) {\n            clearTimeout(this.searchDebounceTimeout);\n          }\n          this.searchDebounceTimeout = setTimeout(() => this.render(), 150);\n        };\n        this.searchInput.addEventListener('input', this.searchInputHandler);\n      }\n\n      if (this.container) {\n        this.render();\n      }\n\n      return this;\n    }\n\n    render(options = {}) {\n      if (!this.container) return;\n      const renderOptions = {\n        ...options,\n        searchFilter: this.searchFilter\n      };\n      renderCollection(this.container, this.puzzles, (index) => {\n        if (this.onPuzzleSelect) {\n          this.onPuzzleSelect(index);\n        }\n      }, renderOptions);\n      // Update roving tabindex after render\n      this.updateRovingTabindex();\n    }\n\n    show() {\n      if (this.container) {\n        this.container.style.display = 'block';\n        this.visible = true;\n        // Clear search filter when showing collection\n        this.searchFilter = '';\n        if (this.searchInput) {\n          this.searchInput.value = '';\n        }\n        this.render(); // Re-render to update completion status\n      }\n    }\n\n    hide() {\n      if (this.container) {\n        this.container.style.display = 'none';\n        this.visible = false;\n      }\n    }\n\n    isVisible() {\n      return this.visible;\n    }\n\n    // Refresh display (e.g., after completing a puzzle)\n    // options.blankPuzzleId: puzzle ID to show with blank placeholder\n    refresh(options = {}) {\n      if (this.visible) {\n        this.render(options);\n      }\n    }\n\n    // Get all visible puzzle cards (in expanded sections)\n    getVisibleCards() {\n      if (!this.container) return [];\n      const cards = [];\n      const sections = this.container.querySelectorAll('.collection-section');\n      sections.forEach(section => {\n        const grid = section.querySelector('.collection-grid');\n        if (grid && grid.style.display !== 'none') {\n          const sectionCards = grid.querySelectorAll('.puzzle-card');\n          sectionCards.forEach(card => cards.push(card));\n        }\n      });\n      return cards;\n    }\n\n    // Get all navigable elements (section headers + visible cards) in DOM order\n    getNavigableElements() {\n      if (!this.container) return [];\n      const elements = [];\n      const sections = this.container.querySelectorAll('.collection-section');\n      sections.forEach(section => {\n        // Add section header (always navigable)\n        const header = section.querySelector('.collection-section-header');\n        if (header) {\n          elements.push(header);\n        }\n        // Add cards only if section is expanded\n        const grid = section.querySelector('.collection-grid');\n        if (grid && grid.style.display !== 'none') {\n          const sectionCards = grid.querySelectorAll('.puzzle-card');\n          sectionCards.forEach(card => elements.push(card));\n        }\n      });\n      return elements;\n    }\n\n    // Check if element is a section header\n    isHeader(element) {\n      return element && element.classList.contains('collection-section-header');\n    }\n\n    // Find element in specified direction based on visual position\n    // Works with both headers and cards\n    // direction: 'up', 'down', 'left', 'right'\n    // targetX: optional X position to use for up/down navigation (for column consistency)\n    findElementInDirection(currentElement, direction, targetX = null) {\n      const elements = this.getNavigableElements();\n      if (elements.length === 0) return null;\n\n      const currentRect = currentElement.getBoundingClientRect();\n      const currentCenterX = currentRect.left + currentRect.width / 2;\n      const currentCenterY = currentRect.top + currentRect.height / 2;\n      const isCurrentHeader = this.isHeader(currentElement);\n\n      // For up/down, use targetX if provided (for column consistency)\n      // For left/right, always use current element's X\n      const searchX = (direction === 'up' || direction === 'down') && targetX !== null\n        ? targetX\n        : currentCenterX;\n\n      // Tolerance for \"same row/column\" comparison\n      const rowTolerance = currentRect.height * 0.5;\n      const colTolerance = currentRect.width * 0.5;\n\n      let bestCandidate = null;\n      let bestDistance = Infinity;\n\n      elements.forEach(element => {\n        if (element === currentElement) return;\n\n        const rect = element.getBoundingClientRect();\n        const centerX = rect.left + rect.width / 2;\n        const centerY = rect.top + rect.height / 2;\n        const isTargetHeader = this.isHeader(element);\n\n        let isValid = false;\n\n        switch (direction) {\n          case 'left':\n            // Must be to the left and roughly same row\n            // Headers span full width, so left/right from header goes nowhere\n            if (isCurrentHeader) {\n              isValid = false;\n            } else {\n              isValid = !isTargetHeader &&\n                        centerX < currentCenterX - colTolerance &&\n                        Math.abs(centerY - currentCenterY) < rowTolerance;\n            }\n            break;\n          case 'right':\n            // Must be to the right and roughly same row\n            if (isCurrentHeader) {\n              isValid = false;\n            } else {\n              isValid = !isTargetHeader &&\n                        centerX > currentCenterX + colTolerance &&\n                        Math.abs(centerY - currentCenterY) < rowTolerance;\n            }\n            break;\n          case 'up':\n            // Must be above (allow any column, prefer closest to searchX)\n            isValid = centerY < currentCenterY - rowTolerance;\n            break;\n          case 'down':\n            // Must be below (allow any column, prefer closest to searchX)\n            isValid = centerY > currentCenterY + rowTolerance;\n            break;\n        }\n\n        if (isValid) {\n          // Calculate distance\n          let distance;\n          if (direction === 'left' || direction === 'right') {\n            distance = Math.abs(centerX - currentCenterX);\n          } else {\n            // For up/down, prioritize closest Y first, then prefer closest to searchX\n            const yDist = Math.abs(centerY - currentCenterY);\n            const xDist = Math.abs(centerX - searchX);\n            distance = yDist * 1000 + xDist; // Heavily weight Y distance\n          }\n\n          if (distance < bestDistance) {\n            bestDistance = distance;\n            bestCandidate = element;\n          }\n        }\n      });\n\n      return bestCandidate;\n    }\n\n    // Unified navigation from any element (header or card)\n    navigateFromElement(element, key) {\n      const directionMap = {\n        'ArrowUp': 'up',\n        'ArrowDown': 'down',\n        'ArrowLeft': 'left',\n        'ArrowRight': 'right'\n      };\n      const direction = directionMap[key];\n      if (!direction) return;\n\n      const currentRect = element.getBoundingClientRect();\n      const currentCenterX = currentRect.left + currentRect.width / 2;\n\n      // For up/down navigation, use idealX for column consistency\n      // For left/right, use current position\n      let targetElement;\n      if (direction === 'up' || direction === 'down') {\n        // Initialize idealX from current position if not set\n        if (this.idealX === null) {\n          this.idealX = currentCenterX;\n        }\n        targetElement = this.findElementInDirection(element, direction, this.idealX);\n      } else {\n        targetElement = this.findElementInDirection(element, direction);\n      }\n\n      if (targetElement) {\n        const targetRect = targetElement.getBoundingClientRect();\n        const targetCenterX = targetRect.left + targetRect.width / 2;\n\n        // Update idealX based on movement type\n        if (direction === 'left' || direction === 'right') {\n          // Horizontal movement: update idealX to new position\n          this.idealX = targetCenterX;\n        } else if (!this.isHeader(targetElement)) {\n          // Vertical movement landing on a card: keep idealX unchanged\n          // This maintains column consistency through headers and varying row lengths\n          // (idealX is only updated on explicit left/right movement)\n        }\n        // Note: landing on a header doesn't change idealX either\n\n        // Update tabindex for roving pattern\n        element.tabIndex = -1;\n        targetElement.tabIndex = 0;\n        targetElement.focus();\n\n        // Track focused element\n        if (this.isHeader(targetElement)) {\n          this.focusedCardId = null;\n          this.focusedHeaderDifficulty = targetElement.dataset.difficulty;\n        } else {\n          this.focusedCardId = targetElement.dataset.puzzleId;\n          this.focusedHeaderDifficulty = null;\n        }\n\n        // Scroll into view if needed\n        targetElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\n      }\n    }\n\n    // Legacy method - delegates to unified navigation\n    // Find card in specified direction based on visual position\n    // direction: 'up', 'down', 'left', 'right'\n    findCardInDirection(currentCard, direction) {\n      const cards = this.getVisibleCards();\n      if (cards.length === 0) return null;\n\n      const currentRect = currentCard.getBoundingClientRect();\n      const currentCenterX = currentRect.left + currentRect.width / 2;\n      const currentCenterY = currentRect.top + currentRect.height / 2;\n\n      // Tolerance for \"same row/column\" comparison\n      const rowTolerance = currentRect.height * 0.5;\n      const colTolerance = currentRect.width * 0.5;\n\n      let bestCandidate = null;\n      let bestDistance = Infinity;\n\n      cards.forEach(card => {\n        if (card === currentCard) return;\n\n        const rect = card.getBoundingClientRect();\n        const centerX = rect.left + rect.width / 2;\n        const centerY = rect.top + rect.height / 2;\n\n        let isValid = false;\n\n        switch (direction) {\n          case 'left':\n            // Must be to the left and roughly same row\n            isValid = centerX < currentCenterX - colTolerance &&\n                      Math.abs(centerY - currentCenterY) < rowTolerance;\n            break;\n          case 'right':\n            // Must be to the right and roughly same row\n            isValid = centerX > currentCenterX + colTolerance &&\n                      Math.abs(centerY - currentCenterY) < rowTolerance;\n            break;\n          case 'up':\n            // Must be above (allow any column, prefer closest X)\n            isValid = centerY < currentCenterY - rowTolerance;\n            break;\n          case 'down':\n            // Must be below (allow any column, prefer closest X)\n            isValid = centerY > currentCenterY + rowTolerance;\n            break;\n        }\n\n        if (isValid) {\n          // Calculate distance (Manhattan for same row/col, Euclidean for up/down)\n          let distance;\n          if (direction === 'left' || direction === 'right') {\n            distance = Math.abs(centerX - currentCenterX);\n          } else {\n            // For up/down, prioritize closest Y first, then prefer similar X\n            const yDist = Math.abs(centerY - currentCenterY);\n            const xDist = Math.abs(centerX - currentCenterX);\n            distance = yDist * 1000 + xDist; // Heavily weight Y distance\n          }\n\n          if (distance < bestDistance) {\n            bestDistance = distance;\n            bestCandidate = card;\n          }\n        }\n      });\n\n      return bestCandidate;\n    }\n\n    // Navigate from a card in response to arrow key\n    navigateFromCard(card, key) {\n      const directionMap = {\n        'ArrowUp': 'up',\n        'ArrowDown': 'down',\n        'ArrowLeft': 'left',\n        'ArrowRight': 'right'\n      };\n      const direction = directionMap[key];\n      if (!direction) return;\n\n      const targetCard = this.findCardInDirection(card, direction);\n      if (targetCard) {\n        // Update tabindex for roving pattern\n        card.tabIndex = -1;\n        targetCard.tabIndex = 0;\n        targetCard.focus();\n        this.focusedCardId = targetCard.dataset.puzzleId;\n\n        // Scroll into view if needed\n        targetCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\n      }\n    }\n\n    // Update roving tabindex after render\n    // Includes both section headers and visible cards in navigation\n    updateRovingTabindex() {\n      const elements = this.getNavigableElements();\n      if (elements.length === 0) return;\n\n      // Find the previously focused element (could be card or header)\n      let focusedElement = null;\n\n      // Try to find by card ID first\n      if (this.focusedCardId) {\n        const candidate = this.container.querySelector(\n          `.puzzle-card[data-puzzle-id=\"${this.focusedCardId}\"]`\n        );\n        // Only use if it's actually visible (not in collapsed section)\n        if (candidate && elements.includes(candidate)) {\n          focusedElement = candidate;\n        }\n      }\n\n      // Try to find by header difficulty\n      if (!focusedElement && this.focusedHeaderDifficulty) {\n        const candidate = this.container.querySelector(\n          `.collection-section-header[data-difficulty=\"${this.focusedHeaderDifficulty}\"]`\n        );\n        if (candidate && elements.includes(candidate)) {\n          focusedElement = candidate;\n        }\n      }\n\n      // If previously focused element not found, use first element (first header)\n      if (!focusedElement) {\n        focusedElement = elements[0];\n        // Update tracking based on element type\n        if (this.isHeader(focusedElement)) {\n          this.focusedHeaderDifficulty = focusedElement.dataset.difficulty;\n          this.focusedCardId = null;\n        } else {\n          this.focusedCardId = focusedElement?.dataset.puzzleId || null;\n          this.focusedHeaderDifficulty = null;\n        }\n      }\n\n      // Set all elements to tabindex=-1 except the focused one\n      elements.forEach(element => {\n        element.tabIndex = (element === focusedElement) ? 0 : -1;\n      });\n    }\n\n    // Scroll to a specific puzzle by ID, expanding its section if needed\n    // options.instant: use instant scroll instead of smooth\n    scrollToPuzzle(puzzleId, options = {}) {\n      if (!this.container) return;\n\n      // Find the puzzle card by data attribute\n      const cards = this.container.querySelectorAll('.puzzle-card');\n      let targetCard = null;\n      let targetIndex = -1;\n\n      // Find puzzle index by ID\n      for (let i = 0; i < this.puzzles.length; i++) {\n        const id = getPuzzleId(this.puzzles[i]);\n        if (id === puzzleId) {\n          targetIndex = i;\n          break;\n        }\n      }\n\n      if (targetIndex === -1) return;\n\n      // Find the card with this puzzle index\n      cards.forEach(card => {\n        if (parseInt(card.dataset.puzzleIndex, 10) === targetIndex) {\n          targetCard = card;\n        }\n      });\n\n      if (!targetCard) return;\n\n      // Find the parent section and expand it if collapsed\n      const section = targetCard.closest('.collection-section');\n      if (section && section.classList.contains('collapsed')) {\n        const difficulty = section.dataset.difficulty;\n        const grid = section.querySelector('.collection-grid');\n        const chevron = section.querySelector('.section-chevron');\n\n        // Expand the section\n        section.classList.remove('collapsed');\n        if (grid) grid.style.display = 'flex';\n        if (chevron) chevron.textContent = '\\u25BC';\n\n        // Update stored collapsed state\n        let collapsed = getCollapsedSections() || {};\n        collapsed[difficulty] = false;\n        saveCollapsedSections(collapsed);\n      }\n\n      // Scroll the card into view with some padding\n      const scrollBehavior = options.instant ? 'instant' : 'smooth';\n      setTimeout(() => {\n        targetCard.scrollIntoView({ behavior: scrollBehavior, block: 'center' });\n      }, options.instant ? 0 : 100);\n    }\n\n    // Animate a flying stamp canvas to a puzzle card\n    // options.quick: use shorter delay for back button animation\n    animateStampTo(puzzleId, flyingStamp, options = {}) {\n      if (!this.container || !flyingStamp) return;\n\n      // Find the target card\n      const targetCard = this.container.querySelector(`.puzzle-card[data-puzzle-id=\"${puzzleId}\"]`);\n      if (!targetCard) {\n        flyingStamp.remove();\n        return;\n      }\n\n      const preview = targetCard.querySelector('.puzzle-card-preview');\n      if (!preview) {\n        flyingStamp.remove();\n        return;\n      }\n\n      // Delay before calculating target position (after scroll settles)\n      const scrollDelay = 100;\n\n      // Wait for scroll to complete before calculating target position\n      setTimeout(() => {\n        // Get target position after scroll settles\n        const targetRect = preview.getBoundingClientRect();\n\n        // Calculate scale factor to match exact mini canvas dimensions\n        // This prevents the visual jump when the stamp is replaced by the actual canvas\n        const currentWidth = parseFloat(flyingStamp.style.width);\n        const currentHeight = parseFloat(flyingStamp.style.height);\n\n        // Find the puzzle to calculate exact mini canvas dimensions\n        const puzzle = this.puzzles.find(p => getPuzzleId(p) === puzzleId);\n        let targetWidth, targetHeight;\n\n        if (puzzle) {\n          // Match the calculation in renderOutlinedCanvas\n          const maxDim = Math.max(puzzle.width, puzzle.height);\n          const cellSize = Math.max(2, Math.floor(CONFIG.MINI_CANVAS_SIZE / maxDim));\n          const padding = CONFIG.OUTLINE_THICKNESS * 2;\n          targetWidth = puzzle.width * cellSize + padding;\n          targetHeight = puzzle.height * cellSize + padding;\n        } else {\n          // Fallback to container-based scaling\n          const stampAspect = currentWidth / currentHeight;\n          if (stampAspect > 1) {\n            targetWidth = targetRect.width;\n            targetHeight = targetRect.width / stampAspect;\n          } else {\n            targetHeight = targetRect.height;\n            targetWidth = targetRect.height * stampAspect;\n          }\n        }\n\n        const scale = targetWidth / currentWidth;\n\n        // Target center position\n        const targetCenterX = targetRect.left + targetRect.width / 2;\n        const targetCenterY = targetRect.top + targetRect.height / 2;\n\n        // Animate position to center and use transform for scaling (preserves aspect ratio)\n        requestAnimationFrame(() => {\n          flyingStamp.style.left = (targetCenterX - currentWidth / 2) + 'px';\n          flyingStamp.style.top = (targetCenterY - currentHeight / 2) + 'px';\n          flyingStamp.style.transform = 'scale(' + scale + ')';\n          flyingStamp.classList.add('landed');\n        });\n\n        // After animation completes, update the card and remove the flying stamp\n        setTimeout(() => {\n          // Remove the awaiting-stamp class and re-render the preview with actual thumbnail\n          preview.classList.remove('awaiting-stamp');\n          preview.innerHTML = '';\n\n          // Find the puzzle and create the mini solution or progress\n          const puzzle = this.puzzles.find(p => {\n            const id = getPuzzleId(p);\n            return id === puzzleId;\n          });\n\n          if (puzzle) {\n            // Check if completed or just partial progress\n            const storage = getStorage();\n            const isCompleted = storage ? storage.isPuzzleCompleted(puzzleId) : false;\n\n            if (isCompleted) {\n              preview.appendChild(createMiniSolution(puzzle));\n            } else {\n              // Show partial progress\n              const savedGrid = storage ? storage.getPuzzleGrid(puzzleId) : null;\n              if (savedGrid) {\n                preview.appendChild(createMiniProgress(puzzle, savedGrid));\n              }\n            }\n          }\n\n          // Remove the flying stamp\n          flyingStamp.remove();\n        }, 650); // Match CSS transition duration + small buffer\n      }, scrollDelay);\n    }\n  }\n\n  // Create singleton\n  const collection = new CollectionManager();\n\n  // Expose globally\n  window.Cozy.Collection = collection;\n})();\n\n\n// ============================================================\n// FILE: src/js/app.js\n// ============================================================\n\n// Cozy Garden - PWA Application Module\n// Handles PWA lifecycle and service worker\n\n(function() {\n  'use strict';\n\n  const App = {\n    // State\n    isInstalled: false,\n    swRegistration: null,\n    resizeTimeout: null,\n\n    // Initialize the app\n    init() {\n      this.checkInstallState();\n      this.registerServiceWorker();\n      this.setupEventListeners();\n\n      console.log('[App] Cozy Garden initialized');\n    },\n\n    // Check if app is installed\n    checkInstallState() {\n      // Check display-mode\n      if (window.matchMedia('(display-mode: standalone)').matches) {\n        this.isInstalled = true;\n      }\n      // iOS Safari\n      if (window.navigator.standalone === true) {\n        this.isInstalled = true;\n      }\n\n      if (this.isInstalled) {\n        document.body.classList.add('is-installed');\n        console.log('[App] Running as installed PWA');\n      }\n    },\n\n    // Register service worker\n    async registerServiceWorker() {\n      if (!('serviceWorker' in navigator)) {\n        console.log('[App] Service workers not supported');\n        return;\n      }\n\n      try {\n        this.swRegistration = await navigator.serviceWorker.register('/sw.js', {\n          scope: '/'\n        });\n\n        console.log('[App] Service worker registered:', this.swRegistration.scope);\n\n        // Check for updates\n        this.swRegistration.addEventListener('updatefound', () => {\n          const newWorker = this.swRegistration.installing;\n          console.log('[App] New service worker installing...');\n\n          newWorker.addEventListener('statechange', () => {\n            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {\n              // New version available\n              this.showUpdateNotification();\n            }\n          });\n        });\n\n      } catch (error) {\n        console.error('[App] Service worker registration failed:', error);\n      }\n    },\n\n    // Show update notification\n    showUpdateNotification() {\n      // Create a simple update banner (using DOM methods for CSP compliance)\n      const banner = document.createElement('div');\n      banner.className = 'update-banner';\n\n      const span = document.createElement('span');\n      span.textContent = 'A new version is available!';\n\n      const updateBtn = document.createElement('button');\n      updateBtn.textContent = 'Update';\n      updateBtn.addEventListener('click', () => this.applyUpdate());\n\n      const laterBtn = document.createElement('button');\n      laterBtn.textContent = 'Later';\n      laterBtn.addEventListener('click', () => banner.remove());\n\n      banner.appendChild(span);\n      banner.appendChild(updateBtn);\n      banner.appendChild(laterBtn);\n      document.body.appendChild(banner);\n    },\n\n    // Apply update\n    applyUpdate() {\n      if (this.swRegistration && this.swRegistration.waiting) {\n        this.swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });\n      }\n      window.location.reload();\n    },\n\n    // Setup event listeners\n    setupEventListeners() {\n      // Handle app visibility changes\n      document.addEventListener('visibilitychange', () => {\n        if (document.visibilityState === 'visible') {\n          this.onAppFocus();\n        } else {\n          this.onAppBlur();\n        }\n      });\n\n      // Handle page unload - save state\n      window.addEventListener('beforeunload', () => {\n        this.saveState();\n      });\n\n      // Handle orientation changes\n      window.addEventListener('orientationchange', () => {\n        setTimeout(() => this.handleResize(), 100);\n      });\n\n      // Handle resize (debounced to avoid excessive calls)\n      window.addEventListener('resize', () => {\n        if (this.resizeTimeout) {\n          clearTimeout(this.resizeTimeout);\n        }\n        this.resizeTimeout = setTimeout(() => this.handleResize(), 100);\n      });\n    },\n\n    // App focus handler\n    onAppFocus() {\n      console.log('[App] App focused');\n      // Could trigger data refresh here\n    },\n\n    // App blur handler\n    onAppBlur() {\n      console.log('[App] App blurred');\n      this.saveState();\n    },\n\n    // Save current state\n    saveState() {\n      if (window.Cozy.Garden && window.Cozy.Storage) {\n        // Game module will handle actual state saving\n        console.log('[App] Saving state...');\n      }\n    },\n\n    // Handle resize\n    handleResize() {\n      // Trigger any responsive adjustments\n      const vh = window.innerHeight * 0.01;\n      document.documentElement.style.setProperty('--vh', `${vh}px`);\n    },\n\n    // Check if running as PWA\n    isPWA() {\n      return this.isInstalled ||\n             window.matchMedia('(display-mode: standalone)').matches ||\n             window.navigator.standalone === true;\n    },\n\n    // Get app version from service worker\n    async getVersion() {\n      if (!this.swRegistration || !navigator.serviceWorker.controller) {\n        return 'unknown';\n      }\n\n      return new Promise((resolve) => {\n        const channel = new MessageChannel();\n        channel.port1.onmessage = (event) => {\n          resolve(event.data.version || 'unknown');\n        };\n        navigator.serviceWorker.controller.postMessage(\n          { type: 'GET_VERSION' },\n          [channel.port2]\n        );\n\n        // Timeout fallback\n        setTimeout(() => resolve('unknown'), 1000);\n      });\n    },\n\n    // Share functionality (Web Share API)\n    async share(title, text, url) {\n      if (navigator.share) {\n        try {\n          await navigator.share({ title, text, url });\n          return true;\n        } catch (e) {\n          if (e.name !== 'AbortError') {\n            console.error('[App] Share failed:', e);\n          }\n          return false;\n        }\n      }\n      return false;\n    },\n\n    // Vibrate (if supported)\n    vibrate(pattern = 50) {\n      if (navigator.vibrate && window.Cozy.Storage?.getSetting('vibration')) {\n        navigator.vibrate(pattern);\n      }\n    }\n  };\n\n  // Initialize when DOM is ready\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => App.init());\n  } else {\n    App.init();\n  }\n\n  // Expose globally\n  window.Cozy.App = App;\n})();\n\n\n// ============================================================\n// FILE: src/js/game.js\n// ============================================================\n\n/**\n * Cozy Garden - Nonogram Game Logic\n *\n * Core gameplay module handling puzzle rendering, user interaction, and win detection.\n *\n * Architecture:\n * - IIFE pattern with window.Cozy.Garden namespace for public API\n * - Grid state stored in `grid[][]` as {value, certain} objects\n * - DOM elements cached in cellElements[][], rowClueElements[], colClueElements[]\n * - Event handlers support mouse, touch, and keyboard (accessibility)\n *\n * Key flows:\n * - loadPuzzle() \u2192 buildPalette() + buildClues() + buildGrid() \u2192 restore session\n * - User interaction \u2192 fillCell() \u2192 updateCellVisual() + updateClueSatisfaction()\n * - Win check via clue validation (not solution comparison)\n *\n * Dependencies:\n * - window.PUZZLE_DATA from data/puzzles.js\n * - window.Cozy.Utils for CONFIG and shared utilities\n * - window.Cozy.Storage for progress persistence\n * - window.Cozy.History for undo/redo\n * - window.Cozy.Screens for navigation\n * - window.Cozy.Zoom for pinch-to-zoom integration\n *\n * @module game\n */\n\n(function() {\n  'use strict';\n\n  // === Shared Utilities ===\n  const { CONFIG, getPuzzleId, getPuzzleTitle, createFlyingStamp, renderOutlinedCanvas } = window.Cozy.Utils;\n\n  // Game state\n  let currentPuzzle = 0;\n  let currentDifficulty = 'easy';\n  let selectedColor = 1;\n  let grid = [];           // Stores {value, certain} objects\n  let isDragging = false;\n  let dragColor = null;\n  let dragCertain = true;  // Whether current drag creates certain or maybe cells\n  let isPencilMode = false;  // Pencil mode for uncertain marks\n  let isLoadingPuzzle = false;  // Guard against concurrent puzzle loads\n\n  // Keyboard navigation state (roving tabindex)\n  let focusedRow = 0;\n  let focusedCol = 0;\n\n  // Event handler references for cleanup (prevents memory leaks)\n  let mouseUpHandler = null;\n  let gridMouseLeaveHandler = null;\n  let gridFocusOutHandler = null;\n\n  // DOM element cache for performance (avoids repeated querySelector calls)\n  let cellElements = [];  // 2D array: cellElements[row][col]\n  let rowClueElements = [];  // rowClueElements[row]\n  let colClueElements = [];  // colClueElements[col]\n\n  // Clue satisfaction state for change detection (enables screen reader announcements)\n  let rowSatisfied = [];  // boolean for each row\n  let colSatisfied = [];  // boolean for each column\n\n  // Help shown flag now stored in CozyStorage.flags.helpShown\n\n  // === Toast Notification ===\n  let toastTimeout = null;\n\n  // Show a toast notification. Uses single-toast pattern: new messages replace\n  // previous ones immediately. This is intentional - rapid actions show latest\n  // feedback only, which is appropriate for non-critical UI messages.\n  function showToast(message, type = 'info') {\n    const toast = document.getElementById('toast');\n    if (!toast) return;\n\n    // Clear any existing timeout (new toast replaces old one)\n    clearTimeout(toastTimeout);\n\n    // Update content and style\n    toast.textContent = message;\n    toast.className = 'toast visible';\n    if (type === 'success') {\n      toast.classList.add('toast-success');\n    } else if (type === 'info') {\n      toast.classList.add('toast-info');\n    }\n\n    // Auto-hide after duration\n    toastTimeout = setTimeout(() => {\n      toast.classList.remove('visible');\n    }, CONFIG.TOAST_DURATION);\n  }\n\n  function hideToast() {\n    const toast = document.getElementById('toast');\n    if (toast) {\n      clearTimeout(toastTimeout);\n      toast.classList.remove('visible');\n    }\n  }\n\n  // === Help Modal ===\n\n  function isTouchDevice() {\n    return 'ontouchstart' in window || navigator.maxTouchPoints > 0;\n  }\n\n  function populateHelpContent() {\n    const helpList = document.getElementById('help-list');\n    if (!helpList) return;\n\n    const isTouch = isTouchDevice();\n\n    // Build help content based on device type\n    let items = [\n      '<li><strong>Select a color</strong> from the palette, then tap cells to fill them</li>',\n      '<li><strong>Drag</strong> across cells to fill multiple at once</li>',\n      '<li><strong>Long-press</strong> a cell to mark it \u2715 (definitely empty)</li>',\n      '<li><strong>Pencil mode</strong> marks uncertain guesses \u2014 confirm or clear them later</li>'\n    ];\n\n    // Add zoom hint for larger puzzles on touch devices\n    if (isTouch) {\n      items.push('<li><strong>Pinch to zoom</strong> on larger puzzles for easier tapping</li>');\n    }\n\n    // Add keyboard shortcuts section for non-touch devices\n    if (!isTouch) {\n      items.push('<li class=\"help-section-title\">Keyboard Shortcuts</li>');\n      items.push('<li><strong>Ctrl+Z</strong> / <strong>Ctrl+Y</strong> \u2014 Undo / Redo</li>');\n      items.push('<li><strong>P</strong> \u2014 Toggle pencil mode</li>');\n      items.push('<li><strong>1-9</strong> \u2014 Select color by number</li>');\n      items.push('<li><strong>+</strong> / <strong>-</strong> \u2014 Zoom in / out</li>');\n    }\n\n    helpList.innerHTML = items.join('');\n  }\n\n  function showHelpModal() {\n    const modal = document.getElementById('help-modal');\n    if (!modal) return;\n\n    populateHelpContent();\n    modal.classList.add('visible');\n    document.body.style.overflow = 'hidden'; // Prevent background scroll\n\n    // Focus close button for accessibility\n    const closeBtn = modal.querySelector('.help-modal-close');\n    if (closeBtn) {\n      setTimeout(() => closeBtn.focus(), 100);\n    }\n  }\n\n  function hideHelpModal() {\n    const modal = document.getElementById('help-modal');\n    if (!modal) return;\n\n    modal.classList.remove('visible');\n    document.body.style.overflow = '';\n  }\n\n  function setupHelpModal() {\n    const helpBtn = document.getElementById('help-btn');\n    const modal = document.getElementById('help-modal');\n    const backdrop = modal?.querySelector('.help-modal-backdrop');\n    const closeBtn = modal?.querySelector('.help-modal-close');\n\n    if (helpBtn) {\n      helpBtn.addEventListener('click', showHelpModal);\n    }\n\n    if (backdrop) {\n      backdrop.addEventListener('click', hideHelpModal);\n    }\n\n    if (closeBtn) {\n      closeBtn.addEventListener('click', hideHelpModal);\n    }\n\n    // Keyboard handling for modal\n    document.addEventListener('keydown', (e) => {\n      if (!modal?.classList.contains('visible')) return;\n\n      // Close on Escape key\n      if (e.key === 'Escape') {\n        hideHelpModal();\n        return;\n      }\n\n      // Focus trap: keep Tab within modal\n      if (e.key === 'Tab') {\n        // Only one focusable element (close button), so always keep focus there\n        if (document.activeElement !== closeBtn) {\n          e.preventDefault();\n          closeBtn?.focus();\n        } else {\n          // Already on close button, prevent Tab from leaving\n          e.preventDefault();\n        }\n      }\n    });\n  }\n\n  /**\n   * Set up skip link for keyboard navigation.\n   * Focuses the first cell of the grid when activated.\n   */\n  function setupSkipLink() {\n    const skipLink = document.getElementById('skip-to-puzzle');\n    if (skipLink) {\n      skipLink.addEventListener('click', (e) => {\n        e.preventDefault();\n        // Focus the first cell of the grid\n        const firstCell = cellElements[0]?.[0];\n        if (firstCell) {\n          firstCell.focus();\n        }\n      });\n    }\n  }\n\n  function maybeShowFirstTimeHelp() {\n    // Show help modal automatically on first visit\n    if (!window.Cozy.Storage?.getFlag('helpShown')) {\n      // Small delay so the puzzle renders first\n      setTimeout(() => {\n        showHelpModal();\n        window.Cozy.Storage?.setFlag('helpShown', true);\n      }, 500);\n    }\n  }\n\n  /**\n   * Convert puzzle from concise storage format to verbose runtime format.\n   * Handles both formats: returns verbose as-is, converts concise format.\n   *\n   * Concise format (storage): {t, w, h, r, c, p, s} with 0-indexed colors\n   * Verbose format (runtime): {title, width, height, row_clues, col_clues, color_map, solution} with 1-indexed colors\n   *\n   * @param {Object} p - Puzzle in either format\n   * @returns {Object|null} Normalized puzzle in verbose format, or null if invalid\n   */\n  function normalizePuzzle(p) {\n    if (!p) return null;\n    // Already in verbose format - validate basic structure\n    if (p.title !== undefined) {\n      if (!p.width || !p.height || !p.row_clues || !p.col_clues || !p.color_map) {\n        console.warn('[Game] Invalid verbose puzzle format:', p.title);\n        return null;\n      }\n      return p;\n    }\n    // Validate concise format has required fields with correct types\n    if (!p.t || !p.w || !p.h || !Array.isArray(p.r) || !Array.isArray(p.c) ||\n        !Array.isArray(p.p) || !Array.isArray(p.s)) {\n      console.warn('[Game] Invalid concise puzzle format, missing or malformed fields:', p.t);\n      return null;\n    }\n    // Validate dimensions are within limits\n    if (p.w > CONFIG.MAX_PUZZLE_DIMENSION || p.h > CONFIG.MAX_PUZZLE_DIMENSION || p.w < 1 || p.h < 1) {\n      console.warn('[Game] Puzzle dimensions out of range:', p.w, 'x', p.h);\n      return null;\n    }\n\n    // Convert hex color to RGB array\n    function hexToRgb(hex) {\n      const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n      return result ? [\n        parseInt(result[1], 16),\n        parseInt(result[2], 16),\n        parseInt(result[3], 16)\n      ] : [0, 0, 0];\n    }\n\n    // Convert clues from [[count, colorIdx], ...] to [{count, color}, ...]\n    // colorIdx is 0-indexed, convert to 1-indexed\n    function convertClues(clues) {\n      return clues.map(row => row.map(([count, colorIdx]) => ({\n        count: count,\n        color: colorIdx + 1\n      })));\n    }\n\n    // Convert palette from [\"#hex\", ...] to {1: [r,g,b], 2: [r,g,b], ...}\n    function convertPalette(palette) {\n      const colorMap = {};\n      palette.forEach((hex, idx) => {\n        colorMap[idx + 1] = hexToRgb(hex);\n      });\n      return colorMap;\n    }\n\n    // Convert solution from 0-indexed (-1 = empty) to 1-indexed (0 = empty)\n    function convertSolution(solution) {\n      return solution.map(row => row.map(c => c < 0 ? 0 : c + 1));\n    }\n\n    try {\n      return {\n        title: p.t,\n        width: p.w,\n        height: p.h,\n        row_clues: convertClues(p.r),\n        col_clues: convertClues(p.c),\n        color_map: convertPalette(p.p),\n        solution: convertSolution(p.s)\n      };\n    } catch (e) {\n      console.error('[Game] Failed to convert puzzle:', p.t, e);\n      return null;\n    }\n  }\n\n  // Cache for normalized puzzles (with reference tracking for invalidation)\n  let normalizedPuzzles = null;\n  let lastRawPuzzleData = null;\n\n  // Get puzzles from global (loaded via script tag)\n  function getPuzzles() {\n    const raw = window.PUZZLE_DATA || [];\n    // Invalidate cache if raw data reference changed (not just length)\n    if (!normalizedPuzzles || raw !== lastRawPuzzleData) {\n      // Filter out invalid puzzles (normalizePuzzle returns null for invalid)\n      normalizedPuzzles = raw.map(normalizePuzzle).filter(p => p !== null);\n      lastRawPuzzleData = raw;\n    }\n    return normalizedPuzzles;\n  }\n\n  // === Cell State Helpers ===\n\n  function createCell(value = null, certain = true) {\n    return { value: value, certain: certain };\n  }\n\n  // Get cell state at position, returning default empty cell if none exists.\n  // Note: Returns a copy/default, does NOT create cell in grid. Use setCellDirect to modify.\n  function getCell(row, col) {\n    return grid[row]?.[col] || createCell();\n  }\n\n  function setCellDirect(row, col, value, certain) {\n    grid[row][col] = { value: value, certain: certain };\n  }\n\n  // === Utility functions ===\n\n  function rgb(color) {\n    return `rgb(${color[0]}, ${color[1]}, ${color[2]})`;\n  }\n\n  // ITU-R BT.601 luma formula - standard weights for perceived brightness\n  // Green (0.587) > Red (0.299) > Blue (0.114) matches human eye sensitivity\n  function getBrightness(color) {\n    return (color[0] * 299 + color[1] * 587 + color[2] * 114) / 1000;\n  }\n\n  function getDifficulty(title) {\n    const t = title.toLowerCase();\n    if (t.includes('easy')) return 'easy';\n    if (t.includes('medium')) return 'medium';\n    if (t.includes('hard')) return 'hard';\n    if (t.includes('challenging')) return 'challenging';\n    if (t.includes('expert')) return 'expert';\n    return 'easy';\n  }\n\n  function getStorage() {\n    return window.Cozy.Storage || null;\n  }\n\n  function getHistory() {\n    return window.Cozy.History || null;\n  }\n\n  // Check if the puzzle grid is completely empty (all cells null)\n  function isPuzzleEmpty() {\n    const puzzle = getPuzzles()[currentPuzzle];\n    if (!puzzle) return true;\n\n    for (let row = 0; row < puzzle.height; row++) {\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = getCell(row, col);\n        if (cell.value !== null) return false;\n      }\n    }\n    return true;\n  }\n\n  // Check if the puzzle grid matches the solution exactly (all cells including empties).\n  // NOTE: This is stricter than winning. Players win via checkWin() by satisfying clues,\n  // which does NOT require marking empty cells. This function requires exact match where\n  // solution empty cells (0) must be explicitly marked (not left as null). This is\n  // intentional - the Solution button staying enabled after winning is harmless.\n  function isPuzzleSolved() {\n    const puzzle = getPuzzles()[currentPuzzle];\n    if (!puzzle) return false;\n\n    for (let row = 0; row < puzzle.height; row++) {\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = getCell(row, col);\n        const solutionValue = puzzle.solution[row][col];\n        if (cell.value !== solutionValue || !cell.certain) return false;\n      }\n    }\n    return true;\n  }\n\n  // Update disabled state of hold-to-confirm buttons\n  function updateHoldButtonStates() {\n    const resetBtn = document.getElementById('reset-btn');\n    const solutionBtn = document.getElementById('solution-btn');\n\n    if (resetBtn) {\n      const empty = isPuzzleEmpty();\n      resetBtn.disabled = empty;\n      resetBtn.setAttribute('aria-label', empty ? 'Reset (puzzle is empty)' : 'Hold to reset puzzle');\n    }\n\n    if (solutionBtn) {\n      const solved = isPuzzleSolved();\n      solutionBtn.disabled = solved;\n      solutionBtn.setAttribute('aria-label', solved ? 'Solution (already shown)' : 'Hold to reveal solution');\n    }\n  }\n\n  // === Screen Reader Announcements ===\n\n  /**\n   * Announce a message to screen readers via live region\n   * @param {string} message - Text to announce\n   */\n  function announce(message) {\n    const el = document.getElementById('sr-announcer');\n    if (el) {\n      el.textContent = '';\n      // Brief delay ensures screen reader registers the change\n      setTimeout(() => { el.textContent = message; }, 50);\n    }\n  }\n\n  // === Pencil Mode ===\n\n  /**\n   * Set pencil mode on or off.\n   * Pencil mode marks cells as \"uncertain\" - they don't count toward win detection.\n   * @param {boolean} enabled - Whether to enable pencil mode\n   */\n  function setPencilMode(enabled) {\n    isPencilMode = enabled;\n    updatePencilModeUI();\n    announce(enabled ? 'Pencil mode' : 'Pen mode');\n    closeModeMenu(); // Close menu after selection\n  }\n\n  /**\n   * Toggle between pen mode (certain marks) and pencil mode (uncertain marks).\n   */\n  function togglePencilMode() {\n    setPencilMode(!isPencilMode);\n  }\n\n  function updatePencilModeUI() {\n    const penBtn = document.getElementById('pen-mode-btn');\n    const pencilBtn = document.getElementById('pencil-mode-btn');\n    const menuBtn = document.getElementById('palette-menu-btn');\n\n    if (penBtn) {\n      penBtn.classList.toggle('active', !isPencilMode);\n      penBtn.setAttribute('aria-checked', String(!isPencilMode));\n    }\n    if (pencilBtn) {\n      pencilBtn.classList.toggle('active', isPencilMode);\n      pencilBtn.setAttribute('aria-checked', String(isPencilMode));\n    }\n\n    // Update menu button icon based on mode\n    if (menuBtn) {\n      const svg = menuBtn.querySelector('.menu-icon-svg');\n      if (svg) {\n        // Remove stroke, use fill for these icons\n        svg.removeAttribute('stroke');\n        svg.removeAttribute('stroke-width');\n        svg.setAttribute('fill', 'currentColor');\n        if (isPencilMode) {\n          // Pencil icon (dashed lines indicate uncertainty)\n          svg.innerHTML = '<path d=\"M19.07 13.88L13 19.94l-1.41-1.41 6.07-6.06 1.41 1.41zm-5.66-5.66l-6.06 6.07-1.42-1.41 6.07-6.07 1.41 1.41zM17.66 5.99l-2.34 2.34 1.41 1.41 2.34-2.34-1.41-1.41zM3 18v3h3l.01-.01L3 18zm3-3l-1 1 3 3 1-1-3-3z\" opacity=\"0.5\"/><path d=\"M9.17 16.17L7.76 17.59l3.54 3.54 1.41-1.41-3.54-3.55zm10.6-10.6l-3.53-3.54-1.42 1.42 3.54 3.53 1.41-1.41z\"/>';\n        } else {\n          // Solid pen icon\n          svg.innerHTML = '<path d=\"M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z\"/>';\n        }\n      }\n    }\n\n    document.body.classList.toggle('pencil-mode', isPencilMode);\n  }\n\n  // === Mode Menu ===\n\n  function toggleModeMenu() {\n    const menu = document.getElementById('mode-menu');\n    const menuBtn = document.getElementById('palette-menu-btn');\n    if (!menu || !menuBtn) return;\n\n    const isOpen = menu.classList.contains('open');\n    if (isOpen) {\n      closeModeMenu();\n    } else {\n      openModeMenu();\n    }\n  }\n\n  function openModeMenu() {\n    const menu = document.getElementById('mode-menu');\n    const menuBtn = document.getElementById('palette-menu-btn');\n    if (!menu || !menuBtn) return;\n\n    menu.classList.add('open');\n    menuBtn.classList.add('menu-open');\n    menuBtn.setAttribute('aria-expanded', 'true');\n\n    // Close menu when clicking outside\n    setTimeout(() => {\n      document.addEventListener('click', handleMenuOutsideClick);\n    }, 0);\n  }\n\n  function closeModeMenu() {\n    const menu = document.getElementById('mode-menu');\n    const menuBtn = document.getElementById('palette-menu-btn');\n    if (!menu) return;\n\n    menu.classList.remove('open');\n    if (menuBtn) {\n      menuBtn.classList.remove('menu-open');\n      menuBtn.setAttribute('aria-expanded', 'false');\n    }\n\n    document.removeEventListener('click', handleMenuOutsideClick);\n  }\n\n  function handleMenuOutsideClick(e) {\n    const menu = document.getElementById('mode-menu');\n    const menuBtn = document.getElementById('palette-menu-btn');\n    if (!menu || !menuBtn) return;\n\n    if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {\n      closeModeMenu();\n    }\n  }\n\n  // Check if there are any pencil marks on the grid\n  function hasPencilMarks() {\n    const puzzle = getPuzzles()[currentPuzzle];\n    if (!puzzle) return false;\n\n    for (let row = 0; row < puzzle.height; row++) {\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = getCell(row, col);\n        if (!cell.certain && cell.value !== null) {\n          return true;\n        }\n      }\n    }\n    return false;\n  }\n\n  // Count pencil marks for badge display\n  function countPencilMarks() {\n    const puzzle = getPuzzles()[currentPuzzle];\n    if (!puzzle) return 0;\n\n    let count = 0;\n    for (let row = 0; row < puzzle.height; row++) {\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = getCell(row, col);\n        if (!cell.certain && cell.value !== null) {\n          count++;\n        }\n      }\n    }\n    return count;\n  }\n\n  function updatePencilActionsVisibility() {\n    const pencilActionsSection = document.getElementById('pencil-actions-section');\n    const menuBtn = document.getElementById('palette-menu-btn');\n    const hasMarks = hasPencilMarks();\n    const markCount = hasMarks ? countPencilMarks() : 0;\n\n    // Show/hide pencil actions in menu\n    if (pencilActionsSection) {\n      pencilActionsSection.classList.toggle('has-marks', hasMarks);\n    }\n\n    // Update menu button badge\n    if (menuBtn) {\n      menuBtn.classList.toggle('has-pencil-marks', hasMarks);\n      const badge = menuBtn.querySelector('.pencil-badge');\n      if (badge) {\n        badge.textContent = markCount > CONFIG.BADGE_MAX_DISPLAY\n          ? `${CONFIG.BADGE_MAX_DISPLAY}+`\n          : String(markCount);\n      }\n    }\n  }\n\n  // === Batch Operations ===\n\n  /**\n   * Clear all pencil (uncertain) marks from the grid.\n   * Resets uncertain cells to empty. Recorded as a single undoable action.\n   */\n  function clearAllPencilMarks() {\n    const puzzle = getPuzzles()[currentPuzzle];\n    if (!puzzle) return;\n\n    const changes = [];\n\n    for (let row = 0; row < puzzle.height; row++) {\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = getCell(row, col);\n        if (!cell.certain && cell.value !== null) {\n          changes.push({\n            row, col,\n            before: { value: cell.value, certain: cell.certain },\n            after: { value: null, certain: true }\n          });\n          setCellDirect(row, col, null, true);\n          updateCellVisual(row, col, puzzle);\n        }\n      }\n    }\n\n    if (changes.length > 0) {\n      const history = getHistory();\n      if (history) {\n        history.recordBatchAction('batch-clear', changes);\n      }\n\n      // Haptic feedback\n      if (window.Cozy.App) window.Cozy.App.vibrate(20);\n    }\n\n    updatePencilActionsVisibility();\n    saveSession();\n  }\n\n  /**\n   * Convert all pencil (uncertain) marks to certain marks.\n   * Makes all uncertain cells permanent. Recorded as a single undoable action.\n   * Triggers win check after confirmation.\n   */\n  function confirmAllPencilMarks() {\n    const puzzle = getPuzzles()[currentPuzzle];\n    if (!puzzle) return;\n\n    const changes = [];\n\n    for (let row = 0; row < puzzle.height; row++) {\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = getCell(row, col);\n        if (!cell.certain && cell.value !== null) {\n          changes.push({\n            row, col,\n            before: { value: cell.value, certain: cell.certain },\n            after: { value: cell.value, certain: true }\n          });\n          setCellDirect(row, col, cell.value, true);\n          updateCellVisual(row, col, puzzle);\n        }\n      }\n    }\n\n    if (changes.length > 0) {\n      const history = getHistory();\n      if (history) {\n        history.recordBatchAction('batch-confirm', changes);\n      }\n\n      // Haptic feedback\n      if (window.Cozy.App) window.Cozy.App.vibrate([20, 50, 20]);\n    }\n\n    updatePencilActionsVisibility();\n    checkWin(puzzle);\n    saveSession();\n  }\n\n  // === Undo/Redo ===\n\n  /**\n   * Undo the last action (fill, clear, or batch operation).\n   * Restores cells to their previous state and updates UI.\n   */\n  function performUndo() {\n    const history = getHistory();\n    if (!history) return;\n\n    const changes = history.undo();\n    if (!changes) return;\n\n    const puzzle = getPuzzles()[currentPuzzle];\n\n    for (const change of changes) {\n      setCellDirect(change.row, change.col, change.state.value, change.state.certain);\n      updateCellVisual(change.row, change.col, puzzle);\n    }\n\n    // Haptic feedback\n    if (window.Cozy.App) window.Cozy.App.vibrate(15);\n\n    updatePencilActionsVisibility();\n    updateClueSatisfaction(puzzle);\n    updateHoldButtonStates();\n    saveSession();\n  }\n\n  /**\n   * Redo the last undone action.\n   * Restores cells to their \"after\" state and triggers win check.\n   */\n  function performRedo() {\n    const history = getHistory();\n    if (!history) return;\n\n    const changes = history.redo();\n    if (!changes) return;\n\n    const puzzle = getPuzzles()[currentPuzzle];\n\n    for (const change of changes) {\n      setCellDirect(change.row, change.col, change.state.value, change.state.certain);\n      updateCellVisual(change.row, change.col, puzzle);\n    }\n\n    // Haptic feedback\n    if (window.Cozy.App) window.Cozy.App.vibrate(15);\n\n    updatePencilActionsVisibility();\n    updateClueSatisfaction(puzzle);\n    updateHoldButtonStates();\n    checkWin(puzzle);\n    saveSession();\n  }\n\n  // === Session Management ===\n\n  function saveSession() {\n    const storage = getStorage();\n    if (!storage) return;\n\n    const puzzles = getPuzzles();\n    const puzzle = puzzles[currentPuzzle];\n    if (!puzzle) return;\n\n    const puzzleId = getPuzzleId(puzzle);\n    storage.savePuzzleGrid(puzzleId, grid);\n    storage.saveSession(currentPuzzle, currentDifficulty, grid);\n  }\n\n  function clearSession() {\n    const storage = getStorage();\n    if (storage) storage.clearSession();\n  }\n\n  // === Puzzle Selection UI ===\n\n  function initPuzzleSelect() {\n    const puzzles = getPuzzles();\n    const container = document.getElementById('puzzle-select');\n\n    const difficulties = [...new Set(puzzles.map(p => getDifficulty(p.title)))];\n    const diffOrder = ['easy', 'medium', 'hard', 'challenging', 'expert'];\n    difficulties.sort((a, b) => diffOrder.indexOf(a) - diffOrder.indexOf(b));\n\n    const tabsDiv = document.createElement('div');\n    tabsDiv.className = 'difficulty-tabs';\n\n    difficulties.forEach(diff => {\n      const btn = document.createElement('button');\n      btn.className = 'difficulty-tab' + (diff === currentDifficulty ? ' active' : '');\n      btn.textContent = diff.charAt(0).toUpperCase() + diff.slice(1);\n      btn.onclick = () => {\n        currentDifficulty = diff;\n        document.querySelectorAll('.difficulty-tab').forEach(t => t.classList.remove('active'));\n        btn.classList.add('active');\n        updateDropdown();\n      };\n      tabsDiv.appendChild(btn);\n    });\n\n    const dropdownDiv = document.createElement('div');\n    dropdownDiv.className = 'puzzle-dropdown';\n    const select = document.createElement('select');\n    select.id = 'puzzle-select-dropdown';\n    select.onchange = (e) => {\n      loadPuzzle(parseInt(e.target.value));\n    };\n    dropdownDiv.appendChild(select);\n\n    container.appendChild(tabsDiv);\n    container.appendChild(dropdownDiv);\n\n    updateDropdown();\n  }\n\n  function updateDropdown() {\n    const puzzles = getPuzzles();\n    const select = document.getElementById('puzzle-select-dropdown');\n    if (!select) return; // Skip if dropdown doesn't exist (using collection view)\n    const storage = getStorage();\n    select.innerHTML = '';\n\n    puzzles.forEach((puzzle, idx) => {\n      if (getDifficulty(puzzle.title) === currentDifficulty) {\n        const opt = document.createElement('option');\n        opt.value = idx;\n\n        const puzzleId = getPuzzleId(puzzle);\n        const isCompleted = storage ? storage.isPuzzleCompleted(puzzleId) : false;\n        opt.textContent = (isCompleted ? '\\u2713 ' : '') + puzzle.title;\n\n        if (idx === currentPuzzle) opt.selected = true;\n        select.appendChild(opt);\n      }\n    });\n\n    const filteredPuzzles = puzzles.filter(p => getDifficulty(p.title) === currentDifficulty);\n    if (filteredPuzzles.length > 0) {\n      const currentInDifficulty = getDifficulty(puzzles[currentPuzzle]?.title) === currentDifficulty;\n      if (!currentInDifficulty) {\n        const firstIdx = puzzles.findIndex(p => getDifficulty(p.title) === currentDifficulty);\n        if (firstIdx >= 0) loadPuzzle(firstIdx);\n      }\n    }\n  }\n\n  // === Core Game Functions ===\n\n  function loadPuzzle(index, restoreGrid = null) {\n    // Guard against concurrent puzzle loads (race condition)\n    if (isLoadingPuzzle) {\n      console.warn('[Game] Puzzle already loading, ignoring request');\n      return;\n    }\n    isLoadingPuzzle = true;\n\n    try {\n      const puzzles = getPuzzles();\n      const storage = getStorage();\n      const history = getHistory();\n\n      // Save current puzzle's grid before switching\n      if (index !== currentPuzzle && grid.length > 0 && puzzles[currentPuzzle] && storage) {\n        const currentPuzzleId = getPuzzleId(puzzles[currentPuzzle]);\n        storage.savePuzzleGrid(currentPuzzleId, grid);\n      }\n\n      // Clear history when switching puzzles\n      if (history) history.clear();\n\n      // Reset pencil mode when loading a new puzzle\n      isPencilMode = false;\n      updatePencilModeUI();\n\n      // Reset keyboard focus to top-left cell\n      focusedRow = 0;\n      focusedCol = 0;\n\n      currentPuzzle = index;\n      const puzzle = puzzles[index];\n      if (!puzzle) {\n        isLoadingPuzzle = false;\n        return;\n      }\n\n      // Validate puzzle dimensions (security: prevent DOM explosion)\n      if (puzzle.width > CONFIG.MAX_PUZZLE_DIMENSION || puzzle.height > CONFIG.MAX_PUZZLE_DIMENSION ||\n          puzzle.width < 1 || puzzle.height < 1) {\n        console.error(`[Game] Invalid puzzle dimensions: ${puzzle.width}x${puzzle.height}`);\n        isLoadingPuzzle = false;\n        return;\n      }\n\n      const puzzleId = getPuzzleId(puzzle);\n\n      // Initialize or restore grid\n      let savedGrid = restoreGrid;\n      if (!savedGrid && storage) {\n        savedGrid = storage.getPuzzleGrid(puzzleId);\n      }\n\n      const hasRestoredGrid = savedGrid && savedGrid.length === puzzle.height;\n      if (hasRestoredGrid) {\n        // Deep copy\n        grid = savedGrid.map(row => row.map(cell =>\n          ({ value: cell.value, certain: cell.certain })\n        ));\n      } else {\n        // Create empty grid\n        grid = [];\n        for (let row = 0; row < puzzle.height; row++) {\n          grid.push([]);\n          for (let col = 0; col < puzzle.width; col++) {\n            grid[row][col] = createCell(null, true);\n          }\n        }\n      }\n\n      selectedColor = 1;\n      buildPalette(puzzle);\n      buildClues(puzzle);\n      buildGrid(puzzle);\n      updateCurrentPuzzleTitle();\n\n      // Update cell visuals if grid was restored\n      if (hasRestoredGrid) {\n        for (let row = 0; row < puzzle.height; row++) {\n          for (let col = 0; col < puzzle.width; col++) {\n            const cell = getCell(row, col);\n            if (cell.value !== null) {\n              updateCellVisual(row, col, puzzle);\n            }\n          }\n        }\n      }\n\n      // Hide any existing toast when loading a new puzzle\n      hideToast();\n\n      const select = document.getElementById('puzzle-select-dropdown');\n      if (select) select.value = index;\n\n      const newDiff = getDifficulty(puzzle.title);\n      if (newDiff !== currentDifficulty) {\n        currentDifficulty = newDiff;\n        document.querySelectorAll('.difficulty-tab').forEach(tab => {\n          tab.classList.toggle('active', tab.textContent.toLowerCase() === newDiff);\n        });\n        updateDropdown();\n      }\n\n      updatePencilActionsVisibility();\n      updateClueSatisfaction(puzzle);\n\n      // Initialize zoom system for this puzzle\n      if (window.Cozy.Zoom) {\n        window.Cozy.Zoom.initForPuzzle(puzzle);\n      }\n\n      // Show help modal on first-ever puzzle load\n      maybeShowFirstTimeHelp();\n\n      // Update hold button states based on puzzle state\n      updateHoldButtonStates();\n    } finally {\n      isLoadingPuzzle = false;\n    }\n  }\n\n  /**\n   * Build the color palette UI for a puzzle.\n   * Creates eraser button (color 0) plus a button for each puzzle color.\n   * Preserves the mode menu if it exists. Adjusts button sizes based on\n   * color count for optimal touch targets.\n   *\n   * @param {Object} puzzle - Puzzle object with color_map\n   */\n  function buildPalette(puzzle) {\n    const palette = document.getElementById('palette');\n\n    // Preserve mode menu before clearing (it may have been appended previously)\n    const existingMenu = document.getElementById('mode-menu');\n    const menuParent = existingMenu ? existingMenu.parentNode : null;\n    if (existingMenu && palette.contains(existingMenu)) {\n      // Temporarily move menu out so it's not destroyed by innerHTML = ''\n      document.body.appendChild(existingMenu);\n    }\n\n    palette.innerHTML = '';\n\n    // Add eraser\n    const eraser = document.createElement('button');\n    eraser.className = 'color-btn eraser';\n    eraser.title = 'Eraser';\n    eraser.setAttribute('aria-label', 'Eraser');\n    eraser.setAttribute('aria-pressed', selectedColor === 0 ? 'true' : 'false');\n    eraser.addEventListener('click', () => selectColor(0));\n    palette.appendChild(eraser);\n\n    // Add color buttons\n    Object.entries(puzzle.color_map).forEach(([colorId, colorRgb]) => {\n      const btn = document.createElement('button');\n      const isSelected = parseInt(colorId) === selectedColor;\n      btn.className = 'color-btn' + (isSelected ? ' selected' : '');\n      btn.style.background = rgb(colorRgb);\n      btn.setAttribute('aria-label', `Color ${colorId}`);\n      btn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');\n      btn.addEventListener('click', () => selectColor(parseInt(colorId)));\n      palette.appendChild(btn);\n    });\n\n    // Add mode menu button at end of palette\n    const menuBtn = document.createElement('button');\n    menuBtn.className = 'palette-menu-btn';\n    menuBtn.id = 'palette-menu-btn';\n    menuBtn.title = 'Drawing mode';\n    menuBtn.setAttribute('aria-label', 'Drawing mode menu');\n    menuBtn.setAttribute('aria-haspopup', 'true');\n    menuBtn.setAttribute('aria-expanded', 'false');\n    // Start with pen icon (default mode)\n    menuBtn.innerHTML = `\n      <svg class=\"menu-icon-svg\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n        <path d=\"M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z\"/>\n      </svg>\n      <span class=\"pencil-badge\">0</span>\n    `;\n    menuBtn.addEventListener('click', (e) => {\n      e.stopPropagation();\n      toggleModeMenu();\n    });\n    palette.appendChild(menuBtn);\n\n    // Move mode menu inside palette for proper positioning\n    const modeMenu = document.getElementById('mode-menu');\n    if (modeMenu) {\n      palette.appendChild(modeMenu);\n    }\n\n    // Add class based on button count for responsive sizing\n    // 8 buttons (6 colors + eraser + menu) need smaller sizes on phones\n    const buttonCount = palette.querySelectorAll('.color-btn, .palette-menu-btn').length;\n    palette.classList.remove('palette-8-buttons', 'palette-7-buttons');\n    if (buttonCount >= 8) {\n      palette.classList.add('palette-8-buttons');\n    } else if (buttonCount === 7) {\n      palette.classList.add('palette-7-buttons');\n    }\n    // 6 or fewer buttons can use full 44px size on all screens\n  }\n\n  /**\n   * Select a color from the palette for filling cells.\n   * @param {number} colorId - Color ID (0 for eraser/X, 1+ for palette colors)\n   */\n  function selectColor(colorId) {\n    selectedColor = colorId;\n    const puzzles = getPuzzles();\n    const puzzle = puzzles[currentPuzzle];\n\n    document.querySelectorAll('.color-btn').forEach((btn, idx) => {\n      let isSelected;\n      if (idx === 0) {\n        isSelected = colorId === 0;\n      } else {\n        isSelected = parseInt(Object.keys(puzzle.color_map)[idx - 1]) === colorId;\n      }\n      btn.classList.toggle('selected', isSelected);\n      btn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');\n    });\n  }\n\n  /**\n   * Create a clue cell element\n   * @param {Object|null} clue - Clue object {count, color} or null for empty row/column\n   * @param {Object} puzzle - Puzzle object with color_map\n   * @param {string} className - CSS class name for the cell\n   * @returns {HTMLElement} The clue cell element\n   */\n  function createClueCell(clue, puzzle, className) {\n    const cell = document.createElement('div');\n    cell.className = className;\n\n    if (clue === null) {\n      // Empty row/column indicator\n      cell.textContent = '0';\n      cell.style.background = '#333';\n    } else {\n      const colorRgb = puzzle.color_map[clue.color];\n      cell.textContent = clue.count;\n      cell.style.background = rgb(colorRgb);\n      cell.style.color = getBrightness(colorRgb) > CONFIG.BRIGHTNESS_MIDPOINT ? '#000' : '#fff';\n      cell.style.cursor = 'pointer';\n      cell.onclick = () => selectColor(clue.color);\n    }\n\n    return cell;\n  }\n\n  /**\n   * Build the row and column clue displays for a puzzle.\n   * Creates DOM elements for each clue cell with appropriate colors and\n   * click handlers. Caches elements in colClueElements/rowClueElements\n   * for fast satisfaction updates.\n   *\n   * @param {Object} puzzle - Puzzle object with row_clues, col_clues, color_map\n   */\n  function buildClues(puzzle) {\n    // Initialize clue element caches and satisfaction state\n    colClueElements = [];\n    rowClueElements = [];\n    rowSatisfied = new Array(puzzle.height).fill(false);\n    colSatisfied = new Array(puzzle.width).fill(false);\n\n    // Column clues\n    const colCluesEl = document.getElementById('col-clues');\n    colCluesEl.innerHTML = '';\n    colCluesEl.style.gridTemplateColumns = `repeat(${puzzle.width}, var(--cell-size))`;\n\n    puzzle.col_clues.forEach((clues, colIndex) => {\n      const col = document.createElement('div');\n      col.className = 'col-clue';\n      col.dataset.col = colIndex;\n\n      if (clues.length === 0) {\n        col.appendChild(createClueCell(null, puzzle, 'clue-cell'));\n      } else {\n        clues.forEach(clue => {\n          col.appendChild(createClueCell(clue, puzzle, 'clue-cell'));\n        });\n      }\n\n      // Cache for fast lookup\n      colClueElements[colIndex] = col;\n      colCluesEl.appendChild(col);\n    });\n\n    // Row clues\n    const rowContainer = document.getElementById('row-clues-container');\n    rowContainer.innerHTML = '';\n    rowContainer.style.gridTemplateRows = `repeat(${puzzle.height}, var(--cell-size))`;\n\n    puzzle.row_clues.forEach((clues, rowIndex) => {\n      const rowClues = document.createElement('div');\n      rowClues.className = 'row-clues';\n      rowClues.dataset.row = rowIndex;\n\n      if (clues.length === 0) {\n        rowClues.appendChild(createClueCell(null, puzzle, 'row-clue-cell'));\n      } else {\n        clues.forEach(clue => {\n          rowClues.appendChild(createClueCell(clue, puzzle, 'row-clue-cell'));\n        });\n      }\n\n      // Cache for fast lookup\n      rowClueElements[rowIndex] = rowClues;\n      rowContainer.appendChild(rowClues);\n    });\n  }\n\n  // === Crosshair Hover Effect ===\n  let currentHoverRow = -1;\n  let currentHoverCol = -1;\n\n  function updateCrosshairHighlight(row, col) {\n    // Skip on touch devices\n    if (isTouchDevice()) return;\n\n    // Skip if same position\n    if (row === currentHoverRow && col === currentHoverCol) return;\n\n    // Clear previous highlights\n    clearCrosshairHighlight();\n\n    // Set new position\n    currentHoverRow = row;\n    currentHoverCol = col;\n\n    if (row < 0 || col < 0) return;\n    if (!cellElements[row]) return;\n\n    // Highlight cells in same row (using cache)\n    const rowCells = cellElements[row];\n    if (rowCells) {\n      for (let c = 0; c < rowCells.length; c++) {\n        const cellEl = rowCells[c];\n        if (cellEl) {\n          cellEl.classList.add('highlight-row');\n          if (c === col) {\n            cellEl.classList.add('highlight-cell');\n          }\n        }\n      }\n    }\n\n    // Highlight cells in same column (using cache)\n    for (let r = 0; r < cellElements.length; r++) {\n      if (r !== row && cellElements[r]?.[col]) {\n        cellElements[r][col].classList.add('highlight-col');\n      }\n    }\n\n    // Highlight corresponding clues (using cache)\n    if (rowClueElements[row]) {\n      rowClueElements[row].classList.add('highlight-clue');\n    }\n    if (colClueElements[col]) {\n      colClueElements[col].classList.add('highlight-clue');\n    }\n  }\n\n  function clearCrosshairHighlight() {\n    const prevRow = currentHoverRow;\n    const prevCol = currentHoverCol;\n    currentHoverRow = -1;\n    currentHoverCol = -1;\n\n    // Only clear if we had a previous highlight\n    if (prevRow < 0 && prevCol < 0) return;\n\n    // Clear only the previously highlighted row and column - O(n) instead of O(n\u00B2)\n    // Clear the highlighted row\n    if (prevRow >= 0 && cellElements[prevRow]) {\n      for (let c = 0; c < cellElements[prevRow].length; c++) {\n        const cellEl = cellElements[prevRow][c];\n        if (cellEl) {\n          cellEl.classList.remove('highlight-row', 'highlight-cell');\n        }\n      }\n    }\n    // Clear the highlighted column\n    if (prevCol >= 0) {\n      for (let r = 0; r < cellElements.length; r++) {\n        const cellEl = cellElements[r]?.[prevCol];\n        if (cellEl) {\n          cellEl.classList.remove('highlight-col');\n        }\n      }\n    }\n\n    // Clear clue highlights (only the previously highlighted ones)\n    if (prevRow >= 0 && rowClueElements[prevRow]) {\n      rowClueElements[prevRow].classList.remove('highlight-clue');\n    }\n    if (prevCol >= 0 && colClueElements[prevCol]) {\n      colClueElements[prevCol].classList.remove('highlight-clue');\n    }\n  }\n\n  // Move keyboard focus to a specific cell (roving tabindex pattern)\n  function moveFocusToCell(newRow, newCol) {\n    const puzzle = getPuzzles()[currentPuzzle];\n    if (!puzzle) return;\n\n    // Bounds check - stop at edges\n    if (newRow < 0 || newRow >= puzzle.height || newCol < 0 || newCol >= puzzle.width) {\n      return;\n    }\n\n    // Update old cell's tabIndex\n    if (cellElements[focusedRow]?.[focusedCol]) {\n      cellElements[focusedRow][focusedCol].tabIndex = -1;\n    }\n\n    // Update state\n    focusedRow = newRow;\n    focusedCol = newCol;\n\n    // Update new cell and focus it\n    const newCell = cellElements[newRow]?.[newCol];\n    if (newCell) {\n      newCell.tabIndex = 0;\n      newCell.focus();\n      // Crosshair highlight is handled by the cell's onfocus handler\n    }\n  }\n\n  // === Cell Creation Helpers (extracted from buildGrid for clarity) ===\n\n  /**\n   * Create a grid cell DOM element with basic attributes\n   */\n  function createGridCell(row, col) {\n    const cell = document.createElement('div');\n    cell.className = 'cell';\n    cell.dataset.row = row;\n    cell.dataset.col = col;\n    // Accessibility: roving tabindex - only focused cell is tabbable\n    cell.tabIndex = (row === focusedRow && col === focusedCol) ? 0 : -1;\n    cell.setAttribute('role', 'gridcell');\n    cell.setAttribute('aria-label', `Row ${row + 1}, Column ${col + 1}, empty`);\n    return cell;\n  }\n\n  /**\n   * Attach focus event handlers for keyboard navigation\n   */\n  function attachCellFocusHandlers(cell, row, col) {\n    cell.onfocus = () => {\n      // Update roving tabindex state when cell receives focus (via click, tab, or arrow)\n      if (focusedRow !== row || focusedCol !== col) {\n        // Update old cell's tabIndex\n        if (cellElements[focusedRow]?.[focusedCol]) {\n          cellElements[focusedRow][focusedCol].tabIndex = -1;\n        }\n        // Update state\n        focusedRow = row;\n        focusedCol = col;\n        // Ensure this cell has correct tabIndex\n        cell.tabIndex = 0;\n      }\n      // Update crosshair highlight\n      updateCrosshairHighlight(row, col);\n    };\n  }\n\n  /**\n   * Attach keyboard event handlers for cell interaction\n   */\n  function attachCellKeyboardHandlers(cell, row, col) {\n    cell.onkeydown = (e) => {\n      // Arrow key navigation\n      if (e.key === 'ArrowUp') {\n        e.preventDefault();\n        moveFocusToCell(row - 1, col);\n      } else if (e.key === 'ArrowDown') {\n        e.preventDefault();\n        moveFocusToCell(row + 1, col);\n      } else if (e.key === 'ArrowLeft') {\n        e.preventDefault();\n        moveFocusToCell(row, col - 1);\n      } else if (e.key === 'ArrowRight') {\n        e.preventDefault();\n        moveFocusToCell(row, col + 1);\n      } else if (e.key === 'Enter' || e.key === ' ') {\n        e.preventDefault();\n        const history = getHistory();\n        if (history) history.beginAction('fill');\n        fillCell(row, col, selectedColor, !isPencilMode);\n        if (history) history.commitAction();\n        updatePencilActionsVisibility();\n      } else if (e.key === 'x' || e.key === 'X') {\n        // X key marks cell as empty\n        e.preventDefault();\n        e.stopPropagation(); // Prevent global handler from selecting eraser\n        const history = getHistory();\n        if (history) history.beginAction('fill');\n        fillCell(row, col, 0, !isPencilMode);\n        if (history) history.commitAction();\n        updatePencilActionsVisibility();\n      }\n    };\n  }\n\n  // === Drag Helpers (shared between mouse and touch handlers) ===\n\n  /**\n   * Begin a drag operation - sets up state and fills the initial cell\n   * @param {number} row - Cell row\n   * @param {number} col - Cell column\n   * @param {boolean} isEraser - Whether to use eraser (X mark) instead of selected color\n   */\n  function beginDrag(row, col, isEraser = false) {\n    const history = getHistory();\n    if (history) history.beginAction('fill');\n\n    isDragging = true;\n    dragColor = isEraser ? 0 : selectedColor;\n    dragCertain = !isPencilMode;\n    fillCell(row, col, dragColor, dragCertain);\n\n    // Capture actual value after toggle logic for consistent drag\n    const cellAfterFill = getCell(row, col);\n    dragColor = cellAfterFill.value;\n    dragCertain = cellAfterFill.certain;\n  }\n\n  /**\n   * End a drag operation - commits or cancels the history action\n   * @param {boolean} commit - Whether to commit (true) or cancel (false) the action\n   */\n  function endDrag(commit = true) {\n    if (!isDragging) return;\n\n    isDragging = false;\n    dragColor = null;\n\n    const history = getHistory();\n    if (history) {\n      if (commit) {\n        history.commitAction();\n      } else {\n        history.cancelAction();\n      }\n    }\n\n    updatePencilActionsVisibility();\n  }\n\n  /**\n   * Attach mouse event handlers for cell interaction\n   */\n  function attachCellMouseHandlers(cell, row, col) {\n    cell.onmousedown = (e) => {\n      e.preventDefault();\n      cell.focus(); // Explicitly focus since preventDefault blocks default focus\n      beginDrag(row, col, e.button === 2);\n    };\n\n    cell.onmouseenter = () => {\n      updateCrosshairHighlight(row, col);\n      if (isDragging) {\n        fillCell(row, col, dragColor, dragCertain, true); // skipToggle=true\n      }\n    };\n\n    cell.oncontextmenu = (e) => {\n      e.preventDefault();\n    };\n  }\n\n  /**\n   * Attach touch event handlers with long-press support\n   */\n  function attachCellTouchHandlers(cell, row, col) {\n    let longPressTimer = null;\n    let touchStartTime = 0;\n    let touchMoved = false;\n    let initialTouchRow = row;\n    let initialTouchCol = col;\n\n    cell.ontouchstart = (e) => {\n      // Don't prevent default here - let zoom handle multi-touch\n      if (e.touches.length > 1) return;\n\n      e.preventDefault();\n      e.stopPropagation(); // Prevent zoom container from starting pan\n      touchMoved = false;\n      touchStartTime = Date.now();\n      initialTouchRow = row;\n      initialTouchCol = col;\n\n      // Notify zoom system for tooltip (pass touch Y for positioning)\n      if (window.Cozy.Zoom) {\n        const touchY = e.touches[0]?.clientY ?? 0;\n        window.Cozy.Zoom.onCellTouchStart(row, col, touchY);\n      }\n\n      const history = getHistory();\n      if (history) history.beginAction('fill');\n\n      isDragging = true;\n      dragColor = selectedColor;\n      dragCertain = !isPencilMode;\n\n      // Long press timer for X mark\n      longPressTimer = setTimeout(() => {\n        if (!touchMoved) {\n          // Switch to X mode\n          dragColor = 0;\n          fillCell(initialTouchRow, initialTouchCol, 0, dragCertain);\n          // Capture actual value after fill for consistent drag\n          const cellAfterFill = getCell(initialTouchRow, initialTouchCol);\n          dragColor = cellAfterFill.value;\n          dragCertain = cellAfterFill.certain;\n          // Haptic feedback for long-press\n          if (window.Cozy.App) window.Cozy.App.vibrate(50);\n        }\n      }, CONFIG.LONG_PRESS_DELAY);\n\n      // Immediate fill with color (will be undone if long-press triggers)\n      fillCell(row, col, dragColor, dragCertain);\n      // Capture actual value after toggle logic for consistent drag\n      const cellAfterFill = getCell(row, col);\n      dragColor = cellAfterFill.value;\n      dragCertain = cellAfterFill.certain;\n    };\n\n    cell.ontouchmove = (e) => {\n      if (e.touches.length > 1) return;\n      if (!isDragging) return;\n\n      e.preventDefault();\n      e.stopPropagation(); // Prevent zoom container from interfering\n      touchMoved = true;\n      clearTimeout(longPressTimer);\n\n      // Handle drag-to-fill\n      const touch = e.touches[0];\n      const target = document.elementFromPoint(touch.clientX, touch.clientY);\n      if (target && target.classList.contains('cell')) {\n        const r = parseInt(target.dataset.row);\n        const c = parseInt(target.dataset.col);\n        if (!isNaN(r) && !isNaN(c)) {\n          fillCell(r, c, dragColor, dragCertain, true); // skipToggle=true\n          // Notify zoom system for tooltip update\n          if (window.Cozy.Zoom) {\n            window.Cozy.Zoom.onCellTouchMove(r, c);\n          }\n        }\n      }\n    };\n\n    cell.ontouchend = () => {\n      clearTimeout(longPressTimer);\n      endDrag(true);\n\n      // Notify zoom system to hide tooltip\n      if (window.Cozy.Zoom) {\n        window.Cozy.Zoom.onCellTouchEnd();\n      }\n    };\n\n    cell.ontouchcancel = () => {\n      clearTimeout(longPressTimer);\n      endDrag(false);\n\n      // Notify zoom system to hide tooltip\n      if (window.Cozy.Zoom) {\n        window.Cozy.Zoom.onCellTouchEnd();\n      }\n    };\n  }\n\n  /**\n   * Build the interactive puzzle grid.\n   * Creates cell elements with mouse, touch, and keyboard event handlers.\n   * Sets up drag handling, crosshair highlighting, and focus management.\n   * Caches elements in cellElements[][] for fast visual updates.\n   *\n   * @param {Object} puzzle - Puzzle object with width, height\n   */\n  function buildGrid(puzzle) {\n    const gridEl = document.getElementById('grid');\n    gridEl.innerHTML = '';\n    gridEl.style.gridTemplateColumns = `repeat(${puzzle.width}, var(--cell-size))`;\n    gridEl.style.gridTemplateRows = `repeat(${puzzle.height}, var(--cell-size))`;\n\n    // Clean up previous event listeners to prevent memory leaks\n    if (gridMouseLeaveHandler) {\n      gridEl.removeEventListener('mouseleave', gridMouseLeaveHandler);\n    }\n    if (gridFocusOutHandler) {\n      gridEl.removeEventListener('focusout', gridFocusOutHandler);\n    }\n    if (mouseUpHandler) {\n      document.removeEventListener('mouseup', mouseUpHandler);\n    }\n\n    // Initialize cell element cache\n    cellElements = [];\n    for (let r = 0; r < puzzle.height; r++) {\n      cellElements[r] = [];\n    }\n\n    // Clear highlight when leaving grid (mouse)\n    gridMouseLeaveHandler = () => clearCrosshairHighlight();\n    gridEl.addEventListener('mouseleave', gridMouseLeaveHandler);\n\n    // Clear highlight when focus leaves grid (keyboard)\n    gridFocusOutHandler = (e) => {\n      // Only clear if focus is leaving the grid entirely\n      if (!gridEl.contains(e.relatedTarget)) {\n        clearCrosshairHighlight();\n      }\n    };\n    gridEl.addEventListener('focusout', gridFocusOutHandler);\n\n    for (let row = 0; row < puzzle.height; row++) {\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = createGridCell(row, col);\n        attachCellFocusHandlers(cell, row, col);\n        attachCellKeyboardHandlers(cell, row, col);\n        attachCellMouseHandlers(cell, row, col);\n        attachCellTouchHandlers(cell, row, col);\n\n        // Cache the cell element for fast lookup\n        cellElements[row][col] = cell;\n        gridEl.appendChild(cell);\n      }\n    }\n\n    // Mouse up handler (for mouse-based drag)\n    mouseUpHandler = () => endDrag(true);\n    document.addEventListener('mouseup', mouseUpHandler);\n  }\n\n  /**\n   * Fill a cell with a color value, handling toggle logic and history.\n   *\n   * Toggle behavior (when skipToggle=false):\n   * - Tapping a pencil cell with same color in pen mode \u2192 converts to certain\n   * - Tapping a cell with same value/certainty \u2192 clears to empty\n   *\n   * Records changes to history for undo. Updates visual and clue satisfaction.\n   *\n   * @param {number} row - Row index\n   * @param {number} col - Column index\n   * @param {number|null} newValue - Color value (0=X, 1+=color, null=empty)\n   * @param {boolean} newCertain - Whether mark is certain (pen) or uncertain (pencil)\n   * @param {boolean} [skipToggle=false] - Skip toggle logic (used during drag)\n   */\n  function fillCell(row, col, newValue, newCertain, skipToggle) {\n    const puzzle = getPuzzles()[currentPuzzle];\n    const currentCell = getCell(row, col);\n    const history = getHistory();\n\n    // Determine final state based on current state and action\n    let finalValue = newValue;\n    let finalCertain = newCertain;\n\n    // Skip toggle logic during drag operations\n    if (!skipToggle) {\n      // Special case: tapping a maybe cell in pen mode with same color converts to certain\n      if (newCertain && !currentCell.certain &&\n          currentCell.value === newValue && newValue !== null) {\n        finalValue = currentCell.value;\n        finalCertain = true;\n      }\n      // Special case: tapping same state toggles to blank\n      else if (currentCell.value === newValue &&\n               currentCell.certain === newCertain &&\n               newValue !== null) {\n        finalValue = null;\n        finalCertain = true;\n      }\n    }\n\n    // Skip if no change\n    if (currentCell.value === finalValue && currentCell.certain === finalCertain) {\n      return;\n    }\n\n    // Record change for undo\n    if (history) {\n      history.recordChange(row, col, currentCell, { value: finalValue, certain: finalCertain });\n    }\n\n    // Apply change\n    setCellDirect(row, col, finalValue, finalCertain);\n    updateCellVisual(row, col, puzzle);\n\n    // Light haptic on fill\n    if (window.Cozy.App) window.Cozy.App.vibrate(10);\n\n    updateClueSatisfaction(puzzle);\n    updateHoldButtonStates();\n    checkWin(puzzle);\n    saveSession();\n  }\n\n  function updateCellVisual(row, col, puzzle) {\n    // Use cached element for performance\n    const cellEl = cellElements[row]?.[col];\n    if (!cellEl) return;\n\n    const cell = getCell(row, col);\n\n    // Clear previous classes and styles\n    cellEl.classList.remove('marked-empty', 'maybe-empty', 'maybe-color');\n    cellEl.style.background = '';\n    cellEl.style.setProperty('--cell-color', '');\n    cellEl.style.setProperty('--fold-outline-color', '');\n\n    if (cell.value === null) {\n      // Blank cell\n      cellEl.style.background = 'var(--color-cell)';\n    }\n    else if (cell.value === 0) {\n      // X mark\n      if (cell.certain) {\n        cellEl.classList.add('marked-empty');\n      } else {\n        cellEl.classList.add('maybe-empty');\n      }\n    }\n    else {\n      // Color\n      const colorRgb = puzzle.color_map[cell.value];\n      if (colorRgb) {\n        const colorStr = `rgb(${colorRgb[0]}, ${colorRgb[1]}, ${colorRgb[2]})`;\n\n        if (cell.certain) {\n          cellEl.style.background = colorStr;\n        } else {\n          cellEl.classList.add('maybe-color');\n          cellEl.style.setProperty('--cell-color', colorStr);\n          // Set fold outline color based on cell brightness for visibility\n          const brightness = getBrightness(colorRgb);\n          const outlineColor = brightness > CONFIG.BRIGHTNESS_MIDPOINT\n            ? 'rgba(0, 0, 0, 0.6)'\n            : 'rgba(255, 255, 255, 0.7)';\n          cellEl.style.setProperty('--fold-outline-color', outlineColor);\n        }\n      }\n    }\n\n    // Update aria-label with cell state for screen readers\n    let stateDesc;\n    if (cell.value === null) {\n      stateDesc = 'empty';\n    } else if (cell.value === 0) {\n      stateDesc = cell.certain ? 'marked empty' : 'maybe empty';\n    } else {\n      stateDesc = cell.certain ? `color ${cell.value}` : `maybe color ${cell.value}`;\n    }\n    cellEl.setAttribute('aria-label', `Row ${row + 1}, Column ${col + 1}, ${stateDesc}`);\n  }\n\n  /**\n   * Extract consecutive color runs from a line of cell values.\n   * A \"run\" is a sequence of consecutive cells with the same non-zero color.\n   * Empty cells (0) act as separators between runs.\n   *\n   * Example: [0, 1, 1, 0, 2, 2, 2, 0] \u2192 [{count: 2, color: 1}, {count: 3, color: 2}]\n   *\n   * @param {number[]} values - Array of cell values (0 = empty, 1+ = color)\n   * @returns {Array<{count: number, color: number}>} Array of run objects\n   */\n  function extractRuns(values) {\n    const runs = [];\n    let currentColor = null;\n    let currentCount = 0;\n\n    for (const value of values) {\n      if (value > 0) {\n        if (value === currentColor) {\n          currentCount++;\n        } else {\n          if (currentColor !== null) {\n            runs.push({ count: currentCount, color: currentColor });\n          }\n          currentColor = value;\n          currentCount = 1;\n        }\n      } else {\n        if (currentColor !== null) {\n          runs.push({ count: currentCount, color: currentColor });\n          currentColor = null;\n          currentCount = 0;\n        }\n      }\n    }\n\n    if (currentColor !== null) {\n      runs.push({ count: currentCount, color: currentColor });\n    }\n\n    return runs;\n  }\n\n  /**\n   * Check if extracted runs exactly match the expected clues.\n   * Both count and color must match for each run, in order.\n   *\n   * @param {Array<{count: number, color: number}>} runs - Extracted runs from grid\n   * @param {Array<{count: number, color: number}>} clues - Expected clues for the line\n   * @returns {boolean} True if runs match clues exactly\n   */\n  function runsMatchClues(runs, clues) {\n    if (runs.length !== clues.length) return false;\n    for (let i = 0; i < runs.length; i++) {\n      if (runs[i].count !== clues[i].count || runs[i].color !== clues[i].color) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  /**\n   * Update visual styling of row/column clues based on satisfaction.\n   * A line is \"satisfied\" when its certain cells form runs that exactly match\n   * the expected clues. Uncertain (pencil) cells prevent satisfaction.\n   *\n   * Adds/removes 'satisfied' class on clue elements for CSS styling\n   * (dimming and strikethrough effect).\n   *\n   * @param {Object} puzzle - Current puzzle object\n   */\n  function updateClueSatisfaction(puzzle) {\n    // Check each row\n    for (let row = 0; row < puzzle.height; row++) {\n      const rowValues = [];\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = getCell(row, col);\n        // Only count certain cells for satisfaction check\n        if (!cell.certain) {\n          rowValues.push(-1); // Mark as uncertain\n        } else {\n          rowValues.push(cell.value === null ? 0 : cell.value);\n        }\n      }\n\n      // Check if row has any uncertain cells\n      const hasUncertain = rowValues.includes(-1);\n      const cleanValues = rowValues.map(v => v === -1 ? 0 : v);\n      const runs = extractRuns(cleanValues);\n      const isSatisfied = !hasUncertain && runsMatchClues(runs, puzzle.row_clues[row]);\n\n      // Use cached element for performance\n      const rowClueEl = rowClueElements[row];\n      if (rowClueEl) {\n        rowClueEl.classList.toggle('satisfied', isSatisfied);\n      }\n\n      // Announce state changes for screen readers\n      if (isSatisfied !== rowSatisfied[row]) {\n        rowSatisfied[row] = isSatisfied;\n        if (isSatisfied) {\n          announce(`Row ${row + 1} complete`);\n        } else {\n          announce(`Row ${row + 1} incomplete`);\n        }\n      }\n    }\n\n    // Check each column\n    for (let col = 0; col < puzzle.width; col++) {\n      const colValues = [];\n      for (let row = 0; row < puzzle.height; row++) {\n        const cell = getCell(row, col);\n        if (!cell.certain) {\n          colValues.push(-1);\n        } else {\n          colValues.push(cell.value === null ? 0 : cell.value);\n        }\n      }\n\n      const hasUncertain = colValues.includes(-1);\n      const cleanValues = colValues.map(v => v === -1 ? 0 : v);\n      const runs = extractRuns(cleanValues);\n      const isSatisfied = !hasUncertain && runsMatchClues(runs, puzzle.col_clues[col]);\n\n      // Use cached element for performance\n      const colClueEl = colClueElements[col];\n      if (colClueEl) {\n        colClueEl.classList.toggle('satisfied', isSatisfied);\n      }\n\n      // Announce state changes for screen readers\n      if (isSatisfied !== colSatisfied[col]) {\n        colSatisfied[col] = isSatisfied;\n        if (isSatisfied) {\n          announce(`Column ${col + 1} complete`);\n        } else {\n          announce(`Column ${col + 1} incomplete`);\n        }\n      }\n    }\n  }\n\n  /**\n   * Check if the puzzle is solved and trigger victory if so.\n   *\n   * Win condition: All rows AND columns have runs that exactly match their clues,\n   * AND no cells are uncertain (pencil marks). This is clue-based validation,\n   * not solution comparison - allows winning without explicitly marking empty cells.\n   *\n   * If won: records completion, clears session, shows victory screen.\n   *\n   * @param {Object} puzzle - Current puzzle object\n   */\n  function checkWin(puzzle) {\n    // Check for any uncertain (pencil) cells first\n    for (let row = 0; row < puzzle.height; row++) {\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = getCell(row, col);\n        if (!cell.certain) return;\n      }\n    }\n\n    // Check each row's clues are satisfied\n    for (let row = 0; row < puzzle.height; row++) {\n      const rowValues = [];\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = getCell(row, col);\n        rowValues.push(cell.value === null ? 0 : cell.value);\n      }\n      const runs = extractRuns(rowValues);\n      if (!runsMatchClues(runs, puzzle.row_clues[row])) return;\n    }\n\n    // Check each column's clues are satisfied\n    for (let col = 0; col < puzzle.width; col++) {\n      const colValues = [];\n      for (let row = 0; row < puzzle.height; row++) {\n        const cell = getCell(row, col);\n        colValues.push(cell.value === null ? 0 : cell.value);\n      }\n      const runs = extractRuns(colValues);\n      if (!runsMatchClues(runs, puzzle.col_clues[col])) return;\n    }\n\n    // Puzzle completed!\n    announce('Puzzle complete!');\n\n    // Success haptic\n    if (window.Cozy.App) window.Cozy.App.vibrate([50, 100, 50]);\n\n    // Record completion\n    const storage = getStorage();\n    if (storage) {\n      const puzzleId = getPuzzleId(puzzle);\n      storage.completePuzzle(puzzleId);\n      clearSession();\n      updateDropdown();\n      // Refresh collection to show completion\n      const collection = window.Cozy.Collection;\n      if (collection) collection.refresh();\n    }\n\n    // Clear history after win\n    const history = getHistory();\n    if (history) history.clear();\n\n    // Show victory screen\n    showVictory(puzzle);\n  }\n\n  /**\n   * Reset the current puzzle to its initial empty state.\n   * Clears all cells and records the action for undo. Requires hold-to-confirm.\n   */\n  function resetPuzzle() {\n    const puzzle = getPuzzles()[currentPuzzle];\n    if (!puzzle) return;\n\n    const history = getHistory();\n    const changes = [];\n\n    // Record all non-blank cells for undo and clear them\n    for (let row = 0; row < puzzle.height; row++) {\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = getCell(row, col);\n        if (cell.value !== null) {\n          changes.push({\n            row, col,\n            before: { value: cell.value, certain: cell.certain },\n            after: { value: null, certain: true }\n          });\n          // Clear the cell\n          cell.value = null;\n          cell.certain = true;\n          updateCellVisual(row, col, puzzle);\n        }\n      }\n    }\n\n    // Only record to history if there were changes\n    if (changes.length > 0) {\n      if (history) {\n        history.recordBatchAction('reset', changes);\n      }\n\n      // Update clue satisfaction\n      updateClueSatisfaction(puzzle);\n\n      // Clear saved grid in storage\n      const storage = getStorage();\n      if (storage) {\n        const puzzleId = getPuzzleId(puzzle);\n        storage.savePuzzleGrid(puzzleId, null);\n      }\n\n      // Update pencil actions visibility\n      updatePencilActionsVisibility();\n    }\n\n    // Always update button states (even if no changes, puzzle could be empty now)\n    updateHoldButtonStates();\n  }\n\n  /**\n   * Reveal the puzzle solution.\n   * Fills all cells with correct values. Recorded for undo. Requires hold-to-confirm.\n   * Does NOT trigger win - player didn't solve it themselves.\n   */\n  function showSolution() {\n    const puzzle = getPuzzles()[currentPuzzle];\n    if (!puzzle) return;\n\n    // Zoom to fit to show full solution\n    if (window.Cozy.Zoom) {\n      window.Cozy.Zoom.zoomToFit();\n    }\n\n    const history = getHistory();\n    const changes = [];\n\n    // Record all cell changes for undo\n    for (let row = 0; row < puzzle.height; row++) {\n      for (let col = 0; col < puzzle.width; col++) {\n        const cell = getCell(row, col);\n        const solutionValue = puzzle.solution[row][col];\n\n        // Only record if the cell is different from solution\n        if (cell.value !== solutionValue || !cell.certain) {\n          changes.push({\n            row, col,\n            before: { value: cell.value, certain: cell.certain },\n            after: { value: solutionValue, certain: true }\n          });\n        }\n\n        // Apply solution\n        cell.value = solutionValue;\n        cell.certain = true;\n        updateCellVisual(row, col, puzzle);\n      }\n    }\n\n    // Record to history if there were changes\n    if (changes.length > 0 && history) {\n      history.recordBatchAction('solution', changes);\n    }\n\n    // Update clue satisfaction\n    updateClueSatisfaction(puzzle);\n\n    showToast('Solution revealed', 'info');\n    updatePencilActionsVisibility();\n    updateHoldButtonStates();\n  }\n\n  // === Keyboard Shortcuts ===\n\n  function setupKeyboardShortcuts() {\n    document.addEventListener('keydown', (e) => {\n      // Ignore if typing in an input\n      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;\n\n      // Ctrl+Z / Cmd+Z = Undo\n      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {\n        e.preventDefault();\n        performUndo();\n      }\n      // Ctrl+Shift+Z / Cmd+Shift+Z = Redo\n      // Ctrl+Y = Redo (Windows)\n      if (((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') ||\n          ((e.ctrlKey || e.metaKey) && e.key === 'y')) {\n        e.preventDefault();\n        performRedo();\n      }\n      // P = Toggle pencil mode\n      if (e.key === 'p' && !e.ctrlKey && !e.metaKey) {\n        e.preventDefault();\n        togglePencilMode();\n      }\n      // Number keys 1-9 = Select color\n      if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.metaKey) {\n        const colorIndex = parseInt(e.key);\n        const puzzle = getPuzzles()[currentPuzzle];\n        const colorIds = Object.keys(puzzle.color_map).map(Number);\n        if (colorIndex <= colorIds.length) {\n          selectColor(colorIds[colorIndex - 1]);\n        }\n      }\n      // 0 or X = Select eraser\n      if ((e.key === '0' || e.key === 'x') && !e.ctrlKey && !e.metaKey) {\n        selectColor(0);\n      }\n      // Escape = Go back to collection (only on puzzle screen, not when modal is open)\n      if (e.key === 'Escape' && !e.ctrlKey && !e.metaKey) {\n        const helpModal = document.getElementById('help-modal');\n        const isHelpModalOpen = helpModal?.classList.contains('visible');\n        const isOnPuzzleScreen = window.Cozy.Screens?.getCurrentScreen() === window.Cozy.Screens?.SCREENS?.PUZZLE;\n\n        if (isOnPuzzleScreen && !isHelpModalOpen) {\n          e.preventDefault();\n          showCollection();\n        }\n      }\n    });\n  }\n\n  // === Navigation (Screen Manager Integration) ===\n\n  function saveCurrentPuzzle() {\n    const puzzles = getPuzzles();\n    const storage = getStorage();\n    if (grid.length > 0 && puzzles[currentPuzzle] && storage) {\n      const puzzleId = getPuzzleId(puzzles[currentPuzzle]);\n      storage.savePuzzleGrid(puzzleId, grid);\n    }\n  }\n\n  /**\n   * Navigate to the collection screen.\n   * Saves current puzzle progress before navigating.\n   */\n  function showCollection() {\n    saveCurrentPuzzle();\n    if (window.Cozy.Screens) {\n      window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION);\n    }\n  }\n\n  /**\n   * Navigate to the puzzle screen for a specific puzzle.\n   * @param {number} puzzleIndex - Index of the puzzle to show\n   */\n  function showGame(puzzleIndex) {\n    if (window.Cozy.Screens) {\n      window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE, { puzzleId: puzzleIndex });\n    }\n  }\n\n  // Handle screen:puzzle event from ScreenManager\n  function handlePuzzleScreen(event) {\n    const data = event.detail || {};\n\n    // Load specific puzzle by ID or index\n    const puzzles = getPuzzles();\n    let puzzleIndex = 0;\n\n    if (data.puzzleId !== undefined) {\n      puzzleIndex = data.puzzleId;\n\n      // If puzzleId is a string, find the matching puzzle\n      if (typeof data.puzzleId === 'string') {\n        puzzleIndex = puzzles.findIndex(p => getPuzzleId(p) === data.puzzleId);\n        if (puzzleIndex === -1) puzzleIndex = 0;\n      }\n    }\n\n    // Always reload puzzle when entering screen (ensures fresh state from storage)\n    loadPuzzle(puzzleIndex);\n  }\n\n  // Handle screen:collection event from ScreenManager\n  function handleCollectionScreen(event) {\n    saveCurrentPuzzle();\n\n    const data = event.detail || {};\n    const collection = window.Cozy.Collection;\n\n    if (collection) {\n      // If animating stamp, render with blank placeholder for target\n      if (data.animateStamp && data.scrollToPuzzleId) {\n        collection.refresh({ blankPuzzleId: data.scrollToPuzzleId });\n      } else {\n        collection.refresh();\n      }\n\n      // Scroll to specific puzzle if requested (e.g., after victory)\n      if (data.scrollToPuzzleId) {\n        // Small delay to ensure DOM is updated after refresh\n        setTimeout(() => {\n          collection.scrollToPuzzle(data.scrollToPuzzleId, {\n            instant: data.quickAnimation\n          });\n\n          // If animating, fly the stamp to the target\n          if (data.animateStamp && data.flyingStamp) {\n            collection.animateStampTo(data.scrollToPuzzleId, data.flyingStamp, {\n              quick: data.quickAnimation\n            });\n          }\n        }, 50);\n      }\n    }\n  }\n\n  // Show victory screen instead of just updating status\n  function showVictory(puzzle) {\n    if (window.Cozy.Screens) {\n      const puzzleId = getPuzzleId(puzzle);\n      const match = puzzle.title.match(/^(.+?)\\s*\\(/);\n      const puzzleName = match ? match[1].trim() : puzzle.title;\n\n      window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.VICTORY, {\n        puzzleId: puzzleId,\n        puzzleName: puzzleName,\n        solution: puzzle.solution,\n        palette: puzzle.color_map\n      });\n    }\n  }\n\n  function updateCurrentPuzzleTitle() {\n    const titleEl = document.getElementById('current-puzzle-title');\n    if (!titleEl) return;\n\n    const puzzles = getPuzzles();\n    const puzzle = puzzles[currentPuzzle];\n    if (puzzle) {\n      // Parse name from title (e.g., \"Dandelion 2 (5x7, easy)\" -> \"Dandelion 2\")\n      const match = puzzle.title.match(/^(.+?)\\s*\\(/);\n      titleEl.textContent = match ? match[1].trim() : puzzle.title;\n    }\n  }\n\n  // === Initialization ===\n\n  // Hold-to-confirm button pattern\n  const HOLD_DURATION = 1200; // ms\n\n  /**\n   * Set up a \"hold to confirm\" button for destructive actions.\n   * User must hold the button for HOLD_DURATION ms to trigger the action.\n   * Provides visual feedback via CSS 'holding' class during hold.\n   *\n   * Supports mouse, touch, and keyboard (Enter/Space) interactions.\n   * Cancels if user releases early or moves away from button.\n   *\n   * @param {HTMLElement} btn - Button element to enhance\n   * @param {Function} onConfirm - Callback when hold completes successfully\n   */\n  function setupHoldButton(btn, onConfirm) {\n    if (!btn) return;\n\n    let holdTimer = null;\n    let isHolding = false;\n\n    function startHold(e) {\n      // Prevent default to avoid text selection on mobile\n      if (e.type === 'touchstart') {\n        e.preventDefault();\n      }\n\n      // Don't start hold if button is disabled\n      if (btn.disabled) return;\n\n      if (isHolding) return;\n      isHolding = true;\n      btn.classList.add('holding');\n\n      // Announce for screen readers\n      announce('Holding, keep holding to confirm');\n\n      holdTimer = setTimeout(() => {\n        if (isHolding) {\n          // Mark as completed for instant hide (no animation)\n          btn.classList.add('hold-complete');\n          cancelHold();\n          announce('Confirmed');\n          onConfirm();\n          // Remove completed class after a tick\n          setTimeout(() => btn.classList.remove('hold-complete'), 50);\n        }\n      }, HOLD_DURATION);\n    }\n\n    function cancelHold() {\n      isHolding = false;\n      btn.classList.remove('holding');\n      if (holdTimer) {\n        clearTimeout(holdTimer);\n        holdTimer = null;\n      }\n    }\n\n    // Mouse events\n    btn.addEventListener('mousedown', startHold);\n    btn.addEventListener('mouseup', cancelHold);\n    btn.addEventListener('mouseleave', cancelHold);\n\n    // Touch events\n    btn.addEventListener('touchstart', startHold, { passive: false });\n    btn.addEventListener('touchend', cancelHold);\n    btn.addEventListener('touchcancel', cancelHold);\n\n    // Keyboard events (Enter/Space)\n    btn.addEventListener('keydown', (e) => {\n      if (e.key === 'Enter' || e.key === ' ') {\n        e.preventDefault();\n        startHold(e);\n      }\n    });\n    btn.addEventListener('keyup', (e) => {\n      if (e.key === 'Enter' || e.key === ' ') {\n        cancelHold();\n      }\n    });\n    btn.addEventListener('blur', cancelHold);\n\n    // Set CSS variable for animation duration\n    btn.style.setProperty('--hold-duration', `${HOLD_DURATION}ms`);\n  }\n\n  // Setup button event listeners (replaces inline onclick handlers for CSP compliance)\n  function setupButtonListeners() {\n    // Mode menu buttons\n    const penModeBtn = document.getElementById('pen-mode-btn');\n    const pencilModeBtn = document.getElementById('pencil-mode-btn');\n    const undoBtn = document.getElementById('undo-btn');\n    const redoBtn = document.getElementById('redo-btn');\n\n    if (penModeBtn) {\n      penModeBtn.addEventListener('click', () => setPencilMode(false));\n    }\n    if (pencilModeBtn) {\n      pencilModeBtn.addEventListener('click', () => setPencilMode(true));\n    }\n    if (undoBtn) {\n      undoBtn.addEventListener('click', performUndo);\n    }\n    if (redoBtn) {\n      redoBtn.addEventListener('click', performRedo);\n    }\n\n    // Pencil action buttons (in mode menu)\n    const clearPencilBtn = document.getElementById('clear-pencil-btn');\n    const confirmPencilBtn = document.getElementById('confirm-pencil-btn');\n\n    if (clearPencilBtn) {\n      clearPencilBtn.addEventListener('click', () => {\n        clearAllPencilMarks();\n        closeModeMenu();\n      });\n    }\n    if (confirmPencilBtn) {\n      confirmPencilBtn.addEventListener('click', () => {\n        confirmAllPencilMarks();\n        closeModeMenu();\n      });\n    }\n\n    // Hold-to-confirm buttons (Reset, Solution)\n    const resetBtn = document.getElementById('reset-btn');\n    const solutionBtn = document.getElementById('solution-btn');\n    setupHoldButton(resetBtn, resetPuzzle);\n    setupHoldButton(solutionBtn, showSolution);\n\n    // Back button on puzzle screen\n    const puzzleBackBtn = document.querySelector('#screen-puzzle .header-back-btn');\n    if (puzzleBackBtn) {\n      puzzleBackBtn.addEventListener('click', navigateToCollectionWithStamp);\n    }\n\n    // Back button on collection screen (handled by ScreenManager)\n    const collectionBackBtn = document.querySelector('#screen-collection .header-back-btn');\n    if (collectionBackBtn) {\n      collectionBackBtn.addEventListener('click', () => {\n        if (window.Cozy.Screens) {\n          window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.HOME);\n        }\n      });\n    }\n  }\n\n  function init() {\n    setupKeyboardShortcuts();\n    setupButtonListeners();\n    setupHelpModal();\n    setupSkipLink();\n\n    // Initialize history UI\n    const history = getHistory();\n    if (history) history.updateUI();\n\n    // Initialize pencil mode UI\n    updatePencilModeUI();\n\n    // Listen for storage reset to clear in-memory grid\n    const storage = getStorage();\n    if (storage && storage.onChange) {\n      storage.onChange((event) => {\n        if (event === 'reset') {\n          // Clear in-memory grid when storage is reset\n          grid = [];\n          currentPuzzle = 0;\n        }\n      });\n    }\n\n    // Initialize collection screen\n    const collection = window.Cozy.Collection;\n    const puzzles = getPuzzles();\n\n    if (collection && puzzles.length > 0) {\n      collection.init('collection-screen', puzzles, (index) => {\n        // Navigate to puzzle via ScreenManager\n        if (window.Cozy.Screens) {\n          window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE, { puzzleId: index });\n        }\n      });\n    }\n\n    // Listen for screen events from ScreenManager\n    window.addEventListener('screen:puzzle', handlePuzzleScreen);\n    window.addEventListener('screen:collection', handleCollectionScreen);\n\n    // Pre-load first puzzle in background (will be shown when puzzle screen activates)\n    if (puzzles.length > 0) {\n      loadPuzzle(0);\n    }\n  }\n\n  // Render current grid state to a canvas for stamp animation\n  function renderGridToCanvas() {\n    const puzzles = getPuzzles();\n    const puzzle = puzzles[currentPuzzle];\n    if (!puzzle || grid.length === 0) return null;\n\n    // Check if there's any progress to show\n    let hasProgress = false;\n    for (let row = 0; row < puzzle.height && !hasProgress; row++) {\n      for (let col = 0; col < puzzle.width && !hasProgress; col++) {\n        const cell = getCell(row, col);\n        if (cell.value !== null && cell.value > 0) {\n          hasProgress = true;\n        }\n      }\n    }\n    if (!hasProgress) return null;\n\n    return renderOutlinedCanvas(\n      puzzle.width,\n      puzzle.height,\n      CONFIG.STAMP_CANVAS_SIZE,\n      (row, col) => {\n        const cell = getCell(row, col);\n        if (cell.value !== null && cell.value > 0) {\n          const color = puzzle.color_map[cell.value];\n          if (color) {\n            return color;\n          }\n        }\n        return null;\n      }\n    );\n  }\n\n  /**\n   * Navigate to collection screen with a flying stamp animation.\n   * Renders current grid progress to a canvas that animates from the grid\n   * to the puzzle's card in the collection. Used when pressing back button\n   * during puzzle play to give visual feedback of progress.\n   */\n  function navigateToCollectionWithStamp() {\n    const puzzles = getPuzzles();\n    const puzzle = puzzles[currentPuzzle];\n    if (!puzzle) {\n      showCollection();\n      return;\n    }\n\n    const puzzleId = getPuzzleId(puzzle);\n\n    // Try to render current progress to canvas\n    const progressCanvas = renderGridToCanvas();\n    if (!progressCanvas) {\n      // No progress to animate, just navigate\n      showCollection();\n      return;\n    }\n\n    // Get the grid element's position for the starting point\n    const gridEl = document.getElementById('grid');\n    if (!gridEl) {\n      showCollection();\n      return;\n    }\n\n    const startRect = gridEl.getBoundingClientRect();\n    const flyingStamp = createFlyingStamp(progressCanvas, startRect);\n\n    // Save and navigate to collection with animation\n    saveCurrentPuzzle();\n    if (window.Cozy.Screens) {\n      window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION, {\n        scrollToPuzzleId: puzzleId,\n        animateStamp: true,\n        flyingStamp: flyingStamp,\n        quickAnimation: true  // Flag for shorter delay\n      });\n    }\n  }\n\n  /**\n   * Clear all game state to initial values.\n   * Called when user resets all progress from settings. Clears grid,\n   * resets indices, and wipes undo history.\n   */\n  function clearAllState() {\n    grid = [];\n    currentPuzzle = 0;\n    selectedColor = 1;\n    isDragging = false;\n    dragColor = null;\n    isPencilMode = false;\n\n    const history = getHistory();\n    if (history) history.clear();\n  }\n\n  // === Zoom Integration API ===\n\n  /**\n   * Get clue information for a specific cell position\n   * @param {number} row - Row index\n   * @param {number} col - Column index\n   * @returns {Object|null} Object with rowClues and colClues arrays, each containing {count, color, satisfied}\n   */\n  function getClueInfo(row, col) {\n    const puzzles = getPuzzles();\n    const puzzle = puzzles[currentPuzzle];\n    if (!puzzle) return null;\n\n    // Get row clues with satisfaction status\n    const rowClueEl = rowClueElements[row];\n    const rowSatisfied = rowClueEl ? rowClueEl.classList.contains('satisfied') : false;\n    const rowClues = puzzle.row_clues[row].map(clue => ({\n      count: clue.count,\n      color: clue.color,\n      satisfied: rowSatisfied\n    }));\n\n    // Get column clues with satisfaction status\n    const colClueEl = colClueElements[col];\n    const colSatisfied = colClueEl ? colClueEl.classList.contains('satisfied') : false;\n    const colClues = puzzle.col_clues[col].map(clue => ({\n      count: clue.count,\n      color: clue.color,\n      satisfied: colSatisfied\n    }));\n\n    return { rowClues, colClues };\n  }\n\n  /**\n   * Get RGB color array for a color ID\n   * @param {number} colorId - Color ID (1-indexed)\n   * @returns {number[]|null} RGB array [r, g, b] or null if not found\n   */\n  function getColorRgb(colorId) {\n    const puzzles = getPuzzles();\n    const puzzle = puzzles[currentPuzzle];\n    if (!puzzle || !puzzle.color_map) return null;\n    return puzzle.color_map[colorId] || null;\n  }\n\n  /**\n   * Get the current puzzle object\n   * @returns {Object|null} Current puzzle or null\n   */\n  function getCurrentPuzzle() {\n    const puzzles = getPuzzles();\n    return puzzles[currentPuzzle] || null;\n  }\n\n  // Expose globally\n  window.Cozy.Garden = {\n    resetPuzzle: resetPuzzle,\n    showSolution: showSolution,\n    performUndo: performUndo,\n    performRedo: performRedo,\n    togglePencilMode: togglePencilMode,\n    setPencilMode: setPencilMode,\n    clearAllPencilMarks: clearAllPencilMarks,\n    confirmAllPencilMarks: confirmAllPencilMarks,\n    selectColor: selectColor,\n    showCollection: showCollection,\n    showGame: showGame,\n    clearAllState: clearAllState,\n    navigateToCollectionWithStamp: navigateToCollectionWithStamp,\n    getPuzzleId: getPuzzleId,  // Utility for generating consistent puzzle IDs\n    // Zoom integration API\n    getClueInfo: getClueInfo,\n    getColorRgb: getColorRgb,\n    getCurrentPuzzle: getCurrentPuzzle\n  };\n\n  // Auto-initialize\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', init);\n  } else {\n    init();\n  }\n})();\n\n\n// ============================================================\n// FILE: src/js/zoom.js\n// ============================================================\n\n// Cozy Garden - Zoom & Pan System\n// Provides pinch-to-zoom and pan for mobile puzzle interaction\n\n(function() {\n  'use strict';\n\n  // === Shared Utilities ===\n  const { CONFIG } = window.Cozy.Utils;\n\n  // === Constants ===\n  const ABSOLUTE_MIN_ZOOM = 0.35; // Absolute floor for zoom (safety)\n  const DEFAULT_ZOOM = 1.0;       // Starting zoom level\n  const FIT_ZOOM_BUFFER = 0.97;   // 3% buffer so fit isn't too tight\n  const DOUBLE_TAP_DELAY = 300;   // ms between taps for double-tap\n  const TOOLTIP_DISMISS_DELAY = 1500;  // ms after touch ends\n  const TOOLTIP_SHOW_DELAY = 100; // ms before showing tooltip\n  const PAN_THRESHOLD = 10;       // pixels of movement before pan commits\n  // Zoom hint flag now stored in CozyStorage.flags.zoomHintShown\n\n  // === State ===\n  let currentZoom = DEFAULT_ZOOM;\n  let baseZoom = DEFAULT_ZOOM;    // Zoom level at start of pinch gesture\n  let isPinching = false;\n  let pinchStartDistance = 0;\n  let lastTapTime = 0;\n  let lastTapTarget = null;\n  let tooltipDismissTimer = null;\n  let tooltipShowTimer = null;\n  let isTooltipLocked = false;      // Lock tooltip during drag\n  let currentTooltipRow = -1;\n  let currentTooltipCol = -1;\n  let initialized = false;\n\n  // === DOM References (cached on init) ===\n  let zoomContainer = null;\n  let boardWrapper = null;\n  let tooltip = null;\n  let tooltipRowClues = null;\n  let tooltipColClues = null;\n  let zoomInBtn = null;\n  let zoomOutBtn = null;\n  let zoomFitBtn = null;\n\n  // === Utility Functions ===\n\n  function clamp(value, min, max) {\n    return Math.min(Math.max(value, min), max);\n  }\n\n  function getDistance(touch1, touch2) {\n    const dx = touch1.clientX - touch2.clientX;\n    const dy = touch1.clientY - touch2.clientY;\n    return Math.sqrt(dx * dx + dy * dy);\n  }\n\n  function getMidpoint(touch1, touch2) {\n    return {\n      x: (touch1.clientX + touch2.clientX) / 2,\n      y: (touch1.clientY + touch2.clientY) / 2\n    };\n  }\n\n  function getBaseCellSize() {\n    // Get the base cell size from CSS (before zoom modifications)\n    const width = window.innerWidth;\n    if (width <= 360) return 20;\n    if (width >= 768) return 28;\n    if (width >= 1200) return 32;\n    return 24;\n  }\n\n  // === Zoom Application ===\n\n  function applyZoom(level, preserveCenter = true) {\n    const container = zoomContainer;\n    if (!container) return;\n\n    const oldZoom = currentZoom;\n    const effectiveMinZoom = getEffectiveMinZoom();\n    const newZoom = clamp(level, effectiveMinZoom, CONFIG.MAX_ZOOM);\n\n    // Calculate center point to preserve scroll position\n    let centerX, centerY;\n    if (preserveCenter && oldZoom !== newZoom) {\n      centerX = container.scrollLeft + container.clientWidth / 2;\n      centerY = container.scrollTop + container.clientHeight / 2;\n    }\n\n    currentZoom = newZoom;\n\n    // Calculate and apply new cell size\n    const baseCellSize = getBaseCellSize();\n    const newCellSize = Math.round(baseCellSize * newZoom);\n    document.documentElement.style.setProperty('--cell-size', `${newCellSize}px`);\n\n    // Update container overflow based on zoom state\n    // Enable scrolling when zoomed beyond fit (content larger than container)\n    const fitZoom = calculateFitZoom();\n    const isZoomed = newZoom > fitZoom + 0.01; // Small epsilon for float comparison\n    container.classList.toggle('is-zoomed', isZoomed);\n\n    // Update button states\n    updateZoomButtons();\n\n    // Restore scroll position to maintain center\n    if (preserveCenter && oldZoom !== newZoom && centerX !== undefined) {\n      requestAnimationFrame(() => {\n        const scale = newZoom / oldZoom;\n        const newScrollLeft = centerX * scale - container.clientWidth / 2;\n        const newScrollTop = centerY * scale - container.clientHeight / 2;\n        container.scrollLeft = Math.max(0, newScrollLeft);\n        container.scrollTop = Math.max(0, newScrollTop);\n      });\n    }\n\n    // Dispatch zoom change event\n    window.dispatchEvent(new CustomEvent('zoomchange', {\n      detail: { zoom: newZoom, oldZoom, isZoomed }\n    }));\n  }\n\n  function updateZoomButtons() {\n    const effectiveMinZoom = getEffectiveMinZoom();\n\n    if (zoomInBtn) {\n      zoomInBtn.disabled = currentZoom >= CONFIG.MAX_ZOOM;\n    }\n    if (zoomOutBtn) {\n      zoomOutBtn.disabled = currentZoom <= effectiveMinZoom;\n    }\n    if (zoomFitBtn) {\n      // Highlight fit button when not at fit zoom\n      const fitZoom = calculateFitZoom();\n      const isAtFit = Math.abs(currentZoom - fitZoom) < 0.05;\n      zoomFitBtn.classList.toggle('highlighted', !isAtFit && currentZoom !== fitZoom);\n    }\n  }\n\n  // === Auto-Fit Calculation ===\n\n  // Cache fit zoom per puzzle to avoid recalculation issues during zoom\n  let cachedFitZoom = null;\n  let cachedPuzzleId = null;\n\n  function calculateFitZoom(forceRecalculate = false) {\n    const container = zoomContainer;\n    if (!container || !window.Cozy.Garden?.getCurrentPuzzle) return DEFAULT_ZOOM;\n\n    const puzzle = window.Cozy.Garden.getCurrentPuzzle();\n    if (!puzzle) return DEFAULT_ZOOM;\n\n    // Use cached value if available for the same puzzle (prevents shrinking spiral)\n    const puzzleId = puzzle.title;\n    if (!forceRecalculate && cachedFitZoom !== null && cachedPuzzleId === puzzleId) {\n      return cachedFitZoom;\n    }\n\n    const baseCellSize = getBaseCellSize();\n\n    // Clue areas scale with cell size, so express them as multiples of cell size\n    const maxRowClues = Math.max(...puzzle.row_clues.map(r => r.length));\n    const maxColClues = Math.max(...puzzle.col_clues.map(c => c.length));\n\n    // Clue area in terms of cell-size units\n    // Row clues: each clue is ~0.6 cell widths, plus gap\n    // Col clues: each clue is ~0.6 cell heights, plus gap\n    const clueWidthUnits = Math.max(2, maxRowClues * 0.6 + 0.5);\n    const clueHeightUnits = Math.max(2, maxColClues * 0.6 + 0.5);\n\n    // Total board size in cell-size units (grid + clues + gap between them)\n    const totalWidthUnits = puzzle.width + clueWidthUnits + 0.25;\n    const totalHeightUnits = puzzle.height + clueHeightUnits + 0.25;\n\n    // Measure actual container dimensions\n    const availableWidth = container.clientWidth;\n    const availableHeight = container.clientHeight;\n\n    // Small padding for breathing room\n    const padding = 8;\n\n    // Calculate zoom needed to fit in each dimension\n    const fitZoomX = (availableWidth - padding * 2) / (totalWidthUnits * baseCellSize);\n    const fitZoomY = (availableHeight - padding * 2) / (totalHeightUnits * baseCellSize);\n\n    // Use the smaller of the two to ensure puzzle fits in both dimensions\n    const fitZoom = Math.min(fitZoomX, fitZoomY);\n\n    // Apply small buffer so fit isn't too tight, then clamp to valid range\n    const result = clamp(fitZoom * FIT_ZOOM_BUFFER, ABSOLUTE_MIN_ZOOM, CONFIG.MAX_ZOOM);\n\n    // Cache the result\n    cachedFitZoom = result;\n    cachedPuzzleId = puzzleId;\n\n    return result;\n  }\n\n  // Invalidate fit zoom cache (call on resize/orientation change)\n  function invalidateFitZoomCache() {\n    cachedFitZoom = null;\n    cachedPuzzleId = null;\n  }\n\n  // Get effective minimum zoom - capped at fit level so user can't zoom out past where puzzle fits\n  function getEffectiveMinZoom() {\n    const fitZoom = calculateFitZoom();\n    // Min zoom is the greater of: absolute floor, or fit zoom (can't zoom out past fit)\n    return Math.max(ABSOLUTE_MIN_ZOOM, fitZoom);\n  }\n\n  // Check if currently zoomed beyond fit (i.e., content larger than container)\n  function isZoomedBeyondFit() {\n    const fitZoom = calculateFitZoom();\n    return currentZoom > fitZoom + 0.01;\n  }\n\n  // === Gesture Handlers ===\n\n  function handleTouchStart(e) {\n    if (e.touches.length === 2) {\n      // Pinch start\n      isPinching = true;\n      pinchStartDistance = getDistance(e.touches[0], e.touches[1]);\n      baseZoom = currentZoom;\n      e.preventDefault();\n    }\n  }\n\n  function handleTouchMove(e) {\n    if (isPinching && e.touches.length === 2) {\n      const distance = getDistance(e.touches[0], e.touches[1]);\n      const scale = distance / pinchStartDistance;\n      const effectiveMinZoom = getEffectiveMinZoom();\n      const newZoom = clamp(baseZoom * scale, effectiveMinZoom, CONFIG.MAX_ZOOM);\n\n      // Apply zoom directly (cell-resize approach)\n      if (Math.abs(newZoom - currentZoom) > 0.05) {\n        applyZoom(newZoom, true);\n      }\n\n      e.preventDefault();\n    }\n  }\n\n  function handleTouchEnd(e) {\n    if (isPinching && e.touches.length < 2) {\n      isPinching = false;\n      // Pinch ended, zoom already applied\n    }\n\n    // Double-tap detection (only on non-cell areas)\n    if (e.touches.length === 0 && !isPinching) {\n      const target = e.target;\n      const isCell = target.classList.contains('cell');\n\n      if (!isCell) {\n        const now = Date.now();\n        if (lastTapTarget === target && now - lastTapTime < DOUBLE_TAP_DELAY) {\n          handleDoubleTap(e.changedTouches[0]);\n          lastTapTime = 0;\n          lastTapTarget = null;\n        } else {\n          lastTapTime = now;\n          lastTapTarget = target;\n        }\n      }\n    }\n  }\n\n  function handleDoubleTap(touch) {\n    if (isZoomedBeyondFit()) {\n      // Zoomed in \u2192 reset to fit\n      applyZoom(calculateFitZoom(), true);\n    } else {\n      // At fit \u2192 zoom to comfortable level\n      applyZoom(CONFIG.COMFORTABLE_ZOOM, true);\n    }\n  }\n\n  // === Wheel/Trackpad Zoom (Desktop) ===\n\n  function handleWheel(e) {\n    // Trackpad pinch on macOS and Ctrl+scroll both report as wheel events with ctrlKey\n    if (e.ctrlKey) {\n      e.preventDefault();\n\n      // deltaY > 0 means zoom out (scroll down / pinch out)\n      // deltaY < 0 means zoom in (scroll up / pinch in)\n      // Use smaller increments for smoother zoom\n      const zoomDelta = e.deltaY > 0 ? -0.15 : 0.15;\n      applyZoom(currentZoom + zoomDelta, true);\n    }\n  }\n\n  // === Tooltip Management ===\n\n  function showTooltip() {\n    if (!tooltip) return;\n    if (!isZoomedBeyondFit()) return; // Only show when zoomed beyond fit\n\n    tooltip.classList.add('visible');\n  }\n\n  function hideTooltip() {\n    if (!tooltip) return;\n    tooltip.classList.remove('visible');\n    currentTooltipRow = -1;\n    currentTooltipCol = -1;\n  }\n\n  function updateTooltipContent(row, col) {\n    if (!tooltip || isTooltipLocked) return;\n    if (row === currentTooltipRow && col === currentTooltipCol) return;\n\n    currentTooltipRow = row;\n    currentTooltipCol = col;\n\n    // Get clue info from game.js\n    const clueInfo = window.Cozy.Garden?.getClueInfo?.(row, col);\n    if (!clueInfo) return;\n\n    // Render row clues\n    if (tooltipRowClues) {\n      tooltipRowClues.innerHTML = renderClues(clueInfo.rowClues);\n    }\n\n    // Render column clues\n    if (tooltipColClues) {\n      tooltipColClues.innerHTML = renderClues(clueInfo.colClues);\n    }\n  }\n\n  function renderClues(clues) {\n    if (!clues || clues.length === 0) {\n      return '<span class=\"clue-tooltip-num satisfied\">0</span>';\n    }\n\n    return clues.map(clue => {\n      const color = window.Cozy.Garden?.getColorRgb?.(clue.color) || [128, 128, 128];\n      const isSatisfied = clue.satisfied;\n      const brightness = (color[0] * 299 + color[1] * 587 + color[2] * 114) / 1000;\n      const textColor = brightness > CONFIG.BRIGHTNESS_MIDPOINT ? '#333' : '#fff';\n\n      return `<span class=\"clue-tooltip-num${isSatisfied ? ' satisfied' : ''}\"\n                    style=\"background: rgb(${color.join(',')}); color: ${textColor}\">\n                ${clue.count}\n              </span>`;\n    }).join('');\n  }\n\n  function positionTooltip(touchY) {\n    if (!tooltip || !zoomContainer) return;\n\n    const containerRect = zoomContainer.getBoundingClientRect();\n    const containerMidpoint = containerRect.top + containerRect.height / 2;\n\n    if (touchY > containerMidpoint) {\n      // Touch in bottom half \u2192 show tooltip at TOP\n      tooltip.classList.add('position-top');\n      tooltip.classList.remove('position-bottom');\n    } else {\n      // Touch in top half \u2192 show tooltip at BOTTOM\n      tooltip.classList.remove('position-top');\n      tooltip.classList.add('position-bottom');\n    }\n  }\n\n  function startTooltipDismissTimer() {\n    clearTimeout(tooltipDismissTimer);\n    tooltipDismissTimer = setTimeout(() => {\n      hideTooltip();\n    }, TOOLTIP_DISMISS_DELAY);\n  }\n\n  function cancelTooltipDismissTimer() {\n    clearTimeout(tooltipDismissTimer);\n  }\n\n  // === Cell Touch Integration ===\n  // These are called from game.js cell handlers\n\n  function onCellTouchStart(row, col, touchY) {\n    if (!isZoomedBeyondFit()) return;\n\n    isTooltipLocked = false;\n    cancelTooltipDismissTimer();\n\n    // Delay showing tooltip slightly to avoid flicker on quick taps\n    clearTimeout(tooltipShowTimer);\n    tooltipShowTimer = setTimeout(() => {\n      updateTooltipContent(row, col);\n      positionTooltip(touchY);\n      showTooltip();\n    }, TOOLTIP_SHOW_DELAY);\n  }\n\n  function onCellTouchMove() {\n    if (!isZoomedBeyondFit()) return;\n\n    // Lock tooltip to initial cell during drag\n    isTooltipLocked = true;\n    tooltip?.classList.add('dragging');\n  }\n\n  function onCellTouchEnd() {\n    if (!isZoomedBeyondFit()) return;\n\n    clearTimeout(tooltipShowTimer);\n    isTooltipLocked = false;\n    tooltip?.classList.remove('dragging');\n    startTooltipDismissTimer();\n  }\n\n  // === Zoom Control Buttons ===\n\n  function setupZoomControls() {\n    zoomInBtn = document.querySelector('.zoom-btn.zoom-in');\n    zoomOutBtn = document.querySelector('.zoom-btn.zoom-out');\n    zoomFitBtn = document.querySelector('.zoom-btn.zoom-fit');\n\n    if (zoomInBtn) {\n      zoomInBtn.addEventListener('click', () => {\n        applyZoom(currentZoom + 0.5, true);\n      });\n    }\n\n    if (zoomOutBtn) {\n      zoomOutBtn.addEventListener('click', () => {\n        applyZoom(currentZoom - 0.5, true);\n      });\n    }\n\n    if (zoomFitBtn) {\n      zoomFitBtn.addEventListener('click', () => {\n        applyZoom(calculateFitZoom(), true);\n      });\n    }\n\n    updateZoomButtons();\n  }\n\n  // === Keyboard Shortcuts ===\n\n  function handleKeyDown(e) {\n    // Only handle when on puzzle screen\n    const puzzleScreen = document.getElementById('screen-puzzle');\n    if (!puzzleScreen || puzzleScreen.classList.contains('screen-hidden')) return;\n\n    if (e.key === '+' || e.key === '=') {\n      e.preventDefault();\n      applyZoom(currentZoom + 0.5, true);\n    } else if (e.key === '-' || e.key === '_') {\n      e.preventDefault();\n      applyZoom(currentZoom - 0.5, true);\n    } else if (e.key === '0') {\n      e.preventDefault();\n      applyZoom(calculateFitZoom(), true);\n    }\n  }\n\n  // === Resize/Orientation Handler ===\n\n  let resizeTimeout = null;\n\n  function handleResize() {\n    // Debounce resize events\n    clearTimeout(resizeTimeout);\n    resizeTimeout = setTimeout(() => {\n      // Only handle when on puzzle screen\n      const puzzleScreen = document.getElementById('screen-puzzle');\n      if (!puzzleScreen || puzzleScreen.classList.contains('screen-hidden')) return;\n\n      // Invalidate cache so fit zoom is recalculated with new dimensions\n      invalidateFitZoomCache();\n\n      const effectiveMinZoom = getEffectiveMinZoom();\n\n      // If current zoom is below the new effective minimum, snap to it\n      if (currentZoom < effectiveMinZoom) {\n        applyZoom(effectiveMinZoom, false);\n      }\n\n      // Update button states\n      updateZoomButtons();\n    }, 150);\n  }\n\n  // === First-Time Hint ===\n\n  function maybeShowZoomHint() {\n    const puzzle = window.Cozy.Garden?.getCurrentPuzzle?.();\n    if (!puzzle) return;\n\n    // Only show for large puzzles\n    if (puzzle.width <= CONFIG.AUTO_ZOOM_MIN_SIZE && puzzle.height <= CONFIG.AUTO_ZOOM_MIN_SIZE) return;\n\n    // Only show once\n    if (window.Cozy.Storage?.getFlag('zoomHintShown')) return;\n\n    // Show hint toast\n    showZoomHint();\n    window.Cozy.Storage?.setFlag('zoomHintShown', true);\n  }\n\n  function showZoomHint() {\n    // Create toast if it doesn't exist\n    let toast = document.getElementById('zoom-hint-toast');\n    if (!toast) {\n      toast = document.createElement('div');\n      toast.id = 'zoom-hint-toast';\n      toast.className = 'zoom-hint-toast';\n      toast.textContent = 'Tip: Pinch to zoom for easier tapping';\n      document.body.appendChild(toast);\n    }\n\n    // Show and auto-hide\n    toast.classList.add('visible');\n    setTimeout(() => {\n      toast.classList.remove('visible');\n    }, 4000);\n  }\n\n  // === Initialization ===\n\n  function init() {\n    if (initialized) return;\n\n    // Cache DOM references\n    zoomContainer = document.getElementById('zoom-container');\n    boardWrapper = zoomContainer?.querySelector('.board-wrapper');\n    tooltip = document.getElementById('clue-tooltip');\n    tooltipRowClues = document.getElementById('tooltip-row-clues');\n    tooltipColClues = document.getElementById('tooltip-col-clues');\n\n    if (!zoomContainer) {\n      console.warn('[Zoom] zoom-container not found, zoom disabled');\n      return;\n    }\n\n    // Set up gesture handlers on zoom container\n    zoomContainer.addEventListener('touchstart', handleTouchStart, { passive: false });\n    zoomContainer.addEventListener('touchmove', handleTouchMove, { passive: false });\n    zoomContainer.addEventListener('touchend', handleTouchEnd, { passive: true });\n\n    // Set up wheel handler for desktop trackpad pinch and Ctrl+scroll\n    zoomContainer.addEventListener('wheel', handleWheel, { passive: false });\n\n    // Set up zoom control buttons\n    setupZoomControls();\n\n    // Set up keyboard shortcuts\n    document.addEventListener('keydown', handleKeyDown);\n\n    // Handle resize/orientation changes\n    window.addEventListener('resize', handleResize);\n\n    initialized = true;\n    console.log('[Zoom] Initialized');\n  }\n\n  function initForPuzzle() {\n    // Called when a puzzle is loaded\n    // Invalidate cache so fit zoom is calculated fresh for this puzzle\n    invalidateFitZoomCache();\n\n    // Always start at fit zoom - the largest zoom where the entire puzzle fits\n    // This maximizes puzzle visibility while ensuring everything is on screen\n    const fitZoom = calculateFitZoom();\n    applyZoom(fitZoom, false);\n\n    // Maybe show first-time hint for large puzzles\n    setTimeout(maybeShowZoomHint, 500);\n  }\n\n  function destroy() {\n    // Reset zoom when leaving puzzle screen\n    resetZoom(false);\n    hideTooltip();\n    clearTimeout(tooltipDismissTimer);\n    clearTimeout(tooltipShowTimer);\n  }\n\n  function resetZoom(animate = true) {\n    const targetZoom = DEFAULT_ZOOM;\n    animateToZoom(targetZoom, animate);\n  }\n\n  function zoomToFit(animate = true) {\n    const targetZoom = calculateFitZoom();\n    animateToZoom(targetZoom, animate);\n  }\n\n  function animateToZoom(targetZoom, animate = true) {\n    if (animate && currentZoom !== targetZoom) {\n      const startZoom = currentZoom;\n      const duration = 200;\n      const startTime = performance.now();\n\n      function animateZoom(currentTime) {\n        const elapsed = currentTime - startTime;\n        const progress = Math.min(elapsed / duration, 1);\n        const eased = 1 - Math.pow(1 - progress, 3); // Ease out cubic\n\n        const zoom = startZoom + (targetZoom - startZoom) * eased;\n        applyZoom(zoom, false);\n\n        if (progress < 1) {\n          requestAnimationFrame(animateZoom);\n        }\n      }\n\n      requestAnimationFrame(animateZoom);\n    } else {\n      applyZoom(targetZoom, false);\n    }\n  }\n\n  // === Public API ===\n\n  window.Cozy.Zoom = {\n    init,\n    initForPuzzle,\n    destroy,\n    resetZoom,\n    zoomToFit,\n\n    getZoom: () => currentZoom,\n    setZoom: (level, animate = true) => applyZoom(level, !animate),\n    zoomIn: (increment = 0.5) => applyZoom(currentZoom + increment, true),\n    zoomOut: (increment = 0.5) => applyZoom(currentZoom - increment, true),\n    isZoomed: isZoomedBeyondFit,\n\n    // Cell touch integration (called from game.js)\n    onCellTouchStart,\n    onCellTouchMove,\n    onCellTouchEnd,\n\n    // Get effective min zoom for current puzzle\n    getEffectiveMinZoom\n    // Note: MAX_ZOOM and COMFORTABLE_ZOOM available via CozyUtils.CONFIG\n  };\n\n})();\n"],
  "mappings": "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",
  "names": ["CONFIG", "getPuzzleId", "puzzle", "getPuzzleTitle", "parsePuzzleTitle", "title", "match", "initOnce", "element", "event", "handler", "options", "createFlyingStamp", "sourceCanvas", "containerRect", "stamp", "canvasAspect", "containerAspect", "cssWidth", "cssHeight", "containerSize", "scale", "centerX", "centerY", "renderOutlinedCanvas", "width", "height", "targetSize", "getColorAt", "maxDim", "cellSize", "padding", "offset", "canvas", "ctx", "outlineColor", "row", "col", "px", "py", "color", "e", "STORAGE_KEY", "isValidStorageData", "data", "getDefaultData", "GameStorage", "stored", "parsed", "callback", "l", "puzzleId", "grid", "cell", "progress", "wasNew", "_a", "puzzleIndex", "difficulty", "savedGrid", "key", "value", "ms", "today", "lastPlay", "yesterday", "jsonString", "imported", "storage", "undoStack", "redoStack", "pendingAction", "History", "type", "before", "after", "existingChange", "c", "changes", "action", "undoBtn", "redoBtn", "SCREENS", "currentScreen", "screenHistory", "screenData", "screenElements", "confirmModalCallback", "showConfirmModal", "modal", "message", "confirmBtn", "cancelBtn", "showAlertModal", "hideConfirmModal", "initConfirmModal", "backdrop", "focusableElements", "firstEl", "lastEl", "init", "initTheme", "screenId", "screen", "handlePopState", "handleGlobalEscape", "showScreen", "confirmModal", "helpModal", "addToHistory", "targetScreen", "previousScreen", "onScreenEnter", "goBack", "initSplashScreen", "initHomeScreen", "initCollectionScreen", "initPuzzleScreen", "initVictoryScreen", "initSettingsScreen", "initTutorialScreen", "getScreenData", "getCurrentScreen", "cleanUrl", "session", "hasPlayedBefore", "playBtn", "settingsBtn", "progressEl", "puzzles", "totalPuzzles", "solvedCount", "searchInput", "victoryPuzzleId", "titleEl", "imageEl", "continueBtn", "renderVictoryImage", "victoryCanvas", "flyingStamp", "container", "solution", "palette", "colorIndex", "initThemeSelector", "themeOptions", "currentTheme", "option", "isActive", "theme", "opt", "applyTheme", "initResetProgressButton", "resetBtn", "_b", "initDebugSolveAll", "solveAllBtn", "backBtn", "vibrationToggle", "tutorialBtn", "tutorialCurrentStep", "skipBtn", "nextBtn", "steps", "dots", "showStep", "index", "step", "i", "dot", "completeTutorial", "themeColorMeta", "savedTheme", "DIFFICULTY_ORDER", "getCollapsedSections", "saveCollapsedSections", "collapsed", "toggleSection", "section", "newCollapsed", "chevron", "header", "stats", "statsText", "completed", "total", "formatDifficulty", "getStorage", "groupPuzzlesByDifficulty", "groups", "meta", "groupPuzzlesByDifficultyWithIndex", "puzzleItems", "item", "getSortedDifficulties", "a", "b", "indexA", "indexB", "getGroupStats", "hasProgress", "createPuzzleCard", "onClick", "isCompleted", "hasPartialProgress", "card", "preview", "placeholder", "createMiniSolution", "createMiniProgress", "name", "colors", "badge", "_c", "renderCollection", "onPuzzleSelect", "searchFilter", "sortedDifficulties", "emptyState", "foundIncomplete", "renderDifficultySection", "isCollapsed", "gridId", "sectionHeader", "sectionTitle", "sectionStats", "cardOptions", "CollectionManager", "containerId", "renderOptions", "cards", "elements", "currentElement", "direction", "targetX", "currentRect", "currentCenterX", "currentCenterY", "isCurrentHeader", "searchX", "rowTolerance", "colTolerance", "bestCandidate", "bestDistance", "rect", "isTargetHeader", "isValid", "distance", "yDist", "xDist", "targetElement", "targetRect", "targetCenterX", "currentCard", "targetCard", "focusedElement", "candidate", "targetIndex", "scrollBehavior", "currentWidth", "currentHeight", "p", "targetWidth", "targetHeight", "stampAspect", "targetCenterY", "collection", "App", "newWorker", "error", "banner", "span", "updateBtn", "laterBtn", "vh", "resolve", "channel", "text", "url", "pattern", "currentPuzzle", "currentDifficulty", "selectedColor", "isDragging", "dragColor", "dragCertain", "isPencilMode", "isLoadingPuzzle", "focusedRow", "focusedCol", "mouseUpHandler", "gridMouseLeaveHandler", "gridFocusOutHandler", "cellElements", "rowClueElements", "colClueElements", "rowSatisfied", "colSatisfied", "toastTimeout", "showToast", "toast", "hideToast", "isTouchDevice", "populateHelpContent", "helpList", "isTouch", "items", "showHelpModal", "closeBtn", "hideHelpModal", "setupHelpModal", "helpBtn", "setupSkipLink", "skipLink", "firstCell", "maybeShowFirstTimeHelp", "normalizePuzzle", "hexToRgb", "hex", "result", "convertClues", "clues", "count", "colorIdx", "convertPalette", "colorMap", "idx", "convertSolution", "normalizedPuzzles", "lastRawPuzzleData", "getPuzzles", "raw", "createCell", "certain", "getCell", "setCellDirect", "rgb", "getBrightness", "getDifficulty", "getHistory", "isPuzzleEmpty", "isPuzzleSolved", "solutionValue", "updateHoldButtonStates", "solutionBtn", "empty", "solved", "announce", "el", "setPencilMode", "enabled", "updatePencilModeUI", "closeModeMenu", "togglePencilMode", "penBtn", "pencilBtn", "menuBtn", "svg", "toggleModeMenu", "menu", "openModeMenu", "handleMenuOutsideClick", "hasPencilMarks", "countPencilMarks", "updatePencilActionsVisibility", "pencilActionsSection", "hasMarks", "markCount", "clearAllPencilMarks", "updateCellVisual", "history", "saveSession", "confirmAllPencilMarks", "checkWin", "performUndo", "change", "updateClueSatisfaction", "performRedo", "clearSession", "initPuzzleSelect", "difficulties", "diffOrder", "tabsDiv", "diff", "btn", "t", "updateDropdown", "dropdownDiv", "select", "loadPuzzle", "firstIdx", "restoreGrid", "currentPuzzleId", "hasRestoredGrid", "buildPalette", "buildClues", "buildGrid", "updateCurrentPuzzleTitle", "newDiff", "tab", "existingMenu", "menuParent", "eraser", "selectColor", "colorId", "colorRgb", "isSelected", "modeMenu", "buttonCount", "createClueCell", "clue", "className", "colCluesEl", "colIndex", "rowContainer", "rowIndex", "rowClues", "currentHoverRow", "currentHoverCol", "updateCrosshairHighlight", "clearCrosshairHighlight", "rowCells", "cellEl", "r", "prevRow", "prevCol", "moveFocusToCell", "newRow", "newCol", "newCell", "createGridCell", "attachCellFocusHandlers", "attachCellKeyboardHandlers", "fillCell", "beginDrag", "isEraser", "cellAfterFill", "endDrag", "commit", "attachCellMouseHandlers", "attachCellTouchHandlers", "longPressTimer", "touchStartTime", "touchMoved", "initialTouchRow", "initialTouchCol", "touchY", "touch", "target", "gridEl", "newValue", "newCertain", "skipToggle", "currentCell", "finalValue", "finalCertain", "colorStr", "stateDesc", "extractRuns", "values", "runs", "currentColor", "currentCount", "runsMatchClues", "rowValues", "hasUncertain", "cleanValues", "v", "isSatisfied", "rowClueEl", "colValues", "colClueEl", "showVictory", "resetPuzzle", "showSolution", "setupKeyboardShortcuts", "colorIds", "isHelpModalOpen", "showCollection", "saveCurrentPuzzle", "showGame", "handlePuzzleScreen", "handleCollectionScreen", "puzzleName", "HOLD_DURATION", "setupHoldButton", "onConfirm", "holdTimer", "isHolding", "startHold", "cancelHold", "setupButtonListeners", "penModeBtn", "pencilModeBtn", "clearPencilBtn", "confirmPencilBtn", "puzzleBackBtn", "navigateToCollectionWithStamp", "collectionBackBtn", "renderGridToCanvas", "progressCanvas", "startRect", "clearAllState", "getClueInfo", "colClues", "getColorRgb", "getCurrentPuzzle", "ABSOLUTE_MIN_ZOOM", "DEFAULT_ZOOM", "FIT_ZOOM_BUFFER", "DOUBLE_TAP_DELAY", "TOOLTIP_DISMISS_DELAY", "TOOLTIP_SHOW_DELAY", "PAN_THRESHOLD", "currentZoom", "baseZoom", "isPinching", "pinchStartDistance", "lastTapTime", "lastTapTarget", "tooltipDismissTimer", "tooltipShowTimer", "isTooltipLocked", "currentTooltipRow", "currentTooltipCol", "initialized", "zoomContainer", "boardWrapper", "tooltip", "tooltipRowClues", "tooltipColClues", "zoomInBtn", "zoomOutBtn", "zoomFitBtn", "clamp", "min", "max", "getDistance", "touch1", "touch2", "dx", "dy", "getMidpoint", "getBaseCellSize", "applyZoom", "level", "preserveCenter", "oldZoom", "effectiveMinZoom", "getEffectiveMinZoom", "newZoom", "baseCellSize", "newCellSize", "fitZoom", "calculateFitZoom", "isZoomed", "updateZoomButtons", "newScrollLeft", "newScrollTop", "isAtFit", "cachedFitZoom", "cachedPuzzleId", "forceRecalculate", "maxRowClues", "maxColClues", "clueWidthUnits", "clueHeightUnits", "totalWidthUnits", "totalHeightUnits", "availableWidth", "availableHeight", "fitZoomX", "fitZoomY", "invalidateFitZoomCache", "isZoomedBeyondFit", "handleTouchStart", "handleTouchMove", "handleTouchEnd", "now", "handleDoubleTap", "handleWheel", "zoomDelta", "showTooltip", "hideTooltip", "updateTooltipContent", "clueInfo", "renderClues", "textColor", "positionTooltip", "containerMidpoint", "startTooltipDismissTimer", "cancelTooltipDismissTimer", "onCellTouchStart", "onCellTouchMove", "onCellTouchEnd", "setupZoomControls", "handleKeyDown", "puzzleScreen", "resizeTimeout", "handleResize", "maybeShowZoomHint", "_d", "showZoomHint", "initForPuzzle", "destroy", "resetZoom", "animate", "animateToZoom", "zoomToFit", "targetZoom", "animateZoom", "currentTime", "elapsed", "startTime", "duration", "eased", "zoom", "startZoom", "increment"]
}
