(function(){"use strict";const R={STAMP_CANVAS_SIZE:180,VICTORY_CANVAS_SIZE:180,MINI_CANVAS_SIZE:80,OUTLINE_THICKNESS:2,MAX_PUZZLE_DIMENSION:32,MAX_HISTORY:50,MAX_SCREEN_HISTORY:10,MAX_SEARCH_LENGTH:100,TOAST_DURATION:2500,LONG_PRESS_DELAY:400,SEARCH_DEBOUNCE:150,MAX_ZOOM:3,COMFORTABLE_ZOOM:2};function L(k){return(k.t||k.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"")}function v(k){return k.t||k.title}function P(k){const S=k.match(/^(.+?)\s*\((\d+)x(\d+),\s*(\w+)\)$/i);return S?{name:S[1].trim(),width:parseInt(S[2],10),height:parseInt(S[3],10),difficulty:S[4].toLowerCase()}:{name:k,width:0,height:0,difficulty:"unknown"}}function T(k,S,d,a){const D=Math.max(k,S),N=Math.max(2,Math.floor(d/D)),W=R.OUTLINE_THICKNESS*2,ne=R.OUTLINE_THICKNESS,J=document.createElement("canvas");J.width=k*N+W,J.height=S*N+W;const _=J.getContext("2d");if(!_)return J;const re=getComputedStyle(document.documentElement).getPropertyValue("--color-text-muted").trim()||"#8a8a7a";_.fillStyle=re;for(let Q=0;Q<S;Q++)for(let ee=0;ee<k;ee++)if(a(Q,ee)){const se=ne+ee*N,V=ne+Q*N;_.fillRect(se-R.OUTLINE_THICKNESS,V-R.OUTLINE_THICKNESS,N+W,N+W)}for(let Q=0;Q<S;Q++)for(let ee=0;ee<k;ee++){const q=a(Q,ee);if(q){_.fillStyle=`rgb(${q[0]}, ${q[1]}, ${q[2]})`;const se=ne+ee*N,V=ne+Q*N;_.fillRect(se,V,N,N)}}return J}window.Cozy=window.Cozy||{},window.Cozy.Utils={CONFIG:R,getPuzzleId:L,getPuzzleTitle:v,parsePuzzleTitle:P,renderOutlinedCanvas:T}})(),function(){"use strict";const R="cozy_garden_data";function v(S){return!(!S||typeof S!="object"||typeof S.version!="number"||S.progress!==null&&typeof S.progress!="object"||S.settings!==null&&typeof S.settings!="object"||S.stats!==null&&typeof S.stats!="object")}function P(){return{version:1,progress:{},settings:{vibration:!0,theme:"light"},stats:{totalCompleted:0,totalAttempts:0,totalPlayTime:0,streak:0,lastPlayDate:null},currentSession:{puzzleIndex:0,difficulty:"easy",grid:null,startTime:null},flags:{tutorialCompleted:!1,helpShown:!1,zoomHintShown:!1},uiState:{collapsedSections:[]}}}class T{constructor(){this.data=null,this.listeners=[]}init(){try{const d=localStorage.getItem(R);if(d){const a=JSON.parse(d);v(a)?this.data=a:(console.warn("[Storage] Invalid data structure, using defaults"),this.data=P(),this.save())}else this.data=P(),this.save()}catch(d){console.warn("[Storage] Failed to load, using defaults:",d),this.data=P(),this.save()}return this}save(){try{return localStorage.setItem(R,JSON.stringify(this.data)),this.notifyListeners("save"),!0}catch(d){return console.error("[Storage] Failed to save:",d),!1}}onChange(d){return this.listeners.push(d),()=>{this.listeners=this.listeners.filter(a=>a!==d)}}notifyListeners(d){this.listeners.forEach(a=>a(d,this.data))}getPuzzleProgress(d){return this.data.progress[d]||{completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}}savePuzzleGrid(d,a){this.data.progress||(this.data.progress={}),this.data.progress[d]||(this.data.progress[d]={completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}),a?this.data.progress[d].savedGrid=a.map(D=>D.map(N=>({value:N.value,certain:N.certain}))):this.data.progress[d].savedGrid=null,this.save()}getPuzzleGrid(d){if(!this.data.progress)return null;const a=this.data.progress[d];return!a||!a.savedGrid?null:a.savedGrid.map(D=>D.map(N=>({value:N.value,certain:N.certain})))}completePuzzle(d){const a=this.getPuzzleProgress(d),D=!a.completed;return a.completed=!0,a.attempts+=1,a.lastPlayed=Date.now(),a.savedGrid=null,this.data.progress[d]=a,D&&(this.data.stats.totalCompleted+=1),this.data.stats.totalAttempts+=1,this.updateStreak(),this.save(),{wasNew:D,progress:a}}isPuzzleCompleted(d){var a;return((a=this.data.progress[d])==null?void 0:a.completed)||!1}getCompletionStats(){return{easy:{completed:0,total:0},medium:{completed:0,total:0},hard:{completed:0,total:0},challenging:{completed:0,total:0},expert:{completed:0,total:0}}}saveSession(d,a,D){let N=null;D&&(N=D.map(W=>W.map(ne=>({value:ne.value,certain:ne.certain})))),this.data.currentSession={puzzleIndex:d,difficulty:a,grid:N},this.save()}getSession(){return this.data.currentSession}clearSession(){this.data.currentSession={puzzleIndex:0,difficulty:"easy",grid:null},this.save()}getSetting(d){return this.data.settings[d]}setSetting(d,a){this.data.settings[d]=a,this.save(),this.notifyListeners("settings")}getSettings(){return{...this.data.settings}}getStats(){return{...this.data.stats}}addPlayTime(d){this.data.stats.totalPlayTime+=d,this.save()}updateStreak(){const d=new Date().toDateString(),a=this.data.stats.lastPlayDate;if(a===d)return;const D=new Date(Date.now()-864e5).toDateString();a===D?this.data.stats.streak+=1:a!==d&&(this.data.stats.streak=1),this.data.stats.lastPlayDate=d}getFlag(d){var a;return((a=this.data.flags)==null?void 0:a[d])||!1}setFlag(d,a=!0){this.data.flags||(this.data.flags={}),this.data.flags[d]=a,this.save()}getUIState(d){var a;return(a=this.data.uiState)==null?void 0:a[d]}setUIState(d,a){this.data.uiState||(this.data.uiState={}),this.data.uiState[d]=a,this.save()}exportData(){return JSON.stringify(this.data,null,2)}importData(d){try{const a=JSON.parse(d);return v(a)?(this.data=a,this.save(),!0):!1}catch(a){return console.error("[Storage] Import failed:",a),!1}}reset(){this.data=P(),this.save(),this.notifyListeners("reset")}}const k=new T().init();window.Cozy.Storage=k}(),function(){"use strict";const{CONFIG:R}=window.Cozy.Utils;let L=[],v=[],P=null;const T={beginAction(k="fill"){P&&P.changes.length>0&&this.commitAction(),P={type:k,changes:[],timestamp:Date.now()}},recordChange(k,S,d,a){if(d.value===a.value&&d.certain===a.certain)return;P||this.beginAction("fill");const D=P.changes.find(N=>N.row===k&&N.col===S);D?D.after={value:a.value,certain:a.certain}:P.changes.push({row:k,col:S,before:{value:d.value,certain:d.certain},after:{value:a.value,certain:a.certain}})},commitAction(){P&&P.changes.length>0&&(P.changes=P.changes.filter(k=>k.before.value!==k.after.value||k.before.certain!==k.after.certain),P.changes.length>0&&(L.push(P),L.length>R.MAX_HISTORY&&L.shift(),v=[]),this.updateUI()),P=null},cancelAction(){P=null},recordBatchAction(k,S){if(S.length===0)return;const d={type:k,changes:S.map(a=>({row:a.row,col:a.col,before:{value:a.before.value,certain:a.before.certain},after:{value:a.after.value,certain:a.after.certain}})),timestamp:Date.now()};L.push(d),L.length>R.MAX_HISTORY&&L.shift(),v=[],this.updateUI()},undo(){if(L.length===0)return null;const k=L.pop();return v.push(k),this.updateUI(),k.changes.map(S=>({row:S.row,col:S.col,state:{value:S.before.value,certain:S.before.certain}}))},redo(){if(v.length===0)return null;const k=v.pop();return L.push(k),this.updateUI(),k.changes.map(S=>({row:S.row,col:S.col,state:{value:S.after.value,certain:S.after.certain}}))},canUndo(){return L.length>0},canRedo(){return v.length>0},clear(){L=[],v=[],P=null,this.updateUI()},updateUI(){const k=document.getElementById("undo-btn"),S=document.getElementById("redo-btn");k&&(k.disabled=!this.canUndo()),S&&(S.disabled=!this.canRedo())},getStats(){return{undoDepth:L.length,redoDepth:v.length,hasPending:P!==null,pendingChanges:P?P.changes.length:0}}};window.Cozy.History=T}();const ScreenManager=function(){"use strict";const{CONFIG:R,renderOutlinedCanvas:L}=window.Cozy.Utils,v={SPLASH:"splash",HOME:"home",COLLECTION:"collection",PUZZLE:"puzzle",VICTORY:"victory",SETTINGS:"settings",TUTORIAL:"tutorial"};let P=null,T=[],k={},S={},d=null;function a(l){const r=document.getElementById("confirm-modal"),f=document.getElementById("confirm-modal-title"),y=document.getElementById("confirm-modal-message"),m=document.getElementById("confirm-modal-confirm"),O=document.getElementById("confirm-modal-cancel");r&&(f.textContent=l.title||"Confirm",y.textContent=l.message||"Are you sure?",m.textContent=l.confirmText||"Confirm",O.textContent=l.cancelText||"Cancel",m.classList.toggle("confirm-modal-btn-danger",!!l.danger),m.classList.toggle("confirm-modal-btn-primary",!l.danger),r.classList.remove("alert-mode"),d=l,r.classList.add("visible"),setTimeout(()=>m.focus(),100))}function D(l){const r=document.getElementById("confirm-modal"),f=document.getElementById("confirm-modal-title"),y=document.getElementById("confirm-modal-message"),m=document.getElementById("confirm-modal-confirm");r&&(f.textContent=l.title||"Notice",y.textContent=l.message||"",m.textContent=l.buttonText||"OK",m.classList.remove("confirm-modal-btn-danger"),m.classList.add("confirm-modal-btn-primary"),r.classList.add("alert-mode"),d={onConfirm:l.onClose},r.classList.add("visible"),setTimeout(()=>m.focus(),100))}function N(){const l=document.getElementById("confirm-modal");l&&l.classList.remove("visible"),d=null}function W(){const l=document.getElementById("confirm-modal"),r=l==null?void 0:l.querySelector(".confirm-modal-backdrop"),f=document.getElementById("confirm-modal-confirm"),y=document.getElementById("confirm-modal-cancel");l&&(f==null||f.addEventListener("click",()=>{const m=d==null?void 0:d.onConfirm;N(),m&&setTimeout(m,200)}),y==null||y.addEventListener("click",()=>{const m=d==null?void 0:d.onCancel;N(),m&&m()}),r==null||r.addEventListener("click",()=>{const m=d==null?void 0:d.onCancel;N(),m&&m()}),document.addEventListener("keydown",m=>{if(m.key==="Escape"&&l.classList.contains("visible")){const O=d==null?void 0:d.onCancel;N(),O&&O()}if(m.key==="Tab"&&l.classList.contains("visible")){const w=l.classList.contains("alert-mode")?[f]:[y,f],x=w[0],Z=w[w.length-1];w.includes(document.activeElement)?m.shiftKey?document.activeElement===x&&(m.preventDefault(),Z.focus()):document.activeElement===Z&&(m.preventDefault(),x.focus()):(m.preventDefault(),x.focus())}}))}function ne(){G(),W(),Object.values(v).forEach(l=>{S[l]=document.getElementById(`screen-${l}`)}),window.addEventListener("popstate",Q),document.addEventListener("keydown",J),_(v.SPLASH,{},!1)}function J(l){if(l.key!=="Escape"||l.target.tagName==="INPUT"||l.target.tagName==="TEXTAREA")return;const r=document.getElementById("confirm-modal"),f=document.getElementById("help-modal");if(!(r!=null&&r.classList.contains("visible")||f!=null&&f.classList.contains("visible")))switch(P){case v.HOME:break;case v.COLLECTION:_(v.HOME);break;case v.PUZZLE:break;case v.VICTORY:_(v.COLLECTION);break;case v.SETTINGS:_(v.HOME);break;case v.TUTORIAL:window.Cozy.Storage&&window.Cozy.Storage.setFlag("tutorialComplete",!0),_(v.HOME);break}}function _(l,r={},f=!0){const y=S[l];if(!y){console.error(`Screen not found: ${l}`);return}k=r,P&&S[P]&&(P===v.PUZZLE&&window.Cozy.Zoom&&window.Cozy.Zoom.destroy(),S[P].classList.remove("screen-active"),S[P].classList.add("screen-hidden")),y.classList.remove("screen-hidden"),y.classList.add("screen-active"),f&&P!==null&&(T.push(P),T.length>R.MAX_SCREEN_HISTORY&&(T=T.slice(-R.MAX_SCREEN_HISTORY)),history.pushState({screen:l},"",`#${l}`));const m=P;P=l,ee(l,r,m)}function re(){if(T.length>0){const l=T.pop();_(l,{},!1),history.back()}}function Q(l){if(l.state&&l.state.screen)_(l.state.screen,{},!1);else if(T.length>0){const r=T.pop();_(r,{},!1)}}function ee(l,r,f){switch(l){case v.SPLASH:V();break;case v.HOME:ge();break;case v.COLLECTION:p(r);break;case v.PUZZLE:z(r);break;case v.VICTORY:A(r);break;case v.SETTINGS:b();break;case v.TUTORIAL:M();break}}function q(){return k}function se(){return P}function V(){setTimeout(()=>{var y;if(new URLSearchParams(window.location.search).get("action")==="continue"){const m=window.location.pathname+window.location.hash;history.replaceState(null,"",m);const O=window.Cozy.Storage;if(O){const w=O.getSession();if(w&&typeof w.puzzleIndex=="number"){_(v.PUZZLE,{puzzleId:w.puzzleIndex});return}}}const f=(y=window.Cozy.Storage)==null?void 0:y.getFlag("tutorialCompleted");_(f?v.HOME:v.TUTORIAL)},1500)}function ge(){var y;const l=document.getElementById("home-play-btn"),r=document.getElementById("home-settings-btn"),f=document.getElementById("home-progress");if(l&&!l.hasAttribute("data-initialized")&&(l.addEventListener("click",()=>_(v.COLLECTION)),l.setAttribute("data-initialized","true")),r&&!r.hasAttribute("data-initialized")&&(r.addEventListener("click",()=>_(v.SETTINGS)),r.setAttribute("data-initialized","true")),f&&window.PUZZLE_DATA){const m=window.PUZZLE_DATA,O=Array.isArray(m)?m.length:0;let w=0;window.Cozy.Storage&&((y=window.Cozy.Garden)!=null&&y.getPuzzleId)&&m.forEach(x=>{const Z=window.Cozy.Garden.getPuzzleId(x);window.Cozy.Storage.isPuzzleCompleted(Z)&&w++}),f.textContent=`${w} / ${O} puzzles solved`}l&&setTimeout(()=>l.focus(),100)}function p(l){window.dispatchEvent(new CustomEvent("screen:collection",{detail:l}));const r=document.getElementById("collection-search-input");r&&setTimeout(()=>r.focus(),100)}function z(l){window.Cozy.Zoom&&window.Cozy.Zoom.init(),window.dispatchEvent(new CustomEvent("screen:puzzle",{detail:l}))}let h=null;function A(l){const r=document.getElementById("victory-puzzle-name"),f=document.getElementById("victory-image"),y=document.getElementById("victory-continue-btn");h=l.puzzleId,r&&l.puzzleName&&(r.textContent=l.puzzleName),f&&l.solution&&E(f,l.solution,l.palette),y&&!y.hasAttribute("data-initialized")&&(y.addEventListener("click",()=>{const m=f?f.querySelector("canvas"):null;if(m){const O=f.getBoundingClientRect(),w=document.createElement("canvas");w.width=m.width,w.height=m.height,w.getContext("2d").drawImage(m,0,0);const Z=m.width,$=m.height,te=m.width/m.height,ce=Math.min(O.width,O.height);let j;te>1?j=ce:j=ce*te;const ze=j/Z,fe=O.left+O.width/2,Ce=O.top+O.height/2;w.className="flying-stamp",w.style.left=fe-Z/2+"px",w.style.top=Ce-$/2+"px",w.style.width=Z+"px",w.style.height=$+"px",w.style.transform="scale("+ze+")",document.body.appendChild(w),_(v.COLLECTION,{scrollToPuzzleId:h,animateStamp:!0,flyingStamp:w})}else _(v.COLLECTION,{scrollToPuzzleId:h})}),y.setAttribute("data-initialized","true")),y&&setTimeout(()=>y.focus(),100)}function E(l,r,f){l.innerHTML="";const y=r.length,m=r[0]?r[0].length:y,O=L(m,y,R.VICTORY_CANVAS_SIZE,(w,x)=>{const Z=r[w][x];return Z>0&&f[Z]?f[Z]:null});l.appendChild(O)}function b(){var Z,$;const l=document.getElementById("settings-back-btn"),r=document.getElementById("settings-vibration"),f=document.getElementById("settings-reset-btn"),y=window.Cozy.Storage;r&&(r.checked=(Z=y==null?void 0:y.getSetting("vibration"))!=null?Z:!0),l&&!l.hasAttribute("data-initialized")&&(l.addEventListener("click",re),l.setAttribute("data-initialized","true")),r&&!r.hasAttribute("data-initialized")&&(r.addEventListener("change",()=>y==null?void 0:y.setSetting("vibration",r.checked)),r.setAttribute("data-initialized","true")),f&&!f.hasAttribute("data-initialized")&&(f.addEventListener("click",()=>{a({title:"Reset Progress",message:"Are you sure you want to reset all progress? This cannot be undone.",confirmText:"Reset",cancelText:"Cancel",danger:!0,onConfirm:()=>{window.Cozy.Garden&&window.Cozy.Garden.clearAllState&&window.Cozy.Garden.clearAllState(),window.Cozy.Storage&&window.Cozy.Storage.reset&&window.Cozy.Storage.reset(),window.Cozy.Collection&&window.Cozy.Collection.refresh(),D({title:"Progress Reset",message:"All progress has been cleared."})}})}),f.setAttribute("data-initialized","true"));const m=document.getElementById("settings-tutorial-btn");m&&!m.hasAttribute("data-initialized")&&(m.addEventListener("click",()=>{_(v.TUTORIAL)}),m.setAttribute("data-initialized","true"));const O=document.querySelectorAll(".theme-option");let w=($=window.Cozy.Storage)==null?void 0:$.getSetting("theme");(!w||w==="system")&&(w=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),O.forEach(te=>{const j=te.dataset.theme===w;te.classList.toggle("active",j),te.setAttribute("aria-pressed",j?"true":"false")}),O.forEach(te=>{te.hasAttribute("data-initialized")||(te.addEventListener("click",()=>{const ce=te.dataset.theme;O.forEach(j=>{j.classList.remove("active"),j.setAttribute("aria-pressed","false")}),te.classList.add("active"),te.setAttribute("aria-pressed","true"),window.Cozy.Storage&&window.Cozy.Storage.setSetting("theme",ce),U(ce)}),te.setAttribute("data-initialized","true"))});const x=document.getElementById("settings-solve-all-btn");x&&!x.hasAttribute("data-initialized")&&(x.addEventListener("click",()=>{a({title:"Debug: Solve All",message:"Mark all puzzles as solved? This is a debug feature.",confirmText:"Solve All",cancelText:"Cancel",onConfirm:()=>{const te=window.PUZZLE_DATA||[],ce=window.Cozy.Storage;ce&&te.forEach(j=>{var fe;let ze;(fe=window.Cozy.Garden)!=null&&fe.getPuzzleId?ze=window.Cozy.Garden.getPuzzleId(j):ze=(j.t||j.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""),ce.completePuzzle(ze)}),window.Cozy.Collection&&window.Cozy.Collection.refresh(),D({title:"All Puzzles Solved",message:`Marked ${te.length} puzzles as solved!`})}})}),x.setAttribute("data-initialized","true")),r&&setTimeout(()=>r.focus(),100)}let H=0;function M(){const l=document.getElementById("tutorial-skip-btn"),r=document.getElementById("tutorial-next-btn"),f=document.querySelectorAll(".tutorial-step"),y=document.querySelectorAll(".tutorial-dot");function m(w){f.forEach((x,Z)=>{x.classList.toggle("active",Z===w)}),y.forEach((x,Z)=>{x.classList.toggle("active",Z===w)}),r&&(r.textContent=w===f.length-1?"Start Playing":"Next")}function O(){var w;(w=window.Cozy.Storage)==null||w.setFlag("tutorialCompleted",!0),_(v.HOME)}l&&!l.hasAttribute("data-initialized")&&(l.addEventListener("click",O),l.setAttribute("data-initialized","true")),r&&!r.hasAttribute("data-initialized")&&(r.addEventListener("click",()=>{H<f.length-1?(H++,m(H)):O()}),r.setAttribute("data-initialized","true")),H=0,m(0),r&&setTimeout(()=>r.focus(),100)}function U(l){document.documentElement.setAttribute("data-theme",l);const r=document.getElementById("theme-color-meta");r&&r.setAttribute("content",l==="dark"?"#0a1018":"#4a7c3f")}function G(){var r;let l=(r=window.Cozy.Storage)==null?void 0:r.getSetting("theme");(!l||l==="system")&&(l=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),U(l)}return{init:ne,showScreen:_,goBack:re,getScreenData:q,getCurrentScreen:se,applyTheme:U,initTheme:G,showConfirmModal:a,SCREENS:v}}();window.Cozy.Screens=ScreenManager,document.addEventListener("DOMContentLoaded",()=>{ScreenManager.init()}),function(){"use strict";const{CONFIG:R,getPuzzleId:L,getPuzzleTitle:v,parsePuzzleTitle:P,renderOutlinedCanvas:T}=window.Cozy.Utils,k=["easy","medium","hard","challenging","expert"];function S(){var z;const p=(z=window.Cozy.Storage)==null?void 0:z.getUIState("collapsedSections");return p&&typeof p=="object"?p:null}function d(p){var z;(z=window.Cozy.Storage)==null||z.setUIState("collapsedSections",p)}function a(p,z){const h=document.querySelector(`.collection-section[data-difficulty="${p}"]`);if(!h)return;const A=z[p];z[p]=!A,d(z),h.classList.toggle("collapsed",!A);const E=h.querySelector(".collection-grid"),b=h.querySelector(".section-chevron");E&&(E.style.display=A?"flex":"none"),b&&(b.textContent=A?"\u25BC":"\u25B6")}function D(){return window.Cozy.Storage||null}function N(p){const z={};return p.forEach((h,A)=>{const E=P(v(h)),b=E.difficulty;z[b]||(z[b]=[]),z[b].push({index:A,puzzle:h,meta:E,id:L(h)})}),z}function W(p){const z={};return p.forEach(h=>{const A=P(v(h.puzzle)),E=A.difficulty;z[E]||(z[E]=[]),z[E].push({index:h.originalIndex,puzzle:h.puzzle,meta:A,id:L(h.puzzle)})}),z}function ne(p){return Object.keys(p).sort((h,A)=>{const E=k.indexOf(h),b=k.indexOf(A);return E!==-1&&b!==-1?E-b:E!==-1?-1:b!==-1?1:h.localeCompare(A)})}function J(p){return p.charAt(0).toUpperCase()+p.slice(1)}function _(p){const z=D();let h=0;return z&&p.forEach(A=>{z.isPuzzleCompleted(A.id)&&h++}),{completed:h,total:p.length}}function re(p){if(!p)return!1;for(const z of p)for(const h of z)if((typeof h=="object"&&h!==null?h.value:h)!==null)return!0;return!1}function Q(p,z,h={}){const A=D(),E=A?A.isPuzzleCompleted(p.id):!1,b=A?A.getPuzzleGrid(p.id):null,H=!E&&re(b),M=document.createElement("div");M.className="puzzle-card"+(E?" completed":"")+(H?" in-progress":""),M.dataset.puzzleIndex=p.index,M.dataset.puzzleId=p.id,M.tabIndex=-1,M.setAttribute("role","button"),M.setAttribute("aria-label",`${p.meta.name}, ${p.meta.width} by ${p.meta.height}${E?", completed":""}`),M.addEventListener("keydown",f=>{if(f.key==="Enter"||f.key===" "){f.preventDefault(),window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=p.id),z(p.index);return}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(f.key)&&(f.preventDefault(),f.stopPropagation(),window.Cozy.Collection&&window.Cozy.Collection.navigateFromCard(M,f.key))});const U=document.createElement("div");if(U.className="puzzle-card-preview",h.forceBlank){U.classList.add("awaiting-stamp");const f=document.createElement("div");f.className="puzzle-card-placeholder",f.textContent="?",U.appendChild(f)}else if(E)U.appendChild(ee(p.puzzle));else if(H)U.appendChild(q(p.puzzle,b));else{const f=document.createElement("div");f.className="puzzle-card-placeholder",f.textContent="?",U.appendChild(f)}M.appendChild(U);const G=document.createElement("div");G.className="puzzle-card-name",G.textContent=p.meta.name,M.appendChild(G);const l=Object.keys(p.puzzle.color_map).length,r=document.createElement("div");return r.className="puzzle-card-badge",r.textContent=`${p.meta.width}\xD7${p.meta.height} \xB7 ${l}c`,M.appendChild(r),M.addEventListener("click",()=>{window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=p.id),z(p.index)}),M}function ee(p){try{const z=T(p.width,p.height,R.MINI_CANVAS_SIZE,(h,A)=>{var b,H,M;const E=(H=(b=p.solution)==null?void 0:b[h])==null?void 0:H[A];if(E>0){const U=(M=p.color_map)==null?void 0:M[E];if(U&&Array.isArray(U)&&U.length>=3)return U}return null});return z.className="puzzle-mini-canvas",z}catch(z){return console.error("[Collection] Error creating mini solution:",z),null}}function q(p,z){try{const h=T(p.width,p.height,R.MINI_CANVAS_SIZE,(A,E)=>{var M,U;const b=(M=z==null?void 0:z[A])==null?void 0:M[E],H=typeof b=="object"&&b!==null?b.value:b;if(H!==null&&H>0){const G=(U=p.color_map)==null?void 0:U[H];if(G&&Array.isArray(G)&&G.length>=3)return G}return null});return h.className="puzzle-mini-canvas",h}catch(h){return console.error("[Collection] Error creating mini progress:",h),null}}function se(p,z,h,A={}){p.innerHTML="";const E=(A.searchFilter||"").toLowerCase().trim().slice(0,R.MAX_SEARCH_LENGTH);let b=z.map((l,r)=>({puzzle:l,originalIndex:r}));E&&(b=b.filter(l=>P(v(l.puzzle)).name.toLowerCase().includes(E)));const H=W(b),M=ne(H),U=D();if(M.length===0&&E){const l=document.createElement("div");l.className="collection-empty-state";const r=document.createElement("p");r.className="collection-empty-message",r.textContent=`No puzzles match "${E}"`,l.appendChild(r),p.appendChild(l);return}let G;if(E)G={},M.forEach(l=>{G[l]=!1});else if(G=S(),!G){G={};let l=!1;M.forEach(r=>{const f=_(H[r]);!l&&f.completed<f.total?(G[r]=!1,l=!0):G[r]=!0}),!l&&M.length>0&&(G[M[0]]=!1),d(G)}M.forEach(l=>{const r=H[l],f=_(r),y=G[l],m=document.createElement("div");m.className="collection-section"+(y?" collapsed":""),m.dataset.difficulty=l;const O=document.createElement("div");O.className="collection-section-header",O.style.cursor="pointer";const w=document.createElement("span");w.className="section-chevron",w.textContent=y?"\u25B6":"\u25BC",O.appendChild(w);const x=document.createElement("h3");x.className="collection-section-title",x.textContent=J(l),O.appendChild(x);const Z=document.createElement("span");Z.className="collection-section-stats",Z.textContent=`${f.completed}/${f.total}`,f.completed===f.total&&f.total>0&&Z.classList.add("complete"),O.appendChild(Z),O.addEventListener("click",()=>{a(l,G)}),m.appendChild(O);const $=document.createElement("div");$.className="collection-grid",$.style.display=y?"none":"flex",r.forEach(te=>{const ce={};A.blankPuzzleId&&te.id===A.blankPuzzleId&&(ce.forceBlank=!0);const j=Q(te,h,ce);$.appendChild(j)}),m.appendChild($),p.appendChild(m)})}class V{constructor(){this.container=null,this.puzzles=[],this.onPuzzleSelect=null,this.visible=!0,this.searchFilter="",this.searchInput=null,this.searchInputHandler=null,this.searchDebounceTimeout=null,this.focusedCardId=null}init(z,h,A){return this.container=document.getElementById(z),this.puzzles=h,this.onPuzzleSelect=A,this.searchInput=document.getElementById("collection-search-input"),this.searchInput&&(this.searchInputHandler&&this.searchInput.removeEventListener("input",this.searchInputHandler),this.searchInputHandler=E=>{this.searchFilter=E.target.value,this.searchDebounceTimeout&&clearTimeout(this.searchDebounceTimeout),this.searchDebounceTimeout=setTimeout(()=>this.render(),150)},this.searchInput.addEventListener("input",this.searchInputHandler)),this.container&&this.render(),this}render(z={}){if(!this.container)return;const h={...z,searchFilter:this.searchFilter};se(this.container,this.puzzles,A=>{this.onPuzzleSelect&&this.onPuzzleSelect(A)},h),this.updateRovingTabindex()}show(){this.container&&(this.container.style.display="block",this.visible=!0,this.searchFilter="",this.searchInput&&(this.searchInput.value=""),this.render())}hide(){this.container&&(this.container.style.display="none",this.visible=!1)}isVisible(){return this.visible}refresh(z={}){this.visible&&this.render(z)}getVisibleCards(){if(!this.container)return[];const z=[];return this.container.querySelectorAll(".collection-section").forEach(A=>{const E=A.querySelector(".collection-grid");E&&E.style.display!=="none"&&E.querySelectorAll(".puzzle-card").forEach(H=>z.push(H))}),z}findCardInDirection(z,h){const A=this.getVisibleCards();if(A.length===0)return null;const E=z.getBoundingClientRect(),b=E.left+E.width/2,H=E.top+E.height/2,M=E.height*.5,U=E.width*.5;let G=null,l=1/0;return A.forEach(r=>{if(r===z)return;const f=r.getBoundingClientRect(),y=f.left+f.width/2,m=f.top+f.height/2;let O=!1;switch(h){case"left":O=y<b-U&&Math.abs(m-H)<M;break;case"right":O=y>b+U&&Math.abs(m-H)<M;break;case"up":O=m<H-M;break;case"down":O=m>H+M;break}if(O){let w;if(h==="left"||h==="right")w=Math.abs(y-b);else{const x=Math.abs(m-H),Z=Math.abs(y-b);w=x*1e3+Z}w<l&&(l=w,G=r)}}),G}navigateFromCard(z,h){const E={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[h];if(!E)return;const b=this.findCardInDirection(z,E);b&&(z.tabIndex=-1,b.tabIndex=0,b.focus(),this.focusedCardId=b.dataset.puzzleId,b.scrollIntoView({behavior:"smooth",block:"nearest"}))}updateRovingTabindex(){const z=this.getVisibleCards();if(z.length===0)return;let h=null;if(this.focusedCardId){const A=this.container.querySelector(`.puzzle-card[data-puzzle-id="${this.focusedCardId}"]`);A&&z.includes(A)&&(h=A)}h||(h=z[0],this.focusedCardId=(h==null?void 0:h.dataset.puzzleId)||null),z.forEach(A=>{A.tabIndex=A===h?0:-1})}scrollToPuzzle(z,h={}){if(!this.container)return;const A=this.container.querySelectorAll(".puzzle-card");let E=null,b=-1;for(let U=0;U<this.puzzles.length;U++)if(L(this.puzzles[U])===z){b=U;break}if(b===-1||(A.forEach(U=>{parseInt(U.dataset.puzzleIndex,10)===b&&(E=U)}),!E))return;const H=E.closest(".collection-section");if(H&&H.classList.contains("collapsed")){const U=H.dataset.difficulty,G=H.querySelector(".collection-grid"),l=H.querySelector(".section-chevron");H.classList.remove("collapsed"),G&&(G.style.display="flex"),l&&(l.textContent="\u25BC");let r=S()||{};r[U]=!1,d(r)}const M=h.instant?"instant":"smooth";setTimeout(()=>{E.scrollIntoView({behavior:M,block:"center"})},h.instant?0:100)}animateStampTo(z,h,A={}){if(!this.container||!h)return;const E=this.container.querySelector(`.puzzle-card[data-puzzle-id="${z}"]`);if(!E){h.remove();return}const b=E.querySelector(".puzzle-card-preview");if(!b){h.remove();return}setTimeout(()=>{const M=b.getBoundingClientRect(),U=parseFloat(h.style.width),G=parseFloat(h.style.height),l=this.puzzles.find(w=>L(w)===z);let r,f;if(l){const w=Math.max(l.width,l.height),x=Math.max(2,Math.floor(R.MINI_CANVAS_SIZE/w)),Z=R.OUTLINE_THICKNESS*2;r=l.width*x+Z,f=l.height*x+Z}else{const w=U/G;w>1?(r=M.width,f=M.width/w):(f=M.height,r=M.height*w)}const y=r/U,m=M.left+M.width/2,O=M.top+M.height/2;requestAnimationFrame(()=>{h.style.left=m-U/2+"px",h.style.top=O-G/2+"px",h.style.transform="scale("+y+")",h.classList.add("landed")}),setTimeout(()=>{b.classList.remove("awaiting-stamp"),b.innerHTML="";const w=this.puzzles.find(x=>L(x)===z);if(w){const x=D();if(x?x.isPuzzleCompleted(z):!1)b.appendChild(ee(w));else{const $=x?x.getPuzzleGrid(z):null;$&&b.appendChild(q(w,$))}}h.remove()},650)},100)}}const ge=new V;window.Cozy.Collection=ge}(),function(){"use strict";const R={isInstalled:!1,swRegistration:null,resizeTimeout:null,init(){this.checkInstallState(),this.registerServiceWorker(),this.setupEventListeners(),console.log("[App] Cozy Garden initialized")},checkInstallState(){window.matchMedia("(display-mode: standalone)").matches&&(this.isInstalled=!0),window.navigator.standalone===!0&&(this.isInstalled=!0),this.isInstalled&&(document.body.classList.add("is-installed"),console.log("[App] Running as installed PWA"))},async registerServiceWorker(){if(!("serviceWorker"in navigator)){console.log("[App] Service workers not supported");return}try{this.swRegistration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("[App] Service worker registered:",this.swRegistration.scope),this.swRegistration.addEventListener("updatefound",()=>{const L=this.swRegistration.installing;console.log("[App] New service worker installing..."),L.addEventListener("statechange",()=>{L.state==="installed"&&navigator.serviceWorker.controller&&this.showUpdateNotification()})})}catch(L){console.error("[App] Service worker registration failed:",L)}},showUpdateNotification(){const L=document.createElement("div");L.className="update-banner";const v=document.createElement("span");v.textContent="A new version is available!";const P=document.createElement("button");P.textContent="Update",P.addEventListener("click",()=>this.applyUpdate());const T=document.createElement("button");T.textContent="Later",T.addEventListener("click",()=>L.remove()),L.appendChild(v),L.appendChild(P),L.appendChild(T),document.body.appendChild(L)},applyUpdate(){this.swRegistration&&this.swRegistration.waiting&&this.swRegistration.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload()},setupEventListeners(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?this.onAppFocus():this.onAppBlur()}),window.addEventListener("beforeunload",()=>{this.saveState()}),window.addEventListener("orientationchange",()=>{setTimeout(()=>this.handleResize(),100)}),window.addEventListener("resize",()=>{this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>this.handleResize(),100)})},onAppFocus(){console.log("[App] App focused")},onAppBlur(){console.log("[App] App blurred"),this.saveState()},saveState(){window.Cozy.Garden&&window.Cozy.Storage&&console.log("[App] Saving state...")},handleResize(){const L=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${L}px`)},isPWA(){return this.isInstalled||window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0},async getVersion(){return!this.swRegistration||!navigator.serviceWorker.controller?"unknown":new Promise(L=>{const v=new MessageChannel;v.port1.onmessage=P=>{L(P.data.version||"unknown")},navigator.serviceWorker.controller.postMessage({type:"GET_VERSION"},[v.port2]),setTimeout(()=>L("unknown"),1e3)})},async share(L,v,P){if(navigator.share)try{return await navigator.share({title:L,text:v,url:P}),!0}catch(T){return T.name!=="AbortError"&&console.error("[App] Share failed:",T),!1}return!1},vibrate(L=50){var v;navigator.vibrate&&((v=window.Cozy.Storage)!=null&&v.getSetting("vibration"))&&navigator.vibrate(L)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>R.init()):R.init(),window.Cozy.App=R}(),function(){"use strict";const{CONFIG:R,getPuzzleId:L,getPuzzleTitle:v,renderOutlinedCanvas:P}=window.Cozy.Utils;let T=0,k="easy",S=1,d=[],a=!1,D=null,N=!0,W=!1,ne=!1,J=0,_=0,re=null,Q=null,ee=null,q=[],se=[],V=[],ge=null;function p(e,t="info"){const n=document.getElementById("toast");n&&(clearTimeout(ge),n.textContent=e,n.className="toast visible",t==="success"?n.classList.add("toast-success"):t==="info"&&n.classList.add("toast-info"),ge=setTimeout(()=>{n.classList.remove("visible")},R.TOAST_DURATION))}function z(){const e=document.getElementById("toast");e&&(clearTimeout(ge),e.classList.remove("visible"))}function h(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function A(){const e=document.getElementById("help-list");if(!e)return;const t=h();let n=["<li><strong>Select a color</strong> from the palette, then tap cells to fill them</li>","<li><strong>Drag</strong> across cells to fill multiple at once</li>","<li><strong>Long-press</strong> a cell to mark it \u2715 (definitely empty)</li>","<li><strong>Pencil mode</strong> marks uncertain guesses \u2014 confirm or clear them later</li>"];t&&n.push("<li><strong>Pinch to zoom</strong> on larger puzzles for easier tapping</li>"),t||(n.push('<li class="help-section-title">Keyboard Shortcuts</li>'),n.push("<li><strong>Ctrl+Z</strong> / <strong>Ctrl+Y</strong> \u2014 Undo / Redo</li>"),n.push("<li><strong>P</strong> \u2014 Toggle pencil mode</li>"),n.push("<li><strong>1-9</strong> \u2014 Select color by number</li>"),n.push("<li><strong>+</strong> / <strong>-</strong> \u2014 Zoom in / out</li>")),e.innerHTML=n.join("")}function E(){const e=document.getElementById("help-modal");if(!e)return;A(),e.classList.add("visible"),document.body.style.overflow="hidden";const t=e.querySelector(".help-modal-close");t&&setTimeout(()=>t.focus(),100)}function b(){const e=document.getElementById("help-modal");e&&(e.classList.remove("visible"),document.body.style.overflow="")}function H(){const e=document.getElementById("help-btn"),t=document.getElementById("help-modal"),n=t==null?void 0:t.querySelector(".help-modal-backdrop"),o=t==null?void 0:t.querySelector(".help-modal-close");e&&e.addEventListener("click",E),n&&n.addEventListener("click",b),o&&o.addEventListener("click",b),document.addEventListener("keydown",i=>{if(t!=null&&t.classList.contains("visible")){if(i.key==="Escape"){b();return}i.key==="Tab"&&(document.activeElement!==o?(i.preventDefault(),o==null||o.focus()):i.preventDefault())}})}function M(){var e;(e=window.Cozy.Storage)!=null&&e.getFlag("helpShown")||setTimeout(()=>{var t;E(),(t=window.Cozy.Storage)==null||t.setFlag("helpShown",!0)},500)}function U(e){if(!e)return null;if(e.title!==void 0)return!e.width||!e.height||!e.row_clues||!e.col_clues||!e.color_map?(console.warn("[Game] Invalid verbose puzzle format:",e.title),null):e;if(!e.t||!e.w||!e.h||!e.r||!e.c||!e.p||!e.s)return console.warn("[Game] Invalid concise puzzle format, missing required fields"),null;if(e.w>R.MAX_PUZZLE_DIMENSION||e.h>R.MAX_PUZZLE_DIMENSION||e.w<1||e.h<1)return console.warn("[Game] Puzzle dimensions out of range:",e.w,"x",e.h),null;function t(s){const c=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(s);return c?[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]:[0,0,0]}function n(s){return s.map(c=>c.map(([g,C])=>({count:g,color:C+1})))}function o(s){const c={};return s.forEach((g,C)=>{c[C+1]=t(g)}),c}function i(s){return s.map(c=>c.map(g=>g<0?0:g+1))}return{title:e.t,width:e.w,height:e.h,row_clues:n(e.r),col_clues:n(e.c),color_map:o(e.p),solution:i(e.s)}}let G=null,l=null;function r(){const e=window.PUZZLE_DATA||[];return(!G||e!==l)&&(G=e.map(U).filter(t=>t!==null),l=e),G}function f(e=null,t=!0){return{value:e,certain:t}}function y(e,t){var n;return((n=d[e])==null?void 0:n[t])||f()}function m(e,t,n,o){d[e][t]={value:n,certain:o}}function O(e){return`rgb(${e[0]}, ${e[1]}, ${e[2]})`}function w(e){return(e[0]*299+e[1]*587+e[2]*114)/1e3}function x(e){const t=e.toLowerCase();return t.includes("easy")?"easy":t.includes("medium")?"medium":t.includes("hard")?"hard":t.includes("challenging")?"challenging":t.includes("expert")?"expert":"easy"}function Z(){return window.Cozy.Storage||null}function $(){return window.Cozy.History||null}function te(){const e=r()[T];if(!e)return!0;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++)if(y(t,n).value!==null)return!1;return!0}function ce(){const e=r()[T];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=y(t,n),i=e.solution[t][n];if(o.value!==i||!o.certain)return!1}return!0}function j(){const e=document.getElementById("reset-btn"),t=document.getElementById("solution-btn");if(e){const n=te();e.disabled=n,e.setAttribute("aria-label",n?"Reset (puzzle is empty)":"Hold to reset puzzle")}if(t){const n=ce();t.disabled=n,t.setAttribute("aria-label",n?"Solution (already shown)":"Hold to reveal solution")}}function ze(e){const t=document.getElementById("sr-announcer");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},50))}function fe(e){W=e,Ae(),ze(e?"Pencil mode":"Pen mode"),Ee()}function Ce(){fe(!W)}function Ae(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("palette-menu-btn");if(e&&(e.classList.toggle("active",!W),e.setAttribute("aria-checked",String(!W))),t&&(t.classList.toggle("active",W),t.setAttribute("aria-checked",String(W))),n){const o=n.querySelector(".menu-icon-svg");o&&(o.removeAttribute("stroke"),o.removeAttribute("stroke-width"),o.setAttribute("fill","currentColor"),W?o.innerHTML='<path d="M19.07 13.88L13 19.94l-1.41-1.41 6.07-6.06 1.41 1.41zm-5.66-5.66l-6.06 6.07-1.42-1.41 6.07-6.07 1.41 1.41zM17.66 5.99l-2.34 2.34 1.41 1.41 2.34-2.34-1.41-1.41zM3 18v3h3l.01-.01L3 18zm3-3l-1 1 3 3 1-1-3-3z" opacity="0.5"/><path d="M9.17 16.17L7.76 17.59l3.54 3.54 1.41-1.41-3.54-3.55zm10.6-10.6l-3.53-3.54-1.42 1.42 3.54 3.53 1.41-1.41z"/>':o.innerHTML='<path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>')}document.body.classList.toggle("pencil-mode",W)}function Ue(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");if(!e||!t)return;e.classList.contains("open")?Ee():Ge()}function Ge(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");!e||!t||(e.classList.add("open"),t.classList.add("menu-open"),t.setAttribute("aria-expanded","true"),setTimeout(()=>{document.addEventListener("click",Re)},0))}function Ee(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");e&&(e.classList.remove("open"),t&&(t.classList.remove("menu-open"),t.setAttribute("aria-expanded","false")),document.removeEventListener("click",Re))}function Re(e){const t=document.getElementById("mode-menu"),n=document.getElementById("palette-menu-btn");!t||!n||!t.contains(e.target)&&!n.contains(e.target)&&Ee()}function Fe(){const e=r()[T];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=y(t,n);if(!o.certain&&o.value!==null)return!0}return!1}function $e(){const e=r()[T];if(!e)return 0;let t=0;for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=y(n,o);!i.certain&&i.value!==null&&t++}return t}function ue(){const e=document.getElementById("pencil-actions-section"),t=document.getElementById("palette-menu-btn"),n=Fe(),o=n?$e():0;if(e&&e.classList.toggle("has-marks",n),t){t.classList.toggle("has-pencil-marks",n);const i=t.querySelector(".pencil-badge");i&&(i.textContent=o>99?"99+":String(o))}}function He(){const e=r()[T];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=y(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:null,certain:!0}}),m(n,o,null,!0),de(n,o,e))}if(t.length>0){const n=$();n&&n.recordBatchAction("batch-clear",t),window.Cozy.App&&window.Cozy.App.vibrate(20)}ue(),Se()}function xe(){const e=r()[T];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=y(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:i.value,certain:!0}}),m(n,o,i.value,!0),de(n,o,e))}if(t.length>0){const n=$();n&&n.recordBatchAction("batch-confirm",t),window.Cozy.App&&window.Cozy.App.vibrate([20,50,20])}ue(),Me(e),Se()}function Ne(){const e=$();if(!e)return;const t=e.undo();if(!t)return;const n=r()[T];for(const o of t)m(o.row,o.col,o.state.value,o.state.certain),de(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),ue(),ve(n),j(),Se()}function De(){const e=$();if(!e)return;const t=e.redo();if(!t)return;const n=r()[T];for(const o of t)m(o.row,o.col,o.state.value,o.state.certain),de(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),ue(),ve(n),j(),Me(n),Se()}function Se(){const e=Z();if(!e)return;const n=r()[T];if(!n)return;const o=L(n);e.savePuzzleGrid(o,d),e.saveSession(T,k,d)}function qe(){const e=Z();e&&e.clearSession()}function Xe(){const e=r(),t=document.getElementById("puzzle-select"),n=[...new Set(e.map(g=>x(g.title)))],o=["easy","medium","hard","challenging","expert"];n.sort((g,C)=>o.indexOf(g)-o.indexOf(C));const i=document.createElement("div");i.className="difficulty-tabs",n.forEach(g=>{const C=document.createElement("button");C.className="difficulty-tab"+(g===k?" active":""),C.textContent=g.charAt(0).toUpperCase()+g.slice(1),C.onclick=()=>{k=g,document.querySelectorAll(".difficulty-tab").forEach(F=>F.classList.remove("active")),C.classList.add("active"),ke()},i.appendChild(C)});const s=document.createElement("div");s.className="puzzle-dropdown";const c=document.createElement("select");c.id="puzzle-select-dropdown",c.onchange=g=>{be(parseInt(g.target.value))},s.appendChild(c),t.appendChild(i),t.appendChild(s),ke()}function ke(){var i;const e=r(),t=document.getElementById("puzzle-select-dropdown");if(!t)return;const n=Z();if(t.innerHTML="",e.forEach((s,c)=>{if(x(s.title)===k){const g=document.createElement("option");g.value=c;const C=L(s),F=n?n.isPuzzleCompleted(C):!1;g.textContent=(F?"\u2713 ":"")+s.title,c===T&&(g.selected=!0),t.appendChild(g)}}),e.filter(s=>x(s.title)===k).length>0&&!(x((i=e[T])==null?void 0:i.title)===k)){const c=e.findIndex(g=>x(g.title)===k);c>=0&&be(c)}}function be(e,t=null){if(ne){console.warn("[Game] Puzzle already loading, ignoring request");return}ne=!0;try{const n=r(),o=Z(),i=$();if(e!==T&&d.length>0&&n[T]&&o){const X=L(n[T]);o.savePuzzleGrid(X,d)}i&&i.clear(),W=!1,Ae(),J=0,_=0,T=e;const s=n[e];if(!s){ne=!1;return}if(s.width>R.MAX_PUZZLE_DIMENSION||s.height>R.MAX_PUZZLE_DIMENSION||s.width<1||s.height<1){console.error(`[Game] Invalid puzzle dimensions: ${s.width}x${s.height}`),ne=!1;return}const c=L(s);let g=t;!g&&o&&(g=o.getPuzzleGrid(c));const C=g&&g.length===s.height;if(C)d=g.map(X=>X.map(ie=>({value:ie.value,certain:ie.certain})));else{d=[];for(let X=0;X<s.height;X++){d.push([]);for(let ie=0;ie<s.width;ie++)d[X][ie]=f(null,!0)}}if(S=1,Ve(s),u(s),Pe(s),it(),C)for(let X=0;X<s.height;X++)for(let ie=0;ie<s.width;ie++)y(X,ie).value!==null&&de(X,ie,s);z();const F=document.getElementById("puzzle-select-dropdown");F&&(F.value=e);const K=x(s.title);K!==k&&(k=K,document.querySelectorAll(".difficulty-tab").forEach(X=>{X.classList.toggle("active",X.textContent.toLowerCase()===K)}),ke()),ue(),ve(s),window.Cozy.Zoom&&window.Cozy.Zoom.initForPuzzle(s),M(),j()}finally{ne=!1}}function Ve(e){const t=document.getElementById("palette"),n=document.getElementById("mode-menu"),o=n?n.parentNode:null;n&&t.contains(n)&&document.body.appendChild(n),t.innerHTML="";const i=document.createElement("button");i.className="color-btn eraser",i.title="Eraser",i.setAttribute("aria-label","Eraser"),i.setAttribute("aria-pressed",S===0?"true":"false"),i.addEventListener("click",()=>pe(0)),t.appendChild(i),Object.entries(e.color_map).forEach(([C,F])=>{const K=document.createElement("button"),X=parseInt(C)===S;K.className="color-btn"+(X?" selected":""),K.style.background=O(F),K.setAttribute("aria-label",`Color ${C}`),K.setAttribute("aria-pressed",X?"true":"false"),K.addEventListener("click",()=>pe(parseInt(C))),t.appendChild(K)});const s=document.createElement("button");s.className="palette-menu-btn",s.id="palette-menu-btn",s.title="Drawing mode",s.setAttribute("aria-label","Drawing mode menu"),s.setAttribute("aria-haspopup","true"),s.setAttribute("aria-expanded","false"),s.innerHTML=`
      <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>
      </svg>
      <span class="pencil-badge">0</span>
    `,s.addEventListener("click",C=>{C.stopPropagation(),Ue()}),t.appendChild(s);const c=document.getElementById("mode-menu");c&&t.appendChild(c);const g=t.querySelectorAll(".color-btn, .palette-menu-btn").length;t.classList.remove("palette-8-buttons","palette-7-buttons"),g>=8?t.classList.add("palette-8-buttons"):g===7&&t.classList.add("palette-7-buttons")}function pe(e){S=e;const n=r()[T];document.querySelectorAll(".color-btn").forEach((o,i)=>{let s;i===0?s=e===0:s=parseInt(Object.keys(n.color_map)[i-1])===e,o.classList.toggle("selected",s),o.setAttribute("aria-pressed",s?"true":"false")})}function u(e){V=[],se=[];const t=document.getElementById("col-clues");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,e.col_clues.forEach((o,i)=>{const s=document.createElement("div");if(s.className="col-clue",s.dataset.col=i,o.length===0){const c=document.createElement("div");c.className="clue-cell",c.textContent="0",c.style.background="#333",s.appendChild(c)}else o.forEach(c=>{const g=document.createElement("div");g.className="clue-cell",g.textContent=c.count,g.style.background=O(e.color_map[c.color]),g.style.color=w(e.color_map[c.color])>128?"#000":"#fff",g.style.cursor="pointer",g.onclick=()=>pe(c.color),s.appendChild(g)});V[i]=s,t.appendChild(s)});const n=document.getElementById("row-clues-container");n.innerHTML="",n.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,e.row_clues.forEach((o,i)=>{const s=document.createElement("div");if(s.className="row-clues",s.dataset.row=i,o.length===0){const c=document.createElement("div");c.className="row-clue-cell",c.textContent="0",c.style.background="#333",s.appendChild(c)}else o.forEach(c=>{const g=document.createElement("div");g.className="row-clue-cell",g.textContent=c.count,g.style.background=O(e.color_map[c.color]),g.style.color=w(e.color_map[c.color])>128?"#000":"#fff",g.style.cursor="pointer",g.onclick=()=>pe(c.color),s.appendChild(g)});se[i]=s,n.appendChild(s)})}let I=-1,B=-1;function Y(e,t){var o;if(h()||e===I&&t===B||(oe(),I=e,B=t,e<0||t<0)||!q[e])return;const n=q[e];if(n)for(let i=0;i<n.length;i++){const s=n[i];s&&(s.classList.add("highlight-row"),i===t&&s.classList.add("highlight-cell"))}for(let i=0;i<q.length;i++)i!==e&&((o=q[i])!=null&&o[t])&&q[i][t].classList.add("highlight-col");se[e]&&se[e].classList.add("highlight-clue"),V[t]&&V[t].classList.add("highlight-clue")}function oe(){var n;const e=I,t=B;if(I=-1,B=-1,!(e<0&&t<0)){if(e>=0&&q[e])for(let o=0;o<q[e].length;o++){const i=q[e][o];i&&i.classList.remove("highlight-row","highlight-cell")}if(t>=0)for(let o=0;o<q.length;o++){const i=(n=q[o])==null?void 0:n[t];i&&i.classList.remove("highlight-col")}e>=0&&se[e]&&se[e].classList.remove("highlight-clue"),t>=0&&V[t]&&V[t].classList.remove("highlight-clue")}}function le(e,t){var i,s;const n=r()[T];if(!n||e<0||e>=n.height||t<0||t>=n.width)return;(i=q[J])!=null&&i[_]&&(q[J][_].tabIndex=-1),J=e,_=t;const o=(s=q[e])==null?void 0:s[t];o&&(o.tabIndex=0,o.focus())}function ae(e,t){const n=document.createElement("div");return n.className="cell",n.dataset.row=e,n.dataset.col=t,n.tabIndex=e===J&&t===_?0:-1,n.setAttribute("role","gridcell"),n.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}`),n}function he(e,t,n){e.onfocus=()=>{var o;(J!==t||_!==n)&&((o=q[J])!=null&&o[_]&&(q[J][_].tabIndex=-1),J=t,_=n,e.tabIndex=0),Y(t,n)}}function ye(e,t,n){e.onkeydown=o=>{if(o.key==="ArrowUp")o.preventDefault(),le(t-1,n);else if(o.key==="ArrowDown")o.preventDefault(),le(t+1,n);else if(o.key==="ArrowLeft")o.preventDefault(),le(t,n-1);else if(o.key==="ArrowRight")o.preventDefault(),le(t,n+1);else if(o.key==="Enter"||o.key===" "){o.preventDefault();const i=$();i&&i.beginAction("fill"),me(t,n,S,!W),i&&i.commitAction(),ue()}else if(o.key==="x"||o.key==="X"){o.preventDefault(),o.stopPropagation();const i=$();i&&i.beginAction("fill"),me(t,n,0,!W),i&&i.commitAction(),ue()}}}function Ie(e,t,n){e.onmousedown=o=>{o.preventDefault(),e.focus();const i=$();i&&i.beginAction("fill"),a=!0,D=o.button===2?0:S,N=!W,me(t,n,D,N);const s=y(t,n);D=s.value,N=s.certain},e.onmouseenter=()=>{Y(t,n),a&&me(t,n,D,N,!0)},e.oncontextmenu=o=>{o.preventDefault()}}function Le(e,t,n){let o=null,i=0,s=!1,c=t,g=n;e.ontouchstart=C=>{var X,ie;if(C.touches.length>1)return;if(C.preventDefault(),C.stopPropagation(),s=!1,i=Date.now(),c=t,g=n,window.Cozy.Zoom){const Te=(ie=(X=C.touches[0])==null?void 0:X.clientY)!=null?ie:0;window.Cozy.Zoom.onCellTouchStart(t,n,Te)}const F=$();F&&F.beginAction("fill"),a=!0,D=S,N=!W,o=setTimeout(()=>{if(!s){D=0,me(c,g,0,N);const Te=y(c,g);D=Te.value,N=Te.certain,window.Cozy.App&&window.Cozy.App.vibrate(50)}},R.LONG_PRESS_DELAY),me(t,n,D,N);const K=y(t,n);D=K.value,N=K.certain},e.ontouchmove=C=>{if(C.touches.length>1||!a)return;C.preventDefault(),C.stopPropagation(),s=!0,clearTimeout(o);const F=C.touches[0],K=document.elementFromPoint(F.clientX,F.clientY);if(K&&K.classList.contains("cell")){const X=parseInt(K.dataset.row),ie=parseInt(K.dataset.col);!isNaN(X)&&!isNaN(ie)&&(me(X,ie,D,N,!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchMove(X,ie))}},e.ontouchend=()=>{clearTimeout(o),Date.now()-i<R.LONG_PRESS_DELAY,a=!1,D=null;const F=$();F&&F.commitAction(),ue(),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()},e.ontouchcancel=()=>{clearTimeout(o),a=!1,D=null;const C=$();C&&C.cancelAction(),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()}}function Pe(e){const t=document.getElementById("grid");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,t.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,Q&&t.removeEventListener("mouseleave",Q),ee&&t.removeEventListener("focusout",ee),re&&document.removeEventListener("mouseup",re),q=[];for(let n=0;n<e.height;n++)q[n]=[];Q=()=>oe(),t.addEventListener("mouseleave",Q),ee=n=>{t.contains(n.relatedTarget)||oe()},t.addEventListener("focusout",ee);for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=ae(n,o);he(i,n,o),ye(i,n,o),Ie(i,n,o),Le(i,n,o),q[n][o]=i,t.appendChild(i)}re=()=>{if(a){a=!1,D=null;const n=$();n&&n.commitAction(),ue()}},document.addEventListener("mouseup",re)}function me(e,t,n,o,i){const s=r()[T],c=y(e,t),g=$();let C=n,F=o;i||(o&&!c.certain&&c.value===n&&n!==null?(C=c.value,F=!0):c.value===n&&c.certain===o&&n!==null&&(C=null,F=!0)),!(c.value===C&&c.certain===F)&&(g&&g.recordChange(e,t,c,{value:C,certain:F}),m(e,t,C,F),de(e,t,s),window.Cozy.App&&window.Cozy.App.vibrate(10),ve(s),j(),Me(s),Se())}function de(e,t,n){var s;const o=(s=q[e])==null?void 0:s[t];if(!o)return;const i=y(e,t);if(o.classList.remove("marked-empty","maybe-empty","maybe-color"),o.style.background="",o.style.setProperty("--cell-color",""),i.value===null)o.style.background="var(--color-cell)";else if(i.value===0)i.certain?o.classList.add("marked-empty"):o.classList.add("maybe-empty");else{const c=n.color_map[i.value];if(c){const g=`rgb(${c[0]}, ${c[1]}, ${c[2]})`;i.certain?o.style.background=g:(o.classList.add("maybe-color"),o.style.setProperty("--cell-color",g))}}}function we(e){const t=[];let n=null,o=0;for(const i of e)i>0?i===n?o++:(n!==null&&t.push({count:o,color:n}),n=i,o=1):n!==null&&(t.push({count:o,color:n}),n=null,o=0);return n!==null&&t.push({count:o,color:n}),t}function Be(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n].count!==t[n].count||e[n].color!==t[n].color)return!1;return!0}function ve(e){for(let t=0;t<e.height;t++){const n=[];for(let C=0;C<e.width;C++){const F=y(t,C);F.certain?n.push(F.value===null?0:F.value):n.push(-1)}const o=n.includes(-1),i=n.map(C=>C===-1?0:C),s=we(i),c=!o&&Be(s,e.row_clues[t]),g=se[t];g&&g.classList.toggle("satisfied",c)}for(let t=0;t<e.width;t++){const n=[];for(let C=0;C<e.height;C++){const F=y(C,t);F.certain?n.push(F.value===null?0:F.value):n.push(-1)}const o=n.includes(-1),i=n.map(C=>C===-1?0:C),s=we(i),c=!o&&Be(s,e.col_clues[t]),g=V[t];g&&g.classList.toggle("satisfied",c)}}function Me(e){for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++)if(!y(o,i).certain)return;for(let o=0;o<e.height;o++){const i=[];for(let c=0;c<e.width;c++){const g=y(o,c);i.push(g.value===null?0:g.value)}const s=we(i);if(!Be(s,e.row_clues[o]))return}for(let o=0;o<e.width;o++){const i=[];for(let c=0;c<e.height;c++){const g=y(c,o);i.push(g.value===null?0:g.value)}const s=we(i);if(!Be(s,e.col_clues[o]))return}window.Cozy.App&&window.Cozy.App.vibrate([50,100,50]);const t=Z();if(t){const o=L(e);t.completePuzzle(o),qe(),ke();const i=window.Cozy.Collection;i&&i.refresh()}const n=$();n&&n.clear(),ot(e)}function _e(){const e=r()[T];if(!e)return;const t=$(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const s=y(o,i);s.value!==null&&(n.push({row:o,col:i,before:{value:s.value,certain:s.certain},after:{value:null,certain:!0}}),s.value=null,s.certain=!0,de(o,i,e))}if(n.length>0){t&&t.recordBatchAction("reset",n),ve(e);const o=Z();if(o){const i=L(e);o.savePuzzleGrid(i,null)}ue()}j()}function Oe(){const e=r()[T];if(!e)return;window.Cozy.Zoom&&window.Cozy.Zoom.zoomToFit();const t=$(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const s=y(o,i),c=e.solution[o][i];(s.value!==c||!s.certain)&&n.push({row:o,col:i,before:{value:s.value,certain:s.certain},after:{value:c,certain:!0}}),s.value=c,s.certain=!0,de(o,i,e)}n.length>0&&t&&t.recordBatchAction("solution",n),ve(e),p("Solution revealed","info"),ue(),j()}function Qe(){document.addEventListener("keydown",e=>{var t,n,o;if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")){if((e.ctrlKey||e.metaKey)&&e.key==="z"&&!e.shiftKey&&(e.preventDefault(),Ne()),((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key==="z"||(e.ctrlKey||e.metaKey)&&e.key==="y")&&(e.preventDefault(),De()),e.key==="p"&&!e.ctrlKey&&!e.metaKey&&(e.preventDefault(),Ce()),e.key>="1"&&e.key<="9"&&!e.ctrlKey&&!e.metaKey){const i=parseInt(e.key),s=r()[T],c=Object.keys(s.color_map).map(Number);i<=c.length&&pe(c[i-1])}if((e.key==="0"||e.key==="x")&&!e.ctrlKey&&!e.metaKey&&pe(0),e.key==="Escape"&&!e.ctrlKey&&!e.metaKey){const i=document.getElementById("help-modal"),s=i==null?void 0:i.classList.contains("visible");((t=window.Cozy.Screens)==null?void 0:t.getCurrentScreen())===((o=(n=window.Cozy.Screens)==null?void 0:n.SCREENS)==null?void 0:o.PUZZLE)&&!s&&(e.preventDefault(),Ze())}}})}function Ye(){const e=r(),t=Z();if(d.length>0&&e[T]&&t){const n=L(e[T]);t.savePuzzleGrid(n,d)}}function Ze(){Ye(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION)}function et(e){window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:e})}function tt(e){const t=e.detail||{},n=r();let o=0;t.puzzleId!==void 0&&(o=t.puzzleId,typeof t.puzzleId=="string"&&(o=n.findIndex(i=>L(i)===t.puzzleId),o===-1&&(o=0))),be(o)}function nt(e){Ye();const t=e.detail||{},n=window.Cozy.Collection;n&&(t.animateStamp&&t.scrollToPuzzleId?n.refresh({blankPuzzleId:t.scrollToPuzzleId}):n.refresh(),t.scrollToPuzzleId&&setTimeout(()=>{n.scrollToPuzzle(t.scrollToPuzzleId,{instant:t.quickAnimation}),t.animateStamp&&t.flyingStamp&&n.animateStampTo(t.scrollToPuzzleId,t.flyingStamp,{quick:t.quickAnimation})},50))}function ot(e){if(window.Cozy.Screens){const t=L(e),n=e.title.match(/^(.+?)\s*\(/),o=n?n[1].trim():e.title;window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.VICTORY,{puzzleId:t,puzzleName:o,solution:e.solution,palette:e.color_map})}}function it(){const e=document.getElementById("current-puzzle-title");if(!e)return;const n=r()[T];if(n){const o=n.title.match(/^(.+?)\s*\(/);e.textContent=o?o[1].trim():n.title}}const Ke=1200;function We(e,t){if(!e)return;let n=null,o=!1;function i(c){c.type==="touchstart"&&c.preventDefault(),!e.disabled&&(o||(o=!0,e.classList.add("holding"),n=setTimeout(()=>{o&&(e.classList.add("hold-complete"),s(),t(),setTimeout(()=>e.classList.remove("hold-complete"),50))},Ke)))}function s(){o=!1,e.classList.remove("holding"),n&&(clearTimeout(n),n=null)}e.addEventListener("mousedown",i),e.addEventListener("mouseup",s),e.addEventListener("mouseleave",s),e.addEventListener("touchstart",i,{passive:!1}),e.addEventListener("touchend",s),e.addEventListener("touchcancel",s),e.addEventListener("keydown",c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),i(c))}),e.addEventListener("keyup",c=>{(c.key==="Enter"||c.key===" ")&&s()}),e.addEventListener("blur",s),e.style.setProperty("--hold-duration",`${Ke}ms`)}function st(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("undo-btn"),o=document.getElementById("redo-btn");e&&e.addEventListener("click",()=>fe(!1)),t&&t.addEventListener("click",()=>fe(!0)),n&&n.addEventListener("click",Ne),o&&o.addEventListener("click",De);const i=document.getElementById("clear-pencil-btn"),s=document.getElementById("confirm-pencil-btn");i&&i.addEventListener("click",()=>{He(),Ee()}),s&&s.addEventListener("click",()=>{xe(),Ee()});const c=document.getElementById("reset-btn"),g=document.getElementById("solution-btn");We(c,_e),We(g,Oe);const C=document.querySelector("#screen-puzzle .header-back-btn");C&&C.addEventListener("click",Je);const F=document.querySelector("#screen-collection .header-back-btn");F&&F.addEventListener("click",()=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.HOME)})}function je(){Qe(),st(),H();const e=$();e&&e.updateUI(),Ae();const t=Z();t&&t.onChange&&t.onChange(i=>{i==="reset"&&(d=[],T=0)});const n=window.Cozy.Collection,o=r();n&&o.length>0&&n.init("collection-screen",o,i=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:i})}),window.addEventListener("screen:puzzle",tt),window.addEventListener("screen:collection",nt),o.length>0&&be(0)}function lt(){const t=r()[T];if(!t||d.length===0)return null;let n=!1;for(let o=0;o<t.height&&!n;o++)for(let i=0;i<t.width&&!n;i++){const s=y(o,i);s.value!==null&&s.value>0&&(n=!0)}return n?P(t.width,t.height,R.STAMP_CANVAS_SIZE,(o,i)=>{const s=y(o,i);if(s.value!==null&&s.value>0){const c=t.color_map[s.value];if(c)return c}return null}):null}function Je(){const t=r()[T];if(!t){Ze();return}const n=L(t),o=lt();if(!o){Ze();return}const i=document.getElementById("grid");if(!i){Ze();return}const s=i.getBoundingClientRect(),c=document.createElement("canvas");c.width=o.width,c.height=o.height,c.getContext("2d").drawImage(o,0,0);const C=o.width/o.height,F=s.width/s.height;let K,X;C>F?(K=s.width,X=s.width/C):(X=s.height,K=s.height*C);const ie=(s.width-K)/2,Te=(s.height-X)/2;c.className="flying-stamp",c.style.left=s.left+ie+"px",c.style.top=s.top+Te+"px",c.style.width=K+"px",c.style.height=X+"px",document.body.appendChild(c),Ye(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION,{scrollToPuzzleId:n,animateStamp:!0,flyingStamp:c,quickAnimation:!0})}function rt(){d=[],T=0,S=1,a=!1,D=null,W=!1;const e=$();e&&e.clear()}function ct(e,t){const o=r()[T];if(!o)return null;const i=se[e],s=i?i.classList.contains("satisfied"):!1,c=o.row_clues[e].map(K=>({count:K.count,color:K.color,satisfied:s})),g=V[t],C=g?g.classList.contains("satisfied"):!1,F=o.col_clues[t].map(K=>({count:K.count,color:K.color,satisfied:C}));return{rowClues:c,colClues:F}}function at(e){const n=r()[T];return!n||!n.color_map?null:n.color_map[e]||null}function ut(){return r()[T]||null}window.Cozy.Garden={resetPuzzle:_e,showSolution:Oe,performUndo:Ne,performRedo:De,togglePencilMode:Ce,setPencilMode:fe,clearAllPencilMarks:He,confirmAllPencilMarks:xe,selectColor:pe,showCollection:Ze,showGame:et,clearAllState:rt,navigateToCollectionWithStamp:Je,getPuzzleId:L,getClueInfo:ct,getColorRgb:at,getCurrentPuzzle:ut},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",je):je()}(),function(){"use strict";const{CONFIG:R}=window.Cozy.Utils,L=.35,v=1,P=.97,T=300,k=1500,S=100,d=10;let a=v,D=v,N=!1,W=0,ne=0,J=null,_=null,re=null,Q=!1,ee=-1,q=-1,se=!1,V=null,ge=null,p=null,z=null,h=null,A=null,E=null,b=null;function H(u,I,B){return Math.min(Math.max(u,I),B)}function M(u,I){const B=u.clientX-I.clientX,Y=u.clientY-I.clientY;return Math.sqrt(B*B+Y*Y)}function U(u,I){return{x:(u.clientX+I.clientX)/2,y:(u.clientY+I.clientY)/2}}function G(){const u=window.innerWidth;return u<=360?20:u>=768?28:u>=1200?32:24}function l(u,I=!0){const B=V;if(!B)return;const Y=a,oe=w(),le=H(u,oe,R.MAX_ZOOM);let ae,he;I&&Y!==le&&(ae=B.scrollLeft+B.clientWidth/2,he=B.scrollTop+B.clientHeight/2),a=le;const ye=G(),Ie=Math.round(ye*le);document.documentElement.style.setProperty("--cell-size",`${Ie}px`);const Le=m(),Pe=le>Le+.01;B.classList.toggle("is-zoomed",Pe),r(),I&&Y!==le&&ae!==void 0&&requestAnimationFrame(()=>{const me=le/Y,de=ae*me-B.clientWidth/2,we=he*me-B.clientHeight/2;B.scrollLeft=Math.max(0,de),B.scrollTop=Math.max(0,we)}),window.dispatchEvent(new CustomEvent("zoomchange",{detail:{zoom:le,oldZoom:Y,isZoomed:Pe}}))}function r(){const u=w();if(A&&(A.disabled=a>=R.MAX_ZOOM),E&&(E.disabled=a<=u),b){const I=m(),B=Math.abs(a-I)<.05;b.classList.toggle("highlighted",!B&&a!==I)}}let f=null,y=null;function m(u=!1){var _e;const I=V;if(!I||!((_e=window.Cozy.Garden)!=null&&_e.getCurrentPuzzle))return v;const B=window.Cozy.Garden.getCurrentPuzzle();if(!B)return v;const Y=B.title;if(!u&&f!==null&&y===Y)return f;const oe=G(),le=Math.max(...B.row_clues.map(Oe=>Oe.length)),ae=Math.max(...B.col_clues.map(Oe=>Oe.length)),he=Math.max(2,le*.6+.5),ye=Math.max(2,ae*.6+.5),Ie=B.width+he+.25,Le=B.height+ye+.25,Pe=I.clientWidth,me=I.clientHeight,de=8,we=(Pe-de*2)/(Ie*oe),Be=(me-de*2)/(Le*oe),ve=Math.min(we,Be),Me=H(ve*P,L,R.MAX_ZOOM);return f=Me,y=Y,Me}function O(){f=null,y=null}function w(){const u=m();return Math.max(L,u)}function x(){const u=m();return a>u+.01}function Z(u){u.touches.length===2&&(N=!0,W=M(u.touches[0],u.touches[1]),D=a,u.preventDefault())}function $(u){if(N&&u.touches.length===2){const B=M(u.touches[0],u.touches[1])/W,Y=w(),oe=H(D*B,Y,R.MAX_ZOOM);Math.abs(oe-a)>.05&&l(oe,!0),u.preventDefault()}}function te(u){if(N&&u.touches.length<2&&(N=!1),u.touches.length===0&&!N){const I=u.target;if(!I.classList.contains("cell")){const Y=Date.now();J===I&&Y-ne<T?(ce(u.changedTouches[0]),ne=0,J=null):(ne=Y,J=I)}}}function ce(u){x()?l(m(),!0):l(R.COMFORTABLE_ZOOM,!0)}function j(u){if(u.ctrlKey){u.preventDefault();const I=u.deltaY>0?-.15:.15;l(a+I,!0)}}function ze(){p&&x()&&p.classList.add("visible")}function fe(){p&&(p.classList.remove("visible"),ee=-1,q=-1)}function Ce(u,I){var Y,oe;if(!p||Q||u===ee&&I===q)return;ee=u,q=I;const B=(oe=(Y=window.Cozy.Garden)==null?void 0:Y.getClueInfo)==null?void 0:oe.call(Y,u,I);B&&(z&&(z.innerHTML=Ae(B.rowClues)),h&&(h.innerHTML=Ae(B.colClues)))}function Ae(u){return!u||u.length===0?'<span class="clue-tooltip-num satisfied">0</span>':u.map(I=>{var ae,he;const B=((he=(ae=window.Cozy.Garden)==null?void 0:ae.getColorRgb)==null?void 0:he.call(ae,I.color))||[128,128,128],Y=I.satisfied,le=(B[0]*299+B[1]*587+B[2]*114)/1e3>128?"#333":"#fff";return`<span class="clue-tooltip-num${Y?" satisfied":""}"
                    style="background: rgb(${B.join(",")}); color: ${le}">
                ${I.count}
              </span>`}).join("")}function Ue(u){if(!p||!V)return;const I=V.getBoundingClientRect(),B=I.top+I.height/2;u>B?(p.classList.add("position-top"),p.classList.remove("position-bottom")):(p.classList.remove("position-top"),p.classList.add("position-bottom"))}function Ge(){clearTimeout(_),_=setTimeout(()=>{fe()},k)}function Ee(){clearTimeout(_)}function Re(u,I,B){x()&&(Q=!1,Ee(),clearTimeout(re),re=setTimeout(()=>{Ce(u,I),Ue(B),ze()},S))}function Fe(){x()&&(Q=!0,p==null||p.classList.add("dragging"))}function $e(){x()&&(clearTimeout(re),Q=!1,p==null||p.classList.remove("dragging"),Ge())}function ue(){A=document.querySelector(".zoom-btn.zoom-in"),E=document.querySelector(".zoom-btn.zoom-out"),b=document.querySelector(".zoom-btn.zoom-fit"),A&&A.addEventListener("click",()=>{l(a+.5,!0)}),E&&E.addEventListener("click",()=>{l(a-.5,!0)}),b&&b.addEventListener("click",()=>{l(m(),!0)}),r()}function He(u){const I=document.getElementById("screen-puzzle");!I||I.classList.contains("screen-hidden")||(u.key==="+"||u.key==="="?(u.preventDefault(),l(a+.5,!0)):u.key==="-"||u.key==="_"?(u.preventDefault(),l(a-.5,!0)):u.key==="0"&&(u.preventDefault(),l(m(),!0)))}let xe=null;function Ne(){clearTimeout(xe),xe=setTimeout(()=>{const u=document.getElementById("screen-puzzle");if(!u||u.classList.contains("screen-hidden"))return;O();const I=w();a<I&&l(I,!1),r()},150)}function De(){var I,B,Y,oe;const u=(B=(I=window.Cozy.Garden)==null?void 0:I.getCurrentPuzzle)==null?void 0:B.call(I);u&&(u.width<=10&&u.height<=10||(Y=window.Cozy.Storage)!=null&&Y.getFlag("zoomHintShown")||(Se(),(oe=window.Cozy.Storage)==null||oe.setFlag("zoomHintShown",!0)))}function Se(){let u=document.getElementById("zoom-hint-toast");u||(u=document.createElement("div"),u.id="zoom-hint-toast",u.className="zoom-hint-toast",u.textContent="Tip: Pinch to zoom for easier tapping",document.body.appendChild(u)),u.classList.add("visible"),setTimeout(()=>{u.classList.remove("visible")},4e3)}function qe(){if(!se){if(V=document.getElementById("zoom-container"),ge=V==null?void 0:V.querySelector(".board-wrapper"),p=document.getElementById("clue-tooltip"),z=document.getElementById("tooltip-row-clues"),h=document.getElementById("tooltip-col-clues"),!V){console.warn("[Zoom] zoom-container not found, zoom disabled");return}V.addEventListener("touchstart",Z,{passive:!1}),V.addEventListener("touchmove",$,{passive:!1}),V.addEventListener("touchend",te,{passive:!0}),V.addEventListener("wheel",j,{passive:!1}),ue(),document.addEventListener("keydown",He),window.addEventListener("resize",Ne),se=!0,console.log("[Zoom] Initialized")}}function Xe(){O();const u=m();l(u,!1),setTimeout(De,500)}function ke(){be(!1),fe(),clearTimeout(_),clearTimeout(re)}function be(u=!0){pe(v,u)}function Ve(u=!0){const I=m();pe(I,u)}function pe(u,I=!0){if(I&&a!==u){let le=function(ae){const he=ae-oe,ye=Math.min(he/Y,1),Ie=1-Math.pow(1-ye,3),Le=B+(u-B)*Ie;l(Le,!1),ye<1&&requestAnimationFrame(le)};const B=a,Y=200,oe=performance.now();requestAnimationFrame(le)}else l(u,!1)}window.Cozy.Zoom={init:qe,initForPuzzle:Xe,destroy:ke,resetZoom:be,zoomToFit:Ve,getZoom:()=>a,setZoom:(u,I=!0)=>l(u,!I),zoomIn:(u=.5)=>l(a+u,!0),zoomOut:(u=.5)=>l(a-u,!0),isZoomed:x,onCellTouchStart:Re,onCellTouchMove:Fe,onCellTouchEnd:$e,getEffectiveMinZoom:w}}();

//# sourceMappingURL=app.min.js.map