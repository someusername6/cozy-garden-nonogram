(function(){"use strict";const _={STAMP_CANVAS_SIZE:180,VICTORY_CANVAS_SIZE:180,MINI_CANVAS_SIZE:80,OUTLINE_THICKNESS:2,MAX_PUZZLE_DIMENSION:32,MAX_HISTORY:50,MAX_SCREEN_HISTORY:10,MAX_SEARCH_LENGTH:100,TOAST_DURATION:2500,LONG_PRESS_DELAY:400,SEARCH_DEBOUNCE:150,MAX_ZOOM:3,COMFORTABLE_ZOOM:2,AUTO_ZOOM_MIN_SIZE:10,BRIGHTNESS_MIDPOINT:128,BADGE_MAX_DISPLAY:99};function E(c){return(c.t||c.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"")}function $(c){return c.t||c.title}function Z(c){const r=c.match(/^(.+?)\s*\((\d+)x(\d+),\s*(\w+)\)$/i);return r?{name:r[1].trim(),width:parseInt(r[2],10),height:parseInt(r[3],10),difficulty:r[4].toLowerCase()}:{name:c,width:0,height:0,difficulty:"unknown"}}function D(c,r,M,B={}){return!c||c.hasAttribute("data-initialized")?!1:(c.addEventListener(r,M,B),c.setAttribute("data-initialized","true"),!0)}function z(c,r,M={}){const B=document.createElement("canvas");B.width=c.width,B.height=c.height,B.getContext("2d").drawImage(c,0,0);const R=c.width/c.height,se=r.width/r.height;let W,J;if(M.useScale){W=c.width,J=c.height;const ee=Math.min(r.width,r.height),X=(R>1?ee:ee*R)/W;B.style.transform="scale("+X+")"}else R>se?(W=r.width,J=r.width/R):(J=r.height,W=r.height*R);const G=r.left+r.width/2,re=r.top+r.height/2;return B.className="flying-stamp",B.style.left=G-W/2+"px",B.style.top=re-J/2+"px",B.style.width=W+"px",B.style.height=J+"px",document.body.appendChild(B),B}function A(c,r,M,B){const ie=Math.max(c,r),R=Math.max(2,Math.floor(M/ie)),se=_.OUTLINE_THICKNESS*2,W=_.OUTLINE_THICKNESS,J=document.createElement("canvas");J.width=c*R+se,J.height=r*R+se;const G=J.getContext("2d");if(!G)return console.warn("[Utils] Failed to get 2D context for canvas"),J;try{const re=getComputedStyle(document.documentElement).getPropertyValue("--color-text-muted").trim()||"#8a8a7a";G.fillStyle=re;for(let ee=0;ee<r;ee++)for(let F=0;F<c;F++)if(B(ee,F)){const ce=W+F*R,Q=W+ee*R;G.fillRect(ce-_.OUTLINE_THICKNESS,Q-_.OUTLINE_THICKNESS,R+se,R+se)}for(let ee=0;ee<r;ee++)for(let F=0;F<c;F++){const X=B(ee,F);if(X){G.fillStyle=`rgb(${X[0]}, ${X[1]}, ${X[2]})`;const ce=W+F*R,Q=W+ee*R;G.fillRect(ce,Q,R,R)}}}catch(re){console.error("[Utils] Failed to render canvas:",re)}return J}window.Cozy=window.Cozy||{},window.Cozy.Utils={CONFIG:_,getPuzzleId:E,getPuzzleTitle:$,parsePuzzleTitle:Z,initOnce:D,createFlyingStamp:z,renderOutlinedCanvas:A}})(),function(){"use strict";const _="cozy_garden_data";function $(A){return!(!A||typeof A!="object"||typeof A.version!="number"||A.progress!==null&&typeof A.progress!="object"||A.settings!==null&&typeof A.settings!="object"||A.stats!==null&&typeof A.stats!="object")}function Z(){return{version:1,progress:{},settings:{vibration:!0,theme:"light"},stats:{totalCompleted:0,totalAttempts:0,totalPlayTime:0,streak:0,lastPlayDate:null},currentSession:{puzzleIndex:0,difficulty:"easy",grid:null,startTime:null},flags:{tutorialCompleted:!1,helpShown:!1,zoomHintShown:!1},uiState:{collapsedSections:[]}}}class D{constructor(){this.data=null,this.listeners=[]}init(){try{const c=localStorage.getItem(_);if(c){const r=JSON.parse(c);$(r)?this.data=r:(console.warn("[Storage] Invalid data structure, using defaults"),this.data=Z(),this.save())}else this.data=Z(),this.save()}catch(c){console.warn("[Storage] Failed to load, using defaults:",c),this.data=Z(),this.save()}return this}save(){try{return localStorage.setItem(_,JSON.stringify(this.data)),this.notifyListeners("save"),!0}catch(c){return console.error("[Storage] Failed to save:",c),!1}}onChange(c){return this.listeners.push(c),()=>{this.listeners=this.listeners.filter(r=>r!==c)}}notifyListeners(c){this.listeners.forEach(r=>r(c,this.data))}getPuzzleProgress(c){return this.data.progress[c]||{completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}}savePuzzleGrid(c,r){this.data.progress||(this.data.progress={}),this.data.progress[c]||(this.data.progress[c]={completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}),r?this.data.progress[c].savedGrid=r.map(M=>M.map(B=>({value:B.value,certain:B.certain}))):this.data.progress[c].savedGrid=null,this.save()}getPuzzleGrid(c){if(!this.data.progress)return null;const r=this.data.progress[c];return!r||!r.savedGrid?null:r.savedGrid.map(M=>M.map(B=>({value:B.value,certain:B.certain})))}completePuzzle(c){const r=this.getPuzzleProgress(c),M=!r.completed;return r.completed=!0,r.attempts+=1,r.lastPlayed=Date.now(),r.savedGrid=null,this.data.progress[c]=r,M&&(this.data.stats.totalCompleted+=1),this.data.stats.totalAttempts+=1,this.updateStreak(),this.save(),{wasNew:M,progress:r}}isPuzzleCompleted(c){var r;return((r=this.data.progress[c])==null?void 0:r.completed)||!1}getCompletionStats(){return{easy:{completed:0,total:0},medium:{completed:0,total:0},hard:{completed:0,total:0},challenging:{completed:0,total:0},expert:{completed:0,total:0}}}saveSession(c,r,M){let B=null;M&&(B=M.map(ie=>ie.map(R=>({value:R.value,certain:R.certain})))),this.data.currentSession={puzzleIndex:c,difficulty:r,grid:B},this.save()}getSession(){return this.data.currentSession}clearSession(){this.data.currentSession={puzzleIndex:0,difficulty:"easy",grid:null},this.save()}getSetting(c){return this.data.settings[c]}setSetting(c,r){this.data.settings[c]=r,this.save(),this.notifyListeners("settings")}getSettings(){return{...this.data.settings}}getStats(){return{...this.data.stats}}addPlayTime(c){this.data.stats.totalPlayTime+=c,this.save()}updateStreak(){const c=new Date().toDateString(),r=this.data.stats.lastPlayDate;if(r===c)return;const M=new Date(Date.now()-864e5).toDateString();r===M?this.data.stats.streak+=1:r!==c&&(this.data.stats.streak=1),this.data.stats.lastPlayDate=c}getFlag(c){var r;return((r=this.data.flags)==null?void 0:r[c])||!1}setFlag(c,r=!0){this.data.flags||(this.data.flags={}),this.data.flags[c]=r,this.save()}getUIState(c){var r;return(r=this.data.uiState)==null?void 0:r[c]}setUIState(c,r){this.data.uiState||(this.data.uiState={}),this.data.uiState[c]=r,this.save()}exportData(){return JSON.stringify(this.data,null,2)}importData(c){try{const r=JSON.parse(c);return $(r)?(this.data=r,this.save(),!0):!1}catch(r){return console.error("[Storage] Import failed:",r),!1}}reset(){this.data=Z(),this.save(),this.notifyListeners("reset")}}const z=new D().init();window.Cozy.Storage=z}(),function(){"use strict";const{CONFIG:_}=window.Cozy.Utils;let E=[],$=[],Z=null;const D={beginAction(z="fill"){Z&&Z.changes.length>0&&this.commitAction(),Z={type:z,changes:[],timestamp:Date.now()}},recordChange(z,A,c,r){if(c.value===r.value&&c.certain===r.certain)return;Z||this.beginAction("fill");const M=Z.changes.find(B=>B.row===z&&B.col===A);M?M.after={value:r.value,certain:r.certain}:Z.changes.push({row:z,col:A,before:{value:c.value,certain:c.certain},after:{value:r.value,certain:r.certain}})},commitAction(){Z&&Z.changes.length>0&&(Z.changes=Z.changes.filter(z=>z.before.value!==z.after.value||z.before.certain!==z.after.certain),Z.changes.length>0&&(E.push(Z),E.length>_.MAX_HISTORY&&E.shift(),$=[]),this.updateUI()),Z=null},cancelAction(){Z=null},recordBatchAction(z,A){if(A.length===0)return;const c={type:z,changes:A.map(r=>({row:r.row,col:r.col,before:{value:r.before.value,certain:r.before.certain},after:{value:r.after.value,certain:r.after.certain}})),timestamp:Date.now()};E.push(c),E.length>_.MAX_HISTORY&&E.shift(),$=[],this.updateUI()},undo(){if(E.length===0)return null;const z=E.pop();return $.push(z),this.updateUI(),z.changes.map(A=>({row:A.row,col:A.col,state:{value:A.before.value,certain:A.before.certain}}))},redo(){if($.length===0)return null;const z=$.pop();return E.push(z),this.updateUI(),z.changes.map(A=>({row:A.row,col:A.col,state:{value:A.after.value,certain:A.after.certain}}))},canUndo(){return E.length>0},canRedo(){return $.length>0},clear(){E=[],$=[],Z=null,this.updateUI()},updateUI(){const z=document.getElementById("undo-btn"),A=document.getElementById("redo-btn");z&&(z.disabled=!this.canUndo()),A&&(A.disabled=!this.canRedo())},getStats(){return{undoDepth:E.length,redoDepth:$.length,hasPending:Z!==null,pendingChanges:Z?Z.changes.length:0}}};window.Cozy.History=D}();const ScreenManager=function(){"use strict";const{CONFIG:_,initOnce:E,createFlyingStamp:$,renderOutlinedCanvas:Z}=window.Cozy.Utils,D={SPLASH:"splash",HOME:"home",COLLECTION:"collection",PUZZLE:"puzzle",VICTORY:"victory",SETTINGS:"settings",TUTORIAL:"tutorial"};let z=null,A=[],c={},r={},M=null;function B(s){const f=document.getElementById("confirm-modal"),u=document.getElementById("confirm-modal-title"),v=document.getElementById("confirm-modal-message"),b=document.getElementById("confirm-modal-confirm"),U=document.getElementById("confirm-modal-cancel");f&&(u.textContent=s.title||"Confirm",v.textContent=s.message||"Are you sure?",b.textContent=s.confirmText||"Confirm",U.textContent=s.cancelText||"Cancel",b.classList.toggle("confirm-modal-btn-danger",!!s.danger),b.classList.toggle("confirm-modal-btn-primary",!s.danger),f.classList.remove("alert-mode"),M=s,f.classList.add("visible"),setTimeout(()=>b.focus(),100))}function ie(s){const f=document.getElementById("confirm-modal"),u=document.getElementById("confirm-modal-title"),v=document.getElementById("confirm-modal-message"),b=document.getElementById("confirm-modal-confirm");f&&(u.textContent=s.title||"Notice",v.textContent=s.message||"",b.textContent=s.buttonText||"OK",b.classList.remove("confirm-modal-btn-danger"),b.classList.add("confirm-modal-btn-primary"),f.classList.add("alert-mode"),M={onConfirm:s.onClose},f.classList.add("visible"),setTimeout(()=>b.focus(),100))}function R(){const s=document.getElementById("confirm-modal");s&&s.classList.remove("visible"),M=null}function se(){const s=document.getElementById("confirm-modal"),f=s==null?void 0:s.querySelector(".confirm-modal-backdrop"),u=document.getElementById("confirm-modal-confirm"),v=document.getElementById("confirm-modal-cancel");s&&(u==null||u.addEventListener("click",()=>{const b=M==null?void 0:M.onConfirm;R(),b&&setTimeout(b,200)}),v==null||v.addEventListener("click",()=>{const b=M==null?void 0:M.onCancel;R(),b&&b()}),f==null||f.addEventListener("click",()=>{const b=M==null?void 0:M.onCancel;R(),b&&b()}),document.addEventListener("keydown",b=>{if(b.key==="Escape"&&s.classList.contains("visible")){const U=M==null?void 0:M.onCancel;R(),U&&U()}if(b.key==="Tab"&&s.classList.contains("visible")){const q=s.classList.contains("alert-mode")?[u]:[v,u],oe=q[0],K=q[q.length-1];q.includes(document.activeElement)?b.shiftKey?document.activeElement===oe&&(b.preventDefault(),K.focus()):document.activeElement===K&&(b.preventDefault(),oe.focus()):(b.preventDefault(),oe.focus())}}))}function W(){j(),se(),Object.values(D).forEach(s=>{const f=document.getElementById(`screen-${s}`);r[s]=f,f&&f.setAttribute("inert","")}),window.addEventListener("popstate",ee),document.addEventListener("keydown",J),G(D.SPLASH,{},!1)}function J(s){if(s.key!=="Escape"||s.target.tagName==="INPUT"||s.target.tagName==="TEXTAREA")return;const f=document.getElementById("confirm-modal"),u=document.getElementById("help-modal");if(!(f!=null&&f.classList.contains("visible")||u!=null&&u.classList.contains("visible")))switch(z){case D.HOME:break;case D.COLLECTION:G(D.HOME);break;case D.PUZZLE:break;case D.VICTORY:G(D.COLLECTION);break;case D.SETTINGS:G(D.HOME);break;case D.TUTORIAL:window.Cozy.Storage&&window.Cozy.Storage.setFlag("tutorialComplete",!0),G(D.HOME);break}}function G(s,f={},u=!0){const v=r[s];if(!v){console.error(`Screen not found: ${s}`);return}c=f,z&&r[z]&&(z===D.PUZZLE&&window.Cozy.Zoom&&window.Cozy.Zoom.destroy(),r[z].classList.remove("screen-active"),r[z].classList.add("screen-hidden"),r[z].setAttribute("inert","")),v.classList.remove("screen-hidden"),v.classList.add("screen-active"),v.removeAttribute("inert"),u&&z!==null&&(A.push(z),A.length>_.MAX_SCREEN_HISTORY&&(A=A.slice(-_.MAX_SCREEN_HISTORY)),history.pushState({screen:s},"",`#${s}`));const b=z;z=s,F(s,f,b)}function re(){if(A.length>0){const s=A.pop();G(s,{},!1),history.back()}}function ee(s){if(s.state&&s.state.screen)G(s.state.screen,{},!1);else if(A.length>0){const f=A.pop();G(f,{},!1)}}function F(s,f,u){switch(s){case D.SPLASH:Q();break;case D.HOME:w();break;case D.COLLECTION:d(f);break;case D.PUZZLE:h(f);break;case D.VICTORY:p(f);break;case D.SETTINGS:C();break;case D.TUTORIAL:H();break}}function X(){return c}function ce(){return z}function Q(){setTimeout(()=>{var v;if(new URLSearchParams(window.location.search).get("action")==="continue"){const b=window.location.pathname+window.location.hash;history.replaceState(null,"",b);const U=window.Cozy.Storage;if(U){const q=U.getSession();if(q&&typeof q.puzzleIndex=="number"){G(D.PUZZLE,{puzzleId:q.puzzleIndex});return}}}const u=(v=window.Cozy.Storage)==null?void 0:v.getFlag("tutorialCompleted");G(u?D.HOME:D.TUTORIAL)},1500)}function w(){var v;const s=document.getElementById("home-play-btn"),f=document.getElementById("home-settings-btn"),u=document.getElementById("home-progress");if(E(s,"click",()=>G(D.COLLECTION)),E(f,"click",()=>G(D.SETTINGS)),u&&window.PUZZLE_DATA){const b=window.PUZZLE_DATA,U=Array.isArray(b)?b.length:0;let q=0;window.Cozy.Storage&&((v=window.Cozy.Garden)!=null&&v.getPuzzleId)&&b.forEach(oe=>{const K=window.Cozy.Garden.getPuzzleId(oe);window.Cozy.Storage.isPuzzleCompleted(K)&&q++}),u.textContent=`${q} / ${U} puzzles solved`}s&&setTimeout(()=>s.focus(),100)}function d(s){window.dispatchEvent(new CustomEvent("screen:collection",{detail:s}));const f=document.getElementById("collection-search-input");f&&setTimeout(()=>f.focus(),100)}function h(s){window.Cozy.Zoom&&window.Cozy.Zoom.init(),window.dispatchEvent(new CustomEvent("screen:puzzle",{detail:s}))}let S=null;function p(s){const f=document.getElementById("victory-puzzle-name"),u=document.getElementById("victory-image"),v=document.getElementById("victory-continue-btn");S=s.puzzleId,f&&s.puzzleName&&(f.textContent=s.puzzleName),u&&s.solution&&y(u,s.solution,s.palette),E(v,"click",()=>{const b=u?u.querySelector("canvas"):null;if(b){const U=u.getBoundingClientRect(),q=$(b,U,{useScale:!0});G(D.COLLECTION,{scrollToPuzzleId:S,animateStamp:!0,flyingStamp:q})}else G(D.COLLECTION,{scrollToPuzzleId:S})}),v&&setTimeout(()=>v.focus(),100)}function y(s,f,u){s.innerHTML="";const v=f.length,b=f[0]?f[0].length:v,U=Z(b,v,_.VICTORY_CANVAS_SIZE,(q,oe)=>{const K=f[q][oe];return K>0&&u[K]?u[K]:null});s.appendChild(U)}function k(){var u;const s=document.querySelectorAll(".theme-option");let f=(u=window.Cozy.Storage)==null?void 0:u.getSetting("theme");(!f||f==="system")&&(f=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),s.forEach(v=>{const U=v.dataset.theme===f;v.classList.toggle("active",U),v.setAttribute("aria-pressed",U?"true":"false")}),s.forEach(v=>{E(v,"click",()=>{const b=v.dataset.theme;s.forEach(U=>{U.classList.remove("active"),U.setAttribute("aria-pressed","false")}),v.classList.add("active"),v.setAttribute("aria-pressed","true"),window.Cozy.Storage&&window.Cozy.Storage.setSetting("theme",b),N(b)})})}function g(){const s=document.getElementById("settings-reset-btn");E(s,"click",()=>{B({title:"Reset Progress",message:"Are you sure you want to reset all progress? This cannot be undone.",confirmText:"Reset",cancelText:"Cancel",danger:!0,onConfirm:()=>{var f,u;(f=window.Cozy.Garden)!=null&&f.clearAllState&&window.Cozy.Garden.clearAllState(),(u=window.Cozy.Storage)!=null&&u.reset&&window.Cozy.Storage.reset(),window.Cozy.Collection&&window.Cozy.Collection.refresh(),ie({title:"Progress Reset",message:"All progress has been cleared."})}})})}function O(){const s=document.getElementById("settings-solve-all-btn");E(s,"click",()=>{B({title:"Debug: Solve All",message:"Mark all puzzles as solved? This is a debug feature.",confirmText:"Solve All",cancelText:"Cancel",onConfirm:()=>{const f=window.PUZZLE_DATA||[],u=window.Cozy.Storage;u&&f.forEach(v=>{var U;let b;(U=window.Cozy.Garden)!=null&&U.getPuzzleId?b=window.Cozy.Garden.getPuzzleId(v):b=(v.t||v.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""),u.completePuzzle(b)}),window.Cozy.Collection&&window.Cozy.Collection.refresh(),ie({title:"All Puzzles Solved",message:`Marked ${f.length} puzzles as solved!`})}})})}function C(){var b;const s=document.getElementById("settings-back-btn"),f=document.getElementById("settings-vibration"),u=document.getElementById("settings-tutorial-btn"),v=window.Cozy.Storage;f&&(f.checked=(b=v==null?void 0:v.getSetting("vibration"))!=null?b:!0),E(s,"click",re),E(u,"click",()=>G(D.TUTORIAL)),E(f,"change",()=>v==null?void 0:v.setSetting("vibration",f.checked)),k(),g(),O(),f&&setTimeout(()=>f.focus(),100)}let P=0;function H(){const s=document.getElementById("tutorial-skip-btn"),f=document.getElementById("tutorial-next-btn"),u=document.querySelectorAll(".tutorial-step"),v=document.querySelectorAll(".tutorial-dot");function b(q){u.forEach((oe,K)=>{oe.classList.toggle("active",K===q)}),v.forEach((oe,K)=>{oe.classList.toggle("active",K===q)}),f&&(f.textContent=q===u.length-1?"Start Playing":"Next")}function U(){var q;(q=window.Cozy.Storage)==null||q.setFlag("tutorialCompleted",!0),G(D.HOME)}E(s,"click",U),E(f,"click",()=>{P<u.length-1?(P++,b(P)):U()}),P=0,b(0),f&&setTimeout(()=>f.focus(),100)}function N(s){document.documentElement.setAttribute("data-theme",s);const f=document.getElementById("theme-color-meta");f&&f.setAttribute("content",s==="dark"?"#0a1018":"#4a7c3f")}function j(){var f;let s=(f=window.Cozy.Storage)==null?void 0:f.getSetting("theme");(!s||s==="system")&&(s=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),N(s)}return{init:W,showScreen:G,goBack:re,getScreenData:X,getCurrentScreen:ce,applyTheme:N,initTheme:j,showConfirmModal:B,SCREENS:D}}();window.Cozy.Screens=ScreenManager,document.addEventListener("DOMContentLoaded",()=>{ScreenManager.init()}),function(){"use strict";const{CONFIG:_,getPuzzleId:E,getPuzzleTitle:$,parsePuzzleTitle:Z,renderOutlinedCanvas:D}=window.Cozy.Utils,z=["easy","medium","hard","challenging","expert"];function A(){var d;const w=(d=window.Cozy.Storage)==null?void 0:d.getUIState("collapsedSections");return w&&typeof w=="object"?w:null}function c(w){var d;(d=window.Cozy.Storage)==null||d.setUIState("collapsedSections",w)}function r(w,d){const h=document.querySelector(`.collection-section[data-difficulty="${w}"]`);if(!h)return;const p=!d[w];d[w]=p,c(d),h.classList.toggle("collapsed",p);const y=h.querySelector(".collection-grid"),k=h.querySelector(".section-chevron"),g=h.querySelector(".collection-section-header");if(y&&(y.style.display=p?"none":"flex"),k&&(k.textContent=p?"\u25B6":"\u25BC"),g){g.setAttribute("aria-expanded",!p);const O=g.querySelector(".collection-section-stats"),C=O?O.textContent:"",[P,H]=C.split("/");g.setAttribute("aria-label",`${se(w)}, ${P} of ${H} completed, ${p?"collapsed":"expanded"}`)}window.Cozy.Collection&&window.Cozy.Collection.updateRovingTabindex()}function M(){return window.Cozy.Storage||null}function B(w){const d={};return w.forEach((h,S)=>{const p=Z($(h)),y=p.difficulty;d[y]||(d[y]=[]),d[y].push({index:S,puzzle:h,meta:p,id:E(h)})}),d}function ie(w){const d={};return w.forEach(h=>{const S=Z($(h.puzzle)),p=S.difficulty;d[p]||(d[p]=[]),d[p].push({index:h.originalIndex,puzzle:h.puzzle,meta:S,id:E(h.puzzle)})}),d}function R(w){return Object.keys(w).sort((h,S)=>{const p=z.indexOf(h),y=z.indexOf(S);return p!==-1&&y!==-1?p-y:p!==-1?-1:y!==-1?1:h.localeCompare(S)})}function se(w){return w.charAt(0).toUpperCase()+w.slice(1)}function W(w){const d=M();let h=0;return d&&w.forEach(S=>{d.isPuzzleCompleted(S.id)&&h++}),{completed:h,total:w.length}}function J(w){if(!w)return!1;for(const d of w)for(const h of d)if((typeof h=="object"&&h!==null?h.value:h)!==null)return!0;return!1}function G(w,d,h={}){const S=M(),p=S?S.isPuzzleCompleted(w.id):!1,y=S?S.getPuzzleGrid(w.id):null,k=!p&&J(y),g=document.createElement("div");g.className="puzzle-card"+(p?" completed":"")+(k?" in-progress":""),g.dataset.puzzleIndex=w.index,g.dataset.puzzleId=w.id,g.tabIndex=-1,g.setAttribute("role","button"),g.setAttribute("aria-label",`${w.meta.name}, ${w.meta.width} by ${w.meta.height}${p?", completed":""}`),g.addEventListener("keydown",N=>{if(N.key==="Enter"||N.key===" "){N.preventDefault(),window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=w.id),d(w.index);return}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(N.key)&&(N.preventDefault(),N.stopPropagation(),window.Cozy.Collection&&window.Cozy.Collection.navigateFromElement(g,N.key))});const O=document.createElement("div");if(O.className="puzzle-card-preview",h.forceBlank){O.classList.add("awaiting-stamp");const N=document.createElement("div");N.className="puzzle-card-placeholder",N.textContent="?",O.appendChild(N)}else if(p)O.appendChild(re(w.puzzle));else if(k)O.appendChild(ee(w.puzzle,y));else{const N=document.createElement("div");N.className="puzzle-card-placeholder",N.textContent="?",O.appendChild(N)}g.appendChild(O);const C=document.createElement("div");C.className="puzzle-card-name",C.textContent=w.meta.name,g.appendChild(C);const P=Object.keys(w.puzzle.color_map).length,H=document.createElement("div");return H.className="puzzle-card-badge",H.textContent=`${w.meta.width}\xD7${w.meta.height} \xB7 ${P}c`,g.appendChild(H),g.addEventListener("click",()=>{window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=w.id),d(w.index)}),g}function re(w){try{const d=D(w.width,w.height,_.MINI_CANVAS_SIZE,(h,S)=>{var y,k,g;const p=(k=(y=w.solution)==null?void 0:y[h])==null?void 0:k[S];if(p>0){const O=(g=w.color_map)==null?void 0:g[p];if(O&&Array.isArray(O)&&O.length>=3)return O}return null});return d.className="puzzle-mini-canvas",d}catch(d){return console.error("[Collection] Error creating mini solution:",d),null}}function ee(w,d){try{const h=D(w.width,w.height,_.MINI_CANVAS_SIZE,(S,p)=>{var g,O;const y=(g=d==null?void 0:d[S])==null?void 0:g[p],k=typeof y=="object"&&y!==null?y.value:y;if(k!==null&&k>0){const C=(O=w.color_map)==null?void 0:O[k];if(C&&Array.isArray(C)&&C.length>=3)return C}return null});return h.className="puzzle-mini-canvas",h}catch(h){return console.error("[Collection] Error creating mini progress:",h),null}}function F(w,d,h,S={}){w.innerHTML="";const p=(S.searchFilter||"").toLowerCase().trim().slice(0,_.MAX_SEARCH_LENGTH);let y=d.map((P,H)=>({puzzle:P,originalIndex:H}));p&&(y=y.filter(P=>Z($(P.puzzle)).name.toLowerCase().includes(p)));const k=ie(y),g=R(k),O=M();if(g.length===0&&p){const P=document.createElement("div");P.className="collection-empty-state";const H=document.createElement("p");H.className="collection-empty-message",H.textContent=`No puzzles match "${p}"`,P.appendChild(H),w.appendChild(P);return}let C;if(p)C={},g.forEach(P=>{C[P]=!1});else if(C=A(),!C){C={};let P=!1;g.forEach(H=>{const N=W(k[H]);!P&&N.completed<N.total?(C[H]=!1,P=!0):C[H]=!0}),!P&&g.length>0&&(C[g[0]]=!1),c(C)}g.forEach(P=>{const H=X(P,k[P],C,h,S);w.appendChild(H)})}function X(w,d,h,S,p){const y=W(d),k=h[w],g=document.createElement("div");g.className="collection-section"+(k?" collapsed":""),g.dataset.difficulty=w;const O=`collection-grid-${w}`,C=document.createElement("div");C.className="collection-section-header",C.style.cursor="pointer",C.dataset.difficulty=w,C.tabIndex=-1,C.setAttribute("role","button"),C.setAttribute("aria-expanded",!k),C.setAttribute("aria-controls",O),C.setAttribute("aria-label",`${se(w)}, ${y.completed} of ${y.total} completed, ${k?"collapsed":"expanded"}`);const P=document.createElement("span");P.className="section-chevron",P.setAttribute("aria-hidden","true"),P.textContent=k?"\u25B6":"\u25BC",C.appendChild(P);const H=document.createElement("h3");H.className="collection-section-title",H.textContent=se(w),C.appendChild(H);const N=document.createElement("span");N.className="collection-section-stats",N.textContent=`${y.completed}/${y.total}`,y.completed===y.total&&y.total>0&&N.classList.add("complete"),C.appendChild(N),C.addEventListener("click",()=>{r(w,h)}),C.addEventListener("keydown",s=>{if(s.key==="Enter"||s.key===" "){s.preventDefault(),r(w,h);return}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(s.key)&&(s.preventDefault(),s.stopPropagation(),window.Cozy.Collection&&window.Cozy.Collection.navigateFromElement(C,s.key))}),g.appendChild(C);const j=document.createElement("div");return j.className="collection-grid",j.id=O,j.style.display=k?"none":"flex",d.forEach(s=>{const f={};p.blankPuzzleId&&s.id===p.blankPuzzleId&&(f.forceBlank=!0);const u=G(s,S,f);j.appendChild(u)}),g.appendChild(j),g}class ce{constructor(){this.container=null,this.puzzles=[],this.onPuzzleSelect=null,this.visible=!0,this.searchFilter="",this.searchInput=null,this.searchInputHandler=null,this.searchDebounceTimeout=null,this.focusedCardId=null,this.focusedHeaderDifficulty=null,this.idealX=null}init(d,h,S){return this.container=document.getElementById(d),this.puzzles=h,this.onPuzzleSelect=S,this.searchInput=document.getElementById("collection-search-input"),this.searchInput&&(this.searchInputHandler&&this.searchInput.removeEventListener("input",this.searchInputHandler),this.searchInputHandler=p=>{this.searchFilter=p.target.value,this.searchDebounceTimeout&&clearTimeout(this.searchDebounceTimeout),this.searchDebounceTimeout=setTimeout(()=>this.render(),150)},this.searchInput.addEventListener("input",this.searchInputHandler)),this.container&&this.render(),this}render(d={}){if(!this.container)return;const h={...d,searchFilter:this.searchFilter};F(this.container,this.puzzles,S=>{this.onPuzzleSelect&&this.onPuzzleSelect(S)},h),this.updateRovingTabindex()}show(){this.container&&(this.container.style.display="block",this.visible=!0,this.searchFilter="",this.searchInput&&(this.searchInput.value=""),this.render())}hide(){this.container&&(this.container.style.display="none",this.visible=!1)}isVisible(){return this.visible}refresh(d={}){this.visible&&this.render(d)}getVisibleCards(){if(!this.container)return[];const d=[];return this.container.querySelectorAll(".collection-section").forEach(S=>{const p=S.querySelector(".collection-grid");p&&p.style.display!=="none"&&p.querySelectorAll(".puzzle-card").forEach(k=>d.push(k))}),d}getNavigableElements(){if(!this.container)return[];const d=[];return this.container.querySelectorAll(".collection-section").forEach(S=>{const p=S.querySelector(".collection-section-header");p&&d.push(p);const y=S.querySelector(".collection-grid");y&&y.style.display!=="none"&&y.querySelectorAll(".puzzle-card").forEach(g=>d.push(g))}),d}isHeader(d){return d&&d.classList.contains("collection-section-header")}findElementInDirection(d,h,S=null){const p=this.getNavigableElements();if(p.length===0)return null;const y=d.getBoundingClientRect(),k=y.left+y.width/2,g=y.top+y.height/2,O=this.isHeader(d),C=(h==="up"||h==="down")&&S!==null?S:k,P=y.height*.5,H=y.width*.5;let N=null,j=1/0;return p.forEach(s=>{if(s===d)return;const f=s.getBoundingClientRect(),u=f.left+f.width/2,v=f.top+f.height/2,b=this.isHeader(s);let U=!1;switch(h){case"left":O?U=!1:U=!b&&u<k-H&&Math.abs(v-g)<P;break;case"right":O?U=!1:U=!b&&u>k+H&&Math.abs(v-g)<P;break;case"up":U=v<g-P;break;case"down":U=v>g+P;break}if(U){let q;if(h==="left"||h==="right")q=Math.abs(u-k);else{const oe=Math.abs(v-g),K=Math.abs(u-C);q=oe*1e3+K}q<j&&(j=q,N=s)}}),N}navigateFromElement(d,h){const p={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[h];if(!p)return;const y=d.getBoundingClientRect(),k=y.left+y.width/2;let g;if(p==="up"||p==="down"?(this.idealX===null&&(this.idealX=k),g=this.findElementInDirection(d,p,this.idealX)):g=this.findElementInDirection(d,p),g){const O=g.getBoundingClientRect(),C=O.left+O.width/2;p==="left"||p==="right"?this.idealX=C:this.isHeader(g),d.tabIndex=-1,g.tabIndex=0,g.focus(),this.isHeader(g)?(this.focusedCardId=null,this.focusedHeaderDifficulty=g.dataset.difficulty):(this.focusedCardId=g.dataset.puzzleId,this.focusedHeaderDifficulty=null),g.scrollIntoView({behavior:"smooth",block:"nearest"})}}findCardInDirection(d,h){const S=this.getVisibleCards();if(S.length===0)return null;const p=d.getBoundingClientRect(),y=p.left+p.width/2,k=p.top+p.height/2,g=p.height*.5,O=p.width*.5;let C=null,P=1/0;return S.forEach(H=>{if(H===d)return;const N=H.getBoundingClientRect(),j=N.left+N.width/2,s=N.top+N.height/2;let f=!1;switch(h){case"left":f=j<y-O&&Math.abs(s-k)<g;break;case"right":f=j>y+O&&Math.abs(s-k)<g;break;case"up":f=s<k-g;break;case"down":f=s>k+g;break}if(f){let u;if(h==="left"||h==="right")u=Math.abs(j-y);else{const v=Math.abs(s-k),b=Math.abs(j-y);u=v*1e3+b}u<P&&(P=u,C=H)}}),C}navigateFromCard(d,h){const p={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[h];if(!p)return;const y=this.findCardInDirection(d,p);y&&(d.tabIndex=-1,y.tabIndex=0,y.focus(),this.focusedCardId=y.dataset.puzzleId,y.scrollIntoView({behavior:"smooth",block:"nearest"}))}updateRovingTabindex(){const d=this.getNavigableElements();if(d.length===0)return;let h=null;if(this.focusedCardId){const S=this.container.querySelector(`.puzzle-card[data-puzzle-id="${this.focusedCardId}"]`);S&&d.includes(S)&&(h=S)}if(!h&&this.focusedHeaderDifficulty){const S=this.container.querySelector(`.collection-section-header[data-difficulty="${this.focusedHeaderDifficulty}"]`);S&&d.includes(S)&&(h=S)}h||(h=d[0],this.isHeader(h)?(this.focusedHeaderDifficulty=h.dataset.difficulty,this.focusedCardId=null):(this.focusedCardId=(h==null?void 0:h.dataset.puzzleId)||null,this.focusedHeaderDifficulty=null)),d.forEach(S=>{S.tabIndex=S===h?0:-1})}scrollToPuzzle(d,h={}){if(!this.container)return;const S=this.container.querySelectorAll(".puzzle-card");let p=null,y=-1;for(let O=0;O<this.puzzles.length;O++)if(E(this.puzzles[O])===d){y=O;break}if(y===-1||(S.forEach(O=>{parseInt(O.dataset.puzzleIndex,10)===y&&(p=O)}),!p))return;const k=p.closest(".collection-section");if(k&&k.classList.contains("collapsed")){const O=k.dataset.difficulty,C=k.querySelector(".collection-grid"),P=k.querySelector(".section-chevron");k.classList.remove("collapsed"),C&&(C.style.display="flex"),P&&(P.textContent="\u25BC");let H=A()||{};H[O]=!1,c(H)}const g=h.instant?"instant":"smooth";setTimeout(()=>{p.scrollIntoView({behavior:g,block:"center"})},h.instant?0:100)}animateStampTo(d,h,S={}){if(!this.container||!h)return;const p=this.container.querySelector(`.puzzle-card[data-puzzle-id="${d}"]`);if(!p){h.remove();return}const y=p.querySelector(".puzzle-card-preview");if(!y){h.remove();return}setTimeout(()=>{const g=y.getBoundingClientRect(),O=parseFloat(h.style.width),C=parseFloat(h.style.height),P=this.puzzles.find(u=>E(u)===d);let H,N;if(P){const u=Math.max(P.width,P.height),v=Math.max(2,Math.floor(_.MINI_CANVAS_SIZE/u)),b=_.OUTLINE_THICKNESS*2;H=P.width*v+b,N=P.height*v+b}else{const u=O/C;u>1?(H=g.width,N=g.width/u):(N=g.height,H=g.height*u)}const j=H/O,s=g.left+g.width/2,f=g.top+g.height/2;requestAnimationFrame(()=>{h.style.left=s-O/2+"px",h.style.top=f-C/2+"px",h.style.transform="scale("+j+")",h.classList.add("landed")}),setTimeout(()=>{y.classList.remove("awaiting-stamp"),y.innerHTML="";const u=this.puzzles.find(v=>E(v)===d);if(u){const v=M();if(v?v.isPuzzleCompleted(d):!1)y.appendChild(re(u));else{const U=v?v.getPuzzleGrid(d):null;U&&y.appendChild(ee(u,U))}}h.remove()},650)},100)}}const Q=new ce;window.Cozy.Collection=Q}(),function(){"use strict";const _={isInstalled:!1,swRegistration:null,resizeTimeout:null,init(){this.checkInstallState(),this.registerServiceWorker(),this.setupEventListeners(),console.log("[App] Cozy Garden initialized")},checkInstallState(){window.matchMedia("(display-mode: standalone)").matches&&(this.isInstalled=!0),window.navigator.standalone===!0&&(this.isInstalled=!0),this.isInstalled&&(document.body.classList.add("is-installed"),console.log("[App] Running as installed PWA"))},async registerServiceWorker(){if(!("serviceWorker"in navigator)){console.log("[App] Service workers not supported");return}try{this.swRegistration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("[App] Service worker registered:",this.swRegistration.scope),this.swRegistration.addEventListener("updatefound",()=>{const E=this.swRegistration.installing;console.log("[App] New service worker installing..."),E.addEventListener("statechange",()=>{E.state==="installed"&&navigator.serviceWorker.controller&&this.showUpdateNotification()})})}catch(E){console.error("[App] Service worker registration failed:",E)}},showUpdateNotification(){const E=document.createElement("div");E.className="update-banner";const $=document.createElement("span");$.textContent="A new version is available!";const Z=document.createElement("button");Z.textContent="Update",Z.addEventListener("click",()=>this.applyUpdate());const D=document.createElement("button");D.textContent="Later",D.addEventListener("click",()=>E.remove()),E.appendChild($),E.appendChild(Z),E.appendChild(D),document.body.appendChild(E)},applyUpdate(){this.swRegistration&&this.swRegistration.waiting&&this.swRegistration.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload()},setupEventListeners(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?this.onAppFocus():this.onAppBlur()}),window.addEventListener("beforeunload",()=>{this.saveState()}),window.addEventListener("orientationchange",()=>{setTimeout(()=>this.handleResize(),100)}),window.addEventListener("resize",()=>{this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>this.handleResize(),100)})},onAppFocus(){console.log("[App] App focused")},onAppBlur(){console.log("[App] App blurred"),this.saveState()},saveState(){window.Cozy.Garden&&window.Cozy.Storage&&console.log("[App] Saving state...")},handleResize(){const E=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${E}px`)},isPWA(){return this.isInstalled||window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0},async getVersion(){return!this.swRegistration||!navigator.serviceWorker.controller?"unknown":new Promise(E=>{const $=new MessageChannel;$.port1.onmessage=Z=>{E(Z.data.version||"unknown")},navigator.serviceWorker.controller.postMessage({type:"GET_VERSION"},[$.port2]),setTimeout(()=>E("unknown"),1e3)})},async share(E,$,Z){if(navigator.share)try{return await navigator.share({title:E,text:$,url:Z}),!0}catch(D){return D.name!=="AbortError"&&console.error("[App] Share failed:",D),!1}return!1},vibrate(E=50){var $;navigator.vibrate&&(($=window.Cozy.Storage)!=null&&$.getSetting("vibration"))&&navigator.vibrate(E)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>_.init()):_.init(),window.Cozy.App=_}(),function(){"use strict";const{CONFIG:_,getPuzzleId:E,getPuzzleTitle:$,createFlyingStamp:Z,renderOutlinedCanvas:D}=window.Cozy.Utils;let z=0,A="easy",c=1,r=[],M=!1,B=null,ie=!0,R=!1,se=!1,W=0,J=0,G=null,re=null,ee=null,F=[],X=[],ce=[],Q=[],w=[],d=null;function h(e,t="info"){const n=document.getElementById("toast");n&&(clearTimeout(d),n.textContent=e,n.className="toast visible",t==="success"?n.classList.add("toast-success"):t==="info"&&n.classList.add("toast-info"),d=setTimeout(()=>{n.classList.remove("visible")},_.TOAST_DURATION))}function S(){const e=document.getElementById("toast");e&&(clearTimeout(d),e.classList.remove("visible"))}function p(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function y(){const e=document.getElementById("help-list");if(!e)return;const t=p();let n=["<li><strong>Select a color</strong> from the palette, then tap cells to fill them</li>","<li><strong>Drag</strong> across cells to fill multiple at once</li>","<li><strong>Long-press</strong> a cell to mark it \u2715 (definitely empty)</li>","<li><strong>Pencil mode</strong> marks uncertain guesses \u2014 confirm or clear them later</li>"];t&&n.push("<li><strong>Pinch to zoom</strong> on larger puzzles for easier tapping</li>"),t||(n.push('<li class="help-section-title">Keyboard Shortcuts</li>'),n.push("<li><strong>Ctrl+Z</strong> / <strong>Ctrl+Y</strong> \u2014 Undo / Redo</li>"),n.push("<li><strong>P</strong> \u2014 Toggle pencil mode</li>"),n.push("<li><strong>1-9</strong> \u2014 Select color by number</li>"),n.push("<li><strong>+</strong> / <strong>-</strong> \u2014 Zoom in / out</li>")),e.innerHTML=n.join("")}function k(){const e=document.getElementById("help-modal");if(!e)return;y(),e.classList.add("visible"),document.body.style.overflow="hidden";const t=e.querySelector(".help-modal-close");t&&setTimeout(()=>t.focus(),100)}function g(){const e=document.getElementById("help-modal");e&&(e.classList.remove("visible"),document.body.style.overflow="")}function O(){const e=document.getElementById("help-btn"),t=document.getElementById("help-modal"),n=t==null?void 0:t.querySelector(".help-modal-backdrop"),o=t==null?void 0:t.querySelector(".help-modal-close");e&&e.addEventListener("click",k),n&&n.addEventListener("click",g),o&&o.addEventListener("click",g),document.addEventListener("keydown",i=>{if(t!=null&&t.classList.contains("visible")){if(i.key==="Escape"){g();return}i.key==="Tab"&&(document.activeElement!==o?(i.preventDefault(),o==null||o.focus()):i.preventDefault())}})}function C(){const e=document.getElementById("skip-to-puzzle");e&&e.addEventListener("click",t=>{var o;t.preventDefault();const n=(o=F[0])==null?void 0:o[0];n&&n.focus()})}function P(){var e;(e=window.Cozy.Storage)!=null&&e.getFlag("helpShown")||setTimeout(()=>{var t;k(),(t=window.Cozy.Storage)==null||t.setFlag("helpShown",!0)},500)}function H(e){if(!e)return null;if(e.title!==void 0)return!e.width||!e.height||!e.row_clues||!e.col_clues||!e.color_map?(console.warn("[Game] Invalid verbose puzzle format:",e.title),null):e;if(!e.t||!e.w||!e.h||!Array.isArray(e.r)||!Array.isArray(e.c)||!Array.isArray(e.p)||!Array.isArray(e.s))return console.warn("[Game] Invalid concise puzzle format, missing or malformed fields:",e.t),null;if(e.w>_.MAX_PUZZLE_DIMENSION||e.h>_.MAX_PUZZLE_DIMENSION||e.w<1||e.h<1)return console.warn("[Game] Puzzle dimensions out of range:",e.w,"x",e.h),null;function t(l){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(l);return m?[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)]:[0,0,0]}function n(l){return l.map(m=>m.map(([I,T])=>({count:I,color:T+1})))}function o(l){const m={};return l.forEach((I,T)=>{m[T+1]=t(I)}),m}function i(l){return l.map(m=>m.map(I=>I<0?0:I+1))}try{return{title:e.t,width:e.w,height:e.h,row_clues:n(e.r),col_clues:n(e.c),color_map:o(e.p),solution:i(e.s)}}catch(l){return console.error("[Game] Failed to convert puzzle:",e.t,l),null}}let N=null,j=null;function s(){const e=window.PUZZLE_DATA||[];return(!N||e!==j)&&(N=e.map(H).filter(t=>t!==null),j=e),N}function f(e=null,t=!0){return{value:e,certain:t}}function u(e,t){var n;return((n=r[e])==null?void 0:n[t])||f()}function v(e,t,n,o){r[e][t]={value:n,certain:o}}function b(e){return`rgb(${e[0]}, ${e[1]}, ${e[2]})`}function U(e){return(e[0]*299+e[1]*587+e[2]*114)/1e3}function q(e){const t=e.toLowerCase();return t.includes("easy")?"easy":t.includes("medium")?"medium":t.includes("hard")?"hard":t.includes("challenging")?"challenging":t.includes("expert")?"expert":"easy"}function oe(){return window.Cozy.Storage||null}function K(){return window.Cozy.History||null}function Ae(){const e=s()[z];if(!e)return!0;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++)if(u(t,n).value!==null)return!1;return!0}function qe(){const e=s()[z];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=u(t,n),i=e.solution[t][n];if(o.value!==i||!o.certain)return!1}return!0}function ye(){const e=document.getElementById("reset-btn"),t=document.getElementById("solution-btn");if(e){const n=Ae();e.disabled=n,e.setAttribute("aria-label",n?"Reset (puzzle is empty)":"Hold to reset puzzle")}if(t){const n=qe();t.disabled=n,t.setAttribute("aria-label",n?"Solution (already shown)":"Hold to reveal solution")}}function pe(e){const t=document.getElementById("sr-announcer");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},50))}function Se(e){R=e,ke(),pe(e?"Pencil mode":"Pen mode"),Ee()}function xe(){Se(!R)}function ke(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("palette-menu-btn");if(e&&(e.classList.toggle("active",!R),e.setAttribute("aria-checked",String(!R))),t&&(t.classList.toggle("active",R),t.setAttribute("aria-checked",String(R))),n){const o=n.querySelector(".menu-icon-svg");o&&(o.removeAttribute("stroke"),o.removeAttribute("stroke-width"),o.setAttribute("fill","currentColor"),R?o.innerHTML='<path d="M19.07 13.88L13 19.94l-1.41-1.41 6.07-6.06 1.41 1.41zm-5.66-5.66l-6.06 6.07-1.42-1.41 6.07-6.07 1.41 1.41zM17.66 5.99l-2.34 2.34 1.41 1.41 2.34-2.34-1.41-1.41zM3 18v3h3l.01-.01L3 18zm3-3l-1 1 3 3 1-1-3-3z" opacity="0.5"/><path d="M9.17 16.17L7.76 17.59l3.54 3.54 1.41-1.41-3.54-3.55zm10.6-10.6l-3.53-3.54-1.42 1.42 3.54 3.53 1.41-1.41z"/>':o.innerHTML='<path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>')}document.body.classList.toggle("pencil-mode",R)}function Xe(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");if(!e||!t)return;e.classList.contains("open")?Ee():Ve()}function Ve(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");!e||!t||(e.classList.add("open"),t.classList.add("menu-open"),t.setAttribute("aria-expanded","true"),setTimeout(()=>{document.addEventListener("click",_e)},0))}function Ee(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");e&&(e.classList.remove("open"),t&&(t.classList.remove("menu-open"),t.setAttribute("aria-expanded","false")),document.removeEventListener("click",_e))}function _e(e){const t=document.getElementById("mode-menu"),n=document.getElementById("palette-menu-btn");!t||!n||!t.contains(e.target)&&!n.contains(e.target)&&Ee()}function He(){const e=s()[z];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=u(t,n);if(!o.certain&&o.value!==null)return!0}return!1}function Ye(){const e=s()[z];if(!e)return 0;let t=0;for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=u(n,o);!i.certain&&i.value!==null&&t++}return t}function he(){const e=document.getElementById("pencil-actions-section"),t=document.getElementById("palette-menu-btn"),n=He(),o=n?Ye():0;if(e&&e.classList.toggle("has-marks",n),t){t.classList.toggle("has-pencil-marks",n);const i=t.querySelector(".pencil-badge");i&&(i.textContent=o>_.BADGE_MAX_DISPLAY?`${_.BADGE_MAX_DISPLAY}+`:String(o))}}function Re(){const e=s()[z];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=u(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:null,certain:!0}}),v(n,o,null,!0),Ce(n,o,e))}if(t.length>0){const n=K();n&&n.recordBatchAction("batch-clear",t),window.Cozy.App&&window.Cozy.App.vibrate(20)}he(),ve()}function Ze(){const e=s()[z];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=u(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:i.value,certain:!0}}),v(n,o,i.value,!0),Ce(n,o,e))}if(t.length>0){const n=K();n&&n.recordBatchAction("batch-confirm",t),window.Cozy.App&&window.Cozy.App.vibrate([20,50,20])}he(),Je(e),ve()}function Pe(){const e=K();if(!e)return;const t=e.undo();if(!t)return;const n=s()[z];for(const o of t)v(o.row,o.col,o.state.value,o.state.certain),Ce(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),he(),Te(n),ye(),ve()}function Me(){const e=K();if(!e)return;const t=e.redo();if(!t)return;const n=s()[z];for(const o of t)v(o.row,o.col,o.state.value,o.state.certain),Ce(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),he(),Te(n),ye(),Je(n),ve()}function ve(){const e=oe();if(!e)return;const n=s()[z];if(!n)return;const o=E(n);e.savePuzzleGrid(o,r),e.saveSession(z,A,r)}function Ke(){const e=oe();e&&e.clearSession()}function We(){const e=s(),t=document.getElementById("puzzle-select"),n=[...new Set(e.map(I=>q(I.title)))],o=["easy","medium","hard","challenging","expert"];n.sort((I,T)=>o.indexOf(I)-o.indexOf(T));const i=document.createElement("div");i.className="difficulty-tabs",n.forEach(I=>{const T=document.createElement("button");T.className="difficulty-tab"+(I===A?" active":""),T.textContent=I.charAt(0).toUpperCase()+I.slice(1),T.onclick=()=>{A=I,document.querySelectorAll(".difficulty-tab").forEach(Y=>Y.classList.remove("active")),T.classList.add("active"),a()},i.appendChild(T)});const l=document.createElement("div");l.className="puzzle-dropdown";const m=document.createElement("select");m.id="puzzle-select-dropdown",m.onchange=I=>{L(parseInt(I.target.value))},l.appendChild(m),t.appendChild(i),t.appendChild(l),a()}function a(){var i;const e=s(),t=document.getElementById("puzzle-select-dropdown");if(!t)return;const n=oe();if(t.innerHTML="",e.forEach((l,m)=>{if(q(l.title)===A){const I=document.createElement("option");I.value=m;const T=E(l),Y=n?n.isPuzzleCompleted(T):!1;I.textContent=(Y?"\u2713 ":"")+l.title,m===z&&(I.selected=!0),t.appendChild(I)}}),e.filter(l=>q(l.title)===A).length>0&&!(q((i=e[z])==null?void 0:i.title)===A)){const m=e.findIndex(I=>q(I.title)===A);m>=0&&L(m)}}function L(e,t=null){if(se){console.warn("[Game] Puzzle already loading, ignoring request");return}se=!0;try{const n=s(),o=oe(),i=K();if(e!==z&&r.length>0&&n[z]&&o){const ne=E(n[z]);o.savePuzzleGrid(ne,r)}i&&i.clear(),R=!1,ke(),W=0,J=0,z=e;const l=n[e];if(!l){se=!1;return}if(l.width>_.MAX_PUZZLE_DIMENSION||l.height>_.MAX_PUZZLE_DIMENSION||l.width<1||l.height<1){console.error(`[Game] Invalid puzzle dimensions: ${l.width}x${l.height}`),se=!1;return}const m=E(l);let I=t;!I&&o&&(I=o.getPuzzleGrid(m));const T=I&&I.length===l.height;if(T)r=I.map(ne=>ne.map(ae=>({value:ae.value,certain:ae.certain})));else{r=[];for(let ne=0;ne<l.height;ne++){r.push([]);for(let ae=0;ae<l.width;ae++)r[ne][ae]=f(null,!0)}}if(c=1,x(l),de(l),Ge(l),dt(),T)for(let ne=0;ne<l.height;ne++)for(let ae=0;ae<l.width;ae++)u(ne,ae).value!==null&&Ce(ne,ae,l);S();const Y=document.getElementById("puzzle-select-dropdown");Y&&(Y.value=e);const te=q(l.title);te!==A&&(A=te,document.querySelectorAll(".difficulty-tab").forEach(ne=>{ne.classList.toggle("active",ne.textContent.toLowerCase()===te)}),a()),he(),Te(l),window.Cozy.Zoom&&window.Cozy.Zoom.initForPuzzle(l),P(),ye()}finally{se=!1}}function x(e){const t=document.getElementById("palette"),n=document.getElementById("mode-menu"),o=n?n.parentNode:null;n&&t.contains(n)&&document.body.appendChild(n),t.innerHTML="";const i=document.createElement("button");i.className="color-btn eraser",i.title="Eraser",i.setAttribute("aria-label","Eraser"),i.setAttribute("aria-pressed",c===0?"true":"false"),i.addEventListener("click",()=>V(0)),t.appendChild(i),Object.entries(e.color_map).forEach(([T,Y])=>{const te=document.createElement("button"),ne=parseInt(T)===c;te.className="color-btn"+(ne?" selected":""),te.style.background=b(Y),te.setAttribute("aria-label",`Color ${T}`),te.setAttribute("aria-pressed",ne?"true":"false"),te.addEventListener("click",()=>V(parseInt(T))),t.appendChild(te)});const l=document.createElement("button");l.className="palette-menu-btn",l.id="palette-menu-btn",l.title="Drawing mode",l.setAttribute("aria-label","Drawing mode menu"),l.setAttribute("aria-haspopup","true"),l.setAttribute("aria-expanded","false"),l.innerHTML=`
      <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>
      </svg>
      <span class="pencil-badge">0</span>
    `,l.addEventListener("click",T=>{T.stopPropagation(),Xe()}),t.appendChild(l);const m=document.getElementById("mode-menu");m&&t.appendChild(m);const I=t.querySelectorAll(".color-btn, .palette-menu-btn").length;t.classList.remove("palette-8-buttons","palette-7-buttons"),I>=8?t.classList.add("palette-8-buttons"):I===7&&t.classList.add("palette-7-buttons")}function V(e){c=e;const n=s()[z];document.querySelectorAll(".color-btn").forEach((o,i)=>{let l;i===0?l=e===0:l=parseInt(Object.keys(n.color_map)[i-1])===e,o.classList.toggle("selected",l),o.setAttribute("aria-pressed",l?"true":"false")})}function le(e,t,n){const o=document.createElement("div");if(o.className=n,e===null)o.textContent="0",o.style.background="#333";else{const i=t.color_map[e.color];o.textContent=e.count,o.style.background=b(i),o.style.color=U(i)>_.BRIGHTNESS_MIDPOINT?"#000":"#fff",o.style.cursor="pointer",o.onclick=()=>V(e.color)}return o}function de(e){ce=[],X=[],Q=new Array(e.height).fill(!1),w=new Array(e.width).fill(!1);const t=document.getElementById("col-clues");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,e.col_clues.forEach((o,i)=>{const l=document.createElement("div");l.className="col-clue",l.dataset.col=i,o.length===0?l.appendChild(le(null,e,"clue-cell")):o.forEach(m=>{l.appendChild(le(m,e,"clue-cell"))}),ce[i]=l,t.appendChild(l)});const n=document.getElementById("row-clues-container");n.innerHTML="",n.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,e.row_clues.forEach((o,i)=>{const l=document.createElement("div");l.className="row-clues",l.dataset.row=i,o.length===0?l.appendChild(le(null,e,"row-clue-cell")):o.forEach(m=>{l.appendChild(le(m,e,"row-clue-cell"))}),X[i]=l,n.appendChild(l)})}let ue=-1,fe=-1;function we(e,t){var o;if(p()||e===ue&&t===fe||(ze(),ue=e,fe=t,e<0||t<0)||!F[e])return;const n=F[e];if(n)for(let i=0;i<n.length;i++){const l=n[i];l&&(l.classList.add("highlight-row"),i===t&&l.classList.add("highlight-cell"))}for(let i=0;i<F.length;i++)i!==e&&((o=F[i])!=null&&o[t])&&F[i][t].classList.add("highlight-col");X[e]&&X[e].classList.add("highlight-clue"),ce[t]&&ce[t].classList.add("highlight-clue")}function ze(){var n;const e=ue,t=fe;if(ue=-1,fe=-1,!(e<0&&t<0)){if(e>=0&&F[e])for(let o=0;o<F[e].length;o++){const i=F[e][o];i&&i.classList.remove("highlight-row","highlight-cell")}if(t>=0)for(let o=0;o<F.length;o++){const i=(n=F[o])==null?void 0:n[t];i&&i.classList.remove("highlight-col")}e>=0&&X[e]&&X[e].classList.remove("highlight-clue"),t>=0&&ce[t]&&ce[t].classList.remove("highlight-clue")}}function ge(e,t){var i,l;const n=s()[z];if(!n||e<0||e>=n.height||t<0||t>=n.width)return;(i=F[W])!=null&&i[J]&&(F[W][J].tabIndex=-1),W=e,J=t;const o=(l=F[e])==null?void 0:l[t];o&&(o.tabIndex=0,o.focus())}function be(e,t){const n=document.createElement("div");return n.className="cell",n.dataset.row=e,n.dataset.col=t,n.tabIndex=e===W&&t===J?0:-1,n.setAttribute("role","gridcell"),n.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}, empty`),n}function Ie(e,t,n){e.onfocus=()=>{var o;(W!==t||J!==n)&&((o=F[W])!=null&&o[J]&&(F[W][J].tabIndex=-1),W=t,J=n,e.tabIndex=0),we(t,n)}}function Le(e,t,n){e.onkeydown=o=>{if(o.key==="ArrowUp")o.preventDefault(),ge(t-1,n);else if(o.key==="ArrowDown")o.preventDefault(),ge(t+1,n);else if(o.key==="ArrowLeft")o.preventDefault(),ge(t,n-1);else if(o.key==="ArrowRight")o.preventDefault(),ge(t,n+1);else if(o.key==="Enter"||o.key===" "){o.preventDefault();const i=K();i&&i.beginAction("fill"),me(t,n,c,!R),i&&i.commitAction(),he()}else if(o.key==="x"||o.key==="X"){o.preventDefault(),o.stopPropagation();const i=K();i&&i.beginAction("fill"),me(t,n,0,!R),i&&i.commitAction(),he()}}}function Be(e,t,n=!1){const o=K();o&&o.beginAction("fill"),M=!0,B=n?0:c,ie=!R,me(e,t,B,ie);const i=u(e,t);B=i.value,ie=i.certain}function Oe(e=!0){if(!M)return;M=!1,B=null;const t=K();t&&(e?t.commitAction():t.cancelAction()),he()}function je(e,t,n){e.onmousedown=o=>{o.preventDefault(),e.focus(),Be(t,n,o.button===2)},e.onmouseenter=()=>{we(t,n),M&&me(t,n,B,ie,!0)},e.oncontextmenu=o=>{o.preventDefault()}}function Ue(e,t,n){let o=null,i=0,l=!1,m=t,I=n;e.ontouchstart=T=>{var ne,ae;if(T.touches.length>1)return;if(T.preventDefault(),T.stopPropagation(),l=!1,i=Date.now(),m=t,I=n,window.Cozy.Zoom){const Ne=(ae=(ne=T.touches[0])==null?void 0:ne.clientY)!=null?ae:0;window.Cozy.Zoom.onCellTouchStart(t,n,Ne)}const Y=K();Y&&Y.beginAction("fill"),M=!0,B=c,ie=!R,o=setTimeout(()=>{if(!l){B=0,me(m,I,0,ie);const Ne=u(m,I);B=Ne.value,ie=Ne.certain,window.Cozy.App&&window.Cozy.App.vibrate(50)}},_.LONG_PRESS_DELAY),me(t,n,B,ie);const te=u(t,n);B=te.value,ie=te.certain},e.ontouchmove=T=>{if(T.touches.length>1||!M)return;T.preventDefault(),T.stopPropagation(),l=!0,clearTimeout(o);const Y=T.touches[0],te=document.elementFromPoint(Y.clientX,Y.clientY);if(te&&te.classList.contains("cell")){const ne=parseInt(te.dataset.row),ae=parseInt(te.dataset.col);!isNaN(ne)&&!isNaN(ae)&&(me(ne,ae,B,ie,!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchMove(ne,ae))}},e.ontouchend=()=>{clearTimeout(o),Oe(!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()},e.ontouchcancel=()=>{clearTimeout(o),Oe(!1),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()}}function Ge(e){const t=document.getElementById("grid");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,t.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,re&&t.removeEventListener("mouseleave",re),ee&&t.removeEventListener("focusout",ee),G&&document.removeEventListener("mouseup",G),F=[];for(let n=0;n<e.height;n++)F[n]=[];re=()=>ze(),t.addEventListener("mouseleave",re),ee=n=>{t.contains(n.relatedTarget)||ze()},t.addEventListener("focusout",ee);for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=be(n,o);Ie(i,n,o),Le(i,n,o),je(i,n,o),Ue(i,n,o),F[n][o]=i,t.appendChild(i)}G=()=>Oe(!0),document.addEventListener("mouseup",G)}function me(e,t,n,o,i){const l=s()[z],m=u(e,t),I=K();let T=n,Y=o;i||(o&&!m.certain&&m.value===n&&n!==null?(T=m.value,Y=!0):m.value===n&&m.certain===o&&n!==null&&(T=null,Y=!0)),!(m.value===T&&m.certain===Y)&&(I&&I.recordChange(e,t,m,{value:T,certain:Y}),v(e,t,T,Y),Ce(e,t,l),window.Cozy.App&&window.Cozy.App.vibrate(10),Te(l),ye(),Je(l),ve())}function Ce(e,t,n){var m;const o=(m=F[e])==null?void 0:m[t];if(!o)return;const i=u(e,t);if(o.classList.remove("marked-empty","maybe-empty","maybe-color"),o.style.background="",o.style.setProperty("--cell-color",""),o.style.setProperty("--fold-outline-color",""),i.value===null)o.style.background="var(--color-cell)";else if(i.value===0)i.certain?o.classList.add("marked-empty"):o.classList.add("maybe-empty");else{const I=n.color_map[i.value];if(I){const T=`rgb(${I[0]}, ${I[1]}, ${I[2]})`;if(i.certain)o.style.background=T;else{o.classList.add("maybe-color"),o.style.setProperty("--cell-color",T);const te=U(I)>_.BRIGHTNESS_MIDPOINT?"rgba(0, 0, 0, 0.6)":"rgba(255, 255, 255, 0.7)";o.style.setProperty("--fold-outline-color",te)}}}let l;i.value===null?l="empty":i.value===0?l=i.certain?"marked empty":"maybe empty":l=i.certain?`color ${i.value}`:`maybe color ${i.value}`,o.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}, ${l}`)}function Fe(e){const t=[];let n=null,o=0;for(const i of e)i>0?i===n?o++:(n!==null&&t.push({count:o,color:n}),n=i,o=1):n!==null&&(t.push({count:o,color:n}),n=null,o=0);return n!==null&&t.push({count:o,color:n}),t}function $e(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n].count!==t[n].count||e[n].color!==t[n].color)return!1;return!0}function Te(e){for(let t=0;t<e.height;t++){const n=[];for(let T=0;T<e.width;T++){const Y=u(t,T);Y.certain?n.push(Y.value===null?0:Y.value):n.push(-1)}const o=n.includes(-1),i=n.map(T=>T===-1?0:T),l=Fe(i),m=!o&&$e(l,e.row_clues[t]),I=X[t];I&&I.classList.toggle("satisfied",m),m!==Q[t]&&(Q[t]=m,pe(m?`Row ${t+1} complete`:`Row ${t+1} incomplete`))}for(let t=0;t<e.width;t++){const n=[];for(let T=0;T<e.height;T++){const Y=u(T,t);Y.certain?n.push(Y.value===null?0:Y.value):n.push(-1)}const o=n.includes(-1),i=n.map(T=>T===-1?0:T),l=Fe(i),m=!o&&$e(l,e.col_clues[t]),I=ce[t];I&&I.classList.toggle("satisfied",m),m!==w[t]&&(w[t]=m,pe(m?`Column ${t+1} complete`:`Column ${t+1} incomplete`))}}function Je(e){for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++)if(!u(o,i).certain)return;for(let o=0;o<e.height;o++){const i=[];for(let m=0;m<e.width;m++){const I=u(o,m);i.push(I.value===null?0:I.value)}const l=Fe(i);if(!$e(l,e.row_clues[o]))return}for(let o=0;o<e.width;o++){const i=[];for(let m=0;m<e.height;m++){const I=u(m,o);i.push(I.value===null?0:I.value)}const l=Fe(i);if(!$e(l,e.col_clues[o]))return}pe("Puzzle complete!"),window.Cozy.App&&window.Cozy.App.vibrate([50,100,50]);const t=oe();if(t){const o=E(e);t.completePuzzle(o),Ke(),a();const i=window.Cozy.Collection;i&&i.refresh()}const n=K();n&&n.clear(),ut(e)}function et(){const e=s()[z];if(!e)return;const t=K(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const l=u(o,i);l.value!==null&&(n.push({row:o,col:i,before:{value:l.value,certain:l.certain},after:{value:null,certain:!0}}),l.value=null,l.certain=!0,Ce(o,i,e))}if(n.length>0){t&&t.recordBatchAction("reset",n),Te(e);const o=oe();if(o){const i=E(e);o.savePuzzleGrid(i,null)}he()}ye()}function tt(){const e=s()[z];if(!e)return;window.Cozy.Zoom&&window.Cozy.Zoom.zoomToFit();const t=K(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const l=u(o,i),m=e.solution[o][i];(l.value!==m||!l.certain)&&n.push({row:o,col:i,before:{value:l.value,certain:l.certain},after:{value:m,certain:!0}}),l.value=m,l.certain=!0,Ce(o,i,e)}n.length>0&&t&&t.recordBatchAction("solution",n),Te(e),h("Solution revealed","info"),he(),ye()}function lt(){document.addEventListener("keydown",e=>{var t,n,o;if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")){if((e.ctrlKey||e.metaKey)&&e.key==="z"&&!e.shiftKey&&(e.preventDefault(),Pe()),((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key==="z"||(e.ctrlKey||e.metaKey)&&e.key==="y")&&(e.preventDefault(),Me()),e.key==="p"&&!e.ctrlKey&&!e.metaKey&&(e.preventDefault(),xe()),e.key>="1"&&e.key<="9"&&!e.ctrlKey&&!e.metaKey){const i=parseInt(e.key),l=s()[z],m=Object.keys(l.color_map).map(Number);i<=m.length&&V(m[i-1])}if((e.key==="0"||e.key==="x")&&!e.ctrlKey&&!e.metaKey&&V(0),e.key==="Escape"&&!e.ctrlKey&&!e.metaKey){const i=document.getElementById("help-modal"),l=i==null?void 0:i.classList.contains("visible");((t=window.Cozy.Screens)==null?void 0:t.getCurrentScreen())===((o=(n=window.Cozy.Screens)==null?void 0:n.SCREENS)==null?void 0:o.PUZZLE)&&!l&&(e.preventDefault(),De())}}})}function Qe(){const e=s(),t=oe();if(r.length>0&&e[z]&&t){const n=E(e[z]);t.savePuzzleGrid(n,r)}}function De(){Qe(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION)}function rt(e){window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:e})}function ct(e){const t=e.detail||{},n=s();let o=0;t.puzzleId!==void 0&&(o=t.puzzleId,typeof t.puzzleId=="string"&&(o=n.findIndex(i=>E(i)===t.puzzleId),o===-1&&(o=0))),L(o)}function at(e){Qe();const t=e.detail||{},n=window.Cozy.Collection;n&&(t.animateStamp&&t.scrollToPuzzleId?n.refresh({blankPuzzleId:t.scrollToPuzzleId}):n.refresh(),t.scrollToPuzzleId&&setTimeout(()=>{n.scrollToPuzzle(t.scrollToPuzzleId,{instant:t.quickAnimation}),t.animateStamp&&t.flyingStamp&&n.animateStampTo(t.scrollToPuzzleId,t.flyingStamp,{quick:t.quickAnimation})},50))}function ut(e){if(window.Cozy.Screens){const t=E(e),n=e.title.match(/^(.+?)\s*\(/),o=n?n[1].trim():e.title;window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.VICTORY,{puzzleId:t,puzzleName:o,solution:e.solution,palette:e.color_map})}}function dt(){const e=document.getElementById("current-puzzle-title");if(!e)return;const n=s()[z];if(n){const o=n.title.match(/^(.+?)\s*\(/);e.textContent=o?o[1].trim():n.title}}const nt=1200;function ot(e,t){if(!e)return;let n=null,o=!1;function i(m){m.type==="touchstart"&&m.preventDefault(),!e.disabled&&(o||(o=!0,e.classList.add("holding"),pe("Holding, keep holding to confirm"),n=setTimeout(()=>{o&&(e.classList.add("hold-complete"),l(),pe("Confirmed"),t(),setTimeout(()=>e.classList.remove("hold-complete"),50))},nt)))}function l(){o=!1,e.classList.remove("holding"),n&&(clearTimeout(n),n=null)}e.addEventListener("mousedown",i),e.addEventListener("mouseup",l),e.addEventListener("mouseleave",l),e.addEventListener("touchstart",i,{passive:!1}),e.addEventListener("touchend",l),e.addEventListener("touchcancel",l),e.addEventListener("keydown",m=>{(m.key==="Enter"||m.key===" ")&&(m.preventDefault(),i(m))}),e.addEventListener("keyup",m=>{(m.key==="Enter"||m.key===" ")&&l()}),e.addEventListener("blur",l),e.style.setProperty("--hold-duration",`${nt}ms`)}function ft(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("undo-btn"),o=document.getElementById("redo-btn");e&&e.addEventListener("click",()=>Se(!1)),t&&t.addEventListener("click",()=>Se(!0)),n&&n.addEventListener("click",Pe),o&&o.addEventListener("click",Me);const i=document.getElementById("clear-pencil-btn"),l=document.getElementById("confirm-pencil-btn");i&&i.addEventListener("click",()=>{Re(),Ee()}),l&&l.addEventListener("click",()=>{Ze(),Ee()});const m=document.getElementById("reset-btn"),I=document.getElementById("solution-btn");ot(m,et),ot(I,tt);const T=document.querySelector("#screen-puzzle .header-back-btn");T&&T.addEventListener("click",st);const Y=document.querySelector("#screen-collection .header-back-btn");Y&&Y.addEventListener("click",()=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.HOME)})}function it(){lt(),ft(),O(),C();const e=K();e&&e.updateUI(),ke();const t=oe();t&&t.onChange&&t.onChange(i=>{i==="reset"&&(r=[],z=0)});const n=window.Cozy.Collection,o=s();n&&o.length>0&&n.init("collection-screen",o,i=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:i})}),window.addEventListener("screen:puzzle",ct),window.addEventListener("screen:collection",at),o.length>0&&L(0)}function ht(){const t=s()[z];if(!t||r.length===0)return null;let n=!1;for(let o=0;o<t.height&&!n;o++)for(let i=0;i<t.width&&!n;i++){const l=u(o,i);l.value!==null&&l.value>0&&(n=!0)}return n?D(t.width,t.height,_.STAMP_CANVAS_SIZE,(o,i)=>{const l=u(o,i);if(l.value!==null&&l.value>0){const m=t.color_map[l.value];if(m)return m}return null}):null}function st(){const t=s()[z];if(!t){De();return}const n=E(t),o=ht();if(!o){De();return}const i=document.getElementById("grid");if(!i){De();return}const l=i.getBoundingClientRect(),m=Z(o,l);Qe(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION,{scrollToPuzzleId:n,animateStamp:!0,flyingStamp:m,quickAnimation:!0})}function mt(){r=[],z=0,c=1,M=!1,B=null,R=!1;const e=K();e&&e.clear()}function pt(e,t){const o=s()[z];if(!o)return null;const i=X[e],l=i?i.classList.contains("satisfied"):!1,m=o.row_clues[e].map(te=>({count:te.count,color:te.color,satisfied:l})),I=ce[t],T=I?I.classList.contains("satisfied"):!1,Y=o.col_clues[t].map(te=>({count:te.count,color:te.color,satisfied:T}));return{rowClues:m,colClues:Y}}function gt(e){const n=s()[z];return!n||!n.color_map?null:n.color_map[e]||null}function yt(){return s()[z]||null}window.Cozy.Garden={resetPuzzle:et,showSolution:tt,performUndo:Pe,performRedo:Me,togglePencilMode:xe,setPencilMode:Se,clearAllPencilMarks:Re,confirmAllPencilMarks:Ze,selectColor:V,showCollection:De,showGame:rt,clearAllState:mt,navigateToCollectionWithStamp:st,getPuzzleId:E,getClueInfo:pt,getColorRgb:gt,getCurrentPuzzle:yt},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",it):it()}(),function(){"use strict";const{CONFIG:_}=window.Cozy.Utils,E=.35,$=1,Z=.97,D=300,z=1500,A=100,c=10;let r=$,M=$,B=!1,ie=0,R=0,se=null,W=null,J=null,G=!1,re=-1,ee=-1,F=!1,X=null,ce=null,Q=null,w=null,d=null,h=null,S=null,p=null;function y(a,L,x){return Math.min(Math.max(a,L),x)}function k(a,L){const x=a.clientX-L.clientX,V=a.clientY-L.clientY;return Math.sqrt(x*x+V*V)}function g(a,L){return{x:(a.clientX+L.clientX)/2,y:(a.clientY+L.clientY)/2}}function O(){const a=window.innerWidth;return a<=360?20:a>=768?28:a>=1200?32:24}function C(a,L=!0){const x=X;if(!x)return;const V=r,le=f(),de=y(a,le,_.MAX_ZOOM);let ue,fe;L&&V!==de&&(ue=x.scrollLeft+x.clientWidth/2,fe=x.scrollTop+x.clientHeight/2),r=de;const we=O(),ze=Math.round(we*de);document.documentElement.style.setProperty("--cell-size",`${ze}px`);const ge=j(),be=de>ge+.01;x.classList.toggle("is-zoomed",be),P(),L&&V!==de&&ue!==void 0&&requestAnimationFrame(()=>{const Ie=de/V,Le=ue*Ie-x.clientWidth/2,Be=fe*Ie-x.clientHeight/2;x.scrollLeft=Math.max(0,Le),x.scrollTop=Math.max(0,Be)}),window.dispatchEvent(new CustomEvent("zoomchange",{detail:{zoom:de,oldZoom:V,isZoomed:be}}))}function P(){const a=f();if(h&&(h.disabled=r>=_.MAX_ZOOM),S&&(S.disabled=r<=a),p){const L=j(),x=Math.abs(r-L)<.05;p.classList.toggle("highlighted",!x&&r!==L)}}let H=null,N=null;function j(a=!1){var Ge;const L=X;if(!L||!((Ge=window.Cozy.Garden)!=null&&Ge.getCurrentPuzzle))return $;const x=window.Cozy.Garden.getCurrentPuzzle();if(!x)return $;const V=x.title;if(!a&&H!==null&&N===V)return H;const le=O(),de=Math.max(...x.row_clues.map(me=>me.length)),ue=Math.max(...x.col_clues.map(me=>me.length)),fe=Math.max(2,de*.6+.5),we=Math.max(2,ue*.6+.5),ze=x.width+fe+.25,ge=x.height+we+.25,be=L.clientWidth,Ie=L.clientHeight,Le=8,Be=(be-Le*2)/(ze*le),Oe=(Ie-Le*2)/(ge*le),je=Math.min(Be,Oe),Ue=y(je*Z,E,_.MAX_ZOOM);return H=Ue,N=V,Ue}function s(){H=null,N=null}function f(){const a=j();return Math.max(E,a)}function u(){const a=j();return r>a+.01}function v(a){a.touches.length===2&&(B=!0,ie=k(a.touches[0],a.touches[1]),M=r,a.preventDefault())}function b(a){if(B&&a.touches.length===2){const x=k(a.touches[0],a.touches[1])/ie,V=f(),le=y(M*x,V,_.MAX_ZOOM);Math.abs(le-r)>.05&&C(le,!0),a.preventDefault()}}function U(a){if(B&&a.touches.length<2&&(B=!1),a.touches.length===0&&!B){const L=a.target;if(!L.classList.contains("cell")){const V=Date.now();se===L&&V-R<D?(q(a.changedTouches[0]),R=0,se=null):(R=V,se=L)}}}function q(a){u()?C(j(),!0):C(_.COMFORTABLE_ZOOM,!0)}function oe(a){if(a.ctrlKey){a.preventDefault();const L=a.deltaY>0?-.15:.15;C(r+L,!0)}}function K(){Q&&u()&&Q.classList.add("visible")}function Ae(){Q&&(Q.classList.remove("visible"),re=-1,ee=-1)}function qe(a,L){var V,le;if(!Q||G||a===re&&L===ee)return;re=a,ee=L;const x=(le=(V=window.Cozy.Garden)==null?void 0:V.getClueInfo)==null?void 0:le.call(V,a,L);x&&(w&&(w.innerHTML=ye(x.rowClues)),d&&(d.innerHTML=ye(x.colClues)))}function ye(a){return!a||a.length===0?'<span class="clue-tooltip-num satisfied">0</span>':a.map(L=>{var ue,fe;const x=((fe=(ue=window.Cozy.Garden)==null?void 0:ue.getColorRgb)==null?void 0:fe.call(ue,L.color))||[128,128,128],V=L.satisfied,de=(x[0]*299+x[1]*587+x[2]*114)/1e3>_.BRIGHTNESS_MIDPOINT?"#333":"#fff";return`<span class="clue-tooltip-num${V?" satisfied":""}"
                    style="background: rgb(${x.join(",")}); color: ${de}">
                ${L.count}
              </span>`}).join("")}function pe(a){if(!Q||!X)return;const L=X.getBoundingClientRect(),x=L.top+L.height/2;a>x?(Q.classList.add("position-top"),Q.classList.remove("position-bottom")):(Q.classList.remove("position-top"),Q.classList.add("position-bottom"))}function Se(){clearTimeout(W),W=setTimeout(()=>{Ae()},z)}function xe(){clearTimeout(W)}function ke(a,L,x){u()&&(G=!1,xe(),clearTimeout(J),J=setTimeout(()=>{qe(a,L),pe(x),K()},A))}function Xe(){u()&&(G=!0,Q==null||Q.classList.add("dragging"))}function Ve(){u()&&(clearTimeout(J),G=!1,Q==null||Q.classList.remove("dragging"),Se())}function Ee(){h=document.querySelector(".zoom-btn.zoom-in"),S=document.querySelector(".zoom-btn.zoom-out"),p=document.querySelector(".zoom-btn.zoom-fit"),h&&h.addEventListener("click",()=>{C(r+.5,!0)}),S&&S.addEventListener("click",()=>{C(r-.5,!0)}),p&&p.addEventListener("click",()=>{C(j(),!0)}),P()}function _e(a){const L=document.getElementById("screen-puzzle");!L||L.classList.contains("screen-hidden")||(a.key==="+"||a.key==="="?(a.preventDefault(),C(r+.5,!0)):a.key==="-"||a.key==="_"?(a.preventDefault(),C(r-.5,!0)):a.key==="0"&&(a.preventDefault(),C(j(),!0)))}let He=null;function Ye(){clearTimeout(He),He=setTimeout(()=>{const a=document.getElementById("screen-puzzle");if(!a||a.classList.contains("screen-hidden"))return;s();const L=f();r<L&&C(L,!1),P()},150)}function he(){var L,x,V,le;const a=(x=(L=window.Cozy.Garden)==null?void 0:L.getCurrentPuzzle)==null?void 0:x.call(L);a&&(a.width<=_.AUTO_ZOOM_MIN_SIZE&&a.height<=_.AUTO_ZOOM_MIN_SIZE||(V=window.Cozy.Storage)!=null&&V.getFlag("zoomHintShown")||(Re(),(le=window.Cozy.Storage)==null||le.setFlag("zoomHintShown",!0)))}function Re(){let a=document.getElementById("zoom-hint-toast");a||(a=document.createElement("div"),a.id="zoom-hint-toast",a.className="zoom-hint-toast",a.textContent="Tip: Pinch to zoom for easier tapping",document.body.appendChild(a)),a.classList.add("visible"),setTimeout(()=>{a.classList.remove("visible")},4e3)}function Ze(){if(!F){if(X=document.getElementById("zoom-container"),ce=X==null?void 0:X.querySelector(".board-wrapper"),Q=document.getElementById("clue-tooltip"),w=document.getElementById("tooltip-row-clues"),d=document.getElementById("tooltip-col-clues"),!X){console.warn("[Zoom] zoom-container not found, zoom disabled");return}X.addEventListener("touchstart",v,{passive:!1}),X.addEventListener("touchmove",b,{passive:!1}),X.addEventListener("touchend",U,{passive:!0}),X.addEventListener("wheel",oe,{passive:!1}),Ee(),document.addEventListener("keydown",_e),window.addEventListener("resize",Ye),F=!0,console.log("[Zoom] Initialized")}}function Pe(){s();const a=j();C(a,!1),setTimeout(he,500)}function Me(){ve(!1),Ae(),clearTimeout(W),clearTimeout(J)}function ve(a=!0){We($,a)}function Ke(a=!0){const L=j();We(L,a)}function We(a,L=!0){if(L&&r!==a){let de=function(ue){const fe=ue-le,we=Math.min(fe/V,1),ze=1-Math.pow(1-we,3),ge=x+(a-x)*ze;C(ge,!1),we<1&&requestAnimationFrame(de)};const x=r,V=200,le=performance.now();requestAnimationFrame(de)}else C(a,!1)}window.Cozy.Zoom={init:Ze,initForPuzzle:Pe,destroy:Me,resetZoom:ve,zoomToFit:Ke,getZoom:()=>r,setZoom:(a,L=!0)=>C(a,!L),zoomIn:(a=.5)=>C(r+a,!0),zoomOut:(a=.5)=>C(r-a,!0),isZoomed:u,onCellTouchStart:ke,onCellTouchMove:Xe,onCellTouchEnd:Ve,getEffectiveMinZoom:f}}();

//# sourceMappingURL=app.min.js.map