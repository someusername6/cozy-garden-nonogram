(function(){"use strict";const _={STAMP_CANVAS_SIZE:180,VICTORY_CANVAS_SIZE:180,MINI_CANVAS_SIZE:80,OUTLINE_THICKNESS:2,MAX_PUZZLE_DIMENSION:32,MAX_HISTORY:50,MAX_SCREEN_HISTORY:10,MAX_SEARCH_LENGTH:100,TOAST_DURATION:2500,LONG_PRESS_DELAY:400,SEARCH_DEBOUNCE:150,MAX_ZOOM:3,COMFORTABLE_ZOOM:2,AUTO_ZOOM_MIN_SIZE:10,BRIGHTNESS_MIDPOINT:128,BADGE_MAX_DISPLAY:99};function A(M){return(M.t||M.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"")}function C(M){return M.t||M.title}function P(M){const I=M.match(/^(.+?)\s*\((\d+)x(\d+),\s*(\w+)\)$/i);return I?{name:I[1].trim(),width:parseInt(I[2],10),height:parseInt(I[3],10),difficulty:I[4].toLowerCase()}:{name:M,width:0,height:0,difficulty:"unknown"}}function T(M,I,h,d){const U=Math.max(M,I),R=Math.max(2,Math.floor(h/U)),J=_.OUTLINE_THICKNESS*2,oe=_.OUTLINE_THICKNESS,ee=document.createElement("canvas");ee.width=M*R+J,ee.height=I*R+J;const Z=ee.getContext("2d");if(!Z)return console.warn("[Utils] Failed to get 2D context for canvas"),ee;try{const re=getComputedStyle(document.documentElement).getPropertyValue("--color-text-muted").trim()||"#8a8a7a";Z.fillStyle=re;for(let te=0;te<I;te++)for(let ne=0;ne<M;ne++)if(d(te,ne)){const se=oe+ne*R,W=oe+te*R;Z.fillRect(se-_.OUTLINE_THICKNESS,W-_.OUTLINE_THICKNESS,R+J,R+J)}for(let te=0;te<I;te++)for(let ne=0;ne<M;ne++){const X=d(te,ne);if(X){Z.fillStyle=`rgb(${X[0]}, ${X[1]}, ${X[2]})`;const se=oe+ne*R,W=oe+te*R;Z.fillRect(se,W,R,R)}}}catch(re){console.error("[Utils] Failed to render canvas:",re)}return ee}window.Cozy=window.Cozy||{},window.Cozy.Utils={CONFIG:_,getPuzzleId:A,getPuzzleTitle:C,parsePuzzleTitle:P,renderOutlinedCanvas:T}})(),function(){"use strict";const _="cozy_garden_data";function C(I){return!(!I||typeof I!="object"||typeof I.version!="number"||I.progress!==null&&typeof I.progress!="object"||I.settings!==null&&typeof I.settings!="object"||I.stats!==null&&typeof I.stats!="object")}function P(){return{version:1,progress:{},settings:{vibration:!0,theme:"light"},stats:{totalCompleted:0,totalAttempts:0,totalPlayTime:0,streak:0,lastPlayDate:null},currentSession:{puzzleIndex:0,difficulty:"easy",grid:null,startTime:null},flags:{tutorialCompleted:!1,helpShown:!1,zoomHintShown:!1},uiState:{collapsedSections:[]}}}class T{constructor(){this.data=null,this.listeners=[]}init(){try{const h=localStorage.getItem(_);if(h){const d=JSON.parse(h);C(d)?this.data=d:(console.warn("[Storage] Invalid data structure, using defaults"),this.data=P(),this.save())}else this.data=P(),this.save()}catch(h){console.warn("[Storage] Failed to load, using defaults:",h),this.data=P(),this.save()}return this}save(){try{return localStorage.setItem(_,JSON.stringify(this.data)),this.notifyListeners("save"),!0}catch(h){return console.error("[Storage] Failed to save:",h),!1}}onChange(h){return this.listeners.push(h),()=>{this.listeners=this.listeners.filter(d=>d!==h)}}notifyListeners(h){this.listeners.forEach(d=>d(h,this.data))}getPuzzleProgress(h){return this.data.progress[h]||{completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}}savePuzzleGrid(h,d){this.data.progress||(this.data.progress={}),this.data.progress[h]||(this.data.progress[h]={completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}),d?this.data.progress[h].savedGrid=d.map(U=>U.map(R=>({value:R.value,certain:R.certain}))):this.data.progress[h].savedGrid=null,this.save()}getPuzzleGrid(h){if(!this.data.progress)return null;const d=this.data.progress[h];return!d||!d.savedGrid?null:d.savedGrid.map(U=>U.map(R=>({value:R.value,certain:R.certain})))}completePuzzle(h){const d=this.getPuzzleProgress(h),U=!d.completed;return d.completed=!0,d.attempts+=1,d.lastPlayed=Date.now(),d.savedGrid=null,this.data.progress[h]=d,U&&(this.data.stats.totalCompleted+=1),this.data.stats.totalAttempts+=1,this.updateStreak(),this.save(),{wasNew:U,progress:d}}isPuzzleCompleted(h){var d;return((d=this.data.progress[h])==null?void 0:d.completed)||!1}getCompletionStats(){return{easy:{completed:0,total:0},medium:{completed:0,total:0},hard:{completed:0,total:0},challenging:{completed:0,total:0},expert:{completed:0,total:0}}}saveSession(h,d,U){let R=null;U&&(R=U.map(J=>J.map(oe=>({value:oe.value,certain:oe.certain})))),this.data.currentSession={puzzleIndex:h,difficulty:d,grid:R},this.save()}getSession(){return this.data.currentSession}clearSession(){this.data.currentSession={puzzleIndex:0,difficulty:"easy",grid:null},this.save()}getSetting(h){return this.data.settings[h]}setSetting(h,d){this.data.settings[h]=d,this.save(),this.notifyListeners("settings")}getSettings(){return{...this.data.settings}}getStats(){return{...this.data.stats}}addPlayTime(h){this.data.stats.totalPlayTime+=h,this.save()}updateStreak(){const h=new Date().toDateString(),d=this.data.stats.lastPlayDate;if(d===h)return;const U=new Date(Date.now()-864e5).toDateString();d===U?this.data.stats.streak+=1:d!==h&&(this.data.stats.streak=1),this.data.stats.lastPlayDate=h}getFlag(h){var d;return((d=this.data.flags)==null?void 0:d[h])||!1}setFlag(h,d=!0){this.data.flags||(this.data.flags={}),this.data.flags[h]=d,this.save()}getUIState(h){var d;return(d=this.data.uiState)==null?void 0:d[h]}setUIState(h,d){this.data.uiState||(this.data.uiState={}),this.data.uiState[h]=d,this.save()}exportData(){return JSON.stringify(this.data,null,2)}importData(h){try{const d=JSON.parse(h);return C(d)?(this.data=d,this.save(),!0):!1}catch(d){return console.error("[Storage] Import failed:",d),!1}}reset(){this.data=P(),this.save(),this.notifyListeners("reset")}}const M=new T().init();window.Cozy.Storage=M}(),function(){"use strict";const{CONFIG:_}=window.Cozy.Utils;let A=[],C=[],P=null;const T={beginAction(M="fill"){P&&P.changes.length>0&&this.commitAction(),P={type:M,changes:[],timestamp:Date.now()}},recordChange(M,I,h,d){if(h.value===d.value&&h.certain===d.certain)return;P||this.beginAction("fill");const U=P.changes.find(R=>R.row===M&&R.col===I);U?U.after={value:d.value,certain:d.certain}:P.changes.push({row:M,col:I,before:{value:h.value,certain:h.certain},after:{value:d.value,certain:d.certain}})},commitAction(){P&&P.changes.length>0&&(P.changes=P.changes.filter(M=>M.before.value!==M.after.value||M.before.certain!==M.after.certain),P.changes.length>0&&(A.push(P),A.length>_.MAX_HISTORY&&A.shift(),C=[]),this.updateUI()),P=null},cancelAction(){P=null},recordBatchAction(M,I){if(I.length===0)return;const h={type:M,changes:I.map(d=>({row:d.row,col:d.col,before:{value:d.before.value,certain:d.before.certain},after:{value:d.after.value,certain:d.after.certain}})),timestamp:Date.now()};A.push(h),A.length>_.MAX_HISTORY&&A.shift(),C=[],this.updateUI()},undo(){if(A.length===0)return null;const M=A.pop();return C.push(M),this.updateUI(),M.changes.map(I=>({row:I.row,col:I.col,state:{value:I.before.value,certain:I.before.certain}}))},redo(){if(C.length===0)return null;const M=C.pop();return A.push(M),this.updateUI(),M.changes.map(I=>({row:I.row,col:I.col,state:{value:I.after.value,certain:I.after.certain}}))},canUndo(){return A.length>0},canRedo(){return C.length>0},clear(){A=[],C=[],P=null,this.updateUI()},updateUI(){const M=document.getElementById("undo-btn"),I=document.getElementById("redo-btn");M&&(M.disabled=!this.canUndo()),I&&(I.disabled=!this.canRedo())},getStats(){return{undoDepth:A.length,redoDepth:C.length,hasPending:P!==null,pendingChanges:P?P.changes.length:0}}};window.Cozy.History=T}();const ScreenManager=function(){"use strict";const{CONFIG:_,renderOutlinedCanvas:A}=window.Cozy.Utils,C={SPLASH:"splash",HOME:"home",COLLECTION:"collection",PUZZLE:"puzzle",VICTORY:"victory",SETTINGS:"settings",TUTORIAL:"tutorial"};let P=null,T=[],M={},I={},h=null;function d(s){const r=document.getElementById("confirm-modal"),g=document.getElementById("confirm-modal-title"),L=document.getElementById("confirm-modal-message"),c=document.getElementById("confirm-modal-confirm"),N=document.getElementById("confirm-modal-cancel");r&&(g.textContent=s.title||"Confirm",L.textContent=s.message||"Are you sure?",c.textContent=s.confirmText||"Confirm",N.textContent=s.cancelText||"Cancel",c.classList.toggle("confirm-modal-btn-danger",!!s.danger),c.classList.toggle("confirm-modal-btn-primary",!s.danger),r.classList.remove("alert-mode"),h=s,r.classList.add("visible"),setTimeout(()=>c.focus(),100))}function U(s){const r=document.getElementById("confirm-modal"),g=document.getElementById("confirm-modal-title"),L=document.getElementById("confirm-modal-message"),c=document.getElementById("confirm-modal-confirm");r&&(g.textContent=s.title||"Notice",L.textContent=s.message||"",c.textContent=s.buttonText||"OK",c.classList.remove("confirm-modal-btn-danger"),c.classList.add("confirm-modal-btn-primary"),r.classList.add("alert-mode"),h={onConfirm:s.onClose},r.classList.add("visible"),setTimeout(()=>c.focus(),100))}function R(){const s=document.getElementById("confirm-modal");s&&s.classList.remove("visible"),h=null}function J(){const s=document.getElementById("confirm-modal"),r=s==null?void 0:s.querySelector(".confirm-modal-backdrop"),g=document.getElementById("confirm-modal-confirm"),L=document.getElementById("confirm-modal-cancel");s&&(g==null||g.addEventListener("click",()=>{const c=h==null?void 0:h.onConfirm;R(),c&&setTimeout(c,200)}),L==null||L.addEventListener("click",()=>{const c=h==null?void 0:h.onCancel;R(),c&&c()}),r==null||r.addEventListener("click",()=>{const c=h==null?void 0:h.onCancel;R(),c&&c()}),document.addEventListener("keydown",c=>{if(c.key==="Escape"&&s.classList.contains("visible")){const N=h==null?void 0:h.onCancel;R(),N&&N()}if(c.key==="Tab"&&s.classList.contains("visible")){const a=s.classList.contains("alert-mode")?[g]:[L,g],B=a[0],G=a[a.length-1];a.includes(document.activeElement)?c.shiftKey?document.activeElement===B&&(c.preventDefault(),G.focus()):document.activeElement===G&&(c.preventDefault(),B.focus()):(c.preventDefault(),B.focus())}}))}function oe(){H(),J(),Object.values(C).forEach(s=>{const r=document.getElementById(`screen-${s}`);I[s]=r,r&&r.setAttribute("inert","")}),window.addEventListener("popstate",te),document.addEventListener("keydown",ee),Z(C.SPLASH,{},!1)}function ee(s){if(s.key!=="Escape"||s.target.tagName==="INPUT"||s.target.tagName==="TEXTAREA")return;const r=document.getElementById("confirm-modal"),g=document.getElementById("help-modal");if(!(r!=null&&r.classList.contains("visible")||g!=null&&g.classList.contains("visible")))switch(P){case C.HOME:break;case C.COLLECTION:Z(C.HOME);break;case C.PUZZLE:break;case C.VICTORY:Z(C.COLLECTION);break;case C.SETTINGS:Z(C.HOME);break;case C.TUTORIAL:window.Cozy.Storage&&window.Cozy.Storage.setFlag("tutorialComplete",!0),Z(C.HOME);break}}function Z(s,r={},g=!0){const L=I[s];if(!L){console.error(`Screen not found: ${s}`);return}M=r,P&&I[P]&&(P===C.PUZZLE&&window.Cozy.Zoom&&window.Cozy.Zoom.destroy(),I[P].classList.remove("screen-active"),I[P].classList.add("screen-hidden"),I[P].setAttribute("inert","")),L.classList.remove("screen-hidden"),L.classList.add("screen-active"),L.removeAttribute("inert"),g&&P!==null&&(T.push(P),T.length>_.MAX_SCREEN_HISTORY&&(T=T.slice(-_.MAX_SCREEN_HISTORY)),history.pushState({screen:s},"",`#${s}`));const c=P;P=s,ne(s,r,c)}function re(){if(T.length>0){const s=T.pop();Z(s,{},!1),history.back()}}function te(s){if(s.state&&s.state.screen)Z(s.state.screen,{},!1);else if(T.length>0){const r=T.pop();Z(r,{},!1)}}function ne(s,r,g){switch(s){case C.SPLASH:W();break;case C.HOME:we();break;case C.COLLECTION:z(r);break;case C.PUZZLE:m(r);break;case C.VICTORY:E(r);break;case C.SETTINGS:v();break;case C.TUTORIAL:w();break}}function X(){return M}function se(){return P}function W(){setTimeout(()=>{var L;if(new URLSearchParams(window.location.search).get("action")==="continue"){const c=window.location.pathname+window.location.hash;history.replaceState(null,"",c);const N=window.Cozy.Storage;if(N){const a=N.getSession();if(a&&typeof a.puzzleIndex=="number"){Z(C.PUZZLE,{puzzleId:a.puzzleIndex});return}}}const g=(L=window.Cozy.Storage)==null?void 0:L.getFlag("tutorialCompleted");Z(g?C.HOME:C.TUTORIAL)},1500)}function we(){var L;const s=document.getElementById("home-play-btn"),r=document.getElementById("home-settings-btn"),g=document.getElementById("home-progress");if(s&&!s.hasAttribute("data-initialized")&&(s.addEventListener("click",()=>Z(C.COLLECTION)),s.setAttribute("data-initialized","true")),r&&!r.hasAttribute("data-initialized")&&(r.addEventListener("click",()=>Z(C.SETTINGS)),r.setAttribute("data-initialized","true")),g&&window.PUZZLE_DATA){const c=window.PUZZLE_DATA,N=Array.isArray(c)?c.length:0;let a=0;window.Cozy.Storage&&((L=window.Cozy.Garden)!=null&&L.getPuzzleId)&&c.forEach(B=>{const G=window.Cozy.Garden.getPuzzleId(B);window.Cozy.Storage.isPuzzleCompleted(G)&&a++}),g.textContent=`${a} / ${N} puzzles solved`}s&&setTimeout(()=>s.focus(),100)}function z(s){window.dispatchEvent(new CustomEvent("screen:collection",{detail:s}));const r=document.getElementById("collection-search-input");r&&setTimeout(()=>r.focus(),100)}function m(s){window.Cozy.Zoom&&window.Cozy.Zoom.init(),window.dispatchEvent(new CustomEvent("screen:puzzle",{detail:s}))}let p=null;function E(s){const r=document.getElementById("victory-puzzle-name"),g=document.getElementById("victory-image"),L=document.getElementById("victory-continue-btn");p=s.puzzleId,r&&s.puzzleName&&(r.textContent=s.puzzleName),g&&s.solution&&y(g,s.solution,s.palette),L&&!L.hasAttribute("data-initialized")&&(L.addEventListener("click",()=>{const c=g?g.querySelector("canvas"):null;if(c){const N=g.getBoundingClientRect(),a=document.createElement("canvas");a.width=c.width,a.height=c.height,a.getContext("2d").drawImage(c,0,0);const G=c.width,Q=c.height,F=c.width/c.height,V=Math.min(N.width,N.height);let $;F>1?$=V:$=V*F;const he=$/G,ve=N.left+N.width/2,me=N.top+N.height/2;a.className="flying-stamp",a.style.left=ve-G/2+"px",a.style.top=me-Q/2+"px",a.style.width=G+"px",a.style.height=Q+"px",a.style.transform="scale("+he+")",document.body.appendChild(a),Z(C.COLLECTION,{scrollToPuzzleId:p,animateStamp:!0,flyingStamp:a})}else Z(C.COLLECTION,{scrollToPuzzleId:p})}),L.setAttribute("data-initialized","true")),L&&setTimeout(()=>L.focus(),100)}function y(s,r,g){s.innerHTML="";const L=r.length,c=r[0]?r[0].length:L,N=A(c,L,_.VICTORY_CANVAS_SIZE,(a,B)=>{const G=r[a][B];return G>0&&g[G]?g[G]:null});s.appendChild(N)}function v(){var G,Q;const s=document.getElementById("settings-back-btn"),r=document.getElementById("settings-vibration"),g=document.getElementById("settings-reset-btn"),L=window.Cozy.Storage;r&&(r.checked=(G=L==null?void 0:L.getSetting("vibration"))!=null?G:!0),s&&!s.hasAttribute("data-initialized")&&(s.addEventListener("click",re),s.setAttribute("data-initialized","true")),r&&!r.hasAttribute("data-initialized")&&(r.addEventListener("change",()=>L==null?void 0:L.setSetting("vibration",r.checked)),r.setAttribute("data-initialized","true")),g&&!g.hasAttribute("data-initialized")&&(g.addEventListener("click",()=>{d({title:"Reset Progress",message:"Are you sure you want to reset all progress? This cannot be undone.",confirmText:"Reset",cancelText:"Cancel",danger:!0,onConfirm:()=>{window.Cozy.Garden&&window.Cozy.Garden.clearAllState&&window.Cozy.Garden.clearAllState(),window.Cozy.Storage&&window.Cozy.Storage.reset&&window.Cozy.Storage.reset(),window.Cozy.Collection&&window.Cozy.Collection.refresh(),U({title:"Progress Reset",message:"All progress has been cleared."})}})}),g.setAttribute("data-initialized","true"));const c=document.getElementById("settings-tutorial-btn");c&&!c.hasAttribute("data-initialized")&&(c.addEventListener("click",()=>{Z(C.TUTORIAL)}),c.setAttribute("data-initialized","true"));const N=document.querySelectorAll(".theme-option");let a=(Q=window.Cozy.Storage)==null?void 0:Q.getSetting("theme");(!a||a==="system")&&(a=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),N.forEach(F=>{const $=F.dataset.theme===a;F.classList.toggle("active",$),F.setAttribute("aria-pressed",$?"true":"false")}),N.forEach(F=>{F.hasAttribute("data-initialized")||(F.addEventListener("click",()=>{const V=F.dataset.theme;N.forEach($=>{$.classList.remove("active"),$.setAttribute("aria-pressed","false")}),F.classList.add("active"),F.setAttribute("aria-pressed","true"),window.Cozy.Storage&&window.Cozy.Storage.setSetting("theme",V),x(V)}),F.setAttribute("data-initialized","true"))});const B=document.getElementById("settings-solve-all-btn");B&&!B.hasAttribute("data-initialized")&&(B.addEventListener("click",()=>{d({title:"Debug: Solve All",message:"Mark all puzzles as solved? This is a debug feature.",confirmText:"Solve All",cancelText:"Cancel",onConfirm:()=>{const F=window.PUZZLE_DATA||[],V=window.Cozy.Storage;V&&F.forEach($=>{var ve;let he;(ve=window.Cozy.Garden)!=null&&ve.getPuzzleId?he=window.Cozy.Garden.getPuzzleId($):he=($.t||$.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""),V.completePuzzle(he)}),window.Cozy.Collection&&window.Cozy.Collection.refresh(),U({title:"All Puzzles Solved",message:`Marked ${F.length} puzzles as solved!`})}})}),B.setAttribute("data-initialized","true")),r&&setTimeout(()=>r.focus(),100)}let D=0;function w(){const s=document.getElementById("tutorial-skip-btn"),r=document.getElementById("tutorial-next-btn"),g=document.querySelectorAll(".tutorial-step"),L=document.querySelectorAll(".tutorial-dot");function c(a){g.forEach((B,G)=>{B.classList.toggle("active",G===a)}),L.forEach((B,G)=>{B.classList.toggle("active",G===a)}),r&&(r.textContent=a===g.length-1?"Start Playing":"Next")}function N(){var a;(a=window.Cozy.Storage)==null||a.setFlag("tutorialCompleted",!0),Z(C.HOME)}s&&!s.hasAttribute("data-initialized")&&(s.addEventListener("click",N),s.setAttribute("data-initialized","true")),r&&!r.hasAttribute("data-initialized")&&(r.addEventListener("click",()=>{D<g.length-1?(D++,c(D)):N()}),r.setAttribute("data-initialized","true")),D=0,c(0),r&&setTimeout(()=>r.focus(),100)}function x(s){document.documentElement.setAttribute("data-theme",s);const r=document.getElementById("theme-color-meta");r&&r.setAttribute("content",s==="dark"?"#0a1018":"#4a7c3f")}function H(){var r;let s=(r=window.Cozy.Storage)==null?void 0:r.getSetting("theme");(!s||s==="system")&&(s=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),x(s)}return{init:oe,showScreen:Z,goBack:re,getScreenData:X,getCurrentScreen:se,applyTheme:x,initTheme:H,showConfirmModal:d,SCREENS:C}}();window.Cozy.Screens=ScreenManager,document.addEventListener("DOMContentLoaded",()=>{ScreenManager.init()}),function(){"use strict";const{CONFIG:_,getPuzzleId:A,getPuzzleTitle:C,parsePuzzleTitle:P,renderOutlinedCanvas:T}=window.Cozy.Utils,M=["easy","medium","hard","challenging","expert"];function I(){var m;const z=(m=window.Cozy.Storage)==null?void 0:m.getUIState("collapsedSections");return z&&typeof z=="object"?z:null}function h(z){var m;(m=window.Cozy.Storage)==null||m.setUIState("collapsedSections",z)}function d(z,m){const p=document.querySelector(`.collection-section[data-difficulty="${z}"]`);if(!p)return;const y=!m[z];m[z]=y,h(m),p.classList.toggle("collapsed",y);const v=p.querySelector(".collection-grid"),D=p.querySelector(".section-chevron"),w=p.querySelector(".collection-section-header");if(v&&(v.style.display=y?"none":"flex"),D&&(D.textContent=y?"\u25B6":"\u25BC"),w){w.setAttribute("aria-expanded",!y);const x=w.querySelector(".collection-section-stats"),H=x?x.textContent:"",[s,r]=H.split("/");w.setAttribute("aria-label",`${ee(z)}, ${s} of ${r} completed, ${y?"collapsed":"expanded"}`)}window.Cozy.Collection&&window.Cozy.Collection.updateRovingTabindex()}function U(){return window.Cozy.Storage||null}function R(z){const m={};return z.forEach((p,E)=>{const y=P(C(p)),v=y.difficulty;m[v]||(m[v]=[]),m[v].push({index:E,puzzle:p,meta:y,id:A(p)})}),m}function J(z){const m={};return z.forEach(p=>{const E=P(C(p.puzzle)),y=E.difficulty;m[y]||(m[y]=[]),m[y].push({index:p.originalIndex,puzzle:p.puzzle,meta:E,id:A(p.puzzle)})}),m}function oe(z){return Object.keys(z).sort((p,E)=>{const y=M.indexOf(p),v=M.indexOf(E);return y!==-1&&v!==-1?y-v:y!==-1?-1:v!==-1?1:p.localeCompare(E)})}function ee(z){return z.charAt(0).toUpperCase()+z.slice(1)}function Z(z){const m=U();let p=0;return m&&z.forEach(E=>{m.isPuzzleCompleted(E.id)&&p++}),{completed:p,total:z.length}}function re(z){if(!z)return!1;for(const m of z)for(const p of m)if((typeof p=="object"&&p!==null?p.value:p)!==null)return!0;return!1}function te(z,m,p={}){const E=U(),y=E?E.isPuzzleCompleted(z.id):!1,v=E?E.getPuzzleGrid(z.id):null,D=!y&&re(v),w=document.createElement("div");w.className="puzzle-card"+(y?" completed":"")+(D?" in-progress":""),w.dataset.puzzleIndex=z.index,w.dataset.puzzleId=z.id,w.tabIndex=-1,w.setAttribute("role","button"),w.setAttribute("aria-label",`${z.meta.name}, ${z.meta.width} by ${z.meta.height}${y?", completed":""}`),w.addEventListener("keydown",g=>{if(g.key==="Enter"||g.key===" "){g.preventDefault(),window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=z.id),m(z.index);return}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(g.key)&&(g.preventDefault(),g.stopPropagation(),window.Cozy.Collection&&window.Cozy.Collection.navigateFromElement(w,g.key))});const x=document.createElement("div");if(x.className="puzzle-card-preview",p.forceBlank){x.classList.add("awaiting-stamp");const g=document.createElement("div");g.className="puzzle-card-placeholder",g.textContent="?",x.appendChild(g)}else if(y)x.appendChild(ne(z.puzzle));else if(D)x.appendChild(X(z.puzzle,v));else{const g=document.createElement("div");g.className="puzzle-card-placeholder",g.textContent="?",x.appendChild(g)}w.appendChild(x);const H=document.createElement("div");H.className="puzzle-card-name",H.textContent=z.meta.name,w.appendChild(H);const s=Object.keys(z.puzzle.color_map).length,r=document.createElement("div");return r.className="puzzle-card-badge",r.textContent=`${z.meta.width}\xD7${z.meta.height} \xB7 ${s}c`,w.appendChild(r),w.addEventListener("click",()=>{window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=z.id),m(z.index)}),w}function ne(z){try{const m=T(z.width,z.height,_.MINI_CANVAS_SIZE,(p,E)=>{var v,D,w;const y=(D=(v=z.solution)==null?void 0:v[p])==null?void 0:D[E];if(y>0){const x=(w=z.color_map)==null?void 0:w[y];if(x&&Array.isArray(x)&&x.length>=3)return x}return null});return m.className="puzzle-mini-canvas",m}catch(m){return console.error("[Collection] Error creating mini solution:",m),null}}function X(z,m){try{const p=T(z.width,z.height,_.MINI_CANVAS_SIZE,(E,y)=>{var w,x;const v=(w=m==null?void 0:m[E])==null?void 0:w[y],D=typeof v=="object"&&v!==null?v.value:v;if(D!==null&&D>0){const H=(x=z.color_map)==null?void 0:x[D];if(H&&Array.isArray(H)&&H.length>=3)return H}return null});return p.className="puzzle-mini-canvas",p}catch(p){return console.error("[Collection] Error creating mini progress:",p),null}}function se(z,m,p,E={}){z.innerHTML="";const y=(E.searchFilter||"").toLowerCase().trim().slice(0,_.MAX_SEARCH_LENGTH);let v=m.map((s,r)=>({puzzle:s,originalIndex:r}));y&&(v=v.filter(s=>P(C(s.puzzle)).name.toLowerCase().includes(y)));const D=J(v),w=oe(D),x=U();if(w.length===0&&y){const s=document.createElement("div");s.className="collection-empty-state";const r=document.createElement("p");r.className="collection-empty-message",r.textContent=`No puzzles match "${y}"`,s.appendChild(r),z.appendChild(s);return}let H;if(y)H={},w.forEach(s=>{H[s]=!1});else if(H=I(),!H){H={};let s=!1;w.forEach(r=>{const g=Z(D[r]);!s&&g.completed<g.total?(H[r]=!1,s=!0):H[r]=!0}),!s&&w.length>0&&(H[w[0]]=!1),h(H)}w.forEach(s=>{const r=D[s],g=Z(r),L=H[s],c=document.createElement("div");c.className="collection-section"+(L?" collapsed":""),c.dataset.difficulty=s;const N=`collection-grid-${s}`,a=document.createElement("div");a.className="collection-section-header",a.style.cursor="pointer",a.dataset.difficulty=s,a.tabIndex=-1,a.setAttribute("role","button"),a.setAttribute("aria-expanded",!L),a.setAttribute("aria-controls",N),a.setAttribute("aria-label",`${ee(s)}, ${g.completed} of ${g.total} completed, ${L?"collapsed":"expanded"}`);const B=document.createElement("span");B.className="section-chevron",B.setAttribute("aria-hidden","true"),B.textContent=L?"\u25B6":"\u25BC",a.appendChild(B);const G=document.createElement("h3");G.className="collection-section-title",G.textContent=ee(s),a.appendChild(G);const Q=document.createElement("span");Q.className="collection-section-stats",Q.textContent=`${g.completed}/${g.total}`,g.completed===g.total&&g.total>0&&Q.classList.add("complete"),a.appendChild(Q),a.addEventListener("click",()=>{d(s,H)}),a.addEventListener("keydown",V=>{if(V.key==="Enter"||V.key===" "){V.preventDefault(),d(s,H);return}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(V.key)&&(V.preventDefault(),V.stopPropagation(),window.Cozy.Collection&&window.Cozy.Collection.navigateFromElement(a,V.key))}),c.appendChild(a);const F=document.createElement("div");F.className="collection-grid",F.id=N,F.style.display=L?"none":"flex",r.forEach(V=>{const $={};E.blankPuzzleId&&V.id===E.blankPuzzleId&&($.forceBlank=!0);const he=te(V,p,$);F.appendChild(he)}),c.appendChild(F),z.appendChild(c)})}class W{constructor(){this.container=null,this.puzzles=[],this.onPuzzleSelect=null,this.visible=!0,this.searchFilter="",this.searchInput=null,this.searchInputHandler=null,this.searchDebounceTimeout=null,this.focusedCardId=null,this.focusedHeaderDifficulty=null,this.idealX=null}init(m,p,E){return this.container=document.getElementById(m),this.puzzles=p,this.onPuzzleSelect=E,this.searchInput=document.getElementById("collection-search-input"),this.searchInput&&(this.searchInputHandler&&this.searchInput.removeEventListener("input",this.searchInputHandler),this.searchInputHandler=y=>{this.searchFilter=y.target.value,this.searchDebounceTimeout&&clearTimeout(this.searchDebounceTimeout),this.searchDebounceTimeout=setTimeout(()=>this.render(),150)},this.searchInput.addEventListener("input",this.searchInputHandler)),this.container&&this.render(),this}render(m={}){if(!this.container)return;const p={...m,searchFilter:this.searchFilter};se(this.container,this.puzzles,E=>{this.onPuzzleSelect&&this.onPuzzleSelect(E)},p),this.updateRovingTabindex()}show(){this.container&&(this.container.style.display="block",this.visible=!0,this.searchFilter="",this.searchInput&&(this.searchInput.value=""),this.render())}hide(){this.container&&(this.container.style.display="none",this.visible=!1)}isVisible(){return this.visible}refresh(m={}){this.visible&&this.render(m)}getVisibleCards(){if(!this.container)return[];const m=[];return this.container.querySelectorAll(".collection-section").forEach(E=>{const y=E.querySelector(".collection-grid");y&&y.style.display!=="none"&&y.querySelectorAll(".puzzle-card").forEach(D=>m.push(D))}),m}getNavigableElements(){if(!this.container)return[];const m=[];return this.container.querySelectorAll(".collection-section").forEach(E=>{const y=E.querySelector(".collection-section-header");y&&m.push(y);const v=E.querySelector(".collection-grid");v&&v.style.display!=="none"&&v.querySelectorAll(".puzzle-card").forEach(w=>m.push(w))}),m}isHeader(m){return m&&m.classList.contains("collection-section-header")}findElementInDirection(m,p,E=null){const y=this.getNavigableElements();if(y.length===0)return null;const v=m.getBoundingClientRect(),D=v.left+v.width/2,w=v.top+v.height/2,x=this.isHeader(m),H=(p==="up"||p==="down")&&E!==null?E:D,s=v.height*.5,r=v.width*.5;let g=null,L=1/0;return y.forEach(c=>{if(c===m)return;const N=c.getBoundingClientRect(),a=N.left+N.width/2,B=N.top+N.height/2,G=this.isHeader(c);let Q=!1;switch(p){case"left":x?Q=!1:Q=!G&&a<D-r&&Math.abs(B-w)<s;break;case"right":x?Q=!1:Q=!G&&a>D+r&&Math.abs(B-w)<s;break;case"up":Q=B<w-s;break;case"down":Q=B>w+s;break}if(Q){let F;if(p==="left"||p==="right")F=Math.abs(a-D);else{const V=Math.abs(B-w),$=Math.abs(a-H);F=V*1e3+$}F<L&&(L=F,g=c)}}),g}navigateFromElement(m,p){const y={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[p];if(!y)return;const v=m.getBoundingClientRect(),D=v.left+v.width/2;let w;if(y==="up"||y==="down"?(this.idealX===null&&(this.idealX=D),w=this.findElementInDirection(m,y,this.idealX)):w=this.findElementInDirection(m,y),w){const x=w.getBoundingClientRect(),H=x.left+x.width/2;y==="left"||y==="right"?this.idealX=H:this.isHeader(w),m.tabIndex=-1,w.tabIndex=0,w.focus(),this.isHeader(w)?(this.focusedCardId=null,this.focusedHeaderDifficulty=w.dataset.difficulty):(this.focusedCardId=w.dataset.puzzleId,this.focusedHeaderDifficulty=null),w.scrollIntoView({behavior:"smooth",block:"nearest"})}}findCardInDirection(m,p){const E=this.getVisibleCards();if(E.length===0)return null;const y=m.getBoundingClientRect(),v=y.left+y.width/2,D=y.top+y.height/2,w=y.height*.5,x=y.width*.5;let H=null,s=1/0;return E.forEach(r=>{if(r===m)return;const g=r.getBoundingClientRect(),L=g.left+g.width/2,c=g.top+g.height/2;let N=!1;switch(p){case"left":N=L<v-x&&Math.abs(c-D)<w;break;case"right":N=L>v+x&&Math.abs(c-D)<w;break;case"up":N=c<D-w;break;case"down":N=c>D+w;break}if(N){let a;if(p==="left"||p==="right")a=Math.abs(L-v);else{const B=Math.abs(c-D),G=Math.abs(L-v);a=B*1e3+G}a<s&&(s=a,H=r)}}),H}navigateFromCard(m,p){const y={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[p];if(!y)return;const v=this.findCardInDirection(m,y);v&&(m.tabIndex=-1,v.tabIndex=0,v.focus(),this.focusedCardId=v.dataset.puzzleId,v.scrollIntoView({behavior:"smooth",block:"nearest"}))}updateRovingTabindex(){const m=this.getNavigableElements();if(m.length===0)return;let p=null;if(this.focusedCardId){const E=this.container.querySelector(`.puzzle-card[data-puzzle-id="${this.focusedCardId}"]`);E&&m.includes(E)&&(p=E)}if(!p&&this.focusedHeaderDifficulty){const E=this.container.querySelector(`.collection-section-header[data-difficulty="${this.focusedHeaderDifficulty}"]`);E&&m.includes(E)&&(p=E)}p||(p=m[0],this.isHeader(p)?(this.focusedHeaderDifficulty=p.dataset.difficulty,this.focusedCardId=null):(this.focusedCardId=(p==null?void 0:p.dataset.puzzleId)||null,this.focusedHeaderDifficulty=null)),m.forEach(E=>{E.tabIndex=E===p?0:-1})}scrollToPuzzle(m,p={}){if(!this.container)return;const E=this.container.querySelectorAll(".puzzle-card");let y=null,v=-1;for(let x=0;x<this.puzzles.length;x++)if(A(this.puzzles[x])===m){v=x;break}if(v===-1||(E.forEach(x=>{parseInt(x.dataset.puzzleIndex,10)===v&&(y=x)}),!y))return;const D=y.closest(".collection-section");if(D&&D.classList.contains("collapsed")){const x=D.dataset.difficulty,H=D.querySelector(".collection-grid"),s=D.querySelector(".section-chevron");D.classList.remove("collapsed"),H&&(H.style.display="flex"),s&&(s.textContent="\u25BC");let r=I()||{};r[x]=!1,h(r)}const w=p.instant?"instant":"smooth";setTimeout(()=>{y.scrollIntoView({behavior:w,block:"center"})},p.instant?0:100)}animateStampTo(m,p,E={}){if(!this.container||!p)return;const y=this.container.querySelector(`.puzzle-card[data-puzzle-id="${m}"]`);if(!y){p.remove();return}const v=y.querySelector(".puzzle-card-preview");if(!v){p.remove();return}setTimeout(()=>{const w=v.getBoundingClientRect(),x=parseFloat(p.style.width),H=parseFloat(p.style.height),s=this.puzzles.find(a=>A(a)===m);let r,g;if(s){const a=Math.max(s.width,s.height),B=Math.max(2,Math.floor(_.MINI_CANVAS_SIZE/a)),G=_.OUTLINE_THICKNESS*2;r=s.width*B+G,g=s.height*B+G}else{const a=x/H;a>1?(r=w.width,g=w.width/a):(g=w.height,r=w.height*a)}const L=r/x,c=w.left+w.width/2,N=w.top+w.height/2;requestAnimationFrame(()=>{p.style.left=c-x/2+"px",p.style.top=N-H/2+"px",p.style.transform="scale("+L+")",p.classList.add("landed")}),setTimeout(()=>{v.classList.remove("awaiting-stamp"),v.innerHTML="";const a=this.puzzles.find(B=>A(B)===m);if(a){const B=U();if(B?B.isPuzzleCompleted(m):!1)v.appendChild(ne(a));else{const Q=B?B.getPuzzleGrid(m):null;Q&&v.appendChild(X(a,Q))}}p.remove()},650)},100)}}const we=new W;window.Cozy.Collection=we}(),function(){"use strict";const _={isInstalled:!1,swRegistration:null,resizeTimeout:null,init(){this.checkInstallState(),this.registerServiceWorker(),this.setupEventListeners(),console.log("[App] Cozy Garden initialized")},checkInstallState(){window.matchMedia("(display-mode: standalone)").matches&&(this.isInstalled=!0),window.navigator.standalone===!0&&(this.isInstalled=!0),this.isInstalled&&(document.body.classList.add("is-installed"),console.log("[App] Running as installed PWA"))},async registerServiceWorker(){if(!("serviceWorker"in navigator)){console.log("[App] Service workers not supported");return}try{this.swRegistration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("[App] Service worker registered:",this.swRegistration.scope),this.swRegistration.addEventListener("updatefound",()=>{const A=this.swRegistration.installing;console.log("[App] New service worker installing..."),A.addEventListener("statechange",()=>{A.state==="installed"&&navigator.serviceWorker.controller&&this.showUpdateNotification()})})}catch(A){console.error("[App] Service worker registration failed:",A)}},showUpdateNotification(){const A=document.createElement("div");A.className="update-banner";const C=document.createElement("span");C.textContent="A new version is available!";const P=document.createElement("button");P.textContent="Update",P.addEventListener("click",()=>this.applyUpdate());const T=document.createElement("button");T.textContent="Later",T.addEventListener("click",()=>A.remove()),A.appendChild(C),A.appendChild(P),A.appendChild(T),document.body.appendChild(A)},applyUpdate(){this.swRegistration&&this.swRegistration.waiting&&this.swRegistration.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload()},setupEventListeners(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?this.onAppFocus():this.onAppBlur()}),window.addEventListener("beforeunload",()=>{this.saveState()}),window.addEventListener("orientationchange",()=>{setTimeout(()=>this.handleResize(),100)}),window.addEventListener("resize",()=>{this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>this.handleResize(),100)})},onAppFocus(){console.log("[App] App focused")},onAppBlur(){console.log("[App] App blurred"),this.saveState()},saveState(){window.Cozy.Garden&&window.Cozy.Storage&&console.log("[App] Saving state...")},handleResize(){const A=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${A}px`)},isPWA(){return this.isInstalled||window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0},async getVersion(){return!this.swRegistration||!navigator.serviceWorker.controller?"unknown":new Promise(A=>{const C=new MessageChannel;C.port1.onmessage=P=>{A(P.data.version||"unknown")},navigator.serviceWorker.controller.postMessage({type:"GET_VERSION"},[C.port2]),setTimeout(()=>A("unknown"),1e3)})},async share(A,C,P){if(navigator.share)try{return await navigator.share({title:A,text:C,url:P}),!0}catch(T){return T.name!=="AbortError"&&console.error("[App] Share failed:",T),!1}return!1},vibrate(A=50){var C;navigator.vibrate&&((C=window.Cozy.Storage)!=null&&C.getSetting("vibration"))&&navigator.vibrate(A)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>_.init()):_.init(),window.Cozy.App=_}(),function(){"use strict";const{CONFIG:_,getPuzzleId:A,getPuzzleTitle:C,renderOutlinedCanvas:P}=window.Cozy.Utils;let T=0,M="easy",I=1,h=[],d=!1,U=null,R=!0,J=!1,oe=!1,ee=0,Z=0,re=null,te=null,ne=null,X=[],se=[],W=[],we=[],z=[],m=null;function p(e,t="info"){const n=document.getElementById("toast");n&&(clearTimeout(m),n.textContent=e,n.className="toast visible",t==="success"?n.classList.add("toast-success"):t==="info"&&n.classList.add("toast-info"),m=setTimeout(()=>{n.classList.remove("visible")},_.TOAST_DURATION))}function E(){const e=document.getElementById("toast");e&&(clearTimeout(m),e.classList.remove("visible"))}function y(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function v(){const e=document.getElementById("help-list");if(!e)return;const t=y();let n=["<li><strong>Select a color</strong> from the palette, then tap cells to fill them</li>","<li><strong>Drag</strong> across cells to fill multiple at once</li>","<li><strong>Long-press</strong> a cell to mark it \u2715 (definitely empty)</li>","<li><strong>Pencil mode</strong> marks uncertain guesses \u2014 confirm or clear them later</li>"];t&&n.push("<li><strong>Pinch to zoom</strong> on larger puzzles for easier tapping</li>"),t||(n.push('<li class="help-section-title">Keyboard Shortcuts</li>'),n.push("<li><strong>Ctrl+Z</strong> / <strong>Ctrl+Y</strong> \u2014 Undo / Redo</li>"),n.push("<li><strong>P</strong> \u2014 Toggle pencil mode</li>"),n.push("<li><strong>1-9</strong> \u2014 Select color by number</li>"),n.push("<li><strong>+</strong> / <strong>-</strong> \u2014 Zoom in / out</li>")),e.innerHTML=n.join("")}function D(){const e=document.getElementById("help-modal");if(!e)return;v(),e.classList.add("visible"),document.body.style.overflow="hidden";const t=e.querySelector(".help-modal-close");t&&setTimeout(()=>t.focus(),100)}function w(){const e=document.getElementById("help-modal");e&&(e.classList.remove("visible"),document.body.style.overflow="")}function x(){const e=document.getElementById("help-btn"),t=document.getElementById("help-modal"),n=t==null?void 0:t.querySelector(".help-modal-backdrop"),o=t==null?void 0:t.querySelector(".help-modal-close");e&&e.addEventListener("click",D),n&&n.addEventListener("click",w),o&&o.addEventListener("click",w),document.addEventListener("keydown",i=>{if(t!=null&&t.classList.contains("visible")){if(i.key==="Escape"){w();return}i.key==="Tab"&&(document.activeElement!==o?(i.preventDefault(),o==null||o.focus()):i.preventDefault())}})}function H(){const e=document.getElementById("skip-to-puzzle");e&&e.addEventListener("click",t=>{var o;t.preventDefault();const n=(o=X[0])==null?void 0:o[0];n&&n.focus()})}function s(){var e;(e=window.Cozy.Storage)!=null&&e.getFlag("helpShown")||setTimeout(()=>{var t;D(),(t=window.Cozy.Storage)==null||t.setFlag("helpShown",!0)},500)}function r(e){if(!e)return null;if(e.title!==void 0)return!e.width||!e.height||!e.row_clues||!e.col_clues||!e.color_map?(console.warn("[Game] Invalid verbose puzzle format:",e.title),null):e;if(!e.t||!e.w||!e.h||!Array.isArray(e.r)||!Array.isArray(e.c)||!Array.isArray(e.p)||!Array.isArray(e.s))return console.warn("[Game] Invalid concise puzzle format, missing or malformed fields:",e.t),null;if(e.w>_.MAX_PUZZLE_DIMENSION||e.h>_.MAX_PUZZLE_DIMENSION||e.w<1||e.h<1)return console.warn("[Game] Puzzle dimensions out of range:",e.w,"x",e.h),null;function t(l){const u=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(l);return u?[parseInt(u[1],16),parseInt(u[2],16),parseInt(u[3],16)]:[0,0,0]}function n(l){return l.map(u=>u.map(([S,b])=>({count:S,color:b+1})))}function o(l){const u={};return l.forEach((S,b)=>{u[b+1]=t(S)}),u}function i(l){return l.map(u=>u.map(S=>S<0?0:S+1))}try{return{title:e.t,width:e.w,height:e.h,row_clues:n(e.r),col_clues:n(e.c),color_map:o(e.p),solution:i(e.s)}}catch(l){return console.error("[Game] Failed to convert puzzle:",e.t,l),null}}let g=null,L=null;function c(){const e=window.PUZZLE_DATA||[];return(!g||e!==L)&&(g=e.map(r).filter(t=>t!==null),L=e),g}function N(e=null,t=!0){return{value:e,certain:t}}function a(e,t){var n;return((n=h[e])==null?void 0:n[t])||N()}function B(e,t,n,o){h[e][t]={value:n,certain:o}}function G(e){return`rgb(${e[0]}, ${e[1]}, ${e[2]})`}function Q(e){return(e[0]*299+e[1]*587+e[2]*114)/1e3}function F(e){const t=e.toLowerCase();return t.includes("easy")?"easy":t.includes("medium")?"medium":t.includes("hard")?"hard":t.includes("challenging")?"challenging":t.includes("expert")?"expert":"easy"}function V(){return window.Cozy.Storage||null}function $(){return window.Cozy.History||null}function he(){const e=c()[T];if(!e)return!0;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++)if(a(t,n).value!==null)return!1;return!0}function ve(){const e=c()[T];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=a(t,n),i=e.solution[t][n];if(o.value!==i||!o.certain)return!1}return!0}function me(){const e=document.getElementById("reset-btn"),t=document.getElementById("solution-btn");if(e){const n=he();e.disabled=n,e.setAttribute("aria-label",n?"Reset (puzzle is empty)":"Hold to reset puzzle")}if(t){const n=ve();t.disabled=n,t.setAttribute("aria-label",n?"Solution (already shown)":"Hold to reveal solution")}}function pe(e){const t=document.getElementById("sr-announcer");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},50))}function Ae(e){J=e,Be(),pe(e?"Pencil mode":"Pen mode"),Ce()}function Ne(){Ae(!J)}function Be(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("palette-menu-btn");if(e&&(e.classList.toggle("active",!J),e.setAttribute("aria-checked",String(!J))),t&&(t.classList.toggle("active",J),t.setAttribute("aria-checked",String(J))),n){const o=n.querySelector(".menu-icon-svg");o&&(o.removeAttribute("stroke"),o.removeAttribute("stroke-width"),o.setAttribute("fill","currentColor"),J?o.innerHTML='<path d="M19.07 13.88L13 19.94l-1.41-1.41 6.07-6.06 1.41 1.41zm-5.66-5.66l-6.06 6.07-1.42-1.41 6.07-6.07 1.41 1.41zM17.66 5.99l-2.34 2.34 1.41 1.41 2.34-2.34-1.41-1.41zM3 18v3h3l.01-.01L3 18zm3-3l-1 1 3 3 1-1-3-3z" opacity="0.5"/><path d="M9.17 16.17L7.76 17.59l3.54 3.54 1.41-1.41-3.54-3.55zm10.6-10.6l-3.53-3.54-1.42 1.42 3.54 3.53 1.41-1.41z"/>':o.innerHTML='<path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>')}document.body.classList.toggle("pencil-mode",J)}function qe(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");if(!e||!t)return;e.classList.contains("open")?Ce():Xe()}function Xe(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");!e||!t||(e.classList.add("open"),t.classList.add("menu-open"),t.setAttribute("aria-expanded","true"),setTimeout(()=>{document.addEventListener("click",_e)},0))}function Ce(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");e&&(e.classList.remove("open"),t&&(t.classList.remove("menu-open"),t.setAttribute("aria-expanded","false")),document.removeEventListener("click",_e))}function _e(e){const t=document.getElementById("mode-menu"),n=document.getElementById("palette-menu-btn");!t||!n||!t.contains(e.target)&&!n.contains(e.target)&&Ce()}function Ve(){const e=c()[T];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=a(t,n);if(!o.certain&&o.value!==null)return!0}return!1}function Re(){const e=c()[T];if(!e)return 0;let t=0;for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=a(n,o);!i.certain&&i.value!==null&&t++}return t}function ue(){const e=document.getElementById("pencil-actions-section"),t=document.getElementById("palette-menu-btn"),n=Ve(),o=n?Re():0;if(e&&e.classList.toggle("has-marks",n),t){t.classList.toggle("has-pencil-marks",n);const i=t.querySelector(".pencil-badge");i&&(i.textContent=o>_.BADGE_MAX_DISPLAY?`${_.BADGE_MAX_DISPLAY}+`:String(o))}}function He(){const e=c()[T];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=a(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:null,certain:!0}}),B(n,o,null,!0),fe(n,o,e))}if(t.length>0){const n=$();n&&n.recordBatchAction("batch-clear",t),window.Cozy.App&&window.Cozy.App.vibrate(20)}ue(),Ee()}function Ze(){const e=c()[T];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=a(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:i.value,certain:!0}}),B(n,o,i.value,!0),fe(n,o,e))}if(t.length>0){const n=$();n&&n.recordBatchAction("batch-confirm",t),window.Cozy.App&&window.Cozy.App.vibrate([20,50,20])}ue(),We(e),Ee()}function Oe(){const e=$();if(!e)return;const t=e.undo();if(!t)return;const n=c()[T];for(const o of t)B(o.row,o.col,o.state.value,o.state.certain),fe(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),ue(),Me(n),me(),Ee()}function De(){const e=$();if(!e)return;const t=e.redo();if(!t)return;const n=c()[T];for(const o of t)B(o.row,o.col,o.state.value,o.state.certain),fe(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),ue(),Me(n),me(),We(n),Ee()}function Ee(){const e=V();if(!e)return;const n=c()[T];if(!n)return;const o=A(n);e.savePuzzleGrid(o,h),e.saveSession(T,M,h)}function Ue(){const e=V();e&&e.clearSession()}function Je(){const e=c(),t=document.getElementById("puzzle-select"),n=[...new Set(e.map(S=>F(S.title)))],o=["easy","medium","hard","challenging","expert"];n.sort((S,b)=>o.indexOf(S)-o.indexOf(b));const i=document.createElement("div");i.className="difficulty-tabs",n.forEach(S=>{const b=document.createElement("button");b.className="difficulty-tab"+(S===M?" active":""),b.textContent=S.charAt(0).toUpperCase()+S.slice(1),b.onclick=()=>{M=S,document.querySelectorAll(".difficulty-tab").forEach(q=>q.classList.remove("active")),b.classList.add("active"),Se()},i.appendChild(b)});const l=document.createElement("div");l.className="puzzle-dropdown";const u=document.createElement("select");u.id="puzzle-select-dropdown",u.onchange=S=>{f(parseInt(S.target.value))},l.appendChild(u),t.appendChild(i),t.appendChild(l),Se()}function Se(){var i;const e=c(),t=document.getElementById("puzzle-select-dropdown");if(!t)return;const n=V();if(t.innerHTML="",e.forEach((l,u)=>{if(F(l.title)===M){const S=document.createElement("option");S.value=u;const b=A(l),q=n?n.isPuzzleCompleted(b):!1;S.textContent=(q?"\u2713 ":"")+l.title,u===T&&(S.selected=!0),t.appendChild(S)}}),e.filter(l=>F(l.title)===M).length>0&&!(F((i=e[T])==null?void 0:i.title)===M)){const u=e.findIndex(S=>F(S.title)===M);u>=0&&f(u)}}function f(e,t=null){if(oe){console.warn("[Game] Puzzle already loading, ignoring request");return}oe=!0;try{const n=c(),o=V(),i=$();if(e!==T&&h.length>0&&n[T]&&o){const j=A(n[T]);o.savePuzzleGrid(j,h)}i&&i.clear(),J=!1,Be(),ee=0,Z=0,T=e;const l=n[e];if(!l){oe=!1;return}if(l.width>_.MAX_PUZZLE_DIMENSION||l.height>_.MAX_PUZZLE_DIMENSION||l.width<1||l.height<1){console.error(`[Game] Invalid puzzle dimensions: ${l.width}x${l.height}`),oe=!1;return}const u=A(l);let S=t;!S&&o&&(S=o.getPuzzleGrid(u));const b=S&&S.length===l.height;if(b)h=S.map(j=>j.map(ie=>({value:ie.value,certain:ie.certain})));else{h=[];for(let j=0;j<l.height;j++){h.push([]);for(let ie=0;ie<l.width;ie++)h[j][ie]=N(null,!0)}}if(I=1,k(l),ce(l),Ge(l),ut(),b)for(let j=0;j<l.height;j++)for(let ie=0;ie<l.width;ie++)a(j,ie).value!==null&&fe(j,ie,l);E();const q=document.getElementById("puzzle-select-dropdown");q&&(q.value=e);const K=F(l.title);K!==M&&(M=K,document.querySelectorAll(".difficulty-tab").forEach(j=>{j.classList.toggle("active",j.textContent.toLowerCase()===K)}),Se()),ue(),Me(l),window.Cozy.Zoom&&window.Cozy.Zoom.initForPuzzle(l),s(),me()}finally{oe=!1}}function k(e){const t=document.getElementById("palette"),n=document.getElementById("mode-menu"),o=n?n.parentNode:null;n&&t.contains(n)&&document.body.appendChild(n),t.innerHTML="";const i=document.createElement("button");i.className="color-btn eraser",i.title="Eraser",i.setAttribute("aria-label","Eraser"),i.setAttribute("aria-pressed",I===0?"true":"false"),i.addEventListener("click",()=>O(0)),t.appendChild(i),Object.entries(e.color_map).forEach(([b,q])=>{const K=document.createElement("button"),j=parseInt(b)===I;K.className="color-btn"+(j?" selected":""),K.style.background=G(q),K.setAttribute("aria-label",`Color ${b}`),K.setAttribute("aria-pressed",j?"true":"false"),K.addEventListener("click",()=>O(parseInt(b))),t.appendChild(K)});const l=document.createElement("button");l.className="palette-menu-btn",l.id="palette-menu-btn",l.title="Drawing mode",l.setAttribute("aria-label","Drawing mode menu"),l.setAttribute("aria-haspopup","true"),l.setAttribute("aria-expanded","false"),l.innerHTML=`
      <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>
      </svg>
      <span class="pencil-badge">0</span>
    `,l.addEventListener("click",b=>{b.stopPropagation(),qe()}),t.appendChild(l);const u=document.getElementById("mode-menu");u&&t.appendChild(u);const S=t.querySelectorAll(".color-btn, .palette-menu-btn").length;t.classList.remove("palette-8-buttons","palette-7-buttons"),S>=8?t.classList.add("palette-8-buttons"):S===7&&t.classList.add("palette-7-buttons")}function O(e){I=e;const n=c()[T];document.querySelectorAll(".color-btn").forEach((o,i)=>{let l;i===0?l=e===0:l=parseInt(Object.keys(n.color_map)[i-1])===e,o.classList.toggle("selected",l),o.setAttribute("aria-pressed",l?"true":"false")})}function Y(e,t,n){const o=document.createElement("div");if(o.className=n,e===null)o.textContent="0",o.style.background="#333";else{const i=t.color_map[e.color];o.textContent=e.count,o.style.background=G(i),o.style.color=Q(i)>_.BRIGHTNESS_MIDPOINT?"#000":"#fff",o.style.cursor="pointer",o.onclick=()=>O(e.color)}return o}function ce(e){W=[],se=[],we=new Array(e.height).fill(!1),z=new Array(e.width).fill(!1);const t=document.getElementById("col-clues");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,e.col_clues.forEach((o,i)=>{const l=document.createElement("div");l.className="col-clue",l.dataset.col=i,o.length===0?l.appendChild(Y(null,e,"clue-cell")):o.forEach(u=>{l.appendChild(Y(u,e,"clue-cell"))}),W[i]=l,t.appendChild(l)});const n=document.getElementById("row-clues-container");n.innerHTML="",n.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,e.row_clues.forEach((o,i)=>{const l=document.createElement("div");l.className="row-clues",l.dataset.row=i,o.length===0?l.appendChild(Y(null,e,"row-clue-cell")):o.forEach(u=>{l.appendChild(Y(u,e,"row-clue-cell"))}),se[i]=l,n.appendChild(l)})}let le=-1,ae=-1;function de(e,t){var o;if(y()||e===le&&t===ae||(ge(),le=e,ae=t,e<0||t<0)||!X[e])return;const n=X[e];if(n)for(let i=0;i<n.length;i++){const l=n[i];l&&(l.classList.add("highlight-row"),i===t&&l.classList.add("highlight-cell"))}for(let i=0;i<X.length;i++)i!==e&&((o=X[i])!=null&&o[t])&&X[i][t].classList.add("highlight-col");se[e]&&se[e].classList.add("highlight-clue"),W[t]&&W[t].classList.add("highlight-clue")}function ge(){var n;const e=le,t=ae;if(le=-1,ae=-1,!(e<0&&t<0)){if(e>=0&&X[e])for(let o=0;o<X[e].length;o++){const i=X[e][o];i&&i.classList.remove("highlight-row","highlight-cell")}if(t>=0)for(let o=0;o<X.length;o++){const i=(n=X[o])==null?void 0:n[t];i&&i.classList.remove("highlight-col")}e>=0&&se[e]&&se[e].classList.remove("highlight-clue"),t>=0&&W[t]&&W[t].classList.remove("highlight-clue")}}function ye(e,t){var i,l;const n=c()[T];if(!n||e<0||e>=n.height||t<0||t>=n.width)return;(i=X[ee])!=null&&i[Z]&&(X[ee][Z].tabIndex=-1),ee=e,Z=t;const o=(l=X[e])==null?void 0:l[t];o&&(o.tabIndex=0,o.focus())}function be(e,t){const n=document.createElement("div");return n.className="cell",n.dataset.row=e,n.dataset.col=t,n.tabIndex=e===ee&&t===Z?0:-1,n.setAttribute("role","gridcell"),n.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}, empty`),n}function Te(e,t,n){e.onfocus=()=>{var o;(ee!==t||Z!==n)&&((o=X[ee])!=null&&o[Z]&&(X[ee][Z].tabIndex=-1),ee=t,Z=n,e.tabIndex=0),de(t,n)}}function ke(e,t,n){e.onkeydown=o=>{if(o.key==="ArrowUp")o.preventDefault(),ye(t-1,n);else if(o.key==="ArrowDown")o.preventDefault(),ye(t+1,n);else if(o.key==="ArrowLeft")o.preventDefault(),ye(t,n-1);else if(o.key==="ArrowRight")o.preventDefault(),ye(t,n+1);else if(o.key==="Enter"||o.key===" "){o.preventDefault();const i=$();i&&i.beginAction("fill"),ze(t,n,I,!J),i&&i.commitAction(),ue()}else if(o.key==="x"||o.key==="X"){o.preventDefault(),o.stopPropagation();const i=$();i&&i.beginAction("fill"),ze(t,n,0,!J),i&&i.commitAction(),ue()}}}function Pe(e,t,n=!1){const o=$();o&&o.beginAction("fill"),d=!0,U=n?0:I,R=!J,ze(e,t,U,R);const i=a(e,t);U=i.value,R=i.certain}function Ie(e=!0){if(!d)return;d=!1,U=null;const t=$();t&&(e?t.commitAction():t.cancelAction()),ue()}function Ye(e,t,n){e.onmousedown=o=>{o.preventDefault(),e.focus(),Pe(t,n,o.button===2)},e.onmouseenter=()=>{de(t,n),d&&ze(t,n,U,R,!0)},e.oncontextmenu=o=>{o.preventDefault()}}function Ke(e,t,n){let o=null,i=0,l=!1,u=t,S=n;e.ontouchstart=b=>{var j,ie;if(b.touches.length>1)return;if(b.preventDefault(),b.stopPropagation(),l=!1,i=Date.now(),u=t,S=n,window.Cozy.Zoom){const Le=(ie=(j=b.touches[0])==null?void 0:j.clientY)!=null?ie:0;window.Cozy.Zoom.onCellTouchStart(t,n,Le)}const q=$();q&&q.beginAction("fill"),d=!0,U=I,R=!J,o=setTimeout(()=>{if(!l){U=0,ze(u,S,0,R);const Le=a(u,S);U=Le.value,R=Le.certain,window.Cozy.App&&window.Cozy.App.vibrate(50)}},_.LONG_PRESS_DELAY),ze(t,n,U,R);const K=a(t,n);U=K.value,R=K.certain},e.ontouchmove=b=>{if(b.touches.length>1||!d)return;b.preventDefault(),b.stopPropagation(),l=!0,clearTimeout(o);const q=b.touches[0],K=document.elementFromPoint(q.clientX,q.clientY);if(K&&K.classList.contains("cell")){const j=parseInt(K.dataset.row),ie=parseInt(K.dataset.col);!isNaN(j)&&!isNaN(ie)&&(ze(j,ie,U,R,!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchMove(j,ie))}},e.ontouchend=()=>{clearTimeout(o),Ie(!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()},e.ontouchcancel=()=>{clearTimeout(o),Ie(!1),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()}}function Ge(e){const t=document.getElementById("grid");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,t.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,te&&t.removeEventListener("mouseleave",te),ne&&t.removeEventListener("focusout",ne),re&&document.removeEventListener("mouseup",re),X=[];for(let n=0;n<e.height;n++)X[n]=[];te=()=>ge(),t.addEventListener("mouseleave",te),ne=n=>{t.contains(n.relatedTarget)||ge()},t.addEventListener("focusout",ne);for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=be(n,o);Te(i,n,o),ke(i,n,o),Ye(i,n,o),Ke(i,n,o),X[n][o]=i,t.appendChild(i)}re=()=>Ie(!0),document.addEventListener("mouseup",re)}function ze(e,t,n,o,i){const l=c()[T],u=a(e,t),S=$();let b=n,q=o;i||(o&&!u.certain&&u.value===n&&n!==null?(b=u.value,q=!0):u.value===n&&u.certain===o&&n!==null&&(b=null,q=!0)),!(u.value===b&&u.certain===q)&&(S&&S.recordChange(e,t,u,{value:b,certain:q}),B(e,t,b,q),fe(e,t,l),window.Cozy.App&&window.Cozy.App.vibrate(10),Me(l),me(),We(l),Ee())}function fe(e,t,n){var u;const o=(u=X[e])==null?void 0:u[t];if(!o)return;const i=a(e,t);if(o.classList.remove("marked-empty","maybe-empty","maybe-color"),o.style.background="",o.style.setProperty("--cell-color",""),o.style.setProperty("--fold-outline-color",""),i.value===null)o.style.background="var(--color-cell)";else if(i.value===0)i.certain?o.classList.add("marked-empty"):o.classList.add("maybe-empty");else{const S=n.color_map[i.value];if(S){const b=`rgb(${S[0]}, ${S[1]}, ${S[2]})`;if(i.certain)o.style.background=b;else{o.classList.add("maybe-color"),o.style.setProperty("--cell-color",b);const K=Q(S)>_.BRIGHTNESS_MIDPOINT?"rgba(0, 0, 0, 0.6)":"rgba(255, 255, 255, 0.7)";o.style.setProperty("--fold-outline-color",K)}}}let l;i.value===null?l="empty":i.value===0?l=i.certain?"marked empty":"maybe empty":l=i.certain?`color ${i.value}`:`maybe color ${i.value}`,o.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}, ${l}`)}function $e(e){const t=[];let n=null,o=0;for(const i of e)i>0?i===n?o++:(n!==null&&t.push({count:o,color:n}),n=i,o=1):n!==null&&(t.push({count:o,color:n}),n=null,o=0);return n!==null&&t.push({count:o,color:n}),t}function Fe(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n].count!==t[n].count||e[n].color!==t[n].color)return!1;return!0}function Me(e){for(let t=0;t<e.height;t++){const n=[];for(let b=0;b<e.width;b++){const q=a(t,b);q.certain?n.push(q.value===null?0:q.value):n.push(-1)}const o=n.includes(-1),i=n.map(b=>b===-1?0:b),l=$e(i),u=!o&&Fe(l,e.row_clues[t]),S=se[t];S&&S.classList.toggle("satisfied",u),u!==we[t]&&(we[t]=u,pe(u?`Row ${t+1} complete`:`Row ${t+1} incomplete`))}for(let t=0;t<e.width;t++){const n=[];for(let b=0;b<e.height;b++){const q=a(b,t);q.certain?n.push(q.value===null?0:q.value):n.push(-1)}const o=n.includes(-1),i=n.map(b=>b===-1?0:b),l=$e(i),u=!o&&Fe(l,e.col_clues[t]),S=W[t];S&&S.classList.toggle("satisfied",u),u!==z[t]&&(z[t]=u,pe(u?`Column ${t+1} complete`:`Column ${t+1} incomplete`))}}function We(e){for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++)if(!a(o,i).certain)return;for(let o=0;o<e.height;o++){const i=[];for(let u=0;u<e.width;u++){const S=a(o,u);i.push(S.value===null?0:S.value)}const l=$e(i);if(!Fe(l,e.row_clues[o]))return}for(let o=0;o<e.width;o++){const i=[];for(let u=0;u<e.height;u++){const S=a(u,o);i.push(S.value===null?0:S.value)}const l=$e(i);if(!Fe(l,e.col_clues[o]))return}pe("Puzzle complete!"),window.Cozy.App&&window.Cozy.App.vibrate([50,100,50]);const t=V();if(t){const o=A(e);t.completePuzzle(o),Ue(),Se();const i=window.Cozy.Collection;i&&i.refresh()}const n=$();n&&n.clear(),at(e)}function Qe(){const e=c()[T];if(!e)return;const t=$(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const l=a(o,i);l.value!==null&&(n.push({row:o,col:i,before:{value:l.value,certain:l.certain},after:{value:null,certain:!0}}),l.value=null,l.certain=!0,fe(o,i,e))}if(n.length>0){t&&t.recordBatchAction("reset",n),Me(e);const o=V();if(o){const i=A(e);o.savePuzzleGrid(i,null)}ue()}me()}function et(){const e=c()[T];if(!e)return;window.Cozy.Zoom&&window.Cozy.Zoom.zoomToFit();const t=$(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const l=a(o,i),u=e.solution[o][i];(l.value!==u||!l.certain)&&n.push({row:o,col:i,before:{value:l.value,certain:l.certain},after:{value:u,certain:!0}}),l.value=u,l.certain=!0,fe(o,i,e)}n.length>0&&t&&t.recordBatchAction("solution",n),Me(e),p("Solution revealed","info"),ue(),me()}function st(){document.addEventListener("keydown",e=>{var t,n,o;if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")){if((e.ctrlKey||e.metaKey)&&e.key==="z"&&!e.shiftKey&&(e.preventDefault(),Oe()),((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key==="z"||(e.ctrlKey||e.metaKey)&&e.key==="y")&&(e.preventDefault(),De()),e.key==="p"&&!e.ctrlKey&&!e.metaKey&&(e.preventDefault(),Ne()),e.key>="1"&&e.key<="9"&&!e.ctrlKey&&!e.metaKey){const i=parseInt(e.key),l=c()[T],u=Object.keys(l.color_map).map(Number);i<=u.length&&O(u[i-1])}if((e.key==="0"||e.key==="x")&&!e.ctrlKey&&!e.metaKey&&O(0),e.key==="Escape"&&!e.ctrlKey&&!e.metaKey){const i=document.getElementById("help-modal"),l=i==null?void 0:i.classList.contains("visible");((t=window.Cozy.Screens)==null?void 0:t.getCurrentScreen())===((o=(n=window.Cozy.Screens)==null?void 0:n.SCREENS)==null?void 0:o.PUZZLE)&&!l&&(e.preventDefault(),xe())}}})}function je(){const e=c(),t=V();if(h.length>0&&e[T]&&t){const n=A(e[T]);t.savePuzzleGrid(n,h)}}function xe(){je(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION)}function lt(e){window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:e})}function rt(e){const t=e.detail||{},n=c();let o=0;t.puzzleId!==void 0&&(o=t.puzzleId,typeof t.puzzleId=="string"&&(o=n.findIndex(i=>A(i)===t.puzzleId),o===-1&&(o=0))),f(o)}function ct(e){je();const t=e.detail||{},n=window.Cozy.Collection;n&&(t.animateStamp&&t.scrollToPuzzleId?n.refresh({blankPuzzleId:t.scrollToPuzzleId}):n.refresh(),t.scrollToPuzzleId&&setTimeout(()=>{n.scrollToPuzzle(t.scrollToPuzzleId,{instant:t.quickAnimation}),t.animateStamp&&t.flyingStamp&&n.animateStampTo(t.scrollToPuzzleId,t.flyingStamp,{quick:t.quickAnimation})},50))}function at(e){if(window.Cozy.Screens){const t=A(e),n=e.title.match(/^(.+?)\s*\(/),o=n?n[1].trim():e.title;window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.VICTORY,{puzzleId:t,puzzleName:o,solution:e.solution,palette:e.color_map})}}function ut(){const e=document.getElementById("current-puzzle-title");if(!e)return;const n=c()[T];if(n){const o=n.title.match(/^(.+?)\s*\(/);e.textContent=o?o[1].trim():n.title}}const tt=1200;function nt(e,t){if(!e)return;let n=null,o=!1;function i(u){u.type==="touchstart"&&u.preventDefault(),!e.disabled&&(o||(o=!0,e.classList.add("holding"),pe("Holding, keep holding to confirm"),n=setTimeout(()=>{o&&(e.classList.add("hold-complete"),l(),pe("Confirmed"),t(),setTimeout(()=>e.classList.remove("hold-complete"),50))},tt)))}function l(){o=!1,e.classList.remove("holding"),n&&(clearTimeout(n),n=null)}e.addEventListener("mousedown",i),e.addEventListener("mouseup",l),e.addEventListener("mouseleave",l),e.addEventListener("touchstart",i,{passive:!1}),e.addEventListener("touchend",l),e.addEventListener("touchcancel",l),e.addEventListener("keydown",u=>{(u.key==="Enter"||u.key===" ")&&(u.preventDefault(),i(u))}),e.addEventListener("keyup",u=>{(u.key==="Enter"||u.key===" ")&&l()}),e.addEventListener("blur",l),e.style.setProperty("--hold-duration",`${tt}ms`)}function dt(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("undo-btn"),o=document.getElementById("redo-btn");e&&e.addEventListener("click",()=>Ae(!1)),t&&t.addEventListener("click",()=>Ae(!0)),n&&n.addEventListener("click",Oe),o&&o.addEventListener("click",De);const i=document.getElementById("clear-pencil-btn"),l=document.getElementById("confirm-pencil-btn");i&&i.addEventListener("click",()=>{He(),Ce()}),l&&l.addEventListener("click",()=>{Ze(),Ce()});const u=document.getElementById("reset-btn"),S=document.getElementById("solution-btn");nt(u,Qe),nt(S,et);const b=document.querySelector("#screen-puzzle .header-back-btn");b&&b.addEventListener("click",it);const q=document.querySelector("#screen-collection .header-back-btn");q&&q.addEventListener("click",()=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.HOME)})}function ot(){st(),dt(),x(),H();const e=$();e&&e.updateUI(),Be();const t=V();t&&t.onChange&&t.onChange(i=>{i==="reset"&&(h=[],T=0)});const n=window.Cozy.Collection,o=c();n&&o.length>0&&n.init("collection-screen",o,i=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:i})}),window.addEventListener("screen:puzzle",rt),window.addEventListener("screen:collection",ct),o.length>0&&f(0)}function ft(){const t=c()[T];if(!t||h.length===0)return null;let n=!1;for(let o=0;o<t.height&&!n;o++)for(let i=0;i<t.width&&!n;i++){const l=a(o,i);l.value!==null&&l.value>0&&(n=!0)}return n?P(t.width,t.height,_.STAMP_CANVAS_SIZE,(o,i)=>{const l=a(o,i);if(l.value!==null&&l.value>0){const u=t.color_map[l.value];if(u)return u}return null}):null}function it(){const t=c()[T];if(!t){xe();return}const n=A(t),o=ft();if(!o){xe();return}const i=document.getElementById("grid");if(!i){xe();return}const l=i.getBoundingClientRect(),u=document.createElement("canvas");u.width=o.width,u.height=o.height,u.getContext("2d").drawImage(o,0,0);const b=o.width/o.height,q=l.width/l.height;let K,j;b>q?(K=l.width,j=l.width/b):(j=l.height,K=l.height*b);const ie=(l.width-K)/2,Le=(l.height-j)/2;u.className="flying-stamp",u.style.left=l.left+ie+"px",u.style.top=l.top+Le+"px",u.style.width=K+"px",u.style.height=j+"px",document.body.appendChild(u),je(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION,{scrollToPuzzleId:n,animateStamp:!0,flyingStamp:u,quickAnimation:!0})}function ht(){h=[],T=0,I=1,d=!1,U=null,J=!1;const e=$();e&&e.clear()}function mt(e,t){const o=c()[T];if(!o)return null;const i=se[e],l=i?i.classList.contains("satisfied"):!1,u=o.row_clues[e].map(K=>({count:K.count,color:K.color,satisfied:l})),S=W[t],b=S?S.classList.contains("satisfied"):!1,q=o.col_clues[t].map(K=>({count:K.count,color:K.color,satisfied:b}));return{rowClues:u,colClues:q}}function pt(e){const n=c()[T];return!n||!n.color_map?null:n.color_map[e]||null}function gt(){return c()[T]||null}window.Cozy.Garden={resetPuzzle:Qe,showSolution:et,performUndo:Oe,performRedo:De,togglePencilMode:Ne,setPencilMode:Ae,clearAllPencilMarks:He,confirmAllPencilMarks:Ze,selectColor:O,showCollection:xe,showGame:lt,clearAllState:ht,navigateToCollectionWithStamp:it,getPuzzleId:A,getClueInfo:mt,getColorRgb:pt,getCurrentPuzzle:gt},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ot):ot()}(),function(){"use strict";const{CONFIG:_}=window.Cozy.Utils,A=.35,C=1,P=.97,T=300,M=1500,I=100,h=10;let d=C,U=C,R=!1,J=0,oe=0,ee=null,Z=null,re=null,te=!1,ne=-1,X=-1,se=!1,W=null,we=null,z=null,m=null,p=null,E=null,y=null,v=null;function D(f,k,O){return Math.min(Math.max(f,k),O)}function w(f,k){const O=f.clientX-k.clientX,Y=f.clientY-k.clientY;return Math.sqrt(O*O+Y*Y)}function x(f,k){return{x:(f.clientX+k.clientX)/2,y:(f.clientY+k.clientY)/2}}function H(){const f=window.innerWidth;return f<=360?20:f>=768?28:f>=1200?32:24}function s(f,k=!0){const O=W;if(!O)return;const Y=d,ce=a(),le=D(f,ce,_.MAX_ZOOM);let ae,de;k&&Y!==le&&(ae=O.scrollLeft+O.clientWidth/2,de=O.scrollTop+O.clientHeight/2),d=le;const ge=H(),ye=Math.round(ge*le);document.documentElement.style.setProperty("--cell-size",`${ye}px`);const be=c(),Te=le>be+.01;O.classList.toggle("is-zoomed",Te),r(),k&&Y!==le&&ae!==void 0&&requestAnimationFrame(()=>{const ke=le/Y,Pe=ae*ke-O.clientWidth/2,Ie=de*ke-O.clientHeight/2;O.scrollLeft=Math.max(0,Pe),O.scrollTop=Math.max(0,Ie)}),window.dispatchEvent(new CustomEvent("zoomchange",{detail:{zoom:le,oldZoom:Y,isZoomed:Te}}))}function r(){const f=a();if(E&&(E.disabled=d>=_.MAX_ZOOM),y&&(y.disabled=d<=f),v){const k=c(),O=Math.abs(d-k)<.05;v.classList.toggle("highlighted",!O&&d!==k)}}let g=null,L=null;function c(f=!1){var ze;const k=W;if(!k||!((ze=window.Cozy.Garden)!=null&&ze.getCurrentPuzzle))return C;const O=window.Cozy.Garden.getCurrentPuzzle();if(!O)return C;const Y=O.title;if(!f&&g!==null&&L===Y)return g;const ce=H(),le=Math.max(...O.row_clues.map(fe=>fe.length)),ae=Math.max(...O.col_clues.map(fe=>fe.length)),de=Math.max(2,le*.6+.5),ge=Math.max(2,ae*.6+.5),ye=O.width+de+.25,be=O.height+ge+.25,Te=k.clientWidth,ke=k.clientHeight,Pe=8,Ie=(Te-Pe*2)/(ye*ce),Ye=(ke-Pe*2)/(be*ce),Ke=Math.min(Ie,Ye),Ge=D(Ke*P,A,_.MAX_ZOOM);return g=Ge,L=Y,Ge}function N(){g=null,L=null}function a(){const f=c();return Math.max(A,f)}function B(){const f=c();return d>f+.01}function G(f){f.touches.length===2&&(R=!0,J=w(f.touches[0],f.touches[1]),U=d,f.preventDefault())}function Q(f){if(R&&f.touches.length===2){const O=w(f.touches[0],f.touches[1])/J,Y=a(),ce=D(U*O,Y,_.MAX_ZOOM);Math.abs(ce-d)>.05&&s(ce,!0),f.preventDefault()}}function F(f){if(R&&f.touches.length<2&&(R=!1),f.touches.length===0&&!R){const k=f.target;if(!k.classList.contains("cell")){const Y=Date.now();ee===k&&Y-oe<T?(V(f.changedTouches[0]),oe=0,ee=null):(oe=Y,ee=k)}}}function V(f){B()?s(c(),!0):s(_.COMFORTABLE_ZOOM,!0)}function $(f){if(f.ctrlKey){f.preventDefault();const k=f.deltaY>0?-.15:.15;s(d+k,!0)}}function he(){z&&B()&&z.classList.add("visible")}function ve(){z&&(z.classList.remove("visible"),ne=-1,X=-1)}function me(f,k){var Y,ce;if(!z||te||f===ne&&k===X)return;ne=f,X=k;const O=(ce=(Y=window.Cozy.Garden)==null?void 0:Y.getClueInfo)==null?void 0:ce.call(Y,f,k);O&&(m&&(m.innerHTML=pe(O.rowClues)),p&&(p.innerHTML=pe(O.colClues)))}function pe(f){return!f||f.length===0?'<span class="clue-tooltip-num satisfied">0</span>':f.map(k=>{var ae,de;const O=((de=(ae=window.Cozy.Garden)==null?void 0:ae.getColorRgb)==null?void 0:de.call(ae,k.color))||[128,128,128],Y=k.satisfied,le=(O[0]*299+O[1]*587+O[2]*114)/1e3>_.BRIGHTNESS_MIDPOINT?"#333":"#fff";return`<span class="clue-tooltip-num${Y?" satisfied":""}"
                    style="background: rgb(${O.join(",")}); color: ${le}">
                ${k.count}
              </span>`}).join("")}function Ae(f){if(!z||!W)return;const k=W.getBoundingClientRect(),O=k.top+k.height/2;f>O?(z.classList.add("position-top"),z.classList.remove("position-bottom")):(z.classList.remove("position-top"),z.classList.add("position-bottom"))}function Ne(){clearTimeout(Z),Z=setTimeout(()=>{ve()},M)}function Be(){clearTimeout(Z)}function qe(f,k,O){B()&&(te=!1,Be(),clearTimeout(re),re=setTimeout(()=>{me(f,k),Ae(O),he()},I))}function Xe(){B()&&(te=!0,z==null||z.classList.add("dragging"))}function Ce(){B()&&(clearTimeout(re),te=!1,z==null||z.classList.remove("dragging"),Ne())}function _e(){E=document.querySelector(".zoom-btn.zoom-in"),y=document.querySelector(".zoom-btn.zoom-out"),v=document.querySelector(".zoom-btn.zoom-fit"),E&&E.addEventListener("click",()=>{s(d+.5,!0)}),y&&y.addEventListener("click",()=>{s(d-.5,!0)}),v&&v.addEventListener("click",()=>{s(c(),!0)}),r()}function Ve(f){const k=document.getElementById("screen-puzzle");!k||k.classList.contains("screen-hidden")||(f.key==="+"||f.key==="="?(f.preventDefault(),s(d+.5,!0)):f.key==="-"||f.key==="_"?(f.preventDefault(),s(d-.5,!0)):f.key==="0"&&(f.preventDefault(),s(c(),!0)))}let Re=null;function ue(){clearTimeout(Re),Re=setTimeout(()=>{const f=document.getElementById("screen-puzzle");if(!f||f.classList.contains("screen-hidden"))return;N();const k=a();d<k&&s(k,!1),r()},150)}function He(){var k,O,Y,ce;const f=(O=(k=window.Cozy.Garden)==null?void 0:k.getCurrentPuzzle)==null?void 0:O.call(k);f&&(f.width<=_.AUTO_ZOOM_MIN_SIZE&&f.height<=_.AUTO_ZOOM_MIN_SIZE||(Y=window.Cozy.Storage)!=null&&Y.getFlag("zoomHintShown")||(Ze(),(ce=window.Cozy.Storage)==null||ce.setFlag("zoomHintShown",!0)))}function Ze(){let f=document.getElementById("zoom-hint-toast");f||(f=document.createElement("div"),f.id="zoom-hint-toast",f.className="zoom-hint-toast",f.textContent="Tip: Pinch to zoom for easier tapping",document.body.appendChild(f)),f.classList.add("visible"),setTimeout(()=>{f.classList.remove("visible")},4e3)}function Oe(){if(!se){if(W=document.getElementById("zoom-container"),we=W==null?void 0:W.querySelector(".board-wrapper"),z=document.getElementById("clue-tooltip"),m=document.getElementById("tooltip-row-clues"),p=document.getElementById("tooltip-col-clues"),!W){console.warn("[Zoom] zoom-container not found, zoom disabled");return}W.addEventListener("touchstart",G,{passive:!1}),W.addEventListener("touchmove",Q,{passive:!1}),W.addEventListener("touchend",F,{passive:!0}),W.addEventListener("wheel",$,{passive:!1}),_e(),document.addEventListener("keydown",Ve),window.addEventListener("resize",ue),se=!0,console.log("[Zoom] Initialized")}}function De(){N();const f=c();s(f,!1),setTimeout(He,500)}function Ee(){Ue(!1),ve(),clearTimeout(Z),clearTimeout(re)}function Ue(f=!0){Se(C,f)}function Je(f=!0){const k=c();Se(k,f)}function Se(f,k=!0){if(k&&d!==f){let le=function(ae){const de=ae-ce,ge=Math.min(de/Y,1),ye=1-Math.pow(1-ge,3),be=O+(f-O)*ye;s(be,!1),ge<1&&requestAnimationFrame(le)};const O=d,Y=200,ce=performance.now();requestAnimationFrame(le)}else s(f,!1)}window.Cozy.Zoom={init:Oe,initForPuzzle:De,destroy:Ee,resetZoom:Ue,zoomToFit:Je,getZoom:()=>d,setZoom:(f,k=!0)=>s(f,!k),zoomIn:(f=.5)=>s(d+f,!0),zoomOut:(f=.5)=>s(d-f,!0),isZoomed:B,onCellTouchStart:qe,onCellTouchMove:Xe,onCellTouchEnd:Ce,getEffectiveMinZoom:a}}();

//# sourceMappingURL=app.min.js.map