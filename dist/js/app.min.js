(function(){"use strict";const H={STAMP_CANVAS_SIZE:180,VICTORY_CANVAS_SIZE:180,MINI_CANVAS_SIZE:80,OUTLINE_THICKNESS:2,MAX_PUZZLE_DIMENSION:32,MAX_HISTORY:50,MAX_SCREEN_HISTORY:10,MAX_SEARCH_LENGTH:100,TOAST_DURATION:2500,LONG_PRESS_DELAY:400,SEARCH_DEBOUNCE:150,MAX_ZOOM:3,COMFORTABLE_ZOOM:2,AUTO_ZOOM_MIN_SIZE:10,BRIGHTNESS_MIDPOINT:128,BADGE_MAX_DISPLAY:99};function S(d){return(d.t||d.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"")}function q(d){return d.t||d.title}function U(d){const s=d.match(/^(.+?)\s*\((\d+)x(\d+),\s*(\w+)\)$/i);return s?{name:s[1].trim(),width:parseInt(s[2],10),height:parseInt(s[3],10),difficulty:s[4].toLowerCase()}:{name:d,width:0,height:0,difficulty:"unknown"}}function D(d,s,N,A={}){return!d||d.hasAttribute("data-initialized")?!1:(d.addEventListener(s,N,A),d.setAttribute("data-initialized","true"),!0)}function C(d,s,N={}){const A=document.createElement("canvas");A.width=d.width,A.height=d.height,A.getContext("2d").drawImage(d,0,0);const Z=d.width/d.height,ie=s.width/s.height;let W,j;if(N.useScale){W=d.width,j=d.height;const ee=Math.min(s.width,s.height),V=(Z>1?ee:ee*Z)/W;A.style.transform="scale("+V+")"}else Z>ie?(W=s.width,j=s.width/Z):(j=s.height,W=s.height*Z);const F=s.left+s.width/2,se=s.top+s.height/2;return A.className="flying-stamp",A.style.left=F-W/2+"px",A.style.top=se-j/2+"px",A.style.width=W+"px",A.style.height=j+"px",document.body.appendChild(A),A}function P(d,s,N,A){const ne=Math.max(d,s),Z=Math.max(2,Math.floor(N/ne)),ie=H.OUTLINE_THICKNESS*2,W=H.OUTLINE_THICKNESS,j=document.createElement("canvas");j.width=d*Z+ie,j.height=s*Z+ie;const F=j.getContext("2d");if(!F)return console.warn("[Utils] Failed to get 2D context for canvas"),j;try{const se=getComputedStyle(document.documentElement).getPropertyValue("--color-text-muted").trim()||"#8a8a7a";F.fillStyle=se;for(let ee=0;ee<s;ee++)for(let G=0;G<d;G++)if(A(ee,G)){const le=W+G*Z,J=W+ee*Z;F.fillRect(le-H.OUTLINE_THICKNESS,J-H.OUTLINE_THICKNESS,Z+ie,Z+ie)}for(let ee=0;ee<s;ee++)for(let G=0;G<d;G++){const V=A(ee,G);if(V){F.fillStyle=`rgb(${V[0]}, ${V[1]}, ${V[2]})`;const le=W+G*Z,J=W+ee*Z;F.fillRect(le,J,Z,Z)}}}catch(se){console.error("[Utils] Failed to render canvas:",se)}return j}window.Cozy=window.Cozy||{},window.Cozy.Utils={CONFIG:H,getPuzzleId:S,getPuzzleTitle:q,parsePuzzleTitle:U,initOnce:D,createFlyingStamp:C,renderOutlinedCanvas:P}})(),function(){"use strict";const H="cozy_garden_data";function q(P){return!(!P||typeof P!="object"||typeof P.version!="number"||P.progress!==null&&typeof P.progress!="object"||P.settings!==null&&typeof P.settings!="object"||P.stats!==null&&typeof P.stats!="object")}function U(){return{version:1,progress:{},settings:{vibration:!0,theme:"light"},stats:{totalCompleted:0,totalAttempts:0,totalPlayTime:0,streak:0,lastPlayDate:null},currentSession:{puzzleIndex:0,difficulty:"easy",grid:null,startTime:null},flags:{tutorialCompleted:!1,helpShown:!1,zoomHintShown:!1},uiState:{collapsedSections:[]}}}class D{constructor(){this.data=null,this.listeners=[]}init(){try{const d=localStorage.getItem(H);if(d){const s=JSON.parse(d);q(s)?this.data=s:(console.warn("[Storage] Invalid data structure, using defaults"),this.data=U(),this.save())}else this.data=U(),this.save()}catch(d){console.warn("[Storage] Failed to load, using defaults:",d),this.data=U(),this.save()}return this}save(){try{return localStorage.setItem(H,JSON.stringify(this.data)),this.notifyListeners("save"),!0}catch(d){return console.error("[Storage] Failed to save:",d),!1}}onChange(d){return this.listeners.push(d),()=>{this.listeners=this.listeners.filter(s=>s!==d)}}notifyListeners(d){this.listeners.forEach(s=>s(d,this.data))}getPuzzleProgress(d){return this.data.progress[d]||{completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}}savePuzzleGrid(d,s){this.data.progress||(this.data.progress={}),this.data.progress[d]||(this.data.progress[d]={completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}),s?this.data.progress[d].savedGrid=s.map(N=>N.map(A=>({value:A.value,certain:A.certain}))):this.data.progress[d].savedGrid=null,this.save()}getPuzzleGrid(d){if(!this.data.progress)return null;const s=this.data.progress[d];return!s||!s.savedGrid?null:s.savedGrid.map(N=>N.map(A=>({value:A.value,certain:A.certain})))}completePuzzle(d){const s=this.getPuzzleProgress(d),N=!s.completed;return s.completed=!0,s.attempts+=1,s.lastPlayed=Date.now(),s.savedGrid=null,this.data.progress[d]=s,N&&(this.data.stats.totalCompleted+=1),this.data.stats.totalAttempts+=1,this.updateStreak(),this.save(),{wasNew:N,progress:s}}isPuzzleCompleted(d){var s;return((s=this.data.progress[d])==null?void 0:s.completed)||!1}getCompletionStats(){return{easy:{completed:0,total:0},medium:{completed:0,total:0},hard:{completed:0,total:0},challenging:{completed:0,total:0},expert:{completed:0,total:0}}}saveSession(d,s,N){let A=null;N&&(A=N.map(ne=>ne.map(Z=>({value:Z.value,certain:Z.certain})))),this.data.currentSession={puzzleIndex:d,difficulty:s,grid:A},this.save()}getSession(){return this.data.currentSession}clearSession(){this.data.currentSession={puzzleIndex:0,difficulty:"easy",grid:null},this.save()}getSetting(d){return this.data.settings[d]}setSetting(d,s){this.data.settings[d]=s,this.save(),this.notifyListeners("settings")}getSettings(){return{...this.data.settings}}getStats(){return{...this.data.stats}}addPlayTime(d){this.data.stats.totalPlayTime+=d,this.save()}updateStreak(){const d=new Date().toDateString(),s=this.data.stats.lastPlayDate;if(s===d)return;const N=new Date(Date.now()-864e5).toDateString();s===N?this.data.stats.streak+=1:s!==d&&(this.data.stats.streak=1),this.data.stats.lastPlayDate=d}getFlag(d){var s;return((s=this.data.flags)==null?void 0:s[d])||!1}setFlag(d,s=!0){this.data.flags||(this.data.flags={}),this.data.flags[d]=s,this.save()}getUIState(d){var s;return(s=this.data.uiState)==null?void 0:s[d]}setUIState(d,s){this.data.uiState||(this.data.uiState={}),this.data.uiState[d]=s,this.save()}exportData(){return JSON.stringify(this.data,null,2)}importData(d){try{const s=JSON.parse(d);return q(s)?(this.data=s,this.save(),!0):!1}catch(s){return console.error("[Storage] Import failed:",s),!1}}reset(){this.data=U(),this.save(),this.notifyListeners("reset")}}const C=new D().init();window.Cozy.Storage=C}(),function(){"use strict";const{CONFIG:H}=window.Cozy.Utils;let S=[],q=[],U=null;const D={beginAction(C="fill"){U&&U.changes.length>0&&this.commitAction(),U={type:C,changes:[],timestamp:Date.now()}},recordChange(C,P,d,s){if(d.value===s.value&&d.certain===s.certain)return;U||this.beginAction("fill");const N=U.changes.find(A=>A.row===C&&A.col===P);N?N.after={value:s.value,certain:s.certain}:U.changes.push({row:C,col:P,before:{value:d.value,certain:d.certain},after:{value:s.value,certain:s.certain}})},commitAction(){U&&U.changes.length>0&&(U.changes=U.changes.filter(C=>C.before.value!==C.after.value||C.before.certain!==C.after.certain),U.changes.length>0&&(S.push(U),S.length>H.MAX_HISTORY&&S.shift(),q=[]),this.updateUI()),U=null},cancelAction(){U=null},recordBatchAction(C,P){if(P.length===0)return;const d={type:C,changes:P.map(s=>({row:s.row,col:s.col,before:{value:s.before.value,certain:s.before.certain},after:{value:s.after.value,certain:s.after.certain}})),timestamp:Date.now()};S.push(d),S.length>H.MAX_HISTORY&&S.shift(),q=[],this.updateUI()},undo(){if(S.length===0)return null;const C=S.pop();return q.push(C),this.updateUI(),C.changes.map(P=>({row:P.row,col:P.col,state:{value:P.before.value,certain:P.before.certain}}))},redo(){if(q.length===0)return null;const C=q.pop();return S.push(C),this.updateUI(),C.changes.map(P=>({row:P.row,col:P.col,state:{value:P.after.value,certain:P.after.certain}}))},canUndo(){return S.length>0},canRedo(){return q.length>0},clear(){S=[],q=[],U=null,this.updateUI()},updateUI(){const C=document.getElementById("undo-btn"),P=document.getElementById("redo-btn");C&&(C.disabled=!this.canUndo()),P&&(P.disabled=!this.canRedo())},getStats(){return{undoDepth:S.length,redoDepth:q.length,hasPending:U!==null,pendingChanges:U?U.changes.length:0}}};window.Cozy.History=D}();const ScreenManager=function(){"use strict";const{CONFIG:H,initOnce:S,createFlyingStamp:q,renderOutlinedCanvas:U}=window.Cozy.Utils,D={SPLASH:"splash",HOME:"home",COLLECTION:"collection",PUZZLE:"puzzle",VICTORY:"victory",SETTINGS:"settings",TUTORIAL:"tutorial"};let C=null,P=[],d={},s={},N=null;function A(l){const a=document.getElementById("confirm-modal"),m=document.getElementById("confirm-modal-title"),y=document.getElementById("confirm-modal-message"),v=document.getElementById("confirm-modal-confirm"),$=document.getElementById("confirm-modal-cancel");a&&(m.textContent=l.title||"Confirm",y.textContent=l.message||"Are you sure?",v.textContent=l.confirmText||"Confirm",$.textContent=l.cancelText||"Cancel",v.classList.toggle("confirm-modal-btn-danger",!!l.danger),v.classList.toggle("confirm-modal-btn-primary",!l.danger),a.classList.remove("alert-mode"),N=l,a.classList.add("visible"),setTimeout(()=>v.focus(),100))}function ne(l){const a=document.getElementById("confirm-modal"),m=document.getElementById("confirm-modal-title"),y=document.getElementById("confirm-modal-message"),v=document.getElementById("confirm-modal-confirm");a&&(m.textContent=l.title||"Notice",y.textContent=l.message||"",v.textContent=l.buttonText||"OK",v.classList.remove("confirm-modal-btn-danger"),v.classList.add("confirm-modal-btn-primary"),a.classList.add("alert-mode"),N={onConfirm:l.onClose},a.classList.add("visible"),setTimeout(()=>v.focus(),100))}function Z(){const l=document.getElementById("confirm-modal");l&&l.classList.remove("visible"),N=null}function ie(){const l=document.getElementById("confirm-modal"),a=l==null?void 0:l.querySelector(".confirm-modal-backdrop"),m=document.getElementById("confirm-modal-confirm"),y=document.getElementById("confirm-modal-cancel");l&&(m==null||m.addEventListener("click",()=>{const v=N==null?void 0:N.onConfirm;Z(),v&&setTimeout(v,200)}),y==null||y.addEventListener("click",()=>{const v=N==null?void 0:N.onCancel;Z(),v&&v()}),a==null||a.addEventListener("click",()=>{const v=N==null?void 0:N.onCancel;Z(),v&&v()}),document.addEventListener("keydown",v=>{if(v.key==="Escape"&&l.classList.contains("visible")){const $=N==null?void 0:N.onCancel;Z(),$&&$()}if(v.key==="Tab"&&l.classList.contains("visible")){const R=l.classList.contains("alert-mode")?[m]:[y,m],Q=R[0],K=R[R.length-1];R.includes(document.activeElement)?v.shiftKey?document.activeElement===Q&&(v.preventDefault(),K.focus()):document.activeElement===K&&(v.preventDefault(),Q.focus()):(v.preventDefault(),Q.focus())}}))}function W(){B(),ie(),Object.values(D).forEach(l=>{const a=document.getElementById(`screen-${l}`);s[l]=a,a&&a.setAttribute("inert","")}),window.addEventListener("popstate",ee),document.addEventListener("keydown",j),F(D.SPLASH,{},!1)}function j(l){if(l.key!=="Escape"||l.target.tagName==="INPUT"||l.target.tagName==="TEXTAREA")return;const a=document.getElementById("confirm-modal"),m=document.getElementById("help-modal");if(!(a!=null&&a.classList.contains("visible")||m!=null&&m.classList.contains("visible")))switch(C){case D.HOME:break;case D.COLLECTION:F(D.HOME);break;case D.PUZZLE:break;case D.VICTORY:F(D.COLLECTION);break;case D.SETTINGS:F(D.HOME);break;case D.TUTORIAL:window.Cozy.Storage&&window.Cozy.Storage.setFlag("tutorialComplete",!0),F(D.HOME);break}}function F(l,a={},m=!0){const y=s[l];if(!y){console.error(`Screen not found: ${l}`);return}d=a,C&&s[C]&&(C===D.PUZZLE&&window.Cozy.Zoom&&window.Cozy.Zoom.destroy(),s[C].classList.remove("screen-active"),s[C].classList.add("screen-hidden"),s[C].setAttribute("inert","")),y.classList.remove("screen-hidden"),y.classList.add("screen-active"),y.removeAttribute("inert"),m&&C!==null&&(P.push(C),P.length>H.MAX_SCREEN_HISTORY&&(P=P.slice(-H.MAX_SCREEN_HISTORY)),history.pushState({screen:l},"",`#${l}`));const v=C;C=l,G(l,a,v)}function se(){if(P.length>0){const l=P.pop();F(l,{},!1),history.back()}}function ee(l){if(l.state&&l.state.screen)F(l.state.screen,{},!1);else if(P.length>0){const a=P.pop();F(a,{},!1)}}function G(l,a,m){switch(l){case D.SPLASH:J();break;case D.HOME:me();break;case D.COLLECTION:z(a);break;case D.PUZZLE:h(a);break;case D.VICTORY:b(a);break;case D.SETTINGS:I();break;case D.TUTORIAL:O();break}}function V(){return d}function le(){return C}function J(){setTimeout(()=>{var y;if(new URLSearchParams(window.location.search).get("action")==="continue"){const v=window.location.pathname+window.location.hash;history.replaceState(null,"",v);const $=window.Cozy.Storage;if($){const R=$.getSession();if(R&&typeof R.puzzleIndex=="number"){F(D.PUZZLE,{puzzleId:R.puzzleIndex});return}}}const m=(y=window.Cozy.Storage)==null?void 0:y.getFlag("tutorialCompleted");F(m?D.HOME:D.TUTORIAL)},1500)}function me(){var y;const l=document.getElementById("home-play-btn"),a=document.getElementById("home-settings-btn"),m=document.getElementById("home-progress");if(S(l,"click",()=>F(D.COLLECTION)),S(a,"click",()=>F(D.SETTINGS)),m&&window.PUZZLE_DATA){const v=window.PUZZLE_DATA,$=Array.isArray(v)?v.length:0;let R=0;window.Cozy.Storage&&((y=window.Cozy.Garden)!=null&&y.getPuzzleId)&&v.forEach(Q=>{const K=window.Cozy.Garden.getPuzzleId(Q);window.Cozy.Storage.isPuzzleCompleted(K)&&R++}),m.textContent=`${R} / ${$} puzzles solved`}l&&setTimeout(()=>l.focus(),100)}function z(l){window.dispatchEvent(new CustomEvent("screen:collection",{detail:l}));const a=document.getElementById("collection-search-input");a&&setTimeout(()=>a.focus(),100)}function h(l){window.Cozy.Zoom&&window.Cozy.Zoom.init(),window.dispatchEvent(new CustomEvent("screen:puzzle",{detail:l}))}let f=null;function b(l){const a=document.getElementById("victory-puzzle-name"),m=document.getElementById("victory-image"),y=document.getElementById("victory-continue-btn");f=l.puzzleId,a&&l.puzzleName&&(a.textContent=l.puzzleName),m&&l.solution&&p(m,l.solution,l.palette),S(y,"click",()=>{const v=m?m.querySelector("canvas"):null;if(v){const $=m.getBoundingClientRect(),R=q(v,$,{useScale:!0});F(D.COLLECTION,{scrollToPuzzleId:f,animateStamp:!0,flyingStamp:R})}else F(D.COLLECTION,{scrollToPuzzleId:f})}),y&&setTimeout(()=>y.focus(),100)}function p(l,a,m){l.innerHTML="";const y=a.length,v=a[0]?a[0].length:y,$=U(v,y,H.VICTORY_CANVAS_SIZE,(R,Q)=>{const K=a[R][Q];return K>0&&m[K]?m[K]:null});l.appendChild($)}function w(){var m;const l=document.querySelectorAll(".theme-option");let a=(m=window.Cozy.Storage)==null?void 0:m.getSetting("theme");(!a||a==="system")&&(a=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),l.forEach(y=>{const $=y.dataset.theme===a;y.classList.toggle("active",$),y.setAttribute("aria-pressed",$?"true":"false")}),l.forEach(y=>{S(y,"click",()=>{const v=y.dataset.theme;l.forEach($=>{$.classList.remove("active"),$.setAttribute("aria-pressed","false")}),y.classList.add("active"),y.setAttribute("aria-pressed","true"),window.Cozy.Storage&&window.Cozy.Storage.setSetting("theme",v),_(v)})})}function M(){const l=document.getElementById("settings-reset-btn");S(l,"click",()=>{A({title:"Reset Progress",message:"Are you sure you want to reset all progress? This cannot be undone.",confirmText:"Reset",cancelText:"Cancel",danger:!0,onConfirm:()=>{var a,m;(a=window.Cozy.Garden)!=null&&a.clearAllState&&window.Cozy.Garden.clearAllState(),(m=window.Cozy.Storage)!=null&&m.reset&&window.Cozy.Storage.reset(),window.Cozy.Collection&&window.Cozy.Collection.refresh(),ne({title:"Progress Reset",message:"All progress has been cleared."})}})})}function g(){const l=document.getElementById("settings-solve-all-btn");S(l,"click",()=>{A({title:"Debug: Solve All",message:"Mark all puzzles as solved? This is a debug feature.",confirmText:"Solve All",cancelText:"Cancel",onConfirm:()=>{const a=window.PUZZLE_DATA||[],m=window.Cozy.Storage;m&&a.forEach(y=>{var $;let v;($=window.Cozy.Garden)!=null&&$.getPuzzleId?v=window.Cozy.Garden.getPuzzleId(y):v=(y.t||y.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""),m.completePuzzle(v)}),window.Cozy.Collection&&window.Cozy.Collection.refresh(),ne({title:"All Puzzles Solved",message:`Marked ${a.length} puzzles as solved!`})}})})}function I(){var v;const l=document.getElementById("settings-back-btn"),a=document.getElementById("settings-vibration"),m=document.getElementById("settings-tutorial-btn"),y=window.Cozy.Storage;a&&(a.checked=(v=y==null?void 0:y.getSetting("vibration"))!=null?v:!0),S(l,"click",se),S(m,"click",()=>F(D.TUTORIAL)),S(a,"change",()=>y==null?void 0:y.setSetting("vibration",a.checked)),w(),M(),g(),a&&setTimeout(()=>a.focus(),100)}let L=0;function O(){const l=document.getElementById("tutorial-skip-btn"),a=document.getElementById("tutorial-next-btn"),m=document.querySelectorAll(".tutorial-step"),y=document.querySelectorAll(".tutorial-dot");function v(R){m.forEach((Q,K)=>{Q.classList.toggle("active",K===R)}),y.forEach((Q,K)=>{Q.classList.toggle("active",K===R)}),a&&(a.textContent=R===m.length-1?"Start Playing":"Next")}function $(){var R;(R=window.Cozy.Storage)==null||R.setFlag("tutorialCompleted",!0),F(D.HOME)}S(l,"click",$),S(a,"click",()=>{L<m.length-1?(L++,v(L)):$()}),L=0,v(0),a&&setTimeout(()=>a.focus(),100)}function _(l){document.documentElement.setAttribute("data-theme",l);const a=document.getElementById("theme-color-meta");a&&a.setAttribute("content",l==="dark"?"#0a1018":"#4a7c3f")}function B(){var a;let l=(a=window.Cozy.Storage)==null?void 0:a.getSetting("theme");(!l||l==="system")&&(l=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),_(l)}return{init:W,showScreen:F,goBack:se,getScreenData:V,getCurrentScreen:le,applyTheme:_,initTheme:B,showConfirmModal:A,SCREENS:D}}();window.Cozy.Screens=ScreenManager,document.addEventListener("DOMContentLoaded",()=>{ScreenManager.init()}),function(){"use strict";const{CONFIG:H,getPuzzleId:S,getPuzzleTitle:q,parsePuzzleTitle:U,renderOutlinedCanvas:D}=window.Cozy.Utils,C=["easy","medium","hard","challenging","expert"],P='<svg class="placeholder-icon" viewBox="300 200 440 600" aria-hidden="true"><path fill="currentColor" transform="scale(2 2)" d="M251.724 120.241C292.099 116.006 333.322 148.379 341.784 187.699C349.613 224.08 333.989 254.362 306.146 276.366C300.534 280.801 290.424 282.015 285.865 286.917C277.693 295.707 280.688 308.471 274.943 317.013C262.186 336.38 226.696 327.87 233.173 294.887C235.824 281.387 239.865 271.299 247.555 260.03C251.934 253.972 262.127 243.93 268.474 240.356C276.495 236.098 283.216 235.327 289.107 227.709C298.349 215.758 298.827 199.451 291.065 186.685C273.123 157.177 231.314 162.292 218.105 193.171C216.601 196.688 216.173 200.717 214.325 204.113C203.424 223.501 172.407 218.828 170.08 195.677C169.429 189.206 171.385 184.817 173.298 178.941C184.909 143.291 215.812 123.577 251.724 120.241Z"/><path fill="currentColor" transform="scale(2 2)" d="M248.076 336.509C263.421 334.867 277.184 345.994 278.792 361.343C280.401 376.691 269.244 390.43 253.892 392.006C238.587 393.577 224.898 382.461 223.295 367.159C221.691 351.857 232.777 338.145 248.076 336.509Z"/></svg>';function d(){var h;const z=(h=window.Cozy.Storage)==null?void 0:h.getUIState("collapsedSections");return z&&typeof z=="object"?z:null}function s(z){var h;(h=window.Cozy.Storage)==null||h.setUIState("collapsedSections",z)}function N(z,h){const f=document.querySelector(`.collection-section[data-difficulty="${z}"]`);if(!f)return;const p=!h[z];h[z]=p,s(h),f.classList.toggle("collapsed",p);const w=f.querySelector(".collection-grid"),M=f.querySelector(".section-chevron"),g=f.querySelector(".collection-section-header");if(w&&(w.style.display=p?"none":"flex"),M&&(M.textContent=p?"\u25B6":"\u25BC"),g){g.setAttribute("aria-expanded",!p);const I=g.querySelector(".collection-section-stats"),L=I?I.textContent:"",[O,_]=L.split("/");g.setAttribute("aria-label",`${W(z)}, ${O} of ${_} completed, ${p?"collapsed":"expanded"}`)}window.Cozy.Collection&&window.Cozy.Collection.updateRovingTabindex()}function A(){return window.Cozy.Storage||null}function ne(z){const h={};return z.forEach((f,b)=>{const p=U(q(f)),w=p.difficulty;h[w]||(h[w]=[]),h[w].push({index:b,puzzle:f,meta:p,id:S(f)})}),h}function Z(z){const h={};return z.forEach(f=>{const b=U(q(f.puzzle)),p=b.difficulty;h[p]||(h[p]=[]),h[p].push({index:f.originalIndex,puzzle:f.puzzle,meta:b,id:S(f.puzzle)})}),h}function ie(z){return Object.keys(z).sort((f,b)=>{const p=C.indexOf(f),w=C.indexOf(b);return p!==-1&&w!==-1?p-w:p!==-1?-1:w!==-1?1:f.localeCompare(b)})}function W(z){return z.charAt(0).toUpperCase()+z.slice(1)}function j(z){const h=A();let f=0;return h&&z.forEach(b=>{h.isPuzzleCompleted(b.id)&&f++}),{completed:f,total:z.length}}function F(z){if(!z)return!1;for(const h of z)for(const f of h)if((typeof f=="object"&&f!==null?f.value:f)!==null)return!0;return!1}function se(z,h,f={}){const b=A(),p=b?b.isPuzzleCompleted(z.id):!1,w=b?b.getPuzzleGrid(z.id):null,M=!p&&F(w),g=document.createElement("div");g.className="puzzle-card"+(p?" completed":"")+(M?" in-progress":""),g.dataset.puzzleIndex=z.index,g.dataset.puzzleId=z.id,g.tabIndex=-1,g.setAttribute("role","button"),g.setAttribute("aria-label",`${z.meta.name}, ${z.meta.width} by ${z.meta.height}${p?", completed":""}`),g.addEventListener("keydown",B=>{if(B.key==="Enter"||B.key===" "){B.preventDefault(),window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=z.id),h(z.index);return}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(B.key)&&(B.preventDefault(),B.stopPropagation(),window.Cozy.Collection&&window.Cozy.Collection.navigateFromElement(g,B.key))});const I=document.createElement("div");if(I.className="puzzle-card-preview",f.forceBlank){I.classList.add("awaiting-stamp");const B=document.createElement("div");B.className="puzzle-card-placeholder",B.innerHTML=P,I.appendChild(B)}else if(p)I.appendChild(ee(z.puzzle));else if(M)I.appendChild(G(z.puzzle,w));else{const B=document.createElement("div");B.className="puzzle-card-placeholder",B.innerHTML=P,I.appendChild(B)}g.appendChild(I);const L=document.createElement("div");L.className="puzzle-card-name",L.textContent=z.meta.name,g.appendChild(L);const O=Object.keys(z.puzzle.color_map).length,_=document.createElement("div");return _.className="puzzle-card-badge",_.textContent=`${z.meta.width}\xD7${z.meta.height} \xB7 ${O}c`,g.appendChild(_),g.addEventListener("click",()=>{window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=z.id),h(z.index)}),g}function ee(z){try{const h=D(z.width,z.height,H.MINI_CANVAS_SIZE,(f,b)=>{var w,M,g;const p=(M=(w=z.solution)==null?void 0:w[f])==null?void 0:M[b];if(p>0){const I=(g=z.color_map)==null?void 0:g[p];if(I&&Array.isArray(I)&&I.length>=3)return I}return null});return h.className="puzzle-mini-canvas",h}catch(h){return console.error("[Collection] Error creating mini solution:",h),null}}function G(z,h){try{const f=D(z.width,z.height,H.MINI_CANVAS_SIZE,(b,p)=>{var g,I;const w=(g=h==null?void 0:h[b])==null?void 0:g[p],M=typeof w=="object"&&w!==null?w.value:w;if(M!==null&&M>0){const L=(I=z.color_map)==null?void 0:I[M];if(L&&Array.isArray(L)&&L.length>=3)return L}return null});return f.className="puzzle-mini-canvas",f}catch(f){return console.error("[Collection] Error creating mini progress:",f),null}}function V(z,h,f,b={}){z.innerHTML="";const p=(b.searchFilter||"").toLowerCase().trim().slice(0,H.MAX_SEARCH_LENGTH);let w=h.map((O,_)=>({puzzle:O,originalIndex:_}));p&&(w=w.filter(O=>U(q(O.puzzle)).name.toLowerCase().includes(p)));const M=Z(w),g=ie(M),I=A();if(g.length===0&&p){const O=document.createElement("div");O.className="collection-empty-state";const _=document.createElement("p");_.className="collection-empty-message",_.textContent=`No puzzles match "${p}"`,O.appendChild(_),z.appendChild(O);return}let L;if(p)L={},g.forEach(O=>{L[O]=!1});else if(L=d(),!L){L={};let O=!1;g.forEach(_=>{const B=j(M[_]);!O&&B.completed<B.total?(L[_]=!1,O=!0):L[_]=!0}),!O&&g.length>0&&(L[g[0]]=!1),s(L)}g.forEach(O=>{const _=le(O,M[O],L,f,b);z.appendChild(_)})}function le(z,h,f,b,p){const w=j(h),M=f[z],g=document.createElement("div");g.className="collection-section"+(M?" collapsed":""),g.dataset.difficulty=z;const I=`collection-grid-${z}`,L=document.createElement("div");L.className="collection-section-header",L.style.cursor="pointer",L.dataset.difficulty=z,L.tabIndex=-1,L.setAttribute("role","button"),L.setAttribute("aria-expanded",!M),L.setAttribute("aria-controls",I),L.setAttribute("aria-label",`${W(z)}, ${w.completed} of ${w.total} completed, ${M?"collapsed":"expanded"}`);const O=document.createElement("span");O.className="section-chevron",O.setAttribute("aria-hidden","true"),O.textContent=M?"\u25B6":"\u25BC",L.appendChild(O);const _=document.createElement("h3");_.className="collection-section-title",_.textContent=W(z),L.appendChild(_);const B=document.createElement("span");B.className="collection-section-stats",B.textContent=`${w.completed}/${w.total}`,w.completed===w.total&&w.total>0&&B.classList.add("complete"),L.appendChild(B),L.addEventListener("click",()=>{N(z,f)}),L.addEventListener("keydown",a=>{if(a.key==="Enter"||a.key===" "){a.preventDefault(),N(z,f);return}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(a.key)&&(a.preventDefault(),a.stopPropagation(),window.Cozy.Collection&&window.Cozy.Collection.navigateFromElement(L,a.key))}),g.appendChild(L);const l=document.createElement("div");return l.className="collection-grid",l.id=I,l.style.display=M?"none":"flex",h.forEach(a=>{const m={};p.blankPuzzleId&&a.id===p.blankPuzzleId&&(m.forceBlank=!0);const y=se(a,b,m);l.appendChild(y)}),g.appendChild(l),g}class J{constructor(){this.container=null,this.puzzles=[],this.onPuzzleSelect=null,this.visible=!0,this.searchFilter="",this.searchInput=null,this.searchInputHandler=null,this.searchDebounceTimeout=null,this.focusedCardId=null,this.focusedHeaderDifficulty=null,this.idealX=null}init(h,f,b){return this.container=document.getElementById(h),this.puzzles=f,this.onPuzzleSelect=b,this.searchInput=document.getElementById("collection-search-input"),this.searchInput&&(this.searchInputHandler&&this.searchInput.removeEventListener("input",this.searchInputHandler),this.searchInputHandler=p=>{this.searchFilter=p.target.value,this.searchDebounceTimeout&&clearTimeout(this.searchDebounceTimeout),this.searchDebounceTimeout=setTimeout(()=>this.render(),150)},this.searchInput.addEventListener("input",this.searchInputHandler)),this.container&&this.render(),this}render(h={}){if(!this.container)return;const f={...h,searchFilter:this.searchFilter};V(this.container,this.puzzles,b=>{this.onPuzzleSelect&&this.onPuzzleSelect(b)},f),this.updateRovingTabindex()}show(){this.container&&(this.container.style.display="block",this.visible=!0,this.searchFilter="",this.searchInput&&(this.searchInput.value=""),this.render())}hide(){this.container&&(this.container.style.display="none",this.visible=!1)}isVisible(){return this.visible}refresh(h={}){this.visible&&this.render(h)}getVisibleCards(){if(!this.container)return[];const h=[];return this.container.querySelectorAll(".collection-section").forEach(b=>{const p=b.querySelector(".collection-grid");p&&p.style.display!=="none"&&p.querySelectorAll(".puzzle-card").forEach(M=>h.push(M))}),h}getNavigableElements(){if(!this.container)return[];const h=[];return this.container.querySelectorAll(".collection-section").forEach(b=>{const p=b.querySelector(".collection-section-header");p&&h.push(p);const w=b.querySelector(".collection-grid");w&&w.style.display!=="none"&&w.querySelectorAll(".puzzle-card").forEach(g=>h.push(g))}),h}isHeader(h){return h&&h.classList.contains("collection-section-header")}findElementInDirection(h,f,b=null){const p=this.getNavigableElements();if(p.length===0)return null;const w=h.getBoundingClientRect(),M=w.left+w.width/2,g=w.top+w.height/2,I=this.isHeader(h),L=(f==="up"||f==="down")&&b!==null?b:M,O=w.height*.5,_=w.width*.5;let B=null,l=1/0;return p.forEach(a=>{if(a===h)return;const m=a.getBoundingClientRect(),y=m.left+m.width/2,v=m.top+m.height/2,$=this.isHeader(a);let R=!1;switch(f){case"left":I?R=!1:R=!$&&y<M-_&&Math.abs(v-g)<O;break;case"right":I?R=!1:R=!$&&y>M+_&&Math.abs(v-g)<O;break;case"up":R=v<g-O;break;case"down":R=v>g+O;break}if(R){let Q;if(f==="left"||f==="right")Q=Math.abs(y-M);else{const K=Math.abs(v-g),Ie=Math.abs(y-L);Q=K*1e3+Ie}Q<l&&(l=Q,B=a)}}),B}navigateFromElement(h,f){const p={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[f];if(!p)return;const w=h.getBoundingClientRect(),M=w.left+w.width/2;let g;if(p==="up"||p==="down"?(this.idealX===null&&(this.idealX=M),g=this.findElementInDirection(h,p,this.idealX)):g=this.findElementInDirection(h,p),g){const I=g.getBoundingClientRect(),L=I.left+I.width/2;p==="left"||p==="right"?this.idealX=L:this.isHeader(g),h.tabIndex=-1,g.tabIndex=0,g.focus(),this.isHeader(g)?(this.focusedCardId=null,this.focusedHeaderDifficulty=g.dataset.difficulty):(this.focusedCardId=g.dataset.puzzleId,this.focusedHeaderDifficulty=null),g.scrollIntoView({behavior:"smooth",block:"nearest"})}}findCardInDirection(h,f){const b=this.getVisibleCards();if(b.length===0)return null;const p=h.getBoundingClientRect(),w=p.left+p.width/2,M=p.top+p.height/2,g=p.height*.5,I=p.width*.5;let L=null,O=1/0;return b.forEach(_=>{if(_===h)return;const B=_.getBoundingClientRect(),l=B.left+B.width/2,a=B.top+B.height/2;let m=!1;switch(f){case"left":m=l<w-I&&Math.abs(a-M)<g;break;case"right":m=l>w+I&&Math.abs(a-M)<g;break;case"up":m=a<M-g;break;case"down":m=a>M+g;break}if(m){let y;if(f==="left"||f==="right")y=Math.abs(l-w);else{const v=Math.abs(a-M),$=Math.abs(l-w);y=v*1e3+$}y<O&&(O=y,L=_)}}),L}navigateFromCard(h,f){const p={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[f];if(!p)return;const w=this.findCardInDirection(h,p);w&&(h.tabIndex=-1,w.tabIndex=0,w.focus(),this.focusedCardId=w.dataset.puzzleId,w.scrollIntoView({behavior:"smooth",block:"nearest"}))}updateRovingTabindex(){const h=this.getNavigableElements();if(h.length===0)return;let f=null;if(this.focusedCardId){const b=this.container.querySelector(`.puzzle-card[data-puzzle-id="${this.focusedCardId}"]`);b&&h.includes(b)&&(f=b)}if(!f&&this.focusedHeaderDifficulty){const b=this.container.querySelector(`.collection-section-header[data-difficulty="${this.focusedHeaderDifficulty}"]`);b&&h.includes(b)&&(f=b)}f||(f=h[0],this.isHeader(f)?(this.focusedHeaderDifficulty=f.dataset.difficulty,this.focusedCardId=null):(this.focusedCardId=(f==null?void 0:f.dataset.puzzleId)||null,this.focusedHeaderDifficulty=null)),h.forEach(b=>{b.tabIndex=b===f?0:-1})}scrollToPuzzle(h,f={}){if(!this.container)return;const b=this.container.querySelectorAll(".puzzle-card");let p=null,w=-1;for(let I=0;I<this.puzzles.length;I++)if(S(this.puzzles[I])===h){w=I;break}if(w===-1||(b.forEach(I=>{parseInt(I.dataset.puzzleIndex,10)===w&&(p=I)}),!p))return;const M=p.closest(".collection-section");if(M&&M.classList.contains("collapsed")){const I=M.dataset.difficulty,L=M.querySelector(".collection-grid"),O=M.querySelector(".section-chevron");M.classList.remove("collapsed"),L&&(L.style.display="flex"),O&&(O.textContent="\u25BC");let _=d()||{};_[I]=!1,s(_)}const g=f.instant?"instant":"smooth";setTimeout(()=>{p.scrollIntoView({behavior:g,block:"center"})},f.instant?0:100)}animateStampTo(h,f,b={}){if(!this.container||!f)return;const p=this.container.querySelector(`.puzzle-card[data-puzzle-id="${h}"]`);if(!p){f.remove();return}const w=p.querySelector(".puzzle-card-preview");if(!w){f.remove();return}setTimeout(()=>{const g=w.getBoundingClientRect(),I=parseFloat(f.style.width),L=parseFloat(f.style.height),O=this.puzzles.find(y=>S(y)===h);let _,B;if(O){const y=Math.max(O.width,O.height),v=Math.max(2,Math.floor(H.MINI_CANVAS_SIZE/y)),$=H.OUTLINE_THICKNESS*2;_=O.width*v+$,B=O.height*v+$}else{const y=I/L;y>1?(_=g.width,B=g.width/y):(B=g.height,_=g.height*y)}const l=_/I,a=g.left+g.width/2,m=g.top+g.height/2;requestAnimationFrame(()=>{f.style.left=a-I/2+"px",f.style.top=m-L/2+"px",f.style.transform="scale("+l+")",f.classList.add("landed")}),setTimeout(()=>{w.classList.remove("awaiting-stamp"),w.innerHTML="";const y=this.puzzles.find(v=>S(v)===h);if(y){const v=A();if(v?v.isPuzzleCompleted(h):!1)w.appendChild(ee(y));else{const R=v?v.getPuzzleGrid(h):null;R&&w.appendChild(G(y,R))}}f.remove()},650)},100)}}const me=new J;window.Cozy.Collection=me}(),function(){"use strict";const H={isInstalled:!1,swRegistration:null,resizeTimeout:null,init(){this.checkInstallState(),this.registerServiceWorker(),this.setupEventListeners(),console.log("[App] Cozy Garden initialized")},checkInstallState(){window.matchMedia("(display-mode: standalone)").matches&&(this.isInstalled=!0),window.navigator.standalone===!0&&(this.isInstalled=!0),this.isInstalled&&(document.body.classList.add("is-installed"),console.log("[App] Running as installed PWA"))},async registerServiceWorker(){if(!("serviceWorker"in navigator)){console.log("[App] Service workers not supported");return}try{this.swRegistration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("[App] Service worker registered:",this.swRegistration.scope),this.swRegistration.addEventListener("updatefound",()=>{const S=this.swRegistration.installing;console.log("[App] New service worker installing..."),S.addEventListener("statechange",()=>{S.state==="installed"&&navigator.serviceWorker.controller&&this.showUpdateNotification()})})}catch(S){console.error("[App] Service worker registration failed:",S)}},showUpdateNotification(){const S=document.createElement("div");S.className="update-banner";const q=document.createElement("span");q.textContent="A new version is available!";const U=document.createElement("button");U.textContent="Update",U.addEventListener("click",()=>this.applyUpdate());const D=document.createElement("button");D.textContent="Later",D.addEventListener("click",()=>S.remove()),S.appendChild(q),S.appendChild(U),S.appendChild(D),document.body.appendChild(S)},applyUpdate(){this.swRegistration&&this.swRegistration.waiting&&this.swRegistration.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload()},setupEventListeners(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?this.onAppFocus():this.onAppBlur()}),window.addEventListener("beforeunload",()=>{this.saveState()}),window.addEventListener("orientationchange",()=>{setTimeout(()=>this.handleResize(),100)}),window.addEventListener("resize",()=>{this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>this.handleResize(),100)})},onAppFocus(){console.log("[App] App focused")},onAppBlur(){console.log("[App] App blurred"),this.saveState()},saveState(){window.Cozy.Garden&&window.Cozy.Storage&&console.log("[App] Saving state...")},handleResize(){const S=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${S}px`)},isPWA(){return this.isInstalled||window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0},async getVersion(){return!this.swRegistration||!navigator.serviceWorker.controller?"unknown":new Promise(S=>{const q=new MessageChannel;q.port1.onmessage=U=>{S(U.data.version||"unknown")},navigator.serviceWorker.controller.postMessage({type:"GET_VERSION"},[q.port2]),setTimeout(()=>S("unknown"),1e3)})},async share(S,q,U){if(navigator.share)try{return await navigator.share({title:S,text:q,url:U}),!0}catch(D){return D.name!=="AbortError"&&console.error("[App] Share failed:",D),!1}return!1},vibrate(S=50){var q;navigator.vibrate&&((q=window.Cozy.Storage)!=null&&q.getSetting("vibration"))&&navigator.vibrate(S)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>H.init()):H.init(),window.Cozy.App=H}(),function(){"use strict";const{CONFIG:H,getPuzzleId:S,getPuzzleTitle:q,createFlyingStamp:U,renderOutlinedCanvas:D}=window.Cozy.Utils;let C=0,P="easy",d=1,s=[],N=!1,A=null,ne=!0,Z=!1,ie=!1,W=0,j=0,F=null,se=null,ee=null,G=[],V=[],le=[],J=[],me=[],z=null;function h(e,t="info"){const n=document.getElementById("toast");n&&(clearTimeout(z),n.textContent=e,n.className="toast visible",t==="success"?n.classList.add("toast-success"):t==="info"&&n.classList.add("toast-info"),z=setTimeout(()=>{n.classList.remove("visible")},H.TOAST_DURATION))}function f(){const e=document.getElementById("toast");e&&(clearTimeout(z),e.classList.remove("visible"))}function b(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function p(){const e=document.getElementById("help-list");if(!e)return;const t=b();let n=["<li><strong>Select a color</strong> from the palette, then tap cells to fill them</li>","<li><strong>Drag</strong> across cells to fill multiple at once</li>","<li><strong>Long-press</strong> a cell to mark it \u2715 (definitely empty)</li>","<li><strong>Pencil mode</strong> marks uncertain guesses \u2014 confirm or clear them later</li>"];t&&n.push("<li><strong>Pinch to zoom</strong> on larger puzzles for easier tapping</li>"),t||(n.push('<li class="help-section-title">Keyboard Shortcuts</li>'),n.push("<li><strong>Ctrl+Z</strong> / <strong>Ctrl+Y</strong> \u2014 Undo / Redo</li>"),n.push("<li><strong>P</strong> \u2014 Toggle pencil mode</li>"),n.push("<li><strong>1-9</strong> \u2014 Select color by number</li>"),n.push("<li><strong>+</strong> / <strong>-</strong> \u2014 Zoom in / out</li>")),e.innerHTML=n.join("")}function w(){const e=document.getElementById("help-modal");if(!e)return;p(),e.classList.add("visible"),document.body.style.overflow="hidden";const t=e.querySelector(".help-modal-close");t&&setTimeout(()=>t.focus(),100)}function M(){const e=document.getElementById("help-modal");e&&(e.classList.remove("visible"),document.body.style.overflow="")}function g(){const e=document.getElementById("help-btn"),t=document.getElementById("help-modal"),n=t==null?void 0:t.querySelector(".help-modal-backdrop"),o=t==null?void 0:t.querySelector(".help-modal-close");e&&e.addEventListener("click",w),n&&n.addEventListener("click",M),o&&o.addEventListener("click",M),document.addEventListener("keydown",i=>{if(t!=null&&t.classList.contains("visible")){if(i.key==="Escape"){M();return}i.key==="Tab"&&(document.activeElement!==o?(i.preventDefault(),o==null||o.focus()):i.preventDefault())}})}function I(){const e=document.getElementById("skip-to-puzzle");e&&e.addEventListener("click",t=>{var o;t.preventDefault();const n=(o=G[0])==null?void 0:o[0];n&&n.focus()})}function L(){var e;(e=window.Cozy.Storage)!=null&&e.getFlag("helpShown")||setTimeout(()=>{var t;w(),(t=window.Cozy.Storage)==null||t.setFlag("helpShown",!0)},500)}function O(e){if(!e)return null;if(e.title!==void 0)return!e.width||!e.height||!e.row_clues||!e.col_clues||!e.color_map?(console.warn("[Game] Invalid verbose puzzle format:",e.title),null):e;if(!e.t||!e.w||!e.h||!Array.isArray(e.r)||!Array.isArray(e.c)||!Array.isArray(e.p)||!Array.isArray(e.s))return console.warn("[Game] Invalid concise puzzle format, missing or malformed fields:",e.t),null;if(e.w>H.MAX_PUZZLE_DIMENSION||e.h>H.MAX_PUZZLE_DIMENSION||e.w<1||e.h<1)return console.warn("[Game] Puzzle dimensions out of range:",e.w,"x",e.h),null;function t(r){const c=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(r);return c?[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]:[0,0,0]}function n(r){return r.map(c=>c.map(([k,E])=>({count:k,color:E+1})))}function o(r){const c={};return r.forEach((k,E)=>{c[E+1]=t(k)}),c}function i(r){return r.map(c=>c.map(k=>k<0?0:k+1))}try{return{title:e.t,width:e.w,height:e.h,row_clues:n(e.r),col_clues:n(e.c),color_map:o(e.p),color_names:e.n||null,solution:i(e.s)}}catch(r){return console.error("[Game] Failed to convert puzzle:",e.t,r),null}}let _=null,B=null;function l(){const e=window.PUZZLE_DATA||[];return(!_||e!==B)&&(_=e.map(O).filter(t=>t!==null),B=e),_}function a(e=null,t=!0){return{value:e,certain:t}}function m(e,t){var n;return((n=s[e])==null?void 0:n[t])||a()}function y(e,t,n,o){s[e][t]={value:n,certain:o}}function v(e){return`rgb(${e[0]}, ${e[1]}, ${e[2]})`}function $(e){return(e[0]*299+e[1]*587+e[2]*114)/1e3}function R(e){const t=e.toLowerCase();return t.includes("easy")?"easy":t.includes("medium")?"medium":t.includes("hard")?"hard":t.includes("challenging")?"challenging":t.includes("expert")?"expert":"easy"}function Q(){return window.Cozy.Storage||null}function K(){return window.Cozy.History||null}function Ie(){const e=l()[C];if(!e)return!0;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++)if(m(t,n).value!==null)return!1;return!0}function Ve(){const e=l()[C];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=m(t,n),i=e.solution[t][n];if(o.value!==i||!o.certain)return!1}return!0}function ze(){const e=document.getElementById("reset-btn"),t=document.getElementById("solution-btn");if(e){const n=Ie();e.disabled=n,e.setAttribute("aria-label",n?"Reset (puzzle is empty)":"Hold to reset puzzle")}if(t){const n=Ve();t.disabled=n,t.setAttribute("aria-label",n?"Solution (already shown)":"Hold to reveal solution")}}function pe(e){const t=document.getElementById("sr-announcer");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},50))}function Te(e){Z=e,Be(),pe(e?"Pencil mode":"Pen mode"),Le()}function He(){Te(!Z)}function Be(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("palette-menu-btn");if(e&&(e.classList.toggle("active",!Z),e.setAttribute("aria-checked",String(!Z))),t&&(t.classList.toggle("active",Z),t.setAttribute("aria-checked",String(Z))),n){const o=n.querySelector(".menu-icon-svg");o&&(o.removeAttribute("stroke"),o.removeAttribute("stroke-width"),o.setAttribute("fill","currentColor"),Z?o.innerHTML='<path d="M19.07 13.88L13 19.94l-1.41-1.41 6.07-6.06 1.41 1.41zm-5.66-5.66l-6.06 6.07-1.42-1.41 6.07-6.07 1.41 1.41zM17.66 5.99l-2.34 2.34 1.41 1.41 2.34-2.34-1.41-1.41zM3 18v3h3l.01-.01L3 18zm3-3l-1 1 3 3 1-1-3-3z" opacity="0.5"/><path d="M9.17 16.17L7.76 17.59l3.54 3.54 1.41-1.41-3.54-3.55zm10.6-10.6l-3.53-3.54-1.42 1.42 3.54 3.53 1.41-1.41z"/>':o.innerHTML='<path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>')}document.body.classList.toggle("pencil-mode",Z)}function Ye(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");if(!e||!t)return;e.classList.contains("open")?Le():Ke()}function Ke(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");!e||!t||(e.classList.add("open"),t.classList.add("menu-open"),t.setAttribute("aria-expanded","true"),setTimeout(()=>{document.addEventListener("click",Ze)},0))}function Le(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");e&&(e.classList.remove("open"),t&&(t.classList.remove("menu-open"),t.setAttribute("aria-expanded","false")),document.removeEventListener("click",Ze))}function Ze(e){const t=document.getElementById("mode-menu"),n=document.getElementById("palette-menu-btn");!t||!n||!t.contains(e.target)&&!n.contains(e.target)&&Le()}function Re(){const e=l()[C];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=m(t,n);if(!o.certain&&o.value!==null)return!0}return!1}function We(){const e=l()[C];if(!e)return 0;let t=0;for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=m(n,o);!i.certain&&i.value!==null&&t++}return t}function fe(){const e=document.getElementById("pencil-actions-section"),t=document.getElementById("palette-menu-btn"),n=Re(),o=n?We():0;if(e&&e.classList.toggle("has-marks",n),t){t.classList.toggle("has-pencil-marks",n);const i=t.querySelector(".pencil-badge");i&&(i.textContent=o>H.BADGE_MAX_DISPLAY?`${H.BADGE_MAX_DISPLAY}+`:String(o))}}function Ue(){const e=l()[C];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=m(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:null,certain:!0}}),y(n,o,null,!0),be(n,o,e))}if(t.length>0){const n=K();n&&n.recordBatchAction("batch-clear",t),window.Cozy.App&&window.Cozy.App.vibrate(20)}fe(),Se()}function $e(){const e=l()[C];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=m(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:i.value,certain:!0}}),y(n,o,i.value,!0),be(n,o,e))}if(t.length>0){const n=K();n&&n.recordBatchAction("batch-confirm",t),window.Cozy.App&&window.Cozy.App.vibrate([20,50,20])}fe(),et(e),Se()}function Oe(){const e=K();if(!e)return;const t=e.undo();if(!t)return;const n=l()[C];for(const o of t)y(o.row,o.col,o.state.value,o.state.certain),be(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),fe(),Me(n),ze(),Se()}function De(){const e=K();if(!e)return;const t=e.redo();if(!t)return;const n=l()[C];for(const o of t)y(o.row,o.col,o.state.value,o.state.certain),be(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),fe(),Me(n),ze(),et(n),Se()}function Se(){const e=Q();if(!e)return;const n=l()[C];if(!n)return;const o=S(n);e.savePuzzleGrid(o,s),e.saveSession(C,P,s)}function je(){const e=Q();e&&e.clearSession()}function Je(){const e=l(),t=document.getElementById("puzzle-select"),n=[...new Set(e.map(k=>R(k.title)))],o=["easy","medium","hard","challenging","expert"];n.sort((k,E)=>o.indexOf(k)-o.indexOf(E));const i=document.createElement("div");i.className="difficulty-tabs",n.forEach(k=>{const E=document.createElement("button");E.className="difficulty-tab"+(k===P?" active":""),E.textContent=k.charAt(0).toUpperCase()+k.slice(1),E.onclick=()=>{P=k,document.querySelectorAll(".difficulty-tab").forEach(X=>X.classList.remove("active")),E.classList.add("active"),u()},i.appendChild(E)});const r=document.createElement("div");r.className="puzzle-dropdown";const c=document.createElement("select");c.id="puzzle-select-dropdown",c.onchange=k=>{T(parseInt(k.target.value))},r.appendChild(c),t.appendChild(i),t.appendChild(r),u()}function u(){var i;const e=l(),t=document.getElementById("puzzle-select-dropdown");if(!t)return;const n=Q();if(t.innerHTML="",e.forEach((r,c)=>{if(R(r.title)===P){const k=document.createElement("option");k.value=c;const E=S(r),X=n?n.isPuzzleCompleted(E):!1;k.textContent=(X?"\u2713 ":"")+r.title,c===C&&(k.selected=!0),t.appendChild(k)}}),e.filter(r=>R(r.title)===P).length>0&&!(R((i=e[C])==null?void 0:i.title)===P)){const c=e.findIndex(k=>R(k.title)===P);c>=0&&T(c)}}function T(e,t=null){var n;if(ie){console.warn("[Game] Puzzle already loading, ignoring request");return}ie=!0;try{const o=l(),i=Q(),r=K();if(e!==C&&s.length>0&&o[C]&&i){const ue=S(o[C]);i.savePuzzleGrid(ue,s)}r&&r.clear(),Z=!1,Be(),W=0,j=0,C=e;const c=o[e];if(!c){ie=!1;return}if(c.width>H.MAX_PUZZLE_DIMENSION||c.height>H.MAX_PUZZLE_DIMENSION||c.width<1||c.height<1){console.error(`[Game] Invalid puzzle dimensions: ${c.width}x${c.height}`),ie=!1;return}const k=S(c);let E=t;!E&&i&&(E=i.getPuzzleGrid(k));const X=E&&E.length===c.height;if(X)s=E.map(ue=>ue.map(ye=>({value:ye.value,certain:ye.certain})));else{s=[];for(let ue=0;ue<c.height;ue++){s.push([]);for(let ye=0;ye<c.width;ye++)s[ue][ye]=a(null,!0)}}if(d=1,x(c),ce(c),Fe(c),ht(),X)for(let ue=0;ue<c.height;ue++)for(let ye=0;ye<c.width;ye++)m(ue,ye).value!==null&&be(ue,ye,c);f();const te=document.getElementById("puzzle-select-dropdown");te&&(te.value=e);const ae=R(c.title);ae!==P&&(P=ae,document.querySelectorAll(".difficulty-tab").forEach(ue=>{ue.classList.toggle("active",ue.textContent.toLowerCase()===ae)}),u()),fe(),Me(c),window.Cozy.Zoom&&window.Cozy.Zoom.initForPuzzle(c),L(),ze();const he=c.title.match(/^(.+?)\s*\(/),Ee=he?he[1].trim():c.title,Ct=R(c.title),vt=((n=c.color_names)==null?void 0:n.join(", "))||`${Object.keys(c.color_map).length} colors`;pe(`${Ee}, ${c.width} by ${c.height}, ${vt}. ${Ct} difficulty.`)}finally{ie=!1}}function x(e){const t=document.getElementById("palette"),n=document.getElementById("mode-menu"),o=n?n.parentNode:null;n&&t.contains(n)&&document.body.appendChild(n),t.innerHTML="";const i=document.createElement("button");i.className="color-btn eraser",i.title="Eraser",i.setAttribute("aria-label","Eraser"),i.setAttribute("aria-pressed",d===0?"true":"false"),i.addEventListener("click",()=>Y(0)),t.appendChild(i),Object.entries(e.color_map).forEach(([E,X])=>{const te=document.createElement("button"),ae=parseInt(E)===d;te.className="color-btn"+(ae?" selected":""),te.style.background=v(X);const he=parseInt(E)-1,Ee=e.color_names&&e.color_names[he]?e.color_names[he]:`Color ${E}`;te.setAttribute("aria-label",Ee.charAt(0).toUpperCase()+Ee.slice(1)),te.setAttribute("aria-pressed",ae?"true":"false"),te.addEventListener("click",()=>Y(parseInt(E))),t.appendChild(te)});const r=document.createElement("button");r.className="palette-menu-btn",r.id="palette-menu-btn",r.title="Drawing mode",r.setAttribute("aria-label","Drawing mode menu"),r.setAttribute("aria-haspopup","true"),r.setAttribute("aria-expanded","false"),r.innerHTML=`
      <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>
      </svg>
      <span class="pencil-badge">0</span>
    `,r.addEventListener("click",E=>{E.stopPropagation(),Ye()}),t.appendChild(r);const c=document.getElementById("mode-menu");c&&t.appendChild(c);const k=t.querySelectorAll(".color-btn, .palette-menu-btn").length;t.classList.remove("palette-8-buttons","palette-7-buttons"),k>=8?t.classList.add("palette-8-buttons"):k===7&&t.classList.add("palette-7-buttons")}function Y(e){d=e;const n=l()[C];document.querySelectorAll(".color-btn").forEach((o,i)=>{let r;i===0?r=e===0:r=parseInt(Object.keys(n.color_map)[i-1])===e,o.classList.toggle("selected",r),o.setAttribute("aria-pressed",r?"true":"false")})}function oe(e,t,n){var i;const o=document.createElement("div");if(o.className=n,e===null)o.textContent="0",o.style.background="#333",o.setAttribute("aria-label","empty");else{const r=t.color_map[e.color];o.textContent=e.count,o.style.background=v(r),o.style.color=$(r)>H.BRIGHTNESS_MIDPOINT?"#000":"#fff",o.style.cursor="pointer",o.onclick=()=>Y(e.color);const c=((i=t.color_names)==null?void 0:i[e.color-1])||`color ${e.color}`;o.setAttribute("aria-label",`${e.count} ${c}`)}return o}function ce(e){le=[],V=[],J=new Array(e.height).fill(!1),me=new Array(e.width).fill(!1);const t=document.getElementById("col-clues");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,e.col_clues.forEach((o,i)=>{const r=document.createElement("div");r.className="col-clue",r.dataset.col=i,o.length===0?r.appendChild(oe(null,e,"clue-cell")):o.forEach(c=>{r.appendChild(oe(c,e,"clue-cell"))}),le[i]=r,t.appendChild(r)});const n=document.getElementById("row-clues-container");n.innerHTML="",n.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,e.row_clues.forEach((o,i)=>{const r=document.createElement("div");r.className="row-clues",r.dataset.row=i,o.length===0?r.appendChild(oe(null,e,"row-clue-cell")):o.forEach(c=>{r.appendChild(oe(c,e,"row-clue-cell"))}),V[i]=r,n.appendChild(r)})}let re=-1,de=-1;function Ce(e,t){var o;if(b()||e===re&&t===de||(ve(),re=e,de=t,e<0||t<0)||!G[e])return;const n=G[e];if(n)for(let i=0;i<n.length;i++){const r=n[i];r&&(r.classList.add("highlight-row"),i===t&&r.classList.add("highlight-cell"))}for(let i=0;i<G.length;i++)i!==e&&((o=G[i])!=null&&o[t])&&G[i][t].classList.add("highlight-col");V[e]&&V[e].classList.add("highlight-clue"),le[t]&&le[t].classList.add("highlight-clue")}function ve(){var n;const e=re,t=de;if(re=-1,de=-1,!(e<0&&t<0)){if(e>=0&&G[e])for(let o=0;o<G[e].length;o++){const i=G[e][o];i&&i.classList.remove("highlight-row","highlight-cell")}if(t>=0)for(let o=0;o<G.length;o++){const i=(n=G[o])==null?void 0:n[t];i&&i.classList.remove("highlight-col")}e>=0&&V[e]&&V[e].classList.remove("highlight-clue"),t>=0&&le[t]&&le[t].classList.remove("highlight-clue")}}function we(e,t){var i,r;const n=l()[C];if(!n||e<0||e>=n.height||t<0||t>=n.width)return;(i=G[W])!=null&&i[j]&&(G[W][j].tabIndex=-1),W=e,j=t;const o=(r=G[e])==null?void 0:r[t];o&&(o.tabIndex=0,o.focus())}function Ae(e,t){const n=document.createElement("div");return n.className="cell",n.dataset.row=e,n.dataset.col=t,n.tabIndex=e===W&&t===j?0:-1,n.setAttribute("role","gridcell"),n.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}, empty`),n}function ke(e,t,n){e.onfocus=()=>{var o;(W!==t||j!==n)&&((o=G[W])!=null&&o[j]&&(G[W][j].tabIndex=-1),W=t,j=n,e.tabIndex=0),Ce(t,n)}}function Pe(e,t,n){e.onkeydown=o=>{if(o.key==="ArrowUp")o.preventDefault(),we(t-1,n);else if(o.key==="ArrowDown")o.preventDefault(),we(t+1,n);else if(o.key==="ArrowLeft")o.preventDefault(),we(t,n-1);else if(o.key==="ArrowRight")o.preventDefault(),we(t,n+1);else if(o.key==="Enter"||o.key===" "){o.preventDefault();const i=K();i&&i.beginAction("fill"),ge(t,n,d,!Z),i&&i.commitAction(),fe()}else if(o.key==="x"||o.key==="X"){o.preventDefault(),o.stopPropagation();const i=K();i&&i.beginAction("fill"),ge(t,n,0,!Z),i&&i.commitAction(),fe()}}}function Ne(e,t,n=!1){const o=K();o&&o.beginAction("fill"),N=!0,A=n?0:d,ne=!Z,ge(e,t,A,ne);const i=m(e,t);A=i.value,ne=i.certain}function _e(e=!0){if(!N)return;N=!1,A=null;const t=K();t&&(e?t.commitAction():t.cancelAction()),fe()}function Qe(e,t,n){e.onmousedown=o=>{o.preventDefault(),e.focus(),Ne(t,n,o.button===2)},e.onmouseenter=()=>{Ce(t,n),N&&ge(t,n,A,ne,!0)},e.oncontextmenu=o=>{o.preventDefault()}}function Ge(e,t,n){let o=null,i=0,r=!1,c=t,k=n;e.ontouchstart=E=>{var ae,he;if(E.touches.length>1)return;if(E.preventDefault(),E.stopPropagation(),r=!1,i=Date.now(),c=t,k=n,window.Cozy.Zoom){const Ee=(he=(ae=E.touches[0])==null?void 0:ae.clientY)!=null?he:0;window.Cozy.Zoom.onCellTouchStart(t,n,Ee)}const X=K();X&&X.beginAction("fill"),N=!0,A=d,ne=!Z,o=setTimeout(()=>{if(!r){A=0,ge(c,k,0,ne);const Ee=m(c,k);A=Ee.value,ne=Ee.certain,window.Cozy.App&&window.Cozy.App.vibrate(50)}},H.LONG_PRESS_DELAY),ge(t,n,A,ne);const te=m(t,n);A=te.value,ne=te.certain},e.ontouchmove=E=>{if(E.touches.length>1||!N)return;E.preventDefault(),E.stopPropagation(),r=!0,clearTimeout(o);const X=E.touches[0],te=document.elementFromPoint(X.clientX,X.clientY);if(te&&te.classList.contains("cell")){const ae=parseInt(te.dataset.row),he=parseInt(te.dataset.col);!isNaN(ae)&&!isNaN(he)&&(ge(ae,he,A,ne,!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchMove(ae,he))}},e.ontouchend=()=>{clearTimeout(o),_e(!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()},e.ontouchcancel=()=>{clearTimeout(o),_e(!1),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()}}function Fe(e){const t=document.getElementById("grid");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,t.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,se&&t.removeEventListener("mouseleave",se),ee&&t.removeEventListener("focusout",ee),F&&document.removeEventListener("mouseup",F),G=[];for(let n=0;n<e.height;n++)G[n]=[];se=()=>ve(),t.addEventListener("mouseleave",se),ee=n=>{t.contains(n.relatedTarget)||ve()},t.addEventListener("focusout",ee);for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=Ae(n,o);ke(i,n,o),Pe(i,n,o),Qe(i,n,o),Ge(i,n,o),G[n][o]=i,t.appendChild(i)}F=()=>_e(!0),document.addEventListener("mouseup",F)}function ge(e,t,n,o,i){const r=l()[C],c=m(e,t),k=K();let E=n,X=o;i||(o&&!c.certain&&c.value===n&&n!==null?(E=c.value,X=!0):c.value===n&&c.certain===o&&n!==null&&(E=null,X=!0)),!(c.value===E&&c.certain===X)&&(k&&k.recordChange(e,t,c,{value:E,certain:X}),y(e,t,E,X),be(e,t,r),window.Cozy.App&&window.Cozy.App.vibrate(10),Me(r),ze(),et(r),Se())}function be(e,t,n){var c,k;const o=(c=G[e])==null?void 0:c[t];if(!o)return;const i=m(e,t);if(o.classList.remove("marked-empty","maybe-empty","maybe-color"),o.style.background="",o.style.setProperty("--cell-color",""),o.style.setProperty("--fold-outline-color",""),i.value===null)o.style.background="var(--color-cell)";else if(i.value===0)i.certain?o.classList.add("marked-empty"):o.classList.add("maybe-empty");else{const E=n.color_map[i.value];if(E){const X=`rgb(${E[0]}, ${E[1]}, ${E[2]})`;if(i.certain)o.style.background=X;else{o.classList.add("maybe-color"),o.style.setProperty("--cell-color",X);const ae=$(E)>H.BRIGHTNESS_MIDPOINT?"rgba(0, 0, 0, 0.6)":"rgba(255, 255, 255, 0.7)";o.style.setProperty("--fold-outline-color",ae)}}}let r;if(i.value===null)r="empty";else if(i.value===0)r=i.certain?"marked empty":"maybe empty";else{const E=((k=n.color_names)==null?void 0:k[i.value-1])||`color ${i.value}`;r=i.certain?E:`maybe ${E}`}o.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}, ${r}`)}function qe(e){const t=[];let n=null,o=0;for(const i of e)i>0?i===n?o++:(n!==null&&t.push({count:o,color:n}),n=i,o=1):n!==null&&(t.push({count:o,color:n}),n=null,o=0);return n!==null&&t.push({count:o,color:n}),t}function Xe(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n].count!==t[n].count||e[n].color!==t[n].color)return!1;return!0}function Me(e){for(let t=0;t<e.height;t++){const n=[];for(let E=0;E<e.width;E++){const X=m(t,E);X.certain?n.push(X.value===null?0:X.value):n.push(-1)}const o=n.includes(-1),i=n.map(E=>E===-1?0:E),r=qe(i),c=!o&&Xe(r,e.row_clues[t]),k=V[t];k&&k.classList.toggle("satisfied",c),c!==J[t]&&(J[t]=c,pe(c?`Row ${t+1} complete`:`Row ${t+1} incomplete`))}for(let t=0;t<e.width;t++){const n=[];for(let E=0;E<e.height;E++){const X=m(E,t);X.certain?n.push(X.value===null?0:X.value):n.push(-1)}const o=n.includes(-1),i=n.map(E=>E===-1?0:E),r=qe(i),c=!o&&Xe(r,e.col_clues[t]),k=le[t];k&&k.classList.toggle("satisfied",c),c!==me[t]&&(me[t]=c,pe(c?`Column ${t+1} complete`:`Column ${t+1} incomplete`))}}function et(e){for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++)if(!m(o,i).certain)return;for(let o=0;o<e.height;o++){const i=[];for(let c=0;c<e.width;c++){const k=m(o,c);i.push(k.value===null?0:k.value)}const r=qe(i);if(!Xe(r,e.row_clues[o]))return}for(let o=0;o<e.width;o++){const i=[];for(let c=0;c<e.height;c++){const k=m(c,o);i.push(k.value===null?0:k.value)}const r=qe(i);if(!Xe(r,e.col_clues[o]))return}pe("Puzzle complete!"),window.Cozy.App&&window.Cozy.App.vibrate([50,100,50]);const t=Q();if(t){const o=S(e);t.completePuzzle(o),je(),u();const i=window.Cozy.Collection;i&&i.refresh()}const n=K();n&&n.clear(),ft(e)}function nt(){const e=l()[C];if(!e)return;const t=K(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const r=m(o,i);r.value!==null&&(n.push({row:o,col:i,before:{value:r.value,certain:r.certain},after:{value:null,certain:!0}}),r.value=null,r.certain=!0,be(o,i,e))}if(n.length>0){t&&t.recordBatchAction("reset",n),Me(e);const o=Q();if(o){const i=S(e);o.savePuzzleGrid(i,null)}fe()}ze()}function ot(){const e=l()[C];if(!e)return;window.Cozy.Zoom&&window.Cozy.Zoom.zoomToFit();const t=K(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const r=m(o,i),c=e.solution[o][i];(r.value!==c||!r.certain)&&n.push({row:o,col:i,before:{value:r.value,certain:r.certain},after:{value:c,certain:!0}}),r.value=c,r.certain=!0,be(o,i,e)}n.length>0&&t&&t.recordBatchAction("solution",n),Me(e),h("Solution revealed","info"),fe(),ze()}function ct(){document.addEventListener("keydown",e=>{var t,n,o;if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")){if((e.ctrlKey||e.metaKey)&&e.key==="z"&&!e.shiftKey&&(e.preventDefault(),Oe()),((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key==="z"||(e.ctrlKey||e.metaKey)&&e.key==="y")&&(e.preventDefault(),De()),e.key==="p"&&!e.ctrlKey&&!e.metaKey&&(e.preventDefault(),He()),e.key>="1"&&e.key<="9"&&!e.ctrlKey&&!e.metaKey){const i=parseInt(e.key),r=l()[C],c=Object.keys(r.color_map).map(Number);i<=c.length&&Y(c[i-1])}if((e.key==="0"||e.key==="x")&&!e.ctrlKey&&!e.metaKey&&Y(0),e.key==="Escape"&&!e.ctrlKey&&!e.metaKey){const i=document.getElementById("help-modal"),r=i==null?void 0:i.classList.contains("visible");((t=window.Cozy.Screens)==null?void 0:t.getCurrentScreen())===((o=(n=window.Cozy.Screens)==null?void 0:n.SCREENS)==null?void 0:o.PUZZLE)&&!r&&(e.preventDefault(),xe())}}})}function tt(){const e=l(),t=Q();if(s.length>0&&e[C]&&t){const n=S(e[C]);t.savePuzzleGrid(n,s)}}function xe(){tt(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION)}function at(e){window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:e})}function ut(e){const t=e.detail||{},n=l();let o=0;t.puzzleId!==void 0&&(o=t.puzzleId,typeof t.puzzleId=="string"&&(o=n.findIndex(i=>S(i)===t.puzzleId),o===-1&&(o=0))),T(o)}function dt(e){tt();const t=e.detail||{},n=window.Cozy.Collection;n&&(t.animateStamp&&t.scrollToPuzzleId?n.refresh({blankPuzzleId:t.scrollToPuzzleId}):n.refresh(),t.scrollToPuzzleId&&setTimeout(()=>{n.scrollToPuzzle(t.scrollToPuzzleId,{instant:t.quickAnimation}),t.animateStamp&&t.flyingStamp&&n.animateStampTo(t.scrollToPuzzleId,t.flyingStamp,{quick:t.quickAnimation})},50))}function ft(e){if(window.Cozy.Screens){const t=S(e),n=e.title.match(/^(.+?)\s*\(/),o=n?n[1].trim():e.title;window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.VICTORY,{puzzleId:t,puzzleName:o,solution:e.solution,palette:e.color_map})}}function ht(){const e=document.getElementById("current-puzzle-title");if(!e)return;const n=l()[C];if(n){const o=n.title.match(/^(.+?)\s*\(/);e.textContent=o?o[1].trim():n.title}}const it=1200;function st(e,t){if(!e)return;let n=null,o=!1;function i(c){c.type==="touchstart"&&c.preventDefault(),!e.disabled&&(o||(o=!0,e.classList.add("holding"),pe("Holding, keep holding to confirm"),n=setTimeout(()=>{o&&(e.classList.add("hold-complete"),r(),window.Cozy.App&&window.Cozy.App.vibrate(50),pe("Confirmed"),t(),setTimeout(()=>e.classList.remove("hold-complete"),50))},it)))}function r(){o=!1,e.classList.remove("holding"),n&&(clearTimeout(n),n=null)}e.addEventListener("mousedown",i),e.addEventListener("mouseup",r),e.addEventListener("mouseleave",r),e.addEventListener("touchstart",i,{passive:!1}),e.addEventListener("touchend",r),e.addEventListener("touchcancel",r),e.addEventListener("keydown",c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),i(c))}),e.addEventListener("keyup",c=>{(c.key==="Enter"||c.key===" ")&&r()}),e.addEventListener("blur",r),e.style.setProperty("--hold-duration",`${it}ms`)}function mt(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("undo-btn"),o=document.getElementById("redo-btn");e&&e.addEventListener("click",()=>Te(!1)),t&&t.addEventListener("click",()=>Te(!0)),n&&n.addEventListener("click",Oe),o&&o.addEventListener("click",De);const i=document.getElementById("clear-pencil-btn"),r=document.getElementById("confirm-pencil-btn");i&&i.addEventListener("click",()=>{Ue(),Le()}),r&&r.addEventListener("click",()=>{$e(),Le()});const c=document.getElementById("reset-btn"),k=document.getElementById("solution-btn");st(c,nt),st(k,ot);const E=document.querySelector("#screen-puzzle .header-back-btn");E&&E.addEventListener("click",rt);const X=document.querySelector("#screen-collection .header-back-btn");X&&X.addEventListener("click",()=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.HOME)})}function lt(){ct(),mt(),g(),I();const e=K();e&&e.updateUI(),Be();const t=Q();t&&t.onChange&&t.onChange(i=>{i==="reset"&&(s=[],C=0)});const n=window.Cozy.Collection,o=l();n&&o.length>0&&n.init("collection-screen",o,i=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:i})}),window.addEventListener("screen:puzzle",ut),window.addEventListener("screen:collection",dt),o.length>0&&T(0)}function pt(){const t=l()[C];if(!t||s.length===0)return null;let n=!1;for(let o=0;o<t.height&&!n;o++)for(let i=0;i<t.width&&!n;i++){const r=m(o,i);r.value!==null&&r.value>0&&(n=!0)}return n?D(t.width,t.height,H.STAMP_CANVAS_SIZE,(o,i)=>{const r=m(o,i);if(r.value!==null&&r.value>0){const c=t.color_map[r.value];if(c)return c}return null}):null}function rt(){const t=l()[C];if(!t){xe();return}const n=S(t),o=pt();if(!o){xe();return}const i=document.getElementById("grid");if(!i){xe();return}const r=i.getBoundingClientRect(),c=U(o,r);tt(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION,{scrollToPuzzleId:n,animateStamp:!0,flyingStamp:c,quickAnimation:!0})}function gt(){s=[],C=0,d=1,N=!1,A=null,Z=!1;const e=K();e&&e.clear()}function yt(e,t){const o=l()[C];if(!o)return null;const i=V[e],r=i?i.classList.contains("satisfied"):!1,c=o.row_clues[e].map(te=>({count:te.count,color:te.color,satisfied:r})),k=le[t],E=k?k.classList.contains("satisfied"):!1,X=o.col_clues[t].map(te=>({count:te.count,color:te.color,satisfied:E}));return{rowClues:c,colClues:X}}function wt(e){const n=l()[C];return!n||!n.color_map?null:n.color_map[e]||null}function zt(){return l()[C]||null}window.Cozy.Garden={resetPuzzle:nt,showSolution:ot,performUndo:Oe,performRedo:De,togglePencilMode:He,setPencilMode:Te,clearAllPencilMarks:Ue,confirmAllPencilMarks:$e,selectColor:Y,showCollection:xe,showGame:at,clearAllState:gt,navigateToCollectionWithStamp:rt,getPuzzleId:S,getClueInfo:yt,getColorRgb:wt,getCurrentPuzzle:zt},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",lt):lt()}(),function(){"use strict";const{CONFIG:H}=window.Cozy.Utils,S=.35,q=1,U=.97,D=300,C=1500,P=100,d=10;let s=q,N=q,A=!1,ne=0,Z=0,ie=null,W=null,j=null,F=!1,se=-1,ee=-1,G=!1,V=null,le=null,J=null,me=null,z=null,h=null,f=null,b=null;function p(u,T,x){return Math.min(Math.max(u,T),x)}function w(u,T){const x=u.clientX-T.clientX,Y=u.clientY-T.clientY;return Math.sqrt(x*x+Y*Y)}function M(u,T){return{x:(u.clientX+T.clientX)/2,y:(u.clientY+T.clientY)/2}}function g(){const u=window.innerWidth;return u<=360?20:u>=768?28:u>=1200?32:24}function I(u,T=!0){const x=V;if(!x)return;const Y=s,oe=a(),ce=p(u,oe,H.MAX_ZOOM);let re,de;T&&Y!==ce&&(re=x.scrollLeft+x.clientWidth/2,de=x.scrollTop+x.clientHeight/2),s=ce;const Ce=g(),ve=Math.round(Ce*ce);document.documentElement.style.setProperty("--cell-size",`${ve}px`);const we=B(),Ae=ce>we+.01;x.classList.toggle("is-zoomed",Ae),L(),T&&Y!==ce&&re!==void 0&&requestAnimationFrame(()=>{const ke=ce/Y,Pe=re*ke-x.clientWidth/2,Ne=de*ke-x.clientHeight/2;x.scrollLeft=Math.max(0,Pe),x.scrollTop=Math.max(0,Ne)}),window.dispatchEvent(new CustomEvent("zoomchange",{detail:{zoom:ce,oldZoom:Y,isZoomed:Ae}}))}function L(){const u=a();if(h&&(h.disabled=s>=H.MAX_ZOOM),f&&(f.disabled=s<=u),b){const T=B(),x=Math.abs(s-T)<.05;b.classList.toggle("highlighted",!x&&s!==T)}}let O=null,_=null;function B(u=!1){var Fe;const T=V;if(!T||!((Fe=window.Cozy.Garden)!=null&&Fe.getCurrentPuzzle))return q;const x=window.Cozy.Garden.getCurrentPuzzle();if(!x)return q;const Y=x.title;if(!u&&O!==null&&_===Y)return O;const oe=g(),ce=Math.max(...x.row_clues.map(ge=>ge.length)),re=Math.max(...x.col_clues.map(ge=>ge.length)),de=Math.max(2,ce*.6+.5),Ce=Math.max(2,re*.6+.5),ve=x.width+de+.25,we=x.height+Ce+.25,Ae=T.clientWidth,ke=T.clientHeight,Pe=8,Ne=(Ae-Pe*2)/(ve*oe),_e=(ke-Pe*2)/(we*oe),Qe=Math.min(Ne,_e),Ge=p(Qe*U,S,H.MAX_ZOOM);return O=Ge,_=Y,Ge}function l(){O=null,_=null}function a(){const u=B();return Math.max(S,u)}function m(){const u=B();return s>u+.01}function y(u){u.touches.length===2&&(A=!0,ne=w(u.touches[0],u.touches[1]),N=s,u.preventDefault())}function v(u){if(A&&u.touches.length===2){const x=w(u.touches[0],u.touches[1])/ne,Y=a(),oe=p(N*x,Y,H.MAX_ZOOM);Math.abs(oe-s)>.05&&I(oe,!0),u.preventDefault()}}function $(u){if(A&&u.touches.length<2&&(A=!1),u.touches.length===0&&!A){const T=u.target;if(!T.classList.contains("cell")){const Y=Date.now();ie===T&&Y-Z<D?(R(u.changedTouches[0]),Z=0,ie=null):(Z=Y,ie=T)}}}function R(u){m()?I(B(),!0):I(H.COMFORTABLE_ZOOM,!0)}function Q(u){if(u.ctrlKey){u.preventDefault();const T=u.deltaY>0?-.15:.15;I(s+T,!0)}}function K(){J&&m()&&J.classList.add("visible")}function Ie(){J&&(J.classList.remove("visible"),se=-1,ee=-1)}function Ve(u,T){var Y,oe;if(!J||F||u===se&&T===ee)return;se=u,ee=T;const x=(oe=(Y=window.Cozy.Garden)==null?void 0:Y.getClueInfo)==null?void 0:oe.call(Y,u,T);x&&(me&&(me.innerHTML=ze(x.rowClues)),z&&(z.innerHTML=ze(x.colClues)))}function ze(u){return!u||u.length===0?'<span class="clue-tooltip-num satisfied">0</span>':u.map(T=>{var re,de;const x=((de=(re=window.Cozy.Garden)==null?void 0:re.getColorRgb)==null?void 0:de.call(re,T.color))||[128,128,128],Y=T.satisfied,ce=(x[0]*299+x[1]*587+x[2]*114)/1e3>H.BRIGHTNESS_MIDPOINT?"#333":"#fff";return`<span class="clue-tooltip-num${Y?" satisfied":""}"
                    style="background: rgb(${x.join(",")}); color: ${ce}">
                ${T.count}
              </span>`}).join("")}function pe(u){if(!J||!V)return;const T=V.getBoundingClientRect(),x=T.top+T.height/2;u>x?(J.classList.add("position-top"),J.classList.remove("position-bottom")):(J.classList.remove("position-top"),J.classList.add("position-bottom"))}function Te(){clearTimeout(W),W=setTimeout(()=>{Ie()},C)}function He(){clearTimeout(W)}function Be(u,T,x){m()&&(F=!1,He(),clearTimeout(j),j=setTimeout(()=>{Ve(u,T),pe(x),K()},P))}function Ye(){m()&&(F=!0,J==null||J.classList.add("dragging"))}function Ke(){m()&&(clearTimeout(j),F=!1,J==null||J.classList.remove("dragging"),Te())}function Le(){h=document.querySelector(".zoom-btn.zoom-in"),f=document.querySelector(".zoom-btn.zoom-out"),b=document.querySelector(".zoom-btn.zoom-fit"),h&&h.addEventListener("click",()=>{I(s+.5,!0)}),f&&f.addEventListener("click",()=>{I(s-.5,!0)}),b&&b.addEventListener("click",()=>{I(B(),!0)}),L()}function Ze(u){const T=document.getElementById("screen-puzzle");!T||T.classList.contains("screen-hidden")||(u.key==="+"||u.key==="="?(u.preventDefault(),I(s+.5,!0)):u.key==="-"||u.key==="_"?(u.preventDefault(),I(s-.5,!0)):u.key==="0"&&(u.preventDefault(),I(B(),!0)))}let Re=null;function We(){clearTimeout(Re),Re=setTimeout(()=>{const u=document.getElementById("screen-puzzle");if(!u||u.classList.contains("screen-hidden"))return;l();const T=a();s<T&&I(T,!1),L()},150)}function fe(){var T,x,Y,oe;const u=(x=(T=window.Cozy.Garden)==null?void 0:T.getCurrentPuzzle)==null?void 0:x.call(T);u&&(u.width<=H.AUTO_ZOOM_MIN_SIZE&&u.height<=H.AUTO_ZOOM_MIN_SIZE||(Y=window.Cozy.Storage)!=null&&Y.getFlag("zoomHintShown")||(Ue(),(oe=window.Cozy.Storage)==null||oe.setFlag("zoomHintShown",!0)))}function Ue(){let u=document.getElementById("zoom-hint-toast");u||(u=document.createElement("div"),u.id="zoom-hint-toast",u.className="zoom-hint-toast",u.textContent="Tip: Pinch to zoom for easier tapping",document.body.appendChild(u)),u.classList.add("visible"),setTimeout(()=>{u.classList.remove("visible")},4e3)}function $e(){if(!G){if(V=document.getElementById("zoom-container"),le=V==null?void 0:V.querySelector(".board-wrapper"),J=document.getElementById("clue-tooltip"),me=document.getElementById("tooltip-row-clues"),z=document.getElementById("tooltip-col-clues"),!V){console.warn("[Zoom] zoom-container not found, zoom disabled");return}V.addEventListener("touchstart",y,{passive:!1}),V.addEventListener("touchmove",v,{passive:!1}),V.addEventListener("touchend",$,{passive:!0}),V.addEventListener("wheel",Q,{passive:!1}),Le(),document.addEventListener("keydown",Ze),window.addEventListener("resize",We),G=!0,console.log("[Zoom] Initialized")}}function Oe(){l();const u=B();I(u,!1),setTimeout(fe,500)}function De(){Se(!1),Ie(),clearTimeout(W),clearTimeout(j)}function Se(u=!0){Je(q,u)}function je(u=!0){const T=B();Je(T,u)}function Je(u,T=!0){if(T&&s!==u){let ce=function(re){const de=re-oe,Ce=Math.min(de/Y,1),ve=1-Math.pow(1-Ce,3),we=x+(u-x)*ve;I(we,!1),Ce<1&&requestAnimationFrame(ce)};const x=s,Y=200,oe=performance.now();requestAnimationFrame(ce)}else I(u,!1)}window.Cozy.Zoom={init:$e,initForPuzzle:Oe,destroy:De,resetZoom:Se,zoomToFit:je,getZoom:()=>s,setZoom:(u,T=!0)=>I(u,!T),zoomIn:(u=.5)=>I(s+u,!0),zoomOut:(u=.5)=>I(s-u,!0),isZoomed:m,onCellTouchStart:Be,onCellTouchMove:Ye,onCellTouchEnd:Ke,getEffectiveMinZoom:a}}();

//# sourceMappingURL=app.min.js.map