(function(){"use strict";const U={STAMP_CANVAS_SIZE:180,VICTORY_CANVAS_SIZE:180,MINI_CANVAS_SIZE:80,OUTLINE_THICKNESS:2,MAX_PUZZLE_DIMENSION:32,MAX_HISTORY:50,MAX_SCREEN_HISTORY:10,MAX_SEARCH_LENGTH:100,TOAST_DURATION:2500,LONG_PRESS_DELAY:400,SEARCH_DEBOUNCE:150,MAX_ZOOM:3,COMFORTABLE_ZOOM:2,AUTO_ZOOM_MIN_SIZE:10,BRIGHTNESS_MIDPOINT:128,BADGE_MAX_DISPLAY:99};function I(A){return(A.t||A.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"")}function V(A){return A.t||A.title}function F(A){const E=A.match(/^(.+?)\s*\((\d+)x(\d+),\s*(\w+)\)$/i);return E?{name:E[1].trim(),width:parseInt(E[2],10),height:parseInt(E[3],10),difficulty:E[4].toLowerCase()}:{name:A,width:0,height:0,difficulty:"unknown"}}function N(A,E,te,j={}){return!A||A.hasAttribute("data-initialized")?!1:(A.addEventListener(E,te,j),A.setAttribute("data-initialized","true"),!0)}function C(A,E,te={}){const j=document.createElement("canvas");j.width=A.width,j.height=A.height,j.getContext("2d").drawImage(A,0,0);const Z=A.width/A.height,ee=E.width/E.height;let X,oe;if(te.useScale){X=A.width,oe=A.height;const a=Math.min(E.width,E.height),m=(Z>1?a:a*Z)/X;j.style.transform="scale("+m+")"}else Z>ee?(X=E.width,oe=E.width/Z):(oe=E.height,X=E.height*Z);const g=E.left+E.width/2,d=E.top+E.height/2;return j.className="flying-stamp",j.style.left=g-X/2+"px",j.style.top=d-oe/2+"px",j.style.width=X+"px",j.style.height=oe+"px",document.body.appendChild(j),j}function B(A,E,te,j){const K=Math.max(A,E),Z=Math.max(2,Math.floor(te/K)),ee=U.OUTLINE_THICKNESS*2,X=U.OUTLINE_THICKNESS,oe=document.createElement("canvas");oe.width=A*Z+ee,oe.height=E*Z+ee;const g=oe.getContext("2d");if(!g)return console.warn("[Utils] Failed to get 2D context for canvas"),oe;try{const d=getComputedStyle(document.documentElement).getPropertyValue("--color-text-muted").trim()||"#8a8a7a";g.fillStyle=d;for(let a=0;a<E;a++)for(let z=0;z<A;z++)if(j(a,z)){const y=X+z*Z,P=X+a*Z;g.fillRect(y-U.OUTLINE_THICKNESS,P-U.OUTLINE_THICKNESS,Z+ee,Z+ee)}for(let a=0;a<E;a++)for(let z=0;z<A;z++){const m=j(a,z);if(m){g.fillStyle=`rgb(${m[0]}, ${m[1]}, ${m[2]})`;const y=X+z*Z,P=X+a*Z;g.fillRect(y,P,Z,Z)}}}catch(d){console.error("[Utils] Failed to render canvas:",d)}return oe}const b=[[.31399022,.63951294,.04649755],[.15537241,.75789446,.08670142],[.01775239,.10944209,.87256922]],c=[[5.47221206,-4.6419601,.16963708],[-1.1252419,2.29317094,-.1678952],[.02980165,-.19318073,1.16364789]],H={protanopia:[[0,1.05118294,-.05116099],[0,1,0],[0,0,1]],deuteranopia:[[1,0,0],[.9513092,0,.04866992],[0,0,1]],tritanopia:[[1,0,0],[0,1,0],[-.86744736,1.86727089,0]]};function q(A,E){return[A[0][0]*E[0]+A[0][1]*E[1]+A[0][2]*E[2],A[1][0]*E[0]+A[1][1]*E[1]+A[1][2]*E[2],A[2][0]*E[0]+A[2][1]*E[1]+A[2][2]*E[2]]}function ie(A){return Math.max(0,Math.min(255,Math.round(A)))}function Q(A,E){if(!E||E==="off"||!H[E])return A;const te=[A[0]/255,A[1]/255,A[2]/255],j=q(b,te),K=q(H[E],j),Z=q(c,K),ee=[te[0]-Z[0],te[1]-Z[1],te[2]-Z[2]];let X;return E==="tritanopia"?X=[ee[2]*.7,ee[2]*.7,0]:X=[0,ee[0]*.7+ee[1]*.7,ee[0]*.7+ee[1]*.7],[ie((te[0]+X[0])*255),ie((te[1]+X[1])*255),ie((te[2]+X[2])*255)]}function ce(){return window.Cozy.Storage&&window.Cozy.Storage.getSetting("colorblindMode")||"off"}function se(A){const E=ce();return Q(A,E)}window.Cozy=window.Cozy||{},window.Cozy.Utils={CONFIG:U,getPuzzleId:I,getPuzzleTitle:V,parsePuzzleTitle:F,initOnce:N,createFlyingStamp:C,renderOutlinedCanvas:B,daltonize:Q,getColorblindMode:ce,getDisplayColor:se}})(),function(){"use strict";const U="cozy_garden_data";function V(B){return!(!B||typeof B!="object"||typeof B.version!="number"||B.progress!==null&&typeof B.progress!="object"||B.settings!==null&&typeof B.settings!="object"||B.stats!==null&&typeof B.stats!="object")}function F(){return{version:1,progress:{},settings:{vibration:!0,theme:"light",colorblindMode:"off"},stats:{totalCompleted:0,totalAttempts:0,totalPlayTime:0,streak:0,lastPlayDate:null},currentSession:{puzzleIndex:0,difficulty:"easy",grid:null,startTime:null},flags:{tutorialCompleted:!1,helpShown:!1,zoomHintShown:!1},uiState:{collapsedSections:[]}}}class N{constructor(){this.data=null,this.listeners=[]}init(){try{const b=localStorage.getItem(U);if(b){const c=JSON.parse(b);V(c)?this.data=c:(console.warn("[Storage] Invalid data structure, using defaults"),this.data=F(),this.save())}else this.data=F(),this.save()}catch(b){console.warn("[Storage] Failed to load, using defaults:",b),this.data=F(),this.save()}return this}save(){try{return localStorage.setItem(U,JSON.stringify(this.data)),this.notifyListeners("save"),!0}catch(b){return console.error("[Storage] Failed to save:",b),!1}}onChange(b){return this.listeners.push(b),()=>{this.listeners=this.listeners.filter(c=>c!==b)}}notifyListeners(b){this.listeners.forEach(c=>c(b,this.data))}getPuzzleProgress(b){return this.data.progress[b]||{completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}}savePuzzleGrid(b,c){this.data.progress||(this.data.progress={}),this.data.progress[b]||(this.data.progress[b]={completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}),c?this.data.progress[b].savedGrid=c.map(H=>H.map(q=>({value:q.value,certain:q.certain}))):this.data.progress[b].savedGrid=null,this.save()}getPuzzleGrid(b){if(!this.data.progress)return null;const c=this.data.progress[b];return!c||!c.savedGrid?null:c.savedGrid.map(H=>H.map(q=>({value:q.value,certain:q.certain})))}completePuzzle(b){const c=this.getPuzzleProgress(b),H=!c.completed;return c.completed=!0,c.attempts+=1,c.lastPlayed=Date.now(),c.savedGrid=null,this.data.progress[b]=c,H&&(this.data.stats.totalCompleted+=1),this.data.stats.totalAttempts+=1,this.updateStreak(),this.save(),{wasNew:H,progress:c}}isPuzzleCompleted(b){var c;return((c=this.data.progress[b])==null?void 0:c.completed)||!1}getCompletionStats(){return{easy:{completed:0,total:0},medium:{completed:0,total:0},hard:{completed:0,total:0},challenging:{completed:0,total:0},expert:{completed:0,total:0}}}saveSession(b,c,H){let q=null;H&&(q=H.map(ie=>ie.map(Q=>({value:Q.value,certain:Q.certain})))),this.data.currentSession={puzzleIndex:b,difficulty:c,grid:q},this.save()}getSession(){return this.data.currentSession}clearSession(){this.data.currentSession={puzzleIndex:0,difficulty:"easy",grid:null},this.save()}getSetting(b){return this.data.settings[b]}setSetting(b,c){this.data.settings[b]=c,this.save(),this.notifyListeners("settings")}getSettings(){return{...this.data.settings}}getStats(){return{...this.data.stats}}addPlayTime(b){this.data.stats.totalPlayTime+=b,this.save()}updateStreak(){const b=new Date().toDateString(),c=this.data.stats.lastPlayDate;if(c===b)return;const H=new Date(Date.now()-864e5).toDateString();c===H?this.data.stats.streak+=1:c!==b&&(this.data.stats.streak=1),this.data.stats.lastPlayDate=b}getFlag(b){var c;return((c=this.data.flags)==null?void 0:c[b])||!1}setFlag(b,c=!0){this.data.flags||(this.data.flags={}),this.data.flags[b]=c,this.save()}getUIState(b){var c;return(c=this.data.uiState)==null?void 0:c[b]}setUIState(b,c){this.data.uiState||(this.data.uiState={}),this.data.uiState[b]=c,this.save()}exportData(){return JSON.stringify(this.data,null,2)}importData(b){try{const c=JSON.parse(b);return V(c)?(this.data=c,this.save(),!0):!1}catch(c){return console.error("[Storage] Import failed:",c),!1}}reset(){this.data=F(),this.save(),this.notifyListeners("reset")}}const C=new N().init();window.Cozy.Storage=C}(),function(){"use strict";const{CONFIG:U}=window.Cozy.Utils;let I=[],V=[],F=null;const N={beginAction(C="fill"){F&&F.changes.length>0&&this.commitAction(),F={type:C,changes:[],timestamp:Date.now()}},recordChange(C,B,b,c){if(b.value===c.value&&b.certain===c.certain)return;F||this.beginAction("fill");const H=F.changes.find(q=>q.row===C&&q.col===B);H?H.after={value:c.value,certain:c.certain}:F.changes.push({row:C,col:B,before:{value:b.value,certain:b.certain},after:{value:c.value,certain:c.certain}})},commitAction(){F&&F.changes.length>0&&(F.changes=F.changes.filter(C=>C.before.value!==C.after.value||C.before.certain!==C.after.certain),F.changes.length>0&&(I.push(F),I.length>U.MAX_HISTORY&&I.shift(),V=[]),this.updateUI()),F=null},cancelAction(){F=null},recordBatchAction(C,B){if(B.length===0)return;const b={type:C,changes:B.map(c=>({row:c.row,col:c.col,before:{value:c.before.value,certain:c.before.certain},after:{value:c.after.value,certain:c.after.certain}})),timestamp:Date.now()};I.push(b),I.length>U.MAX_HISTORY&&I.shift(),V=[],this.updateUI()},undo(){if(I.length===0)return null;const C=I.pop();return V.push(C),this.updateUI(),C.changes.map(B=>({row:B.row,col:B.col,state:{value:B.before.value,certain:B.before.certain}}))},redo(){if(V.length===0)return null;const C=V.pop();return I.push(C),this.updateUI(),C.changes.map(B=>({row:B.row,col:B.col,state:{value:B.after.value,certain:B.after.certain}}))},canUndo(){return I.length>0},canRedo(){return V.length>0},clear(){I=[],V=[],F=null,this.updateUI()},updateUI(){const C=document.getElementById("undo-btn"),B=document.getElementById("redo-btn");C&&(C.disabled=!this.canUndo()),B&&(B.disabled=!this.canRedo())},getStats(){return{undoDepth:I.length,redoDepth:V.length,hasPending:F!==null,pendingChanges:F?F.changes.length:0}}};window.Cozy.History=N}();const ScreenManager=function(){"use strict";const{CONFIG:U,initOnce:I,createFlyingStamp:V,renderOutlinedCanvas:F}=window.Cozy.Utils,N={SPLASH:"splash",HOME:"home",COLLECTION:"collection",PUZZLE:"puzzle",VICTORY:"victory",SETTINGS:"settings",TUTORIAL:"tutorial"};let C=null,B=[],b={},c={},H=null;function q(l){const u=document.getElementById("confirm-modal"),h=document.getElementById("confirm-modal-title"),S=document.getElementById("confirm-modal-message"),p=document.getElementById("confirm-modal-confirm"),$=document.getElementById("confirm-modal-cancel");u&&(h.textContent=l.title||"Confirm",S.textContent=l.message||"Are you sure?",p.textContent=l.confirmText||"Confirm",$.textContent=l.cancelText||"Cancel",p.classList.toggle("confirm-modal-btn-danger",!!l.danger),p.classList.toggle("confirm-modal-btn-primary",!l.danger),u.classList.remove("alert-mode"),H=l,u.classList.add("visible"),setTimeout(()=>p.focus(),100))}function ie(l){const u=document.getElementById("confirm-modal"),h=document.getElementById("confirm-modal-title"),S=document.getElementById("confirm-modal-message"),p=document.getElementById("confirm-modal-confirm");u&&(h.textContent=l.title||"Notice",S.textContent=l.message||"",p.textContent=l.buttonText||"OK",p.classList.remove("confirm-modal-btn-danger"),p.classList.add("confirm-modal-btn-primary"),u.classList.add("alert-mode"),H={onConfirm:l.onClose},u.classList.add("visible"),setTimeout(()=>p.focus(),100))}function Q(){const l=document.getElementById("confirm-modal");l&&l.classList.remove("visible"),H=null}function ce(){const l=document.getElementById("confirm-modal"),u=l==null?void 0:l.querySelector(".confirm-modal-backdrop"),h=document.getElementById("confirm-modal-confirm"),S=document.getElementById("confirm-modal-cancel");l&&(h==null||h.addEventListener("click",()=>{const p=H==null?void 0:H.onConfirm;Q(),p&&setTimeout(p,200)}),S==null||S.addEventListener("click",()=>{const p=H==null?void 0:H.onCancel;Q(),p&&p()}),u==null||u.addEventListener("click",()=>{const p=H==null?void 0:H.onCancel;Q(),p&&p()}),document.addEventListener("keydown",p=>{if(p.key==="Escape"&&l.classList.contains("visible")){const $=H==null?void 0:H.onCancel;Q(),$&&$()}if(p.key==="Tab"&&l.classList.contains("visible")){const G=l.classList.contains("alert-mode")?[h]:[S,h],ne=G[0],W=G[G.length-1];G.includes(document.activeElement)?p.shiftKey?document.activeElement===ne&&(p.preventDefault(),W.focus()):document.activeElement===W&&(p.preventDefault(),ne.focus()):(p.preventDefault(),ne.focus())}}))}function se(){D(),ce(),Object.values(N).forEach(l=>{const u=document.getElementById(`screen-${l}`);c[l]=u,u&&u.setAttribute("inert","")}),window.addEventListener("popstate",j),document.addEventListener("keydown",A),E(N.SPLASH,{},!1)}function A(l){if(l.key!=="Escape"||l.target.tagName==="INPUT"||l.target.tagName==="TEXTAREA")return;const u=document.getElementById("confirm-modal"),h=document.getElementById("help-modal");if(!(u!=null&&u.classList.contains("visible")||h!=null&&h.classList.contains("visible")))switch(C){case N.HOME:break;case N.COLLECTION:E(N.HOME);break;case N.PUZZLE:break;case N.VICTORY:E(N.COLLECTION);break;case N.SETTINGS:E(N.HOME);break;case N.TUTORIAL:window.Cozy.Storage&&window.Cozy.Storage.setFlag("tutorialComplete",!0),E(N.HOME);break}}function E(l,u={},h=!0){const S=c[l];if(!S){console.error(`Screen not found: ${l}`);return}b=u,C&&c[C]&&(C===N.PUZZLE&&window.Cozy.Zoom&&window.Cozy.Zoom.destroy(),c[C].classList.remove("screen-active"),c[C].classList.add("screen-hidden"),c[C].setAttribute("inert","")),S.classList.remove("screen-hidden"),S.classList.add("screen-active"),S.removeAttribute("inert"),h&&C!==null&&(B.push(C),B.length>U.MAX_SCREEN_HISTORY&&(B=B.slice(-U.MAX_SCREEN_HISTORY)),history.pushState({screen:l},"",`#${l}`));const p=C;C=l,K(l,u,p)}function te(){if(B.length>0){const l=B.pop();E(l,{},!1),history.back()}}function j(l){if(l.state&&l.state.screen)E(l.state.screen,{},!1);else if(B.length>0){const u=B.pop();E(u,{},!1)}}function K(l,u,h){switch(l){case N.SPLASH:X();break;case N.HOME:oe();break;case N.COLLECTION:g(u);break;case N.PUZZLE:d(u);break;case N.VICTORY:z(u);break;case N.SETTINGS:T();break;case N.TUTORIAL:O();break}}function Z(){return b}function ee(){return C}function X(){setTimeout(()=>{var S;if(new URLSearchParams(window.location.search).get("action")==="continue"){const p=window.location.pathname+window.location.hash;history.replaceState(null,"",p);const $=window.Cozy.Storage;if($){const G=$.getSession();if(G&&typeof G.puzzleIndex=="number"){E(N.PUZZLE,{puzzleId:G.puzzleIndex});return}}}const h=(S=window.Cozy.Storage)==null?void 0:S.getFlag("tutorialCompleted");E(h?N.HOME:N.TUTORIAL)},1500)}function oe(){var S;const l=document.getElementById("home-play-btn"),u=document.getElementById("home-settings-btn"),h=document.getElementById("home-progress");if(I(l,"click",()=>E(N.COLLECTION)),I(u,"click",()=>E(N.SETTINGS)),h&&window.PUZZLE_DATA){const p=window.PUZZLE_DATA,$=Array.isArray(p)?p.length:0;let G=0;window.Cozy.Storage&&((S=window.Cozy.Garden)!=null&&S.getPuzzleId)&&p.forEach(ne=>{const W=window.Cozy.Garden.getPuzzleId(ne);window.Cozy.Storage.isPuzzleCompleted(W)&&G++}),h.textContent=`${G} / ${$} puzzles solved`}l&&setTimeout(()=>l.focus(),100)}function g(l){window.dispatchEvent(new CustomEvent("screen:collection",{detail:l}));const u=document.getElementById("collection-search-input");u&&setTimeout(()=>u.focus(),100)}function d(l){window.Cozy.Zoom&&window.Cozy.Zoom.init(),window.dispatchEvent(new CustomEvent("screen:puzzle",{detail:l}))}let a=null;function z(l){const u=document.getElementById("victory-puzzle-name"),h=document.getElementById("victory-image"),S=document.getElementById("victory-continue-btn");a=l.puzzleId,u&&l.puzzleName&&(u.textContent=l.puzzleName),h&&l.solution&&m(h,l.solution,l.palette),I(S,"click",()=>{const p=h?h.querySelector("canvas"):null;if(p){const $=h.getBoundingClientRect(),G=V(p,$,{useScale:!0});E(N.COLLECTION,{scrollToPuzzleId:a,animateStamp:!0,flyingStamp:G})}else E(N.COLLECTION,{scrollToPuzzleId:a})}),S&&setTimeout(()=>S.focus(),100)}function m(l,u,h){l.innerHTML="";const S=u.length,p=u[0]?u[0].length:S,$=F(p,S,U.VICTORY_CANVAS_SIZE,(G,ne)=>{const W=u[G][ne];return W>0&&h[W]?window.Cozy.Utils.getDisplayColor(h[W]):null});l.appendChild($)}function y(){var h;const l=document.querySelectorAll(".theme-option");let u=(h=window.Cozy.Storage)==null?void 0:h.getSetting("theme");(!u||u==="system")&&(u=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),l.forEach(S=>{const $=S.dataset.theme===u;S.classList.toggle("active",$),S.setAttribute("aria-pressed",$?"true":"false")}),l.forEach(S=>{I(S,"click",()=>{const p=S.dataset.theme;l.forEach($=>{$.classList.remove("active"),$.setAttribute("aria-pressed","false")}),S.classList.add("active"),S.setAttribute("aria-pressed","true"),window.Cozy.Storage&&window.Cozy.Storage.setSetting("theme",p),_(p)})})}function P(){const l=document.getElementById("settings-reset-btn");I(l,"click",()=>{q({title:"Reset Progress",message:"Are you sure you want to reset all progress? This cannot be undone.",confirmText:"Reset",cancelText:"Cancel",danger:!0,onConfirm:()=>{var u,h;(u=window.Cozy.Garden)!=null&&u.clearAllState&&window.Cozy.Garden.clearAllState(),(h=window.Cozy.Storage)!=null&&h.reset&&window.Cozy.Storage.reset(),window.Cozy.Collection&&window.Cozy.Collection.refresh(),ie({title:"Progress Reset",message:"All progress has been cleared."})}})})}function w(){const l=document.getElementById("settings-solve-all-btn");I(l,"click",()=>{q({title:"Debug: Solve All",message:"Mark all puzzles as solved? This is a debug feature.",confirmText:"Solve All",cancelText:"Cancel",onConfirm:()=>{const u=window.PUZZLE_DATA||[],h=window.Cozy.Storage;h&&u.forEach(S=>{var $;let p;($=window.Cozy.Garden)!=null&&$.getPuzzleId?p=window.Cozy.Garden.getPuzzleId(S):p=(S.t||S.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""),h.completePuzzle(p)}),window.Cozy.Collection&&window.Cozy.Collection.refresh(),ie({title:"All Puzzles Solved",message:`Marked ${u.length} puzzles as solved!`})}})})}function T(){var $;const l=document.getElementById("settings-back-btn"),u=document.getElementById("settings-vibration"),h=document.getElementById("settings-colorblind"),S=document.getElementById("settings-tutorial-btn"),p=window.Cozy.Storage;u&&(u.checked=($=p==null?void 0:p.getSetting("vibration"))!=null?$:!0),h&&(h.value=(p==null?void 0:p.getSetting("colorblindMode"))||"off"),I(l,"click",te),I(S,"click",()=>E(N.TUTORIAL)),I(u,"change",()=>p==null?void 0:p.setSetting("vibration",u.checked)),I(h,"change",()=>{p==null||p.setSetting("colorblindMode",h.value),window.Cozy.Collection&&window.Cozy.Collection.refresh()}),y(),P(),w(),u&&setTimeout(()=>u.focus(),100)}let k=0;function O(){const l=document.getElementById("tutorial-skip-btn"),u=document.getElementById("tutorial-next-btn"),h=document.querySelectorAll(".tutorial-step"),S=document.querySelectorAll(".tutorial-dot");function p(G){h.forEach((ne,W)=>{ne.classList.toggle("active",W===G)}),S.forEach((ne,W)=>{ne.classList.toggle("active",W===G)}),u&&(u.textContent=G===h.length-1?"Start Playing":"Next")}function $(){var G;(G=window.Cozy.Storage)==null||G.setFlag("tutorialCompleted",!0),E(N.HOME)}I(l,"click",$),I(u,"click",()=>{k<h.length-1?(k++,p(k)):$()}),k=0,p(0),u&&setTimeout(()=>u.focus(),100)}function _(l){document.documentElement.setAttribute("data-theme",l);const u=document.getElementById("theme-color-meta");u&&u.setAttribute("content",l==="dark"?"#0a1018":"#4a7c3f")}function D(){var u;let l=(u=window.Cozy.Storage)==null?void 0:u.getSetting("theme");(!l||l==="system")&&(l=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),_(l)}return{init:se,showScreen:E,goBack:te,getScreenData:Z,getCurrentScreen:ee,applyTheme:_,initTheme:D,showConfirmModal:q,SCREENS:N}}();window.Cozy.Screens=ScreenManager,document.addEventListener("DOMContentLoaded",()=>{ScreenManager.init()}),function(){"use strict";const{CONFIG:U,getPuzzleId:I,getPuzzleTitle:V,parsePuzzleTitle:F,renderOutlinedCanvas:N}=window.Cozy.Utils,C=["easy","medium","hard","challenging","expert"],B='<svg class="placeholder-icon" viewBox="300 200 440 600" aria-hidden="true"><path fill="currentColor" transform="scale(2 2)" d="M251.724 120.241C292.099 116.006 333.322 148.379 341.784 187.699C349.613 224.08 333.989 254.362 306.146 276.366C300.534 280.801 290.424 282.015 285.865 286.917C277.693 295.707 280.688 308.471 274.943 317.013C262.186 336.38 226.696 327.87 233.173 294.887C235.824 281.387 239.865 271.299 247.555 260.03C251.934 253.972 262.127 243.93 268.474 240.356C276.495 236.098 283.216 235.327 289.107 227.709C298.349 215.758 298.827 199.451 291.065 186.685C273.123 157.177 231.314 162.292 218.105 193.171C216.601 196.688 216.173 200.717 214.325 204.113C203.424 223.501 172.407 218.828 170.08 195.677C169.429 189.206 171.385 184.817 173.298 178.941C184.909 143.291 215.812 123.577 251.724 120.241Z"/><path fill="currentColor" transform="scale(2 2)" d="M248.076 336.509C263.421 334.867 277.184 345.994 278.792 361.343C280.401 376.691 269.244 390.43 253.892 392.006C238.587 393.577 224.898 382.461 223.295 367.159C221.691 351.857 232.777 338.145 248.076 336.509Z"/></svg>';function b(){var d;const g=(d=window.Cozy.Storage)==null?void 0:d.getUIState("collapsedSections");return g&&typeof g=="object"?g:null}function c(g){var d;(d=window.Cozy.Storage)==null||d.setUIState("collapsedSections",g)}function H(g,d){const a=document.querySelector(`.collection-section[data-difficulty="${g}"]`);if(!a)return;const m=!d[g];d[g]=m,c(d),a.classList.toggle("collapsed",m);const y=a.querySelector(".collection-grid"),P=a.querySelector(".section-chevron"),w=a.querySelector(".collection-section-header");if(y&&(y.style.display=m?"none":"flex"),P&&(P.textContent=m?"\u25B6":"\u25BC"),w){w.setAttribute("aria-expanded",!m);const T=w.querySelector(".collection-section-stats"),k=T?T.textContent:"",[O,_]=k.split("/");w.setAttribute("aria-label",`${se(g)}, ${O} of ${_} completed, ${m?"collapsed":"expanded"}`)}window.Cozy.Collection&&window.Cozy.Collection.updateRovingTabindex()}function q(){return window.Cozy.Storage||null}function ie(g){const d={};return g.forEach((a,z)=>{const m=F(V(a)),y=m.difficulty;d[y]||(d[y]=[]),d[y].push({index:z,puzzle:a,meta:m,id:I(a)})}),d}function Q(g){const d={};return g.forEach(a=>{const z=F(V(a.puzzle)),m=z.difficulty;d[m]||(d[m]=[]),d[m].push({index:a.originalIndex,puzzle:a.puzzle,meta:z,id:I(a.puzzle)})}),d}function ce(g){return Object.keys(g).sort((a,z)=>{const m=C.indexOf(a),y=C.indexOf(z);return m!==-1&&y!==-1?m-y:m!==-1?-1:y!==-1?1:a.localeCompare(z)})}function se(g){return g.charAt(0).toUpperCase()+g.slice(1)}function A(g){const d=q();let a=0;return d&&g.forEach(z=>{d.isPuzzleCompleted(z.id)&&a++}),{completed:a,total:g.length}}function E(g){if(!g)return!1;for(const d of g)for(const a of d)if((typeof a=="object"&&a!==null?a.value:a)!==null)return!0;return!1}function te(g,d,a={}){const z=q(),m=z?z.isPuzzleCompleted(g.id):!1,y=z?z.getPuzzleGrid(g.id):null,P=!m&&E(y),w=document.createElement("div");w.className="puzzle-card"+(m?" completed":"")+(P?" in-progress":""),w.dataset.puzzleIndex=g.index,w.dataset.puzzleId=g.id,w.tabIndex=-1,w.setAttribute("role","button"),w.setAttribute("aria-label",`${g.meta.name}, ${g.meta.width} by ${g.meta.height}${m?", completed":""}`),w.addEventListener("keydown",D=>{if(D.key==="Enter"||D.key===" "){D.preventDefault(),window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=g.id),d(g.index);return}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(D.key)&&(D.preventDefault(),D.stopPropagation(),window.Cozy.Collection&&window.Cozy.Collection.navigateFromElement(w,D.key))});const T=document.createElement("div");if(T.className="puzzle-card-preview",a.forceBlank){T.classList.add("awaiting-stamp");const D=document.createElement("div");D.className="puzzle-card-placeholder",D.innerHTML=B,T.appendChild(D)}else if(m)T.appendChild(j(g.puzzle));else if(P)T.appendChild(K(g.puzzle,y));else{const D=document.createElement("div");D.className="puzzle-card-placeholder",D.innerHTML=B,T.appendChild(D)}w.appendChild(T);const k=document.createElement("div");k.className="puzzle-card-name",k.textContent=g.meta.name,w.appendChild(k);const O=Object.keys(g.puzzle.color_map).length,_=document.createElement("div");return _.className="puzzle-card-badge",_.textContent=`${g.meta.width}\xD7${g.meta.height} \xB7 ${O}c`,w.appendChild(_),w.addEventListener("click",()=>{window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=g.id),d(g.index)}),w}function j(g){try{const d=N(g.width,g.height,U.MINI_CANVAS_SIZE,(a,z)=>{var y,P,w;const m=(P=(y=g.solution)==null?void 0:y[a])==null?void 0:P[z];if(m>0){const T=(w=g.color_map)==null?void 0:w[m];if(T&&Array.isArray(T)&&T.length>=3)return window.Cozy.Utils.getDisplayColor(T)}return null});return d.className="puzzle-mini-canvas",d}catch(d){return console.error("[Collection] Error creating mini solution:",d),null}}function K(g,d){try{const a=N(g.width,g.height,U.MINI_CANVAS_SIZE,(z,m)=>{var w,T;const y=(w=d==null?void 0:d[z])==null?void 0:w[m],P=typeof y=="object"&&y!==null?y.value:y;if(P!==null&&P>0){const k=(T=g.color_map)==null?void 0:T[P];if(k&&Array.isArray(k)&&k.length>=3)return window.Cozy.Utils.getDisplayColor(k)}return null});return a.className="puzzle-mini-canvas",a}catch(a){return console.error("[Collection] Error creating mini progress:",a),null}}function Z(g,d,a,z={}){g.innerHTML="";const m=(z.searchFilter||"").toLowerCase().trim().slice(0,U.MAX_SEARCH_LENGTH);let y=d.map((O,_)=>({puzzle:O,originalIndex:_}));m&&(y=y.filter(O=>F(V(O.puzzle)).name.toLowerCase().includes(m)));const P=Q(y),w=ce(P),T=q();if(w.length===0&&m){const O=document.createElement("div");O.className="collection-empty-state";const _=document.createElement("p");_.className="collection-empty-message",_.textContent=`No puzzles match "${m}"`,O.appendChild(_),g.appendChild(O);return}let k;if(m)k={},w.forEach(O=>{k[O]=!1});else if(k=b(),!k){k={};let O=!1;w.forEach(_=>{const D=A(P[_]);!O&&D.completed<D.total?(k[_]=!1,O=!0):k[_]=!0}),!O&&w.length>0&&(k[w[0]]=!1),c(k)}w.forEach(O=>{const _=ee(O,P[O],k,a,z);g.appendChild(_)})}function ee(g,d,a,z,m){const y=A(d),P=a[g],w=document.createElement("div");w.className="collection-section"+(P?" collapsed":""),w.dataset.difficulty=g;const T=`collection-grid-${g}`,k=document.createElement("div");k.className="collection-section-header",k.style.cursor="pointer",k.dataset.difficulty=g,k.tabIndex=-1,k.setAttribute("role","button"),k.setAttribute("aria-expanded",!P),k.setAttribute("aria-controls",T),k.setAttribute("aria-label",`${se(g)}, ${y.completed} of ${y.total} completed, ${P?"collapsed":"expanded"}`);const O=document.createElement("span");O.className="section-chevron",O.setAttribute("aria-hidden","true"),O.textContent=P?"\u25B6":"\u25BC",k.appendChild(O);const _=document.createElement("h3");_.className="collection-section-title",_.textContent=se(g),k.appendChild(_);const D=document.createElement("span");D.className="collection-section-stats",D.textContent=`${y.completed}/${y.total}`,y.completed===y.total&&y.total>0&&D.classList.add("complete"),k.appendChild(D),k.addEventListener("click",()=>{H(g,a)}),k.addEventListener("keydown",u=>{if(u.key==="Enter"||u.key===" "){u.preventDefault(),H(g,a);return}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(u.key)&&(u.preventDefault(),u.stopPropagation(),window.Cozy.Collection&&window.Cozy.Collection.navigateFromElement(k,u.key))}),w.appendChild(k);const l=document.createElement("div");return l.className="collection-grid",l.id=T,l.style.display=P?"none":"flex",d.forEach(u=>{const h={};m.blankPuzzleId&&u.id===m.blankPuzzleId&&(h.forceBlank=!0);const S=te(u,z,h);l.appendChild(S)}),w.appendChild(l),w}class X{constructor(){this.container=null,this.puzzles=[],this.onPuzzleSelect=null,this.visible=!0,this.searchFilter="",this.searchInput=null,this.searchInputHandler=null,this.searchDebounceTimeout=null,this.focusedCardId=null,this.focusedHeaderDifficulty=null,this.idealX=null}init(d,a,z){return this.container=document.getElementById(d),this.puzzles=a,this.onPuzzleSelect=z,this.searchInput=document.getElementById("collection-search-input"),this.searchInput&&(this.searchInputHandler&&this.searchInput.removeEventListener("input",this.searchInputHandler),this.searchInputHandler=m=>{this.searchFilter=m.target.value,this.searchDebounceTimeout&&clearTimeout(this.searchDebounceTimeout),this.searchDebounceTimeout=setTimeout(()=>this.render(),150)},this.searchInput.addEventListener("input",this.searchInputHandler)),this.container&&this.render(),this}render(d={}){if(!this.container)return;const a={...d,searchFilter:this.searchFilter};Z(this.container,this.puzzles,z=>{this.onPuzzleSelect&&this.onPuzzleSelect(z)},a),this.updateRovingTabindex()}show(){this.container&&(this.container.style.display="block",this.visible=!0,this.searchFilter="",this.searchInput&&(this.searchInput.value=""),this.render())}hide(){this.container&&(this.container.style.display="none",this.visible=!1)}isVisible(){return this.visible}refresh(d={}){this.visible&&this.render(d)}getVisibleCards(){if(!this.container)return[];const d=[];return this.container.querySelectorAll(".collection-section").forEach(z=>{const m=z.querySelector(".collection-grid");m&&m.style.display!=="none"&&m.querySelectorAll(".puzzle-card").forEach(P=>d.push(P))}),d}getNavigableElements(){if(!this.container)return[];const d=[];return this.container.querySelectorAll(".collection-section").forEach(z=>{const m=z.querySelector(".collection-section-header");m&&d.push(m);const y=z.querySelector(".collection-grid");y&&y.style.display!=="none"&&y.querySelectorAll(".puzzle-card").forEach(w=>d.push(w))}),d}isHeader(d){return d&&d.classList.contains("collection-section-header")}findElementInDirection(d,a,z=null){const m=this.getNavigableElements();if(m.length===0)return null;const y=d.getBoundingClientRect(),P=y.left+y.width/2,w=y.top+y.height/2,T=this.isHeader(d),k=(a==="up"||a==="down")&&z!==null?z:P,O=y.height*.5,_=y.width*.5;let D=null,l=1/0;return m.forEach(u=>{if(u===d)return;const h=u.getBoundingClientRect(),S=h.left+h.width/2,p=h.top+h.height/2,$=this.isHeader(u);let G=!1;switch(a){case"left":T?G=!1:G=!$&&S<P-_&&Math.abs(p-w)<O;break;case"right":T?G=!1:G=!$&&S>P+_&&Math.abs(p-w)<O;break;case"up":G=p<w-O;break;case"down":G=p>w+O;break}if(G){let ne;if(a==="left"||a==="right")ne=Math.abs(S-P);else{const W=Math.abs(p-w),be=Math.abs(S-k);ne=W*1e3+be}ne<l&&(l=ne,D=u)}}),D}navigateFromElement(d,a){const m={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[a];if(!m)return;const y=d.getBoundingClientRect(),P=y.left+y.width/2;let w;if(m==="up"||m==="down"?(this.idealX===null&&(this.idealX=P),w=this.findElementInDirection(d,m,this.idealX)):w=this.findElementInDirection(d,m),w){const T=w.getBoundingClientRect(),k=T.left+T.width/2;m==="left"||m==="right"?this.idealX=k:this.isHeader(w),d.tabIndex=-1,w.tabIndex=0,w.focus(),this.isHeader(w)?(this.focusedCardId=null,this.focusedHeaderDifficulty=w.dataset.difficulty):(this.focusedCardId=w.dataset.puzzleId,this.focusedHeaderDifficulty=null),w.scrollIntoView({behavior:"smooth",block:"nearest"})}}findCardInDirection(d,a){const z=this.getVisibleCards();if(z.length===0)return null;const m=d.getBoundingClientRect(),y=m.left+m.width/2,P=m.top+m.height/2,w=m.height*.5,T=m.width*.5;let k=null,O=1/0;return z.forEach(_=>{if(_===d)return;const D=_.getBoundingClientRect(),l=D.left+D.width/2,u=D.top+D.height/2;let h=!1;switch(a){case"left":h=l<y-T&&Math.abs(u-P)<w;break;case"right":h=l>y+T&&Math.abs(u-P)<w;break;case"up":h=u<P-w;break;case"down":h=u>P+w;break}if(h){let S;if(a==="left"||a==="right")S=Math.abs(l-y);else{const p=Math.abs(u-P),$=Math.abs(l-y);S=p*1e3+$}S<O&&(O=S,k=_)}}),k}navigateFromCard(d,a){const m={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[a];if(!m)return;const y=this.findCardInDirection(d,m);y&&(d.tabIndex=-1,y.tabIndex=0,y.focus(),this.focusedCardId=y.dataset.puzzleId,y.scrollIntoView({behavior:"smooth",block:"nearest"}))}updateRovingTabindex(){const d=this.getNavigableElements();if(d.length===0)return;let a=null;if(this.focusedCardId){const z=this.container.querySelector(`.puzzle-card[data-puzzle-id="${this.focusedCardId}"]`);z&&d.includes(z)&&(a=z)}if(!a&&this.focusedHeaderDifficulty){const z=this.container.querySelector(`.collection-section-header[data-difficulty="${this.focusedHeaderDifficulty}"]`);z&&d.includes(z)&&(a=z)}a||(a=d[0],this.isHeader(a)?(this.focusedHeaderDifficulty=a.dataset.difficulty,this.focusedCardId=null):(this.focusedCardId=(a==null?void 0:a.dataset.puzzleId)||null,this.focusedHeaderDifficulty=null)),d.forEach(z=>{z.tabIndex=z===a?0:-1})}scrollToPuzzle(d,a={}){if(!this.container)return;const z=this.container.querySelectorAll(".puzzle-card");let m=null,y=-1;for(let T=0;T<this.puzzles.length;T++)if(I(this.puzzles[T])===d){y=T;break}if(y===-1||(z.forEach(T=>{parseInt(T.dataset.puzzleIndex,10)===y&&(m=T)}),!m))return;const P=m.closest(".collection-section");if(P&&P.classList.contains("collapsed")){const T=P.dataset.difficulty,k=P.querySelector(".collection-grid"),O=P.querySelector(".section-chevron");P.classList.remove("collapsed"),k&&(k.style.display="flex"),O&&(O.textContent="\u25BC");let _=b()||{};_[T]=!1,c(_)}const w=a.instant?"instant":"smooth";setTimeout(()=>{m.scrollIntoView({behavior:w,block:"center"})},a.instant?0:100)}animateStampTo(d,a,z={}){if(!this.container||!a)return;const m=this.container.querySelector(`.puzzle-card[data-puzzle-id="${d}"]`);if(!m){a.remove();return}const y=m.querySelector(".puzzle-card-preview");if(!y){a.remove();return}setTimeout(()=>{const w=y.getBoundingClientRect(),T=parseFloat(a.style.width),k=parseFloat(a.style.height),O=this.puzzles.find(S=>I(S)===d);let _,D;if(O){const S=Math.max(O.width,O.height),p=Math.max(2,Math.floor(U.MINI_CANVAS_SIZE/S)),$=U.OUTLINE_THICKNESS*2;_=O.width*p+$,D=O.height*p+$}else{const S=T/k;S>1?(_=w.width,D=w.width/S):(D=w.height,_=w.height*S)}const l=_/T,u=w.left+w.width/2,h=w.top+w.height/2;requestAnimationFrame(()=>{a.style.left=u-T/2+"px",a.style.top=h-k/2+"px",a.style.transform="scale("+l+")",a.classList.add("landed")}),setTimeout(()=>{y.classList.remove("awaiting-stamp"),y.innerHTML="";const S=this.puzzles.find(p=>I(p)===d);if(S){const p=q();if(p?p.isPuzzleCompleted(d):!1)y.appendChild(j(S));else{const G=p?p.getPuzzleGrid(d):null;G&&y.appendChild(K(S,G))}}a.remove()},650)},100)}}const oe=new X;window.Cozy.Collection=oe}(),function(){"use strict";const U={isInstalled:!1,swRegistration:null,resizeTimeout:null,init(){this.checkInstallState(),this.registerServiceWorker(),this.setupEventListeners(),console.log("[App] Cozy Garden initialized")},checkInstallState(){window.matchMedia("(display-mode: standalone)").matches&&(this.isInstalled=!0),window.navigator.standalone===!0&&(this.isInstalled=!0),this.isInstalled&&(document.body.classList.add("is-installed"),console.log("[App] Running as installed PWA"))},async registerServiceWorker(){if(!("serviceWorker"in navigator)){console.log("[App] Service workers not supported");return}try{this.swRegistration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("[App] Service worker registered:",this.swRegistration.scope),this.swRegistration.addEventListener("updatefound",()=>{const I=this.swRegistration.installing;console.log("[App] New service worker installing..."),I.addEventListener("statechange",()=>{I.state==="installed"&&navigator.serviceWorker.controller&&this.showUpdateNotification()})})}catch(I){console.error("[App] Service worker registration failed:",I)}},showUpdateNotification(){const I=document.createElement("div");I.className="update-banner";const V=document.createElement("span");V.textContent="A new version is available!";const F=document.createElement("button");F.textContent="Update",F.addEventListener("click",()=>this.applyUpdate());const N=document.createElement("button");N.textContent="Later",N.addEventListener("click",()=>I.remove()),I.appendChild(V),I.appendChild(F),I.appendChild(N),document.body.appendChild(I)},applyUpdate(){this.swRegistration&&this.swRegistration.waiting&&this.swRegistration.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload()},setupEventListeners(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?this.onAppFocus():this.onAppBlur()}),window.addEventListener("beforeunload",()=>{this.saveState()}),window.addEventListener("orientationchange",()=>{setTimeout(()=>this.handleResize(),100)}),window.addEventListener("resize",()=>{this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>this.handleResize(),100)})},onAppFocus(){console.log("[App] App focused")},onAppBlur(){console.log("[App] App blurred"),this.saveState()},saveState(){window.Cozy.Garden&&window.Cozy.Storage&&console.log("[App] Saving state...")},handleResize(){const I=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${I}px`)},isPWA(){return this.isInstalled||window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0},async getVersion(){return!this.swRegistration||!navigator.serviceWorker.controller?"unknown":new Promise(I=>{const V=new MessageChannel;V.port1.onmessage=F=>{I(F.data.version||"unknown")},navigator.serviceWorker.controller.postMessage({type:"GET_VERSION"},[V.port2]),setTimeout(()=>I("unknown"),1e3)})},async share(I,V,F){if(navigator.share)try{return await navigator.share({title:I,text:V,url:F}),!0}catch(N){return N.name!=="AbortError"&&console.error("[App] Share failed:",N),!1}return!1},vibrate(I=50){var V;navigator.vibrate&&((V=window.Cozy.Storage)!=null&&V.getSetting("vibration"))&&navigator.vibrate(I)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>U.init()):U.init(),window.Cozy.App=U}(),function(){"use strict";const{CONFIG:U,getPuzzleId:I,getPuzzleTitle:V,createFlyingStamp:F,renderOutlinedCanvas:N}=window.Cozy.Utils;let C=0,B="easy",b=1,c=[],H=!1,q=null,ie=!0,Q=!1,ce=!1,se=0,A=0,E=null,te=null,j=null,K=[],Z=[],ee=[],X=[],oe=[],g=null;function d(e,t="info"){const n=document.getElementById("toast");n&&(clearTimeout(g),n.textContent=e,n.className="toast visible",t==="success"?n.classList.add("toast-success"):t==="info"&&n.classList.add("toast-info"),g=setTimeout(()=>{n.classList.remove("visible")},U.TOAST_DURATION))}function a(){const e=document.getElementById("toast");e&&(clearTimeout(g),e.classList.remove("visible"))}function z(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function m(){const e=document.getElementById("help-list");if(!e)return;const t=z();let n=["<li><strong>Select a color</strong> from the palette, then tap cells to fill them</li>","<li><strong>Drag</strong> across cells to fill multiple at once</li>","<li><strong>Long-press</strong> a cell to mark it \u2715 (definitely empty)</li>","<li><strong>Pencil mode</strong> marks uncertain guesses \u2014 confirm or clear them later</li>"];t&&n.push("<li><strong>Pinch to zoom</strong> on larger puzzles for easier tapping</li>"),t||(n.push('<li class="help-section-title">Keyboard Shortcuts</li>'),n.push("<li><strong>Ctrl+Z</strong> / <strong>Ctrl+Y</strong> \u2014 Undo / Redo</li>"),n.push("<li><strong>P</strong> \u2014 Toggle pencil mode</li>"),n.push("<li><strong>1-9</strong> \u2014 Select color by number</li>"),n.push("<li><strong>+</strong> / <strong>-</strong> \u2014 Zoom in / out</li>")),e.innerHTML=n.join("")}function y(){const e=document.getElementById("help-modal");if(!e)return;m(),e.classList.add("visible"),document.body.style.overflow="hidden";const t=e.querySelector(".help-modal-close");t&&setTimeout(()=>t.focus(),100)}function P(){const e=document.getElementById("help-modal");e&&(e.classList.remove("visible"),document.body.style.overflow="")}function w(){const e=document.getElementById("help-btn"),t=document.getElementById("help-modal"),n=t==null?void 0:t.querySelector(".help-modal-backdrop"),o=t==null?void 0:t.querySelector(".help-modal-close");e&&e.addEventListener("click",y),n&&n.addEventListener("click",P),o&&o.addEventListener("click",P),document.addEventListener("keydown",i=>{if(t!=null&&t.classList.contains("visible")){if(i.key==="Escape"){P();return}i.key==="Tab"&&(document.activeElement!==o?(i.preventDefault(),o==null||o.focus()):i.preventDefault())}})}function T(){const e=document.getElementById("skip-to-puzzle");e&&e.addEventListener("click",t=>{var o;t.preventDefault();const n=(o=K[0])==null?void 0:o[0];n&&n.focus()})}function k(){var e;(e=window.Cozy.Storage)!=null&&e.getFlag("helpShown")||setTimeout(()=>{var t;y(),(t=window.Cozy.Storage)==null||t.setFlag("helpShown",!0)},500)}function O(e){if(!e)return null;if(e.title!==void 0)return!e.width||!e.height||!e.row_clues||!e.col_clues||!e.color_map?(console.warn("[Game] Invalid verbose puzzle format:",e.title),null):e;if(!e.t||!e.w||!e.h||!Array.isArray(e.r)||!Array.isArray(e.c)||!Array.isArray(e.p)||!Array.isArray(e.s))return console.warn("[Game] Invalid concise puzzle format, missing or malformed fields:",e.t),null;if(e.w>U.MAX_PUZZLE_DIMENSION||e.h>U.MAX_PUZZLE_DIMENSION||e.w<1||e.h<1)return console.warn("[Game] Puzzle dimensions out of range:",e.w,"x",e.h),null;function t(s){const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(s);return r?[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16)]:[0,0,0]}function n(s){return s.map(r=>r.map(([L,v])=>({count:L,color:v+1})))}function o(s){const r={};return s.forEach((L,v)=>{r[v+1]=t(L)}),r}function i(s){return s.map(r=>r.map(L=>L<0?0:L+1))}try{return{title:e.t,width:e.w,height:e.h,row_clues:n(e.r),col_clues:n(e.c),color_map:o(e.p),color_names:e.n||null,solution:i(e.s)}}catch(s){return console.error("[Game] Failed to convert puzzle:",e.t,s),null}}let _=null,D=null;function l(){const e=window.PUZZLE_DATA||[];return(!_||e!==D)&&(_=e.map(O).filter(t=>t!==null),D=e),_}function u(e=null,t=!0){return{value:e,certain:t}}function h(e,t){var n;return((n=c[e])==null?void 0:n[t])||u()}function S(e,t,n,o){c[e][t]={value:n,certain:o}}function p(e){return`rgb(${e[0]}, ${e[1]}, ${e[2]})`}function $(e){return(e[0]*299+e[1]*587+e[2]*114)/1e3}function G(e){const t=e.toLowerCase();return t.includes("easy")?"easy":t.includes("medium")?"medium":t.includes("hard")?"hard":t.includes("challenging")?"challenging":t.includes("expert")?"expert":"easy"}function ne(){return window.Cozy.Storage||null}function W(){return window.Cozy.History||null}function be(){const e=l()[C];if(!e)return!0;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++)if(h(t,n).value!==null)return!1;return!0}function Ke(){const e=l()[C];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=h(t,n),i=e.solution[t][n];if(o.value!==i||!o.certain)return!1}return!0}function we(){const e=document.getElementById("reset-btn"),t=document.getElementById("solution-btn");if(e){const n=be();e.disabled=n,e.setAttribute("aria-label",n?"Reset (puzzle is empty)":"Hold to reset puzzle")}if(t){const n=Ke();t.disabled=n,t.setAttribute("aria-label",n?"Solution (already shown)":"Hold to reveal solution")}}function ue(e){const t=document.getElementById("sr-announcer");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},50))}function Te(e){Q=e,De(),ue(e?"Pencil mode":"Pen mode"),Ie()}function He(){Te(!Q)}function De(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("palette-menu-btn");if(e&&(e.classList.toggle("active",!Q),e.setAttribute("aria-checked",String(!Q))),t&&(t.classList.toggle("active",Q),t.setAttribute("aria-checked",String(Q))),n){const o=n.querySelector(".menu-icon-svg");o&&(o.removeAttribute("stroke"),o.removeAttribute("stroke-width"),o.setAttribute("fill","currentColor"),Q?o.innerHTML='<path d="M19.07 13.88L13 19.94l-1.41-1.41 6.07-6.06 1.41 1.41zm-5.66-5.66l-6.06 6.07-1.42-1.41 6.07-6.07 1.41 1.41zM17.66 5.99l-2.34 2.34 1.41 1.41 2.34-2.34-1.41-1.41zM3 18v3h3l.01-.01L3 18zm3-3l-1 1 3 3 1-1-3-3z" opacity="0.5"/><path d="M9.17 16.17L7.76 17.59l3.54 3.54 1.41-1.41-3.54-3.55zm10.6-10.6l-3.53-3.54-1.42 1.42 3.54 3.53 1.41-1.41z"/>':o.innerHTML='<path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>')}document.body.classList.toggle("pencil-mode",Q)}function We(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");if(!e||!t)return;e.classList.contains("open")?Ie():je()}function je(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");!e||!t||(e.classList.add("open"),t.classList.add("menu-open"),t.setAttribute("aria-expanded","true"),setTimeout(()=>{document.addEventListener("click",Ze)},0))}function Ie(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");e&&(e.classList.remove("open"),t&&(t.classList.remove("menu-open"),t.setAttribute("aria-expanded","false")),document.removeEventListener("click",Ze))}function Ze(e){const t=document.getElementById("mode-menu"),n=document.getElementById("palette-menu-btn");!t||!n||!t.contains(e.target)&&!n.contains(e.target)&&Ie()}function Ue(){const e=l()[C];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=h(t,n);if(!o.certain&&o.value!==null)return!0}return!1}function Je(){const e=l()[C];if(!e)return 0;let t=0;for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=h(n,o);!i.certain&&i.value!==null&&t++}return t}function pe(){const e=document.getElementById("pencil-actions-section"),t=document.getElementById("palette-menu-btn"),n=Ue(),o=n?Je():0;if(e&&e.classList.toggle("has-marks",n),t){t.classList.toggle("has-pencil-marks",n);const i=t.querySelector(".pencil-badge");i&&(i.textContent=o>U.BADGE_MAX_DISPLAY?`${U.BADGE_MAX_DISPLAY}+`:String(o))}}function $e(){const e=l()[C];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=h(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:null,certain:!0}}),S(n,o,null,!0),Se(n,o,e))}if(t.length>0){const n=W();n&&n.recordBatchAction("batch-clear",t),window.Cozy.App&&window.Cozy.App.vibrate(20)}pe(),Ee()}function Ge(){const e=l()[C];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=h(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:i.value,certain:!0}}),S(n,o,i.value,!0),Se(n,o,e))}if(t.length>0){const n=W();n&&n.recordBatchAction("batch-confirm",t),window.Cozy.App&&window.Cozy.App.vibrate([20,50,20])}pe(),nt(e),Ee()}function Oe(){const e=W();if(!e)return;const t=e.undo();if(!t)return;const n=l()[C];for(const o of t)S(o.row,o.col,o.state.value,o.state.certain),Se(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),pe(),Be(n),we(),Ee()}function Ne(){const e=W();if(!e)return;const t=e.redo();if(!t)return;const n=l()[C];for(const o of t)S(o.row,o.col,o.state.value,o.state.certain),Se(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),pe(),Be(n),we(),nt(n),Ee()}function Ee(){const e=ne();if(!e)return;const n=l()[C];if(!n)return;const o=I(n);e.savePuzzleGrid(o,c),e.saveSession(C,B,c)}function Qe(){const e=ne();e&&e.clearSession()}function et(){const e=l(),t=document.getElementById("puzzle-select"),n=[...new Set(e.map(L=>G(L.title)))],o=["easy","medium","hard","challenging","expert"];n.sort((L,v)=>o.indexOf(L)-o.indexOf(v));const i=document.createElement("div");i.className="difficulty-tabs",n.forEach(L=>{const v=document.createElement("button");v.className="difficulty-tab"+(L===B?" active":""),v.textContent=L.charAt(0).toUpperCase()+L.slice(1),v.onclick=()=>{B=L,document.querySelectorAll(".difficulty-tab").forEach(x=>x.classList.remove("active")),v.classList.add("active"),f()},i.appendChild(v)});const s=document.createElement("div");s.className="puzzle-dropdown";const r=document.createElement("select");r.id="puzzle-select-dropdown",r.onchange=L=>{M(parseInt(L.target.value))},s.appendChild(r),t.appendChild(i),t.appendChild(s),f()}function f(){var i;const e=l(),t=document.getElementById("puzzle-select-dropdown");if(!t)return;const n=ne();if(t.innerHTML="",e.forEach((s,r)=>{if(G(s.title)===B){const L=document.createElement("option");L.value=r;const v=I(s),x=n?n.isPuzzleCompleted(v):!1;L.textContent=(x?"\u2713 ":"")+s.title,r===C&&(L.selected=!0),t.appendChild(L)}}),e.filter(s=>G(s.title)===B).length>0&&!(G((i=e[C])==null?void 0:i.title)===B)){const r=e.findIndex(L=>G(L.title)===B);r>=0&&M(r)}}function M(e,t=null){var n;if(ce){console.warn("[Game] Puzzle already loading, ignoring request");return}ce=!0;try{const o=l(),i=ne(),s=W();if(e!==C&&c.length>0&&o[C]&&i){const de=I(o[C]);i.savePuzzleGrid(de,c)}s&&s.clear(),Q=!1,De(),se=0,A=0,C=e;const r=o[e];if(!r){ce=!1;return}if(r.width>U.MAX_PUZZLE_DIMENSION||r.height>U.MAX_PUZZLE_DIMENSION||r.width<1||r.height<1){console.error(`[Game] Invalid puzzle dimensions: ${r.width}x${r.height}`),ce=!1;return}const L=I(r);let v=t;!v&&i&&(v=i.getPuzzleGrid(L));const x=v&&v.length===r.height;if(x)c=v.map(de=>de.map(ge=>({value:ge.value,certain:ge.certain})));else{c=[];for(let de=0;de<r.height;de++){c.push([]);for(let ge=0;ge<r.width;ge++)c[de][ge]=u(null,!0)}}if(b=1,R(r),ae(r),xe(r),pt(),x)for(let de=0;de<r.height;de++)for(let ge=0;ge<r.width;ge++)h(de,ge).value!==null&&Se(de,ge,r);a();const J=document.getElementById("puzzle-select-dropdown");J&&(J.value=e);const he=G(r.title);he!==B&&(B=he,document.querySelectorAll(".difficulty-tab").forEach(de=>{de.classList.toggle("active",de.textContent.toLowerCase()===he)}),f()),pe(),Be(r),window.Cozy.Zoom&&window.Cozy.Zoom.initForPuzzle(r),k(),we();const me=r.title.match(/^(.+?)\s*\(/),ve=me?me[1].trim():r.title,Ye=G(r.title),Et=((n=r.color_names)==null?void 0:n.join(", "))||`${Object.keys(r.color_map).length} colors`;ue(`${ve}, ${r.width} by ${r.height}, ${Et}. ${Ye} difficulty.`)}finally{ce=!1}}function R(e){const t=document.getElementById("palette"),n=document.getElementById("mode-menu"),o=n?n.parentNode:null;n&&t.contains(n)&&document.body.appendChild(n),t.innerHTML="";const i=document.createElement("button");i.className="color-btn eraser",i.title="Eraser",i.setAttribute("aria-label","Eraser"),i.setAttribute("aria-pressed",b===0?"true":"false"),i.addEventListener("click",()=>Y(0)),t.appendChild(i),Object.entries(e.color_map).forEach(([v,x])=>{const J=document.createElement("button"),he=parseInt(v)===b;J.className="color-btn"+(he?" selected":"");const me=window.Cozy.Utils.getDisplayColor(x);J.style.background=p(me);const ve=parseInt(v)-1,Ye=e.color_names&&e.color_names[ve]?e.color_names[ve]:`Color ${v}`;J.setAttribute("aria-label",Ye.charAt(0).toUpperCase()+Ye.slice(1)),J.setAttribute("aria-pressed",he?"true":"false"),J.addEventListener("click",()=>Y(parseInt(v))),t.appendChild(J)});const s=document.createElement("button");s.className="palette-menu-btn",s.id="palette-menu-btn",s.title="Drawing mode",s.setAttribute("aria-label","Drawing mode menu"),s.setAttribute("aria-haspopup","true"),s.setAttribute("aria-expanded","false"),s.innerHTML=`
      <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>
      </svg>
      <span class="pencil-badge">0</span>
    `,s.addEventListener("click",v=>{v.stopPropagation(),We()}),t.appendChild(s);const r=document.getElementById("mode-menu");r&&t.appendChild(r);const L=t.querySelectorAll(".color-btn, .palette-menu-btn").length;t.classList.remove("palette-8-buttons","palette-7-buttons"),L>=8?t.classList.add("palette-8-buttons"):L===7&&t.classList.add("palette-7-buttons")}function Y(e){b=e;const n=l()[C];document.querySelectorAll(".color-btn").forEach((o,i)=>{let s;i===0?s=e===0:s=parseInt(Object.keys(n.color_map)[i-1])===e,o.classList.toggle("selected",s),o.setAttribute("aria-pressed",s?"true":"false")})}function le(e,t,n){var i;const o=document.createElement("div");if(o.className=n,e===null)o.textContent="0",o.style.background="#333",o.setAttribute("aria-label","empty");else{const s=t.color_map[e.color],r=window.Cozy.Utils.getDisplayColor(s);o.textContent=e.count,o.style.background=p(r),o.style.color=$(r)>U.BRIGHTNESS_MIDPOINT?"#000":"#fff",o.style.cursor="pointer",o.onclick=()=>Y(e.color);const L=((i=t.color_names)==null?void 0:i[e.color-1])||`color ${e.color}`;o.setAttribute("aria-label",`${e.count} ${L}`)}return o}function ae(e){ee=[],Z=[],X=new Array(e.height).fill(!1),oe=new Array(e.width).fill(!1);const t=document.getElementById("col-clues");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,e.col_clues.forEach((o,i)=>{const s=document.createElement("div");s.className="col-clue",s.dataset.col=i,o.length===0?s.appendChild(le(null,e,"clue-cell")):o.forEach(r=>{s.appendChild(le(r,e,"clue-cell"))}),ee[i]=s,t.appendChild(s)});const n=document.getElementById("row-clues-container");n.innerHTML="",n.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,e.row_clues.forEach((o,i)=>{const s=document.createElement("div");s.className="row-clues",s.dataset.row=i,o.length===0?s.appendChild(le(null,e,"row-clue-cell")):o.forEach(r=>{s.appendChild(le(r,e,"row-clue-cell"))}),Z[i]=s,n.appendChild(s)})}let re=-1,fe=-1;function ze(e,t){var o;if(z()||e===re&&t===fe||(Ce(),re=e,fe=t,e<0||t<0)||!K[e])return;const n=K[e];if(n)for(let i=0;i<n.length;i++){const s=n[i];s&&(s.classList.add("highlight-row"),i===t&&s.classList.add("highlight-cell"))}for(let i=0;i<K.length;i++)i!==e&&((o=K[i])!=null&&o[t])&&K[i][t].classList.add("highlight-col");Z[e]&&Z[e].classList.add("highlight-clue"),ee[t]&&ee[t].classList.add("highlight-clue")}function Ce(){var n;const e=re,t=fe;if(re=-1,fe=-1,!(e<0&&t<0)){if(e>=0&&K[e])for(let o=0;o<K[e].length;o++){const i=K[e][o];i&&i.classList.remove("highlight-row","highlight-cell")}if(t>=0)for(let o=0;o<K.length;o++){const i=(n=K[o])==null?void 0:n[t];i&&i.classList.remove("highlight-col")}e>=0&&Z[e]&&Z[e].classList.remove("highlight-clue"),t>=0&&ee[t]&&ee[t].classList.remove("highlight-clue")}}function ye(e,t){var i,s;const n=l()[C];if(!n||e<0||e>=n.height||t<0||t>=n.width)return;(i=K[se])!=null&&i[A]&&(K[se][A].tabIndex=-1),se=e,A=t;const o=(s=K[e])==null?void 0:s[t];o&&(o.tabIndex=0,o.focus())}function Ae(e,t){const n=document.createElement("div");return n.className="cell",n.dataset.row=e,n.dataset.col=t,n.tabIndex=e===se&&t===A?0:-1,n.setAttribute("role","gridcell"),n.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}, empty`),n}function ke(e,t,n){e.onfocus=()=>{var o;(se!==t||A!==n)&&((o=K[se])!=null&&o[A]&&(K[se][A].tabIndex=-1),se=t,A=n,e.tabIndex=0),ze(t,n)}}function Me(e,t,n){e.onkeydown=o=>{if(o.key==="ArrowUp")o.preventDefault(),ye(t-1,n);else if(o.key==="ArrowDown")o.preventDefault(),ye(t+1,n);else if(o.key==="ArrowLeft")o.preventDefault(),ye(t,n-1);else if(o.key==="ArrowRight")o.preventDefault(),ye(t,n+1);else if(o.key==="Enter"||o.key===" "){o.preventDefault();const i=W();i&&i.beginAction("fill"),Le(t,n,b,!Q),i&&i.commitAction(),pe()}else if(o.key==="x"||o.key==="X"){o.preventDefault(),o.stopPropagation();const i=W();i&&i.beginAction("fill"),Le(t,n,0,!Q),i&&i.commitAction(),pe()}else if(o.key==="r"||o.key==="R"){o.preventDefault();const i=l()[C];if(i)if(o.shiftKey){const s=Pe(t,"row",i);ue(`Row ${t+1} state: ${s}`)}else{const s=i.row_clues[t],r=s.length>0?s.map(L=>{var x;const v=((x=i.color_names)==null?void 0:x[L.color-1])||`color ${L.color}`;return`${L.count} ${v}`}).join(", "):"empty row";ue(`Row ${t+1} clues: ${r}`)}}else if(o.key==="c"||o.key==="C"){o.preventDefault();const i=l()[C];if(i)if(o.shiftKey){const s=Pe(n,"col",i);ue(`Column ${n+1} state: ${s}`)}else{const s=i.col_clues[n],r=s.length>0?s.map(L=>{var x;const v=((x=i.color_names)==null?void 0:x[L.color-1])||`color ${L.color}`;return`${L.count} ${v}`}).join(", "):"empty column";ue(`Column ${n+1} clues: ${r}`)}}}}function Pe(e,t,n){var L;const o=t==="row"?n.width:n.height,i=[];let s=null,r=0;for(let v=0;v<o;v++){const x=t==="row"?h(e,v):h(v,e);let J;x.value===null?J="unfilled":x.value===0?J="X":J=((L=n.color_names)==null?void 0:L[x.value-1])||`color ${x.value}`,J===s?r++:(s!==null&&i.push(`${r} ${s}`),s=J,r=1)}return s!==null&&i.push(`${r} ${s}`),i.length===0?"empty":i.length===1&&s==="unfilled"?"all unfilled":i.join(", ")}function tt(e,t,n=!1){const o=W();o&&o.beginAction("fill"),H=!0,q=n?0:b,ie=!Q,Le(e,t,q,ie);const i=h(e,t);q=i.value,ie=i.certain}function _e(e=!0){if(!H)return;H=!1,q=null;const t=W();t&&(e?t.commitAction():t.cancelAction()),pe()}function Fe(e,t,n){e.onmousedown=o=>{o.preventDefault(),e.focus(),tt(t,n,o.button===2)},e.onmouseenter=()=>{ze(t,n),H&&Le(t,n,q,ie,!0)},e.oncontextmenu=o=>{o.preventDefault()}}function qe(e,t,n){let o=null,i=0,s=!1,r=t,L=n;e.ontouchstart=v=>{var he,me;if(v.touches.length>1)return;if(v.preventDefault(),v.stopPropagation(),s=!1,i=Date.now(),r=t,L=n,window.Cozy.Zoom){const ve=(me=(he=v.touches[0])==null?void 0:he.clientY)!=null?me:0;window.Cozy.Zoom.onCellTouchStart(t,n,ve)}const x=W();x&&x.beginAction("fill"),H=!0,q=b,ie=!Q,o=setTimeout(()=>{if(!s){q=0,Le(r,L,0,ie);const ve=h(r,L);q=ve.value,ie=ve.certain,window.Cozy.App&&window.Cozy.App.vibrate(50)}},U.LONG_PRESS_DELAY),Le(t,n,q,ie);const J=h(t,n);q=J.value,ie=J.certain},e.ontouchmove=v=>{if(v.touches.length>1||!H)return;v.preventDefault(),v.stopPropagation(),s=!0,clearTimeout(o);const x=v.touches[0],J=document.elementFromPoint(x.clientX,x.clientY);if(J&&J.classList.contains("cell")){const he=parseInt(J.dataset.row),me=parseInt(J.dataset.col);!isNaN(he)&&!isNaN(me)&&(Le(he,me,q,ie,!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchMove(he,me))}},e.ontouchend=()=>{clearTimeout(o),_e(!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()},e.ontouchcancel=()=>{clearTimeout(o),_e(!1),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()}}function xe(e){const t=document.getElementById("grid");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,t.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,te&&t.removeEventListener("mouseleave",te),j&&t.removeEventListener("focusout",j),E&&document.removeEventListener("mouseup",E),K=[];for(let n=0;n<e.height;n++)K[n]=[];te=()=>Ce(),t.addEventListener("mouseleave",te),j=n=>{t.contains(n.relatedTarget)||Ce()},t.addEventListener("focusout",j);for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=Ae(n,o);ke(i,n,o),Me(i,n,o),Fe(i,n,o),qe(i,n,o),K[n][o]=i,t.appendChild(i)}E=()=>_e(!0),document.addEventListener("mouseup",E)}function Le(e,t,n,o,i){const s=l()[C],r=h(e,t),L=W();let v=n,x=o;i||(o&&!r.certain&&r.value===n&&n!==null?(v=r.value,x=!0):r.value===n&&r.certain===o&&n!==null&&(v=null,x=!0)),!(r.value===v&&r.certain===x)&&(L&&L.recordChange(e,t,r,{value:v,certain:x}),S(e,t,v,x),Se(e,t,s),window.Cozy.App&&window.Cozy.App.vibrate(10),Be(s),we(),nt(s),Ee())}function Se(e,t,n){var r,L;const o=(r=K[e])==null?void 0:r[t];if(!o)return;const i=h(e,t);if(o.classList.remove("marked-empty","maybe-empty","maybe-color"),o.style.background="",o.style.setProperty("--cell-color",""),o.style.setProperty("--fold-outline-color",""),i.value===null)o.style.background="var(--color-cell)";else if(i.value===0)i.certain?o.classList.add("marked-empty"):o.classList.add("maybe-empty");else{const v=n.color_map[i.value];if(v){const x=window.Cozy.Utils.getDisplayColor(v),J=`rgb(${x[0]}, ${x[1]}, ${x[2]})`;if(i.certain)o.style.background=J;else{o.classList.add("maybe-color"),o.style.setProperty("--cell-color",J);const me=$(x)>U.BRIGHTNESS_MIDPOINT?"rgba(0, 0, 0, 0.6)":"rgba(255, 255, 255, 0.7)";o.style.setProperty("--fold-outline-color",me)}}}let s;if(i.value===null)s="empty";else if(i.value===0)s=i.certain?"marked empty":"maybe empty";else{const v=((L=n.color_names)==null?void 0:L[i.value-1])||`color ${i.value}`;s=i.certain?v:`maybe ${v}`}o.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}, ${s}`)}function Xe(e){const t=[];let n=null,o=0;for(const i of e)i>0?i===n?o++:(n!==null&&t.push({count:o,color:n}),n=i,o=1):n!==null&&(t.push({count:o,color:n}),n=null,o=0);return n!==null&&t.push({count:o,color:n}),t}function Ve(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n].count!==t[n].count||e[n].color!==t[n].color)return!1;return!0}function Be(e){for(let t=0;t<e.height;t++){const n=[];for(let v=0;v<e.width;v++){const x=h(t,v);x.certain?n.push(x.value===null?0:x.value):n.push(-1)}const o=n.includes(-1),i=n.map(v=>v===-1?0:v),s=Xe(i),r=!o&&Ve(s,e.row_clues[t]),L=Z[t];L&&L.classList.toggle("satisfied",r),r!==X[t]&&(X[t]=r,ue(r?`Row ${t+1} complete`:`Row ${t+1} incomplete`))}for(let t=0;t<e.width;t++){const n=[];for(let v=0;v<e.height;v++){const x=h(v,t);x.certain?n.push(x.value===null?0:x.value):n.push(-1)}const o=n.includes(-1),i=n.map(v=>v===-1?0:v),s=Xe(i),r=!o&&Ve(s,e.col_clues[t]),L=ee[t];L&&L.classList.toggle("satisfied",r),r!==oe[t]&&(oe[t]=r,ue(r?`Column ${t+1} complete`:`Column ${t+1} incomplete`))}}function nt(e){for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++)if(!h(o,i).certain)return;for(let o=0;o<e.height;o++){const i=[];for(let r=0;r<e.width;r++){const L=h(o,r);i.push(L.value===null?0:L.value)}const s=Xe(i);if(!Ve(s,e.row_clues[o]))return}for(let o=0;o<e.width;o++){const i=[];for(let r=0;r<e.height;r++){const L=h(r,o);i.push(L.value===null?0:L.value)}const s=Xe(i);if(!Ve(s,e.col_clues[o]))return}ue("Puzzle complete!"),window.Cozy.App&&window.Cozy.App.vibrate([50,100,50]);const t=ne();if(t){const o=I(e);t.completePuzzle(o),Qe(),f();const i=window.Cozy.Collection;i&&i.refresh()}const n=W();n&&n.clear(),mt(e)}function it(){const e=l()[C];if(!e)return;const t=W(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const s=h(o,i);s.value!==null&&(n.push({row:o,col:i,before:{value:s.value,certain:s.certain},after:{value:null,certain:!0}}),s.value=null,s.certain=!0,Se(o,i,e))}if(n.length>0){t&&t.recordBatchAction("reset",n),Be(e);const o=ne();if(o){const i=I(e);o.savePuzzleGrid(i,null)}pe()}we()}function st(){const e=l()[C];if(!e)return;window.Cozy.Zoom&&window.Cozy.Zoom.zoomToFit();const t=W(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const s=h(o,i),r=e.solution[o][i];(s.value!==r||!s.certain)&&n.push({row:o,col:i,before:{value:s.value,certain:s.certain},after:{value:r,certain:!0}}),s.value=r,s.certain=!0,Se(o,i,e)}n.length>0&&t&&t.recordBatchAction("solution",n),Be(e),d("Solution revealed","info"),pe(),we()}function ut(){document.addEventListener("keydown",e=>{var t,n,o;if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")){if((e.ctrlKey||e.metaKey)&&e.key==="z"&&!e.shiftKey&&(e.preventDefault(),Oe()),((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key==="z"||(e.ctrlKey||e.metaKey)&&e.key==="y")&&(e.preventDefault(),Ne()),e.key==="p"&&!e.ctrlKey&&!e.metaKey&&(e.preventDefault(),He()),e.key>="1"&&e.key<="9"&&!e.ctrlKey&&!e.metaKey){const i=parseInt(e.key),s=l()[C],r=Object.keys(s.color_map).map(Number);i<=r.length&&Y(r[i-1])}if((e.key==="0"||e.key==="x")&&!e.ctrlKey&&!e.metaKey&&Y(0),e.key==="Escape"&&!e.ctrlKey&&!e.metaKey){const i=document.getElementById("help-modal"),s=i==null?void 0:i.classList.contains("visible");((t=window.Cozy.Screens)==null?void 0:t.getCurrentScreen())===((o=(n=window.Cozy.Screens)==null?void 0:n.SCREENS)==null?void 0:o.PUZZLE)&&!s&&(e.preventDefault(),Re())}}})}function ot(){const e=l(),t=ne();if(c.length>0&&e[C]&&t){const n=I(e[C]);t.savePuzzleGrid(n,c)}}function Re(){ot(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION)}function dt(e){window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:e})}function ft(e){const t=e.detail||{},n=l();let o=0;t.puzzleId!==void 0&&(o=t.puzzleId,typeof t.puzzleId=="string"&&(o=n.findIndex(i=>I(i)===t.puzzleId),o===-1&&(o=0))),M(o)}function ht(e){ot();const t=e.detail||{},n=window.Cozy.Collection;n&&(t.animateStamp&&t.scrollToPuzzleId?n.refresh({blankPuzzleId:t.scrollToPuzzleId}):n.refresh(),t.scrollToPuzzleId&&setTimeout(()=>{n.scrollToPuzzle(t.scrollToPuzzleId,{instant:t.quickAnimation}),t.animateStamp&&t.flyingStamp&&n.animateStampTo(t.scrollToPuzzleId,t.flyingStamp,{quick:t.quickAnimation})},50))}function mt(e){if(window.Cozy.Screens){const t=I(e),n=e.title.match(/^(.+?)\s*\(/),o=n?n[1].trim():e.title;window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.VICTORY,{puzzleId:t,puzzleName:o,solution:e.solution,palette:e.color_map})}}function pt(){const e=document.getElementById("current-puzzle-title");if(!e)return;const n=l()[C];if(n){const o=n.title.match(/^(.+?)\s*\(/);e.textContent=o?o[1].trim():n.title}}const lt=1200;function rt(e,t){if(!e)return;let n=null,o=!1;function i(r){r.type==="touchstart"&&r.preventDefault(),!e.disabled&&(o||(o=!0,e.classList.add("holding"),ue("Holding, keep holding to confirm"),n=setTimeout(()=>{o&&(e.classList.add("hold-complete"),s(),window.Cozy.App&&window.Cozy.App.vibrate(50),ue("Confirmed"),t(),setTimeout(()=>e.classList.remove("hold-complete"),50))},lt)))}function s(){o=!1,e.classList.remove("holding"),n&&(clearTimeout(n),n=null)}e.addEventListener("mousedown",i),e.addEventListener("mouseup",s),e.addEventListener("mouseleave",s),e.addEventListener("touchstart",i,{passive:!1}),e.addEventListener("touchend",s),e.addEventListener("touchcancel",s),e.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),i(r))}),e.addEventListener("keyup",r=>{(r.key==="Enter"||r.key===" ")&&s()}),e.addEventListener("blur",s),e.style.setProperty("--hold-duration",`${lt}ms`)}function gt(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("undo-btn"),o=document.getElementById("redo-btn");e&&e.addEventListener("click",()=>Te(!1)),t&&t.addEventListener("click",()=>Te(!0)),n&&n.addEventListener("click",Oe),o&&o.addEventListener("click",Ne);const i=document.getElementById("clear-pencil-btn"),s=document.getElementById("confirm-pencil-btn");i&&i.addEventListener("click",()=>{$e(),Ie()}),s&&s.addEventListener("click",()=>{Ge(),Ie()});const r=document.getElementById("reset-btn"),L=document.getElementById("solution-btn");rt(r,it),rt(L,st);const v=document.querySelector("#screen-puzzle .header-back-btn");v&&v.addEventListener("click",at);const x=document.querySelector("#screen-collection .header-back-btn");x&&x.addEventListener("click",()=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.HOME)})}function ct(){ut(),gt(),w(),T();const e=W();e&&e.updateUI(),De();const t=ne();t&&t.onChange&&t.onChange(i=>{i==="reset"&&(c=[],C=0)});const n=window.Cozy.Collection,o=l();n&&o.length>0&&n.init("collection-screen",o,i=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:i})}),window.addEventListener("screen:puzzle",ft),window.addEventListener("screen:collection",ht),o.length>0&&M(0)}function yt(){const t=l()[C];if(!t||c.length===0)return null;let n=!1;for(let o=0;o<t.height&&!n;o++)for(let i=0;i<t.width&&!n;i++){const s=h(o,i);s.value!==null&&s.value>0&&(n=!0)}return n?N(t.width,t.height,U.STAMP_CANVAS_SIZE,(o,i)=>{const s=h(o,i);if(s.value!==null&&s.value>0){const r=t.color_map[s.value];if(r)return window.Cozy.Utils.getDisplayColor(r)}return null}):null}function at(){const t=l()[C];if(!t){Re();return}const n=I(t),o=yt();if(!o){Re();return}const i=document.getElementById("grid");if(!i){Re();return}const s=i.getBoundingClientRect(),r=F(o,s);ot(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION,{scrollToPuzzleId:n,animateStamp:!0,flyingStamp:r,quickAnimation:!0})}function wt(){c=[],C=0,b=1,H=!1,q=null,Q=!1;const e=W();e&&e.clear()}function zt(e,t){const o=l()[C];if(!o)return null;const i=Z[e],s=i?i.classList.contains("satisfied"):!1,r=o.row_clues[e].map(J=>({count:J.count,color:J.color,satisfied:s})),L=ee[t],v=L?L.classList.contains("satisfied"):!1,x=o.col_clues[t].map(J=>({count:J.count,color:J.color,satisfied:v}));return{rowClues:r,colClues:x}}function Ct(e){const n=l()[C];return!n||!n.color_map?null:n.color_map[e]||null}function vt(){return l()[C]||null}window.Cozy.Garden={resetPuzzle:it,showSolution:st,performUndo:Oe,performRedo:Ne,togglePencilMode:He,setPencilMode:Te,clearAllPencilMarks:$e,confirmAllPencilMarks:Ge,selectColor:Y,showCollection:Re,showGame:dt,clearAllState:wt,navigateToCollectionWithStamp:at,getPuzzleId:I,getClueInfo:zt,getColorRgb:Ct,getCurrentPuzzle:vt},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ct):ct()}(),function(){"use strict";const{CONFIG:U}=window.Cozy.Utils,I=.35,V=1,F=.97,N=300,C=1500,B=100,b=10;let c=V,H=V,q=!1,ie=0,Q=0,ce=null,se=null,A=null,E=!1,te=-1,j=-1,K=!1,Z=null,ee=null,X=null,oe=null,g=null,d=null,a=null,z=null;function m(f,M,R){return Math.min(Math.max(f,M),R)}function y(f,M){const R=f.clientX-M.clientX,Y=f.clientY-M.clientY;return Math.sqrt(R*R+Y*Y)}function P(f,M){return{x:(f.clientX+M.clientX)/2,y:(f.clientY+M.clientY)/2}}function w(){const f=window.innerWidth;return f<=360?20:f>=768?28:f>=1200?32:24}function T(f,M=!0){const R=Z;if(!R)return;const Y=c,le=u(),ae=m(f,le,U.MAX_ZOOM);let re,fe;M&&Y!==ae&&(re=R.scrollLeft+R.clientWidth/2,fe=R.scrollTop+R.clientHeight/2),c=ae;const ze=w(),Ce=Math.round(ze*ae);document.documentElement.style.setProperty("--cell-size",`${Ce}px`);const ye=D(),Ae=ae>ye+.01;R.classList.toggle("is-zoomed",Ae),k(),M&&Y!==ae&&re!==void 0&&requestAnimationFrame(()=>{const ke=ae/Y,Me=re*ke-R.clientWidth/2,Pe=fe*ke-R.clientHeight/2;R.scrollLeft=Math.max(0,Me),R.scrollTop=Math.max(0,Pe)}),window.dispatchEvent(new CustomEvent("zoomchange",{detail:{zoom:ae,oldZoom:Y,isZoomed:Ae}}))}function k(){const f=u();if(d&&(d.disabled=c>=U.MAX_ZOOM),a&&(a.disabled=c<=f),z){const M=D(),R=Math.abs(c-M)<.05;z.classList.toggle("highlighted",!R&&c!==M)}}let O=null,_=null;function D(f=!1){var qe;const M=Z;if(!M||!((qe=window.Cozy.Garden)!=null&&qe.getCurrentPuzzle))return V;const R=window.Cozy.Garden.getCurrentPuzzle();if(!R)return V;const Y=R.title;if(!f&&O!==null&&_===Y)return O;const le=w(),ae=Math.max(...R.row_clues.map(xe=>xe.length)),re=Math.max(...R.col_clues.map(xe=>xe.length)),fe=Math.max(2,ae*.6+.5),ze=Math.max(2,re*.6+.5),Ce=R.width+fe+.25,ye=R.height+ze+.25,Ae=M.clientWidth,ke=M.clientHeight,Me=8,Pe=(Ae-Me*2)/(Ce*le),tt=(ke-Me*2)/(ye*le),_e=Math.min(Pe,tt),Fe=m(_e*F,I,U.MAX_ZOOM);return O=Fe,_=Y,Fe}function l(){O=null,_=null}function u(){const f=D();return Math.max(I,f)}function h(){const f=D();return c>f+.01}function S(f){f.touches.length===2&&(q=!0,ie=y(f.touches[0],f.touches[1]),H=c,f.preventDefault())}function p(f){if(q&&f.touches.length===2){const R=y(f.touches[0],f.touches[1])/ie,Y=u(),le=m(H*R,Y,U.MAX_ZOOM);Math.abs(le-c)>.05&&T(le,!0),f.preventDefault()}}function $(f){if(q&&f.touches.length<2&&(q=!1),f.touches.length===0&&!q){const M=f.target;if(!M.classList.contains("cell")){const Y=Date.now();ce===M&&Y-Q<N?(G(f.changedTouches[0]),Q=0,ce=null):(Q=Y,ce=M)}}}function G(f){h()?T(D(),!0):T(U.COMFORTABLE_ZOOM,!0)}function ne(f){if(f.ctrlKey){f.preventDefault();const M=f.deltaY>0?-.15:.15;T(c+M,!0)}}function W(){X&&h()&&X.classList.add("visible")}function be(){X&&(X.classList.remove("visible"),te=-1,j=-1)}function Ke(f,M){var Y,le;if(!X||E||f===te&&M===j)return;te=f,j=M;const R=(le=(Y=window.Cozy.Garden)==null?void 0:Y.getClueInfo)==null?void 0:le.call(Y,f,M);R&&(oe&&(oe.innerHTML=we(R.rowClues)),g&&(g.innerHTML=we(R.colClues)))}function we(f){return!f||f.length===0?'<span class="clue-tooltip-num satisfied">0</span>':f.map(M=>{var re,fe;const R=((fe=(re=window.Cozy.Garden)==null?void 0:re.getColorRgb)==null?void 0:fe.call(re,M.color))||[128,128,128],Y=M.satisfied,ae=(R[0]*299+R[1]*587+R[2]*114)/1e3>U.BRIGHTNESS_MIDPOINT?"#333":"#fff";return`<span class="clue-tooltip-num${Y?" satisfied":""}"
                    style="background: rgb(${R.join(",")}); color: ${ae}">
                ${M.count}
              </span>`}).join("")}function ue(f){if(!X||!Z)return;const M=Z.getBoundingClientRect(),R=M.top+M.height/2;f>R?(X.classList.add("position-top"),X.classList.remove("position-bottom")):(X.classList.remove("position-top"),X.classList.add("position-bottom"))}function Te(){clearTimeout(se),se=setTimeout(()=>{be()},C)}function He(){clearTimeout(se)}function De(f,M,R){h()&&(E=!1,He(),clearTimeout(A),A=setTimeout(()=>{Ke(f,M),ue(R),W()},B))}function We(){h()&&(E=!0,X==null||X.classList.add("dragging"))}function je(){h()&&(clearTimeout(A),E=!1,X==null||X.classList.remove("dragging"),Te())}function Ie(){d=document.querySelector(".zoom-btn.zoom-in"),a=document.querySelector(".zoom-btn.zoom-out"),z=document.querySelector(".zoom-btn.zoom-fit"),d&&d.addEventListener("click",()=>{T(c+.5,!0)}),a&&a.addEventListener("click",()=>{T(c-.5,!0)}),z&&z.addEventListener("click",()=>{T(D(),!0)}),k()}function Ze(f){const M=document.getElementById("screen-puzzle");!M||M.classList.contains("screen-hidden")||(f.key==="+"||f.key==="="?(f.preventDefault(),T(c+.5,!0)):f.key==="-"||f.key==="_"?(f.preventDefault(),T(c-.5,!0)):f.key==="0"&&(f.preventDefault(),T(D(),!0)))}let Ue=null;function Je(){clearTimeout(Ue),Ue=setTimeout(()=>{const f=document.getElementById("screen-puzzle");if(!f||f.classList.contains("screen-hidden"))return;l();const M=u();c<M&&T(M,!1),k()},150)}function pe(){var M,R,Y,le;const f=(R=(M=window.Cozy.Garden)==null?void 0:M.getCurrentPuzzle)==null?void 0:R.call(M);f&&(f.width<=U.AUTO_ZOOM_MIN_SIZE&&f.height<=U.AUTO_ZOOM_MIN_SIZE||(Y=window.Cozy.Storage)!=null&&Y.getFlag("zoomHintShown")||($e(),(le=window.Cozy.Storage)==null||le.setFlag("zoomHintShown",!0)))}function $e(){let f=document.getElementById("zoom-hint-toast");f||(f=document.createElement("div"),f.id="zoom-hint-toast",f.className="zoom-hint-toast",f.textContent="Tip: Pinch to zoom for easier tapping",document.body.appendChild(f)),f.classList.add("visible"),setTimeout(()=>{f.classList.remove("visible")},4e3)}function Ge(){if(!K){if(Z=document.getElementById("zoom-container"),ee=Z==null?void 0:Z.querySelector(".board-wrapper"),X=document.getElementById("clue-tooltip"),oe=document.getElementById("tooltip-row-clues"),g=document.getElementById("tooltip-col-clues"),!Z){console.warn("[Zoom] zoom-container not found, zoom disabled");return}Z.addEventListener("touchstart",S,{passive:!1}),Z.addEventListener("touchmove",p,{passive:!1}),Z.addEventListener("touchend",$,{passive:!0}),Z.addEventListener("wheel",ne,{passive:!1}),Ie(),document.addEventListener("keydown",Ze),window.addEventListener("resize",Je),K=!0,console.log("[Zoom] Initialized")}}function Oe(){l();const f=D();T(f,!1),setTimeout(pe,500)}function Ne(){Ee(!1),be(),clearTimeout(se),clearTimeout(A)}function Ee(f=!0){et(V,f)}function Qe(f=!0){const M=D();et(M,f)}function et(f,M=!0){if(M&&c!==f){let ae=function(re){const fe=re-le,ze=Math.min(fe/Y,1),Ce=1-Math.pow(1-ze,3),ye=R+(f-R)*Ce;T(ye,!1),ze<1&&requestAnimationFrame(ae)};const R=c,Y=200,le=performance.now();requestAnimationFrame(ae)}else T(f,!1)}window.Cozy.Zoom={init:Ge,initForPuzzle:Oe,destroy:Ne,resetZoom:Ee,zoomToFit:Qe,getZoom:()=>c,setZoom:(f,M=!0)=>T(f,!M),zoomIn:(f=.5)=>T(c+f,!0),zoomOut:(f=.5)=>T(c-f,!0),isZoomed:h,onCellTouchStart:De,onCellTouchMove:We,onCellTouchEnd:je,getEffectiveMinZoom:u}}();

//# sourceMappingURL=app.min.js.map