(function(){"use strict";const N={STAMP_CANVAS_SIZE:180,VICTORY_CANVAS_SIZE:180,MINI_CANVAS_SIZE:80,OUTLINE_THICKNESS:2,MAX_PUZZLE_DIMENSION:32,MAX_HISTORY:50,MAX_SCREEN_HISTORY:10,MAX_SEARCH_LENGTH:100,TOAST_DURATION:2500,LONG_PRESS_DELAY:400,SEARCH_DEBOUNCE:150,MAX_ZOOM:3,COMFORTABLE_ZOOM:2,AUTO_ZOOM_MIN_SIZE:10,BRIGHTNESS_MIDPOINT:128,BADGE_MAX_DISPLAY:99};function S(P){return(P.t||P.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"")}function y(P){return P.t||P.title}function k(P){const E=P.match(/^(.+?)\s*\((\d+)x(\d+),\s*(\w+)\)$/i);return E?{name:E[1].trim(),width:parseInt(E[2],10),height:parseInt(E[3],10),difficulty:E[4].toLowerCase()}:{name:P,width:0,height:0,difficulty:"unknown"}}function I(P,E,f,u){const Z=Math.max(P,E),D=Math.max(2,Math.floor(f/Z)),W=N.OUTLINE_THICKNESS*2,ne=N.OUTLINE_THICKNESS,J=document.createElement("canvas");J.width=P*D+W,J.height=E*D+W;const _=J.getContext("2d");if(!_)return console.warn("[Utils] Failed to get 2D context for canvas"),J;try{const re=getComputedStyle(document.documentElement).getPropertyValue("--color-text-muted").trim()||"#8a8a7a";_.fillStyle=re;for(let Q=0;Q<E;Q++)for(let ee=0;ee<P;ee++)if(u(Q,ee)){const ie=ne+ee*D,X=ne+Q*D;_.fillRect(ie-N.OUTLINE_THICKNESS,X-N.OUTLINE_THICKNESS,D+W,D+W)}for(let Q=0;Q<E;Q++)for(let ee=0;ee<P;ee++){const $=u(Q,ee);if($){_.fillStyle=`rgb(${$[0]}, ${$[1]}, ${$[2]})`;const ie=ne+ee*D,X=ne+Q*D;_.fillRect(ie,X,D,D)}}}catch(re){console.error("[Utils] Failed to render canvas:",re)}return J}window.Cozy=window.Cozy||{},window.Cozy.Utils={CONFIG:N,getPuzzleId:S,getPuzzleTitle:y,parsePuzzleTitle:k,renderOutlinedCanvas:I}})(),function(){"use strict";const N="cozy_garden_data";function y(E){return!(!E||typeof E!="object"||typeof E.version!="number"||E.progress!==null&&typeof E.progress!="object"||E.settings!==null&&typeof E.settings!="object"||E.stats!==null&&typeof E.stats!="object")}function k(){return{version:1,progress:{},settings:{vibration:!0,theme:"light"},stats:{totalCompleted:0,totalAttempts:0,totalPlayTime:0,streak:0,lastPlayDate:null},currentSession:{puzzleIndex:0,difficulty:"easy",grid:null,startTime:null},flags:{tutorialCompleted:!1,helpShown:!1,zoomHintShown:!1},uiState:{collapsedSections:[]}}}class I{constructor(){this.data=null,this.listeners=[]}init(){try{const f=localStorage.getItem(N);if(f){const u=JSON.parse(f);y(u)?this.data=u:(console.warn("[Storage] Invalid data structure, using defaults"),this.data=k(),this.save())}else this.data=k(),this.save()}catch(f){console.warn("[Storage] Failed to load, using defaults:",f),this.data=k(),this.save()}return this}save(){try{return localStorage.setItem(N,JSON.stringify(this.data)),this.notifyListeners("save"),!0}catch(f){return console.error("[Storage] Failed to save:",f),!1}}onChange(f){return this.listeners.push(f),()=>{this.listeners=this.listeners.filter(u=>u!==f)}}notifyListeners(f){this.listeners.forEach(u=>u(f,this.data))}getPuzzleProgress(f){return this.data.progress[f]||{completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}}savePuzzleGrid(f,u){this.data.progress||(this.data.progress={}),this.data.progress[f]||(this.data.progress[f]={completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}),u?this.data.progress[f].savedGrid=u.map(Z=>Z.map(D=>({value:D.value,certain:D.certain}))):this.data.progress[f].savedGrid=null,this.save()}getPuzzleGrid(f){if(!this.data.progress)return null;const u=this.data.progress[f];return!u||!u.savedGrid?null:u.savedGrid.map(Z=>Z.map(D=>({value:D.value,certain:D.certain})))}completePuzzle(f){const u=this.getPuzzleProgress(f),Z=!u.completed;return u.completed=!0,u.attempts+=1,u.lastPlayed=Date.now(),u.savedGrid=null,this.data.progress[f]=u,Z&&(this.data.stats.totalCompleted+=1),this.data.stats.totalAttempts+=1,this.updateStreak(),this.save(),{wasNew:Z,progress:u}}isPuzzleCompleted(f){var u;return((u=this.data.progress[f])==null?void 0:u.completed)||!1}getCompletionStats(){return{easy:{completed:0,total:0},medium:{completed:0,total:0},hard:{completed:0,total:0},challenging:{completed:0,total:0},expert:{completed:0,total:0}}}saveSession(f,u,Z){let D=null;Z&&(D=Z.map(W=>W.map(ne=>({value:ne.value,certain:ne.certain})))),this.data.currentSession={puzzleIndex:f,difficulty:u,grid:D},this.save()}getSession(){return this.data.currentSession}clearSession(){this.data.currentSession={puzzleIndex:0,difficulty:"easy",grid:null},this.save()}getSetting(f){return this.data.settings[f]}setSetting(f,u){this.data.settings[f]=u,this.save(),this.notifyListeners("settings")}getSettings(){return{...this.data.settings}}getStats(){return{...this.data.stats}}addPlayTime(f){this.data.stats.totalPlayTime+=f,this.save()}updateStreak(){const f=new Date().toDateString(),u=this.data.stats.lastPlayDate;if(u===f)return;const Z=new Date(Date.now()-864e5).toDateString();u===Z?this.data.stats.streak+=1:u!==f&&(this.data.stats.streak=1),this.data.stats.lastPlayDate=f}getFlag(f){var u;return((u=this.data.flags)==null?void 0:u[f])||!1}setFlag(f,u=!0){this.data.flags||(this.data.flags={}),this.data.flags[f]=u,this.save()}getUIState(f){var u;return(u=this.data.uiState)==null?void 0:u[f]}setUIState(f,u){this.data.uiState||(this.data.uiState={}),this.data.uiState[f]=u,this.save()}exportData(){return JSON.stringify(this.data,null,2)}importData(f){try{const u=JSON.parse(f);return y(u)?(this.data=u,this.save(),!0):!1}catch(u){return console.error("[Storage] Import failed:",u),!1}}reset(){this.data=k(),this.save(),this.notifyListeners("reset")}}const P=new I().init();window.Cozy.Storage=P}(),function(){"use strict";const{CONFIG:N}=window.Cozy.Utils;let S=[],y=[],k=null;const I={beginAction(P="fill"){k&&k.changes.length>0&&this.commitAction(),k={type:P,changes:[],timestamp:Date.now()}},recordChange(P,E,f,u){if(f.value===u.value&&f.certain===u.certain)return;k||this.beginAction("fill");const Z=k.changes.find(D=>D.row===P&&D.col===E);Z?Z.after={value:u.value,certain:u.certain}:k.changes.push({row:P,col:E,before:{value:f.value,certain:f.certain},after:{value:u.value,certain:u.certain}})},commitAction(){k&&k.changes.length>0&&(k.changes=k.changes.filter(P=>P.before.value!==P.after.value||P.before.certain!==P.after.certain),k.changes.length>0&&(S.push(k),S.length>N.MAX_HISTORY&&S.shift(),y=[]),this.updateUI()),k=null},cancelAction(){k=null},recordBatchAction(P,E){if(E.length===0)return;const f={type:P,changes:E.map(u=>({row:u.row,col:u.col,before:{value:u.before.value,certain:u.before.certain},after:{value:u.after.value,certain:u.after.certain}})),timestamp:Date.now()};S.push(f),S.length>N.MAX_HISTORY&&S.shift(),y=[],this.updateUI()},undo(){if(S.length===0)return null;const P=S.pop();return y.push(P),this.updateUI(),P.changes.map(E=>({row:E.row,col:E.col,state:{value:E.before.value,certain:E.before.certain}}))},redo(){if(y.length===0)return null;const P=y.pop();return S.push(P),this.updateUI(),P.changes.map(E=>({row:E.row,col:E.col,state:{value:E.after.value,certain:E.after.certain}}))},canUndo(){return S.length>0},canRedo(){return y.length>0},clear(){S=[],y=[],k=null,this.updateUI()},updateUI(){const P=document.getElementById("undo-btn"),E=document.getElementById("redo-btn");P&&(P.disabled=!this.canUndo()),E&&(E.disabled=!this.canRedo())},getStats(){return{undoDepth:S.length,redoDepth:y.length,hasPending:k!==null,pendingChanges:k?k.changes.length:0}}};window.Cozy.History=I}();const ScreenManager=function(){"use strict";const{CONFIG:N,renderOutlinedCanvas:S}=window.Cozy.Utils,y={SPLASH:"splash",HOME:"home",COLLECTION:"collection",PUZZLE:"puzzle",VICTORY:"victory",SETTINGS:"settings",TUTORIAL:"tutorial"};let k=null,I=[],P={},E={},f=null;function u(l){const c=document.getElementById("confirm-modal"),h=document.getElementById("confirm-modal-title"),A=document.getElementById("confirm-modal-message"),r=document.getElementById("confirm-modal-confirm"),O=document.getElementById("confirm-modal-cancel");c&&(h.textContent=l.title||"Confirm",A.textContent=l.message||"Are you sure?",r.textContent=l.confirmText||"Confirm",O.textContent=l.cancelText||"Cancel",r.classList.toggle("confirm-modal-btn-danger",!!l.danger),r.classList.toggle("confirm-modal-btn-primary",!l.danger),c.classList.remove("alert-mode"),f=l,c.classList.add("visible"),setTimeout(()=>r.focus(),100))}function Z(l){const c=document.getElementById("confirm-modal"),h=document.getElementById("confirm-modal-title"),A=document.getElementById("confirm-modal-message"),r=document.getElementById("confirm-modal-confirm");c&&(h.textContent=l.title||"Notice",A.textContent=l.message||"",r.textContent=l.buttonText||"OK",r.classList.remove("confirm-modal-btn-danger"),r.classList.add("confirm-modal-btn-primary"),c.classList.add("alert-mode"),f={onConfirm:l.onClose},c.classList.add("visible"),setTimeout(()=>r.focus(),100))}function D(){const l=document.getElementById("confirm-modal");l&&l.classList.remove("visible"),f=null}function W(){const l=document.getElementById("confirm-modal"),c=l==null?void 0:l.querySelector(".confirm-modal-backdrop"),h=document.getElementById("confirm-modal-confirm"),A=document.getElementById("confirm-modal-cancel");l&&(h==null||h.addEventListener("click",()=>{const r=f==null?void 0:f.onConfirm;D(),r&&setTimeout(r,200)}),A==null||A.addEventListener("click",()=>{const r=f==null?void 0:f.onCancel;D(),r&&r()}),c==null||c.addEventListener("click",()=>{const r=f==null?void 0:f.onCancel;D(),r&&r()}),document.addEventListener("keydown",r=>{if(r.key==="Escape"&&l.classList.contains("visible")){const O=f==null?void 0:f.onCancel;D(),O&&O()}if(r.key==="Tab"&&l.classList.contains("visible")){const m=l.classList.contains("alert-mode")?[h]:[A,h],x=m[0],G=m[m.length-1];m.includes(document.activeElement)?r.shiftKey?document.activeElement===x&&(r.preventDefault(),G.focus()):document.activeElement===G&&(r.preventDefault(),x.focus()):(r.preventDefault(),x.focus())}}))}function ne(){U(),W(),Object.values(y).forEach(l=>{E[l]=document.getElementById(`screen-${l}`)}),window.addEventListener("popstate",Q),document.addEventListener("keydown",J),_(y.SPLASH,{},!1)}function J(l){if(l.key!=="Escape"||l.target.tagName==="INPUT"||l.target.tagName==="TEXTAREA")return;const c=document.getElementById("confirm-modal"),h=document.getElementById("help-modal");if(!(c!=null&&c.classList.contains("visible")||h!=null&&h.classList.contains("visible")))switch(k){case y.HOME:break;case y.COLLECTION:_(y.HOME);break;case y.PUZZLE:break;case y.VICTORY:_(y.COLLECTION);break;case y.SETTINGS:_(y.HOME);break;case y.TUTORIAL:window.Cozy.Storage&&window.Cozy.Storage.setFlag("tutorialComplete",!0),_(y.HOME);break}}function _(l,c={},h=!0){const A=E[l];if(!A){console.error(`Screen not found: ${l}`);return}P=c,k&&E[k]&&(k===y.PUZZLE&&window.Cozy.Zoom&&window.Cozy.Zoom.destroy(),E[k].classList.remove("screen-active"),E[k].classList.add("screen-hidden")),A.classList.remove("screen-hidden"),A.classList.add("screen-active"),h&&k!==null&&(I.push(k),I.length>N.MAX_SCREEN_HISTORY&&(I=I.slice(-N.MAX_SCREEN_HISTORY)),history.pushState({screen:l},"",`#${l}`));const r=k;k=l,ee(l,c,r)}function re(){if(I.length>0){const l=I.pop();_(l,{},!1),history.back()}}function Q(l){if(l.state&&l.state.screen)_(l.state.screen,{},!1);else if(I.length>0){const c=I.pop();_(c,{},!1)}}function ee(l,c,h){switch(l){case y.SPLASH:X();break;case y.HOME:ze();break;case y.COLLECTION:p(c);break;case y.PUZZLE:z(c);break;case y.VICTORY:b(c);break;case y.SETTINGS:L();break;case y.TUTORIAL:B();break}}function $(){return P}function ie(){return k}function X(){setTimeout(()=>{var A;if(new URLSearchParams(window.location.search).get("action")==="continue"){const r=window.location.pathname+window.location.hash;history.replaceState(null,"",r);const O=window.Cozy.Storage;if(O){const m=O.getSession();if(m&&typeof m.puzzleIndex=="number"){_(y.PUZZLE,{puzzleId:m.puzzleIndex});return}}}const h=(A=window.Cozy.Storage)==null?void 0:A.getFlag("tutorialCompleted");_(h?y.HOME:y.TUTORIAL)},1500)}function ze(){var A;const l=document.getElementById("home-play-btn"),c=document.getElementById("home-settings-btn"),h=document.getElementById("home-progress");if(l&&!l.hasAttribute("data-initialized")&&(l.addEventListener("click",()=>_(y.COLLECTION)),l.setAttribute("data-initialized","true")),c&&!c.hasAttribute("data-initialized")&&(c.addEventListener("click",()=>_(y.SETTINGS)),c.setAttribute("data-initialized","true")),h&&window.PUZZLE_DATA){const r=window.PUZZLE_DATA,O=Array.isArray(r)?r.length:0;let m=0;window.Cozy.Storage&&((A=window.Cozy.Garden)!=null&&A.getPuzzleId)&&r.forEach(x=>{const G=window.Cozy.Garden.getPuzzleId(x);window.Cozy.Storage.isPuzzleCompleted(G)&&m++}),h.textContent=`${m} / ${O} puzzles solved`}l&&setTimeout(()=>l.focus(),100)}function p(l){window.dispatchEvent(new CustomEvent("screen:collection",{detail:l}));const c=document.getElementById("collection-search-input");c&&setTimeout(()=>c.focus(),100)}function z(l){window.Cozy.Zoom&&window.Cozy.Zoom.init(),window.dispatchEvent(new CustomEvent("screen:puzzle",{detail:l}))}let g=null;function b(l){const c=document.getElementById("victory-puzzle-name"),h=document.getElementById("victory-image"),A=document.getElementById("victory-continue-btn");g=l.puzzleId,c&&l.puzzleName&&(c.textContent=l.puzzleName),h&&l.solution&&w(h,l.solution,l.palette),A&&!A.hasAttribute("data-initialized")&&(A.addEventListener("click",()=>{const r=h?h.querySelector("canvas"):null;if(r){const O=h.getBoundingClientRect(),m=document.createElement("canvas");m.width=r.width,m.height=r.height,m.getContext("2d").drawImage(r,0,0);const G=r.width,se=r.height,j=r.width/r.height,te=Math.min(O.width,O.height);let q;j>1?q=te:q=te*j;const ye=q/G,we=O.left+O.width/2,me=O.top+O.height/2;m.className="flying-stamp",m.style.left=we-G/2+"px",m.style.top=me-se/2+"px",m.style.width=G+"px",m.style.height=se+"px",m.style.transform="scale("+ye+")",document.body.appendChild(m),_(y.COLLECTION,{scrollToPuzzleId:g,animateStamp:!0,flyingStamp:m})}else _(y.COLLECTION,{scrollToPuzzleId:g})}),A.setAttribute("data-initialized","true")),A&&setTimeout(()=>A.focus(),100)}function w(l,c,h){l.innerHTML="";const A=c.length,r=c[0]?c[0].length:A,O=S(r,A,N.VICTORY_CANVAS_SIZE,(m,x)=>{const G=c[m][x];return G>0&&h[G]?h[G]:null});l.appendChild(O)}function L(){var G,se;const l=document.getElementById("settings-back-btn"),c=document.getElementById("settings-vibration"),h=document.getElementById("settings-reset-btn"),A=window.Cozy.Storage;c&&(c.checked=(G=A==null?void 0:A.getSetting("vibration"))!=null?G:!0),l&&!l.hasAttribute("data-initialized")&&(l.addEventListener("click",re),l.setAttribute("data-initialized","true")),c&&!c.hasAttribute("data-initialized")&&(c.addEventListener("change",()=>A==null?void 0:A.setSetting("vibration",c.checked)),c.setAttribute("data-initialized","true")),h&&!h.hasAttribute("data-initialized")&&(h.addEventListener("click",()=>{u({title:"Reset Progress",message:"Are you sure you want to reset all progress? This cannot be undone.",confirmText:"Reset",cancelText:"Cancel",danger:!0,onConfirm:()=>{window.Cozy.Garden&&window.Cozy.Garden.clearAllState&&window.Cozy.Garden.clearAllState(),window.Cozy.Storage&&window.Cozy.Storage.reset&&window.Cozy.Storage.reset(),window.Cozy.Collection&&window.Cozy.Collection.refresh(),Z({title:"Progress Reset",message:"All progress has been cleared."})}})}),h.setAttribute("data-initialized","true"));const r=document.getElementById("settings-tutorial-btn");r&&!r.hasAttribute("data-initialized")&&(r.addEventListener("click",()=>{_(y.TUTORIAL)}),r.setAttribute("data-initialized","true"));const O=document.querySelectorAll(".theme-option");let m=(se=window.Cozy.Storage)==null?void 0:se.getSetting("theme");(!m||m==="system")&&(m=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),O.forEach(j=>{const q=j.dataset.theme===m;j.classList.toggle("active",q),j.setAttribute("aria-pressed",q?"true":"false")}),O.forEach(j=>{j.hasAttribute("data-initialized")||(j.addEventListener("click",()=>{const te=j.dataset.theme;O.forEach(q=>{q.classList.remove("active"),q.setAttribute("aria-pressed","false")}),j.classList.add("active"),j.setAttribute("aria-pressed","true"),window.Cozy.Storage&&window.Cozy.Storage.setSetting("theme",te),H(te)}),j.setAttribute("data-initialized","true"))});const x=document.getElementById("settings-solve-all-btn");x&&!x.hasAttribute("data-initialized")&&(x.addEventListener("click",()=>{u({title:"Debug: Solve All",message:"Mark all puzzles as solved? This is a debug feature.",confirmText:"Solve All",cancelText:"Cancel",onConfirm:()=>{const j=window.PUZZLE_DATA||[],te=window.Cozy.Storage;te&&j.forEach(q=>{var we;let ye;(we=window.Cozy.Garden)!=null&&we.getPuzzleId?ye=window.Cozy.Garden.getPuzzleId(q):ye=(q.t||q.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""),te.completePuzzle(ye)}),window.Cozy.Collection&&window.Cozy.Collection.refresh(),Z({title:"All Puzzles Solved",message:`Marked ${j.length} puzzles as solved!`})}})}),x.setAttribute("data-initialized","true")),c&&setTimeout(()=>c.focus(),100)}let R=0;function B(){const l=document.getElementById("tutorial-skip-btn"),c=document.getElementById("tutorial-next-btn"),h=document.querySelectorAll(".tutorial-step"),A=document.querySelectorAll(".tutorial-dot");function r(m){h.forEach((x,G)=>{x.classList.toggle("active",G===m)}),A.forEach((x,G)=>{x.classList.toggle("active",G===m)}),c&&(c.textContent=m===h.length-1?"Start Playing":"Next")}function O(){var m;(m=window.Cozy.Storage)==null||m.setFlag("tutorialCompleted",!0),_(y.HOME)}l&&!l.hasAttribute("data-initialized")&&(l.addEventListener("click",O),l.setAttribute("data-initialized","true")),c&&!c.hasAttribute("data-initialized")&&(c.addEventListener("click",()=>{R<h.length-1?(R++,r(R)):O()}),c.setAttribute("data-initialized","true")),R=0,r(0),c&&setTimeout(()=>c.focus(),100)}function H(l){document.documentElement.setAttribute("data-theme",l);const c=document.getElementById("theme-color-meta");c&&c.setAttribute("content",l==="dark"?"#0a1018":"#4a7c3f")}function U(){var c;let l=(c=window.Cozy.Storage)==null?void 0:c.getSetting("theme");(!l||l==="system")&&(l=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),H(l)}return{init:ne,showScreen:_,goBack:re,getScreenData:$,getCurrentScreen:ie,applyTheme:H,initTheme:U,showConfirmModal:u,SCREENS:y}}();window.Cozy.Screens=ScreenManager,document.addEventListener("DOMContentLoaded",()=>{ScreenManager.init()}),function(){"use strict";const{CONFIG:N,getPuzzleId:S,getPuzzleTitle:y,parsePuzzleTitle:k,renderOutlinedCanvas:I}=window.Cozy.Utils,P=["easy","medium","hard","challenging","expert"];function E(){var z;const p=(z=window.Cozy.Storage)==null?void 0:z.getUIState("collapsedSections");return p&&typeof p=="object"?p:null}function f(p){var z;(z=window.Cozy.Storage)==null||z.setUIState("collapsedSections",p)}function u(p,z){const g=document.querySelector(`.collection-section[data-difficulty="${p}"]`);if(!g)return;const b=z[p];z[p]=!b,f(z),g.classList.toggle("collapsed",!b);const w=g.querySelector(".collection-grid"),L=g.querySelector(".section-chevron");w&&(w.style.display=b?"flex":"none"),L&&(L.textContent=b?"\u25BC":"\u25B6")}function Z(){return window.Cozy.Storage||null}function D(p){const z={};return p.forEach((g,b)=>{const w=k(y(g)),L=w.difficulty;z[L]||(z[L]=[]),z[L].push({index:b,puzzle:g,meta:w,id:S(g)})}),z}function W(p){const z={};return p.forEach(g=>{const b=k(y(g.puzzle)),w=b.difficulty;z[w]||(z[w]=[]),z[w].push({index:g.originalIndex,puzzle:g.puzzle,meta:b,id:S(g.puzzle)})}),z}function ne(p){return Object.keys(p).sort((g,b)=>{const w=P.indexOf(g),L=P.indexOf(b);return w!==-1&&L!==-1?w-L:w!==-1?-1:L!==-1?1:g.localeCompare(b)})}function J(p){return p.charAt(0).toUpperCase()+p.slice(1)}function _(p){const z=Z();let g=0;return z&&p.forEach(b=>{z.isPuzzleCompleted(b.id)&&g++}),{completed:g,total:p.length}}function re(p){if(!p)return!1;for(const z of p)for(const g of z)if((typeof g=="object"&&g!==null?g.value:g)!==null)return!0;return!1}function Q(p,z,g={}){const b=Z(),w=b?b.isPuzzleCompleted(p.id):!1,L=b?b.getPuzzleGrid(p.id):null,R=!w&&re(L),B=document.createElement("div");B.className="puzzle-card"+(w?" completed":"")+(R?" in-progress":""),B.dataset.puzzleIndex=p.index,B.dataset.puzzleId=p.id,B.tabIndex=-1,B.setAttribute("role","button"),B.setAttribute("aria-label",`${p.meta.name}, ${p.meta.width} by ${p.meta.height}${w?", completed":""}`),B.addEventListener("keydown",h=>{if(h.key==="Enter"||h.key===" "){h.preventDefault(),window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=p.id),z(p.index);return}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(h.key)&&(h.preventDefault(),h.stopPropagation(),window.Cozy.Collection&&window.Cozy.Collection.navigateFromCard(B,h.key))});const H=document.createElement("div");if(H.className="puzzle-card-preview",g.forceBlank){H.classList.add("awaiting-stamp");const h=document.createElement("div");h.className="puzzle-card-placeholder",h.textContent="?",H.appendChild(h)}else if(w)H.appendChild(ee(p.puzzle));else if(R)H.appendChild($(p.puzzle,L));else{const h=document.createElement("div");h.className="puzzle-card-placeholder",h.textContent="?",H.appendChild(h)}B.appendChild(H);const U=document.createElement("div");U.className="puzzle-card-name",U.textContent=p.meta.name,B.appendChild(U);const l=Object.keys(p.puzzle.color_map).length,c=document.createElement("div");return c.className="puzzle-card-badge",c.textContent=`${p.meta.width}\xD7${p.meta.height} \xB7 ${l}c`,B.appendChild(c),B.addEventListener("click",()=>{window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=p.id),z(p.index)}),B}function ee(p){try{const z=I(p.width,p.height,N.MINI_CANVAS_SIZE,(g,b)=>{var L,R,B;const w=(R=(L=p.solution)==null?void 0:L[g])==null?void 0:R[b];if(w>0){const H=(B=p.color_map)==null?void 0:B[w];if(H&&Array.isArray(H)&&H.length>=3)return H}return null});return z.className="puzzle-mini-canvas",z}catch(z){return console.error("[Collection] Error creating mini solution:",z),null}}function $(p,z){try{const g=I(p.width,p.height,N.MINI_CANVAS_SIZE,(b,w)=>{var B,H;const L=(B=z==null?void 0:z[b])==null?void 0:B[w],R=typeof L=="object"&&L!==null?L.value:L;if(R!==null&&R>0){const U=(H=p.color_map)==null?void 0:H[R];if(U&&Array.isArray(U)&&U.length>=3)return U}return null});return g.className="puzzle-mini-canvas",g}catch(g){return console.error("[Collection] Error creating mini progress:",g),null}}function ie(p,z,g,b={}){p.innerHTML="";const w=(b.searchFilter||"").toLowerCase().trim().slice(0,N.MAX_SEARCH_LENGTH);let L=z.map((l,c)=>({puzzle:l,originalIndex:c}));w&&(L=L.filter(l=>k(y(l.puzzle)).name.toLowerCase().includes(w)));const R=W(L),B=ne(R),H=Z();if(B.length===0&&w){const l=document.createElement("div");l.className="collection-empty-state";const c=document.createElement("p");c.className="collection-empty-message",c.textContent=`No puzzles match "${w}"`,l.appendChild(c),p.appendChild(l);return}let U;if(w)U={},B.forEach(l=>{U[l]=!1});else if(U=E(),!U){U={};let l=!1;B.forEach(c=>{const h=_(R[c]);!l&&h.completed<h.total?(U[c]=!1,l=!0):U[c]=!0}),!l&&B.length>0&&(U[B[0]]=!1),f(U)}B.forEach(l=>{const c=R[l],h=_(c),A=U[l],r=document.createElement("div");r.className="collection-section"+(A?" collapsed":""),r.dataset.difficulty=l;const O=document.createElement("div");O.className="collection-section-header",O.style.cursor="pointer";const m=document.createElement("span");m.className="section-chevron",m.textContent=A?"\u25B6":"\u25BC",O.appendChild(m);const x=document.createElement("h3");x.className="collection-section-title",x.textContent=J(l),O.appendChild(x);const G=document.createElement("span");G.className="collection-section-stats",G.textContent=`${h.completed}/${h.total}`,h.completed===h.total&&h.total>0&&G.classList.add("complete"),O.appendChild(G),O.addEventListener("click",()=>{u(l,U)}),r.appendChild(O);const se=document.createElement("div");se.className="collection-grid",se.style.display=A?"none":"flex",c.forEach(j=>{const te={};b.blankPuzzleId&&j.id===b.blankPuzzleId&&(te.forceBlank=!0);const q=Q(j,g,te);se.appendChild(q)}),r.appendChild(se),p.appendChild(r)})}class X{constructor(){this.container=null,this.puzzles=[],this.onPuzzleSelect=null,this.visible=!0,this.searchFilter="",this.searchInput=null,this.searchInputHandler=null,this.searchDebounceTimeout=null,this.focusedCardId=null}init(z,g,b){return this.container=document.getElementById(z),this.puzzles=g,this.onPuzzleSelect=b,this.searchInput=document.getElementById("collection-search-input"),this.searchInput&&(this.searchInputHandler&&this.searchInput.removeEventListener("input",this.searchInputHandler),this.searchInputHandler=w=>{this.searchFilter=w.target.value,this.searchDebounceTimeout&&clearTimeout(this.searchDebounceTimeout),this.searchDebounceTimeout=setTimeout(()=>this.render(),150)},this.searchInput.addEventListener("input",this.searchInputHandler)),this.container&&this.render(),this}render(z={}){if(!this.container)return;const g={...z,searchFilter:this.searchFilter};ie(this.container,this.puzzles,b=>{this.onPuzzleSelect&&this.onPuzzleSelect(b)},g),this.updateRovingTabindex()}show(){this.container&&(this.container.style.display="block",this.visible=!0,this.searchFilter="",this.searchInput&&(this.searchInput.value=""),this.render())}hide(){this.container&&(this.container.style.display="none",this.visible=!1)}isVisible(){return this.visible}refresh(z={}){this.visible&&this.render(z)}getVisibleCards(){if(!this.container)return[];const z=[];return this.container.querySelectorAll(".collection-section").forEach(b=>{const w=b.querySelector(".collection-grid");w&&w.style.display!=="none"&&w.querySelectorAll(".puzzle-card").forEach(R=>z.push(R))}),z}findCardInDirection(z,g){const b=this.getVisibleCards();if(b.length===0)return null;const w=z.getBoundingClientRect(),L=w.left+w.width/2,R=w.top+w.height/2,B=w.height*.5,H=w.width*.5;let U=null,l=1/0;return b.forEach(c=>{if(c===z)return;const h=c.getBoundingClientRect(),A=h.left+h.width/2,r=h.top+h.height/2;let O=!1;switch(g){case"left":O=A<L-H&&Math.abs(r-R)<B;break;case"right":O=A>L+H&&Math.abs(r-R)<B;break;case"up":O=r<R-B;break;case"down":O=r>R+B;break}if(O){let m;if(g==="left"||g==="right")m=Math.abs(A-L);else{const x=Math.abs(r-R),G=Math.abs(A-L);m=x*1e3+G}m<l&&(l=m,U=c)}}),U}navigateFromCard(z,g){const w={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[g];if(!w)return;const L=this.findCardInDirection(z,w);L&&(z.tabIndex=-1,L.tabIndex=0,L.focus(),this.focusedCardId=L.dataset.puzzleId,L.scrollIntoView({behavior:"smooth",block:"nearest"}))}updateRovingTabindex(){const z=this.getVisibleCards();if(z.length===0)return;let g=null;if(this.focusedCardId){const b=this.container.querySelector(`.puzzle-card[data-puzzle-id="${this.focusedCardId}"]`);b&&z.includes(b)&&(g=b)}g||(g=z[0],this.focusedCardId=(g==null?void 0:g.dataset.puzzleId)||null),z.forEach(b=>{b.tabIndex=b===g?0:-1})}scrollToPuzzle(z,g={}){if(!this.container)return;const b=this.container.querySelectorAll(".puzzle-card");let w=null,L=-1;for(let H=0;H<this.puzzles.length;H++)if(S(this.puzzles[H])===z){L=H;break}if(L===-1||(b.forEach(H=>{parseInt(H.dataset.puzzleIndex,10)===L&&(w=H)}),!w))return;const R=w.closest(".collection-section");if(R&&R.classList.contains("collapsed")){const H=R.dataset.difficulty,U=R.querySelector(".collection-grid"),l=R.querySelector(".section-chevron");R.classList.remove("collapsed"),U&&(U.style.display="flex"),l&&(l.textContent="\u25BC");let c=E()||{};c[H]=!1,f(c)}const B=g.instant?"instant":"smooth";setTimeout(()=>{w.scrollIntoView({behavior:B,block:"center"})},g.instant?0:100)}animateStampTo(z,g,b={}){if(!this.container||!g)return;const w=this.container.querySelector(`.puzzle-card[data-puzzle-id="${z}"]`);if(!w){g.remove();return}const L=w.querySelector(".puzzle-card-preview");if(!L){g.remove();return}setTimeout(()=>{const B=L.getBoundingClientRect(),H=parseFloat(g.style.width),U=parseFloat(g.style.height),l=this.puzzles.find(m=>S(m)===z);let c,h;if(l){const m=Math.max(l.width,l.height),x=Math.max(2,Math.floor(N.MINI_CANVAS_SIZE/m)),G=N.OUTLINE_THICKNESS*2;c=l.width*x+G,h=l.height*x+G}else{const m=H/U;m>1?(c=B.width,h=B.width/m):(h=B.height,c=B.height*m)}const A=c/H,r=B.left+B.width/2,O=B.top+B.height/2;requestAnimationFrame(()=>{g.style.left=r-H/2+"px",g.style.top=O-U/2+"px",g.style.transform="scale("+A+")",g.classList.add("landed")}),setTimeout(()=>{L.classList.remove("awaiting-stamp"),L.innerHTML="";const m=this.puzzles.find(x=>S(x)===z);if(m){const x=Z();if(x?x.isPuzzleCompleted(z):!1)L.appendChild(ee(m));else{const se=x?x.getPuzzleGrid(z):null;se&&L.appendChild($(m,se))}}g.remove()},650)},100)}}const ze=new X;window.Cozy.Collection=ze}(),function(){"use strict";const N={isInstalled:!1,swRegistration:null,resizeTimeout:null,init(){this.checkInstallState(),this.registerServiceWorker(),this.setupEventListeners(),console.log("[App] Cozy Garden initialized")},checkInstallState(){window.matchMedia("(display-mode: standalone)").matches&&(this.isInstalled=!0),window.navigator.standalone===!0&&(this.isInstalled=!0),this.isInstalled&&(document.body.classList.add("is-installed"),console.log("[App] Running as installed PWA"))},async registerServiceWorker(){if(!("serviceWorker"in navigator)){console.log("[App] Service workers not supported");return}try{this.swRegistration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("[App] Service worker registered:",this.swRegistration.scope),this.swRegistration.addEventListener("updatefound",()=>{const S=this.swRegistration.installing;console.log("[App] New service worker installing..."),S.addEventListener("statechange",()=>{S.state==="installed"&&navigator.serviceWorker.controller&&this.showUpdateNotification()})})}catch(S){console.error("[App] Service worker registration failed:",S)}},showUpdateNotification(){const S=document.createElement("div");S.className="update-banner";const y=document.createElement("span");y.textContent="A new version is available!";const k=document.createElement("button");k.textContent="Update",k.addEventListener("click",()=>this.applyUpdate());const I=document.createElement("button");I.textContent="Later",I.addEventListener("click",()=>S.remove()),S.appendChild(y),S.appendChild(k),S.appendChild(I),document.body.appendChild(S)},applyUpdate(){this.swRegistration&&this.swRegistration.waiting&&this.swRegistration.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload()},setupEventListeners(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?this.onAppFocus():this.onAppBlur()}),window.addEventListener("beforeunload",()=>{this.saveState()}),window.addEventListener("orientationchange",()=>{setTimeout(()=>this.handleResize(),100)}),window.addEventListener("resize",()=>{this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>this.handleResize(),100)})},onAppFocus(){console.log("[App] App focused")},onAppBlur(){console.log("[App] App blurred"),this.saveState()},saveState(){window.Cozy.Garden&&window.Cozy.Storage&&console.log("[App] Saving state...")},handleResize(){const S=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${S}px`)},isPWA(){return this.isInstalled||window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0},async getVersion(){return!this.swRegistration||!navigator.serviceWorker.controller?"unknown":new Promise(S=>{const y=new MessageChannel;y.port1.onmessage=k=>{S(k.data.version||"unknown")},navigator.serviceWorker.controller.postMessage({type:"GET_VERSION"},[y.port2]),setTimeout(()=>S("unknown"),1e3)})},async share(S,y,k){if(navigator.share)try{return await navigator.share({title:S,text:y,url:k}),!0}catch(I){return I.name!=="AbortError"&&console.error("[App] Share failed:",I),!1}return!1},vibrate(S=50){var y;navigator.vibrate&&((y=window.Cozy.Storage)!=null&&y.getSetting("vibration"))&&navigator.vibrate(S)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>N.init()):N.init(),window.Cozy.App=N}(),function(){"use strict";const{CONFIG:N,getPuzzleId:S,getPuzzleTitle:y,renderOutlinedCanvas:k}=window.Cozy.Utils;let I=0,P="easy",E=1,f=[],u=!1,Z=null,D=!0,W=!1,ne=!1,J=0,_=0,re=null,Q=null,ee=null,$=[],ie=[],X=[],ze=[],p=[],z=null;function g(e,t="info"){const n=document.getElementById("toast");n&&(clearTimeout(z),n.textContent=e,n.className="toast visible",t==="success"?n.classList.add("toast-success"):t==="info"&&n.classList.add("toast-info"),z=setTimeout(()=>{n.classList.remove("visible")},N.TOAST_DURATION))}function b(){const e=document.getElementById("toast");e&&(clearTimeout(z),e.classList.remove("visible"))}function w(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function L(){const e=document.getElementById("help-list");if(!e)return;const t=w();let n=["<li><strong>Select a color</strong> from the palette, then tap cells to fill them</li>","<li><strong>Drag</strong> across cells to fill multiple at once</li>","<li><strong>Long-press</strong> a cell to mark it \u2715 (definitely empty)</li>","<li><strong>Pencil mode</strong> marks uncertain guesses \u2014 confirm or clear them later</li>"];t&&n.push("<li><strong>Pinch to zoom</strong> on larger puzzles for easier tapping</li>"),t||(n.push('<li class="help-section-title">Keyboard Shortcuts</li>'),n.push("<li><strong>Ctrl+Z</strong> / <strong>Ctrl+Y</strong> \u2014 Undo / Redo</li>"),n.push("<li><strong>P</strong> \u2014 Toggle pencil mode</li>"),n.push("<li><strong>1-9</strong> \u2014 Select color by number</li>"),n.push("<li><strong>+</strong> / <strong>-</strong> \u2014 Zoom in / out</li>")),e.innerHTML=n.join("")}function R(){const e=document.getElementById("help-modal");if(!e)return;L(),e.classList.add("visible"),document.body.style.overflow="hidden";const t=e.querySelector(".help-modal-close");t&&setTimeout(()=>t.focus(),100)}function B(){const e=document.getElementById("help-modal");e&&(e.classList.remove("visible"),document.body.style.overflow="")}function H(){const e=document.getElementById("help-btn"),t=document.getElementById("help-modal"),n=t==null?void 0:t.querySelector(".help-modal-backdrop"),o=t==null?void 0:t.querySelector(".help-modal-close");e&&e.addEventListener("click",R),n&&n.addEventListener("click",B),o&&o.addEventListener("click",B),document.addEventListener("keydown",i=>{if(t!=null&&t.classList.contains("visible")){if(i.key==="Escape"){B();return}i.key==="Tab"&&(document.activeElement!==o?(i.preventDefault(),o==null||o.focus()):i.preventDefault())}})}function U(){const e=document.getElementById("skip-to-puzzle");e&&e.addEventListener("click",t=>{var o;t.preventDefault();const n=(o=$[0])==null?void 0:o[0];n&&n.focus()})}function l(){var e;(e=window.Cozy.Storage)!=null&&e.getFlag("helpShown")||setTimeout(()=>{var t;R(),(t=window.Cozy.Storage)==null||t.setFlag("helpShown",!0)},500)}function c(e){if(!e)return null;if(e.title!==void 0)return!e.width||!e.height||!e.row_clues||!e.col_clues||!e.color_map?(console.warn("[Game] Invalid verbose puzzle format:",e.title),null):e;if(!e.t||!e.w||!e.h||!Array.isArray(e.r)||!Array.isArray(e.c)||!Array.isArray(e.p)||!Array.isArray(e.s))return console.warn("[Game] Invalid concise puzzle format, missing or malformed fields:",e.t),null;if(e.w>N.MAX_PUZZLE_DIMENSION||e.h>N.MAX_PUZZLE_DIMENSION||e.w<1||e.h<1)return console.warn("[Game] Puzzle dimensions out of range:",e.w,"x",e.h),null;function t(s){const a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(s);return a?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:[0,0,0]}function n(s){return s.map(a=>a.map(([v,C])=>({count:v,color:C+1})))}function o(s){const a={};return s.forEach((v,C)=>{a[C+1]=t(v)}),a}function i(s){return s.map(a=>a.map(v=>v<0?0:v+1))}try{return{title:e.t,width:e.w,height:e.h,row_clues:n(e.r),col_clues:n(e.c),color_map:o(e.p),solution:i(e.s)}}catch(s){return console.error("[Game] Failed to convert puzzle:",e.t,s),null}}let h=null,A=null;function r(){const e=window.PUZZLE_DATA||[];return(!h||e!==A)&&(h=e.map(c).filter(t=>t!==null),A=e),h}function O(e=null,t=!0){return{value:e,certain:t}}function m(e,t){var n;return((n=f[e])==null?void 0:n[t])||O()}function x(e,t,n,o){f[e][t]={value:n,certain:o}}function G(e){return`rgb(${e[0]}, ${e[1]}, ${e[2]})`}function se(e){return(e[0]*299+e[1]*587+e[2]*114)/1e3}function j(e){const t=e.toLowerCase();return t.includes("easy")?"easy":t.includes("medium")?"medium":t.includes("hard")?"hard":t.includes("challenging")?"challenging":t.includes("expert")?"expert":"easy"}function te(){return window.Cozy.Storage||null}function q(){return window.Cozy.History||null}function ye(){const e=r()[I];if(!e)return!0;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++)if(m(t,n).value!==null)return!1;return!0}function we(){const e=r()[I];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=m(t,n),i=e.solution[t][n];if(o.value!==i||!o.certain)return!1}return!0}function me(){const e=document.getElementById("reset-btn"),t=document.getElementById("solution-btn");if(e){const n=ye();e.disabled=n,e.setAttribute("aria-label",n?"Reset (puzzle is empty)":"Hold to reset puzzle")}if(t){const n=we();t.disabled=n,t.setAttribute("aria-label",n?"Solution (already shown)":"Hold to reveal solution")}}function ve(e){const t=document.getElementById("sr-announcer");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},50))}function Te(e){W=e,Be(),ve(e?"Pencil mode":"Pen mode"),Ce()}function De(){Te(!W)}function Be(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("palette-menu-btn");if(e&&(e.classList.toggle("active",!W),e.setAttribute("aria-checked",String(!W))),t&&(t.classList.toggle("active",W),t.setAttribute("aria-checked",String(W))),n){const o=n.querySelector(".menu-icon-svg");o&&(o.removeAttribute("stroke"),o.removeAttribute("stroke-width"),o.setAttribute("fill","currentColor"),W?o.innerHTML='<path d="M19.07 13.88L13 19.94l-1.41-1.41 6.07-6.06 1.41 1.41zm-5.66-5.66l-6.06 6.07-1.42-1.41 6.07-6.07 1.41 1.41zM17.66 5.99l-2.34 2.34 1.41 1.41 2.34-2.34-1.41-1.41zM3 18v3h3l.01-.01L3 18zm3-3l-1 1 3 3 1-1-3-3z" opacity="0.5"/><path d="M9.17 16.17L7.76 17.59l3.54 3.54 1.41-1.41-3.54-3.55zm10.6-10.6l-3.53-3.54-1.42 1.42 3.54 3.53 1.41-1.41z"/>':o.innerHTML='<path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>')}document.body.classList.toggle("pencil-mode",W)}function qe(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");if(!e||!t)return;e.classList.contains("open")?Ce():Ve()}function Ve(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");!e||!t||(e.classList.add("open"),t.classList.add("menu-open"),t.setAttribute("aria-expanded","true"),setTimeout(()=>{document.addEventListener("click",_e)},0))}function Ce(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");e&&(e.classList.remove("open"),t&&(t.classList.remove("menu-open"),t.setAttribute("aria-expanded","false")),document.removeEventListener("click",_e))}function _e(e){const t=document.getElementById("mode-menu"),n=document.getElementById("palette-menu-btn");!t||!n||!t.contains(e.target)&&!n.contains(e.target)&&Ce()}function Ye(){const e=r()[I];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=m(t,n);if(!o.certain&&o.value!==null)return!0}return!1}function Re(){const e=r()[I];if(!e)return 0;let t=0;for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=m(n,o);!i.certain&&i.value!==null&&t++}return t}function ue(){const e=document.getElementById("pencil-actions-section"),t=document.getElementById("palette-menu-btn"),n=Ye(),o=n?Re():0;if(e&&e.classList.toggle("has-marks",n),t){t.classList.toggle("has-pencil-marks",n);const i=t.querySelector(".pencil-badge");i&&(i.textContent=o>N.BADGE_MAX_DISPLAY?`${N.BADGE_MAX_DISPLAY}+`:String(o))}}function Ze(){const e=r()[I];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=m(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:null,certain:!0}}),x(n,o,null,!0),fe(n,o,e))}if(t.length>0){const n=q();n&&n.recordBatchAction("batch-clear",t),window.Cozy.App&&window.Cozy.App.vibrate(20)}ue(),Ee()}function He(){const e=r()[I];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=m(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:i.value,certain:!0}}),x(n,o,i.value,!0),fe(n,o,e))}if(t.length>0){const n=q();n&&n.recordBatchAction("batch-confirm",t),window.Cozy.App&&window.Cozy.App.vibrate([20,50,20])}ue(),We(e),Ee()}function Oe(){const e=q();if(!e)return;const t=e.undo();if(!t)return;const n=r()[I];for(const o of t)x(o.row,o.col,o.state.value,o.state.certain),fe(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),ue(),Me(n),me(),Ee()}function Ne(){const e=q();if(!e)return;const t=e.redo();if(!t)return;const n=r()[I];for(const o of t)x(o.row,o.col,o.state.value,o.state.certain),fe(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),ue(),Me(n),me(),We(n),Ee()}function Ee(){const e=te();if(!e)return;const n=r()[I];if(!n)return;const o=S(n);e.savePuzzleGrid(o,f),e.saveSession(I,P,f)}function Ue(){const e=te();e&&e.clearSession()}function Je(){const e=r(),t=document.getElementById("puzzle-select"),n=[...new Set(e.map(v=>j(v.title)))],o=["easy","medium","hard","challenging","expert"];n.sort((v,C)=>o.indexOf(v)-o.indexOf(C));const i=document.createElement("div");i.className="difficulty-tabs",n.forEach(v=>{const C=document.createElement("button");C.className="difficulty-tab"+(v===P?" active":""),C.textContent=v.charAt(0).toUpperCase()+v.slice(1),C.onclick=()=>{P=v,document.querySelectorAll(".difficulty-tab").forEach(F=>F.classList.remove("active")),C.classList.add("active"),Se()},i.appendChild(C)});const s=document.createElement("div");s.className="puzzle-dropdown";const a=document.createElement("select");a.id="puzzle-select-dropdown",a.onchange=v=>{d(parseInt(v.target.value))},s.appendChild(a),t.appendChild(i),t.appendChild(s),Se()}function Se(){var i;const e=r(),t=document.getElementById("puzzle-select-dropdown");if(!t)return;const n=te();if(t.innerHTML="",e.forEach((s,a)=>{if(j(s.title)===P){const v=document.createElement("option");v.value=a;const C=S(s),F=n?n.isPuzzleCompleted(C):!1;v.textContent=(F?"\u2713 ":"")+s.title,a===I&&(v.selected=!0),t.appendChild(v)}}),e.filter(s=>j(s.title)===P).length>0&&!(j((i=e[I])==null?void 0:i.title)===P)){const a=e.findIndex(v=>j(v.title)===P);a>=0&&d(a)}}function d(e,t=null){if(ne){console.warn("[Game] Puzzle already loading, ignoring request");return}ne=!0;try{const n=r(),o=te(),i=q();if(e!==I&&f.length>0&&n[I]&&o){const K=S(n[I]);o.savePuzzleGrid(K,f)}i&&i.clear(),W=!1,Be(),J=0,_=0,I=e;const s=n[e];if(!s){ne=!1;return}if(s.width>N.MAX_PUZZLE_DIMENSION||s.height>N.MAX_PUZZLE_DIMENSION||s.width<1||s.height<1){console.error(`[Game] Invalid puzzle dimensions: ${s.width}x${s.height}`),ne=!1;return}const a=S(s);let v=t;!v&&o&&(v=o.getPuzzleGrid(a));const C=v&&v.length===s.height;if(C)f=v.map(K=>K.map(oe=>({value:oe.value,certain:oe.certain})));else{f=[];for(let K=0;K<s.height;K++){f.push([]);for(let oe=0;oe<s.width;oe++)f[K][oe]=O(null,!0)}}if(E=1,T(s),ce(s),Ge(s),ut(),C)for(let K=0;K<s.height;K++)for(let oe=0;oe<s.width;oe++)m(K,oe).value!==null&&fe(K,oe,s);b();const F=document.getElementById("puzzle-select-dropdown");F&&(F.value=e);const Y=j(s.title);Y!==P&&(P=Y,document.querySelectorAll(".difficulty-tab").forEach(K=>{K.classList.toggle("active",K.textContent.toLowerCase()===Y)}),Se()),ue(),Me(s),window.Cozy.Zoom&&window.Cozy.Zoom.initForPuzzle(s),l(),me()}finally{ne=!1}}function T(e){const t=document.getElementById("palette"),n=document.getElementById("mode-menu"),o=n?n.parentNode:null;n&&t.contains(n)&&document.body.appendChild(n),t.innerHTML="";const i=document.createElement("button");i.className="color-btn eraser",i.title="Eraser",i.setAttribute("aria-label","Eraser"),i.setAttribute("aria-pressed",E===0?"true":"false"),i.addEventListener("click",()=>M(0)),t.appendChild(i),Object.entries(e.color_map).forEach(([C,F])=>{const Y=document.createElement("button"),K=parseInt(C)===E;Y.className="color-btn"+(K?" selected":""),Y.style.background=G(F),Y.setAttribute("aria-label",`Color ${C}`),Y.setAttribute("aria-pressed",K?"true":"false"),Y.addEventListener("click",()=>M(parseInt(C))),t.appendChild(Y)});const s=document.createElement("button");s.className="palette-menu-btn",s.id="palette-menu-btn",s.title="Drawing mode",s.setAttribute("aria-label","Drawing mode menu"),s.setAttribute("aria-haspopup","true"),s.setAttribute("aria-expanded","false"),s.innerHTML=`
      <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>
      </svg>
      <span class="pencil-badge">0</span>
    `,s.addEventListener("click",C=>{C.stopPropagation(),qe()}),t.appendChild(s);const a=document.getElementById("mode-menu");a&&t.appendChild(a);const v=t.querySelectorAll(".color-btn, .palette-menu-btn").length;t.classList.remove("palette-8-buttons","palette-7-buttons"),v>=8?t.classList.add("palette-8-buttons"):v===7&&t.classList.add("palette-7-buttons")}function M(e){E=e;const n=r()[I];document.querySelectorAll(".color-btn").forEach((o,i)=>{let s;i===0?s=e===0:s=parseInt(Object.keys(n.color_map)[i-1])===e,o.classList.toggle("selected",s),o.setAttribute("aria-pressed",s?"true":"false")})}function V(e,t,n){const o=document.createElement("div");if(o.className=n,e===null)o.textContent="0",o.style.background="#333";else{const i=t.color_map[e.color];o.textContent=e.count,o.style.background=G(i),o.style.color=se(i)>N.BRIGHTNESS_MIDPOINT?"#000":"#fff",o.style.cursor="pointer",o.onclick=()=>M(e.color)}return o}function ce(e){X=[],ie=[],ze=new Array(e.height).fill(!1),p=new Array(e.width).fill(!1);const t=document.getElementById("col-clues");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,e.col_clues.forEach((o,i)=>{const s=document.createElement("div");s.className="col-clue",s.dataset.col=i,o.length===0?s.appendChild(V(null,e,"clue-cell")):o.forEach(a=>{s.appendChild(V(a,e,"clue-cell"))}),X[i]=s,t.appendChild(s)});const n=document.getElementById("row-clues-container");n.innerHTML="",n.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,e.row_clues.forEach((o,i)=>{const s=document.createElement("div");s.className="row-clues",s.dataset.row=i,o.length===0?s.appendChild(V(null,e,"row-clue-cell")):o.forEach(a=>{s.appendChild(V(a,e,"row-clue-cell"))}),ie[i]=s,n.appendChild(s)})}let le=-1,ae=-1;function de(e,t){var o;if(w()||e===le&&t===ae||(he(),le=e,ae=t,e<0||t<0)||!$[e])return;const n=$[e];if(n)for(let i=0;i<n.length;i++){const s=n[i];s&&(s.classList.add("highlight-row"),i===t&&s.classList.add("highlight-cell"))}for(let i=0;i<$.length;i++)i!==e&&((o=$[i])!=null&&o[t])&&$[i][t].classList.add("highlight-col");ie[e]&&ie[e].classList.add("highlight-clue"),X[t]&&X[t].classList.add("highlight-clue")}function he(){var n;const e=le,t=ae;if(le=-1,ae=-1,!(e<0&&t<0)){if(e>=0&&$[e])for(let o=0;o<$[e].length;o++){const i=$[e][o];i&&i.classList.remove("highlight-row","highlight-cell")}if(t>=0)for(let o=0;o<$.length;o++){const i=(n=$[o])==null?void 0:n[t];i&&i.classList.remove("highlight-col")}e>=0&&ie[e]&&ie[e].classList.remove("highlight-clue"),t>=0&&X[t]&&X[t].classList.remove("highlight-clue")}}function pe(e,t){var i,s;const n=r()[I];if(!n||e<0||e>=n.height||t<0||t>=n.width)return;(i=$[J])!=null&&i[_]&&($[J][_].tabIndex=-1),J=e,_=t;const o=(s=$[e])==null?void 0:s[t];o&&(o.tabIndex=0,o.focus())}function Ie(e,t){const n=document.createElement("div");return n.className="cell",n.dataset.row=e,n.dataset.col=t,n.tabIndex=e===J&&t===_?0:-1,n.setAttribute("role","gridcell"),n.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}, empty`),n}function Ae(e,t,n){e.onfocus=()=>{var o;(J!==t||_!==n)&&((o=$[J])!=null&&o[_]&&($[J][_].tabIndex=-1),J=t,_=n,e.tabIndex=0),de(t,n)}}function Pe(e,t,n){e.onkeydown=o=>{if(o.key==="ArrowUp")o.preventDefault(),pe(t-1,n);else if(o.key==="ArrowDown")o.preventDefault(),pe(t+1,n);else if(o.key==="ArrowLeft")o.preventDefault(),pe(t,n-1);else if(o.key==="ArrowRight")o.preventDefault(),pe(t,n+1);else if(o.key==="Enter"||o.key===" "){o.preventDefault();const i=q();i&&i.beginAction("fill"),ge(t,n,E,!W),i&&i.commitAction(),ue()}else if(o.key==="x"||o.key==="X"){o.preventDefault(),o.stopPropagation();const i=q();i&&i.beginAction("fill"),ge(t,n,0,!W),i&&i.commitAction(),ue()}}}function ke(e,t,n=!1){const o=q();o&&o.beginAction("fill"),u=!0,Z=n?0:E,D=!W,ge(e,t,Z,D);const i=m(e,t);Z=i.value,D=i.certain}function be(e=!0){if(!u)return;u=!1,Z=null;const t=q();t&&(e?t.commitAction():t.cancelAction()),ue()}function Xe(e,t,n){e.onmousedown=o=>{o.preventDefault(),e.focus(),ke(t,n,o.button===2)},e.onmouseenter=()=>{de(t,n),u&&ge(t,n,Z,D,!0)},e.oncontextmenu=o=>{o.preventDefault()}}function Ke(e,t,n){let o=null,i=0,s=!1,a=t,v=n;e.ontouchstart=C=>{var K,oe;if(C.touches.length>1)return;if(C.preventDefault(),C.stopPropagation(),s=!1,i=Date.now(),a=t,v=n,window.Cozy.Zoom){const Le=(oe=(K=C.touches[0])==null?void 0:K.clientY)!=null?oe:0;window.Cozy.Zoom.onCellTouchStart(t,n,Le)}const F=q();F&&F.beginAction("fill"),u=!0,Z=E,D=!W,o=setTimeout(()=>{if(!s){Z=0,ge(a,v,0,D);const Le=m(a,v);Z=Le.value,D=Le.certain,window.Cozy.App&&window.Cozy.App.vibrate(50)}},N.LONG_PRESS_DELAY),ge(t,n,Z,D);const Y=m(t,n);Z=Y.value,D=Y.certain},e.ontouchmove=C=>{if(C.touches.length>1||!u)return;C.preventDefault(),C.stopPropagation(),s=!0,clearTimeout(o);const F=C.touches[0],Y=document.elementFromPoint(F.clientX,F.clientY);if(Y&&Y.classList.contains("cell")){const K=parseInt(Y.dataset.row),oe=parseInt(Y.dataset.col);!isNaN(K)&&!isNaN(oe)&&(ge(K,oe,Z,D,!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchMove(K,oe))}},e.ontouchend=()=>{clearTimeout(o),be(!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()},e.ontouchcancel=()=>{clearTimeout(o),be(!1),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()}}function Ge(e){const t=document.getElementById("grid");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,t.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,Q&&t.removeEventListener("mouseleave",Q),ee&&t.removeEventListener("focusout",ee),re&&document.removeEventListener("mouseup",re),$=[];for(let n=0;n<e.height;n++)$[n]=[];Q=()=>he(),t.addEventListener("mouseleave",Q),ee=n=>{t.contains(n.relatedTarget)||he()},t.addEventListener("focusout",ee);for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=Ie(n,o);Ae(i,n,o),Pe(i,n,o),Xe(i,n,o),Ke(i,n,o),$[n][o]=i,t.appendChild(i)}re=()=>be(!0),document.addEventListener("mouseup",re)}function ge(e,t,n,o,i){const s=r()[I],a=m(e,t),v=q();let C=n,F=o;i||(o&&!a.certain&&a.value===n&&n!==null?(C=a.value,F=!0):a.value===n&&a.certain===o&&n!==null&&(C=null,F=!0)),!(a.value===C&&a.certain===F)&&(v&&v.recordChange(e,t,a,{value:C,certain:F}),x(e,t,C,F),fe(e,t,s),window.Cozy.App&&window.Cozy.App.vibrate(10),Me(s),me(),We(s),Ee())}function fe(e,t,n){var a;const o=(a=$[e])==null?void 0:a[t];if(!o)return;const i=m(e,t);if(o.classList.remove("marked-empty","maybe-empty","maybe-color"),o.style.background="",o.style.setProperty("--cell-color",""),o.style.setProperty("--fold-outline-color",""),i.value===null)o.style.background="var(--color-cell)";else if(i.value===0)i.certain?o.classList.add("marked-empty"):o.classList.add("maybe-empty");else{const v=n.color_map[i.value];if(v){const C=`rgb(${v[0]}, ${v[1]}, ${v[2]})`;if(i.certain)o.style.background=C;else{o.classList.add("maybe-color"),o.style.setProperty("--cell-color",C);const Y=se(v)>N.BRIGHTNESS_MIDPOINT?"rgba(0, 0, 0, 0.6)":"rgba(255, 255, 255, 0.7)";o.style.setProperty("--fold-outline-color",Y)}}}let s;i.value===null?s="empty":i.value===0?s=i.certain?"marked empty":"maybe empty":s=i.certain?`color ${i.value}`:`maybe color ${i.value}`,o.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}, ${s}`)}function Fe(e){const t=[];let n=null,o=0;for(const i of e)i>0?i===n?o++:(n!==null&&t.push({count:o,color:n}),n=i,o=1):n!==null&&(t.push({count:o,color:n}),n=null,o=0);return n!==null&&t.push({count:o,color:n}),t}function $e(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n].count!==t[n].count||e[n].color!==t[n].color)return!1;return!0}function Me(e){for(let t=0;t<e.height;t++){const n=[];for(let C=0;C<e.width;C++){const F=m(t,C);F.certain?n.push(F.value===null?0:F.value):n.push(-1)}const o=n.includes(-1),i=n.map(C=>C===-1?0:C),s=Fe(i),a=!o&&$e(s,e.row_clues[t]),v=ie[t];v&&v.classList.toggle("satisfied",a),a!==ze[t]&&(ze[t]=a,ve(a?`Row ${t+1} complete`:`Row ${t+1} incomplete`))}for(let t=0;t<e.width;t++){const n=[];for(let C=0;C<e.height;C++){const F=m(C,t);F.certain?n.push(F.value===null?0:F.value):n.push(-1)}const o=n.includes(-1),i=n.map(C=>C===-1?0:C),s=Fe(i),a=!o&&$e(s,e.col_clues[t]),v=X[t];v&&v.classList.toggle("satisfied",a),a!==p[t]&&(p[t]=a,ve(a?`Column ${t+1} complete`:`Column ${t+1} incomplete`))}}function We(e){for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++)if(!m(o,i).certain)return;for(let o=0;o<e.height;o++){const i=[];for(let a=0;a<e.width;a++){const v=m(o,a);i.push(v.value===null?0:v.value)}const s=Fe(i);if(!$e(s,e.row_clues[o]))return}for(let o=0;o<e.width;o++){const i=[];for(let a=0;a<e.height;a++){const v=m(a,o);i.push(v.value===null?0:v.value)}const s=Fe(i);if(!$e(s,e.col_clues[o]))return}ve("Puzzle complete!"),window.Cozy.App&&window.Cozy.App.vibrate([50,100,50]);const t=te();if(t){const o=S(e);t.completePuzzle(o),Ue(),Se();const i=window.Cozy.Collection;i&&i.refresh()}const n=q();n&&n.clear(),at(e)}function Qe(){const e=r()[I];if(!e)return;const t=q(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const s=m(o,i);s.value!==null&&(n.push({row:o,col:i,before:{value:s.value,certain:s.certain},after:{value:null,certain:!0}}),s.value=null,s.certain=!0,fe(o,i,e))}if(n.length>0){t&&t.recordBatchAction("reset",n),Me(e);const o=te();if(o){const i=S(e);o.savePuzzleGrid(i,null)}ue()}me()}function et(){const e=r()[I];if(!e)return;window.Cozy.Zoom&&window.Cozy.Zoom.zoomToFit();const t=q(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const s=m(o,i),a=e.solution[o][i];(s.value!==a||!s.certain)&&n.push({row:o,col:i,before:{value:s.value,certain:s.certain},after:{value:a,certain:!0}}),s.value=a,s.certain=!0,fe(o,i,e)}n.length>0&&t&&t.recordBatchAction("solution",n),Me(e),g("Solution revealed","info"),ue(),me()}function st(){document.addEventListener("keydown",e=>{var t,n,o;if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")){if((e.ctrlKey||e.metaKey)&&e.key==="z"&&!e.shiftKey&&(e.preventDefault(),Oe()),((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key==="z"||(e.ctrlKey||e.metaKey)&&e.key==="y")&&(e.preventDefault(),Ne()),e.key==="p"&&!e.ctrlKey&&!e.metaKey&&(e.preventDefault(),De()),e.key>="1"&&e.key<="9"&&!e.ctrlKey&&!e.metaKey){const i=parseInt(e.key),s=r()[I],a=Object.keys(s.color_map).map(Number);i<=a.length&&M(a[i-1])}if((e.key==="0"||e.key==="x")&&!e.ctrlKey&&!e.metaKey&&M(0),e.key==="Escape"&&!e.ctrlKey&&!e.metaKey){const i=document.getElementById("help-modal"),s=i==null?void 0:i.classList.contains("visible");((t=window.Cozy.Screens)==null?void 0:t.getCurrentScreen())===((o=(n=window.Cozy.Screens)==null?void 0:n.SCREENS)==null?void 0:o.PUZZLE)&&!s&&(e.preventDefault(),xe())}}})}function je(){const e=r(),t=te();if(f.length>0&&e[I]&&t){const n=S(e[I]);t.savePuzzleGrid(n,f)}}function xe(){je(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION)}function lt(e){window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:e})}function rt(e){const t=e.detail||{},n=r();let o=0;t.puzzleId!==void 0&&(o=t.puzzleId,typeof t.puzzleId=="string"&&(o=n.findIndex(i=>S(i)===t.puzzleId),o===-1&&(o=0))),d(o)}function ct(e){je();const t=e.detail||{},n=window.Cozy.Collection;n&&(t.animateStamp&&t.scrollToPuzzleId?n.refresh({blankPuzzleId:t.scrollToPuzzleId}):n.refresh(),t.scrollToPuzzleId&&setTimeout(()=>{n.scrollToPuzzle(t.scrollToPuzzleId,{instant:t.quickAnimation}),t.animateStamp&&t.flyingStamp&&n.animateStampTo(t.scrollToPuzzleId,t.flyingStamp,{quick:t.quickAnimation})},50))}function at(e){if(window.Cozy.Screens){const t=S(e),n=e.title.match(/^(.+?)\s*\(/),o=n?n[1].trim():e.title;window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.VICTORY,{puzzleId:t,puzzleName:o,solution:e.solution,palette:e.color_map})}}function ut(){const e=document.getElementById("current-puzzle-title");if(!e)return;const n=r()[I];if(n){const o=n.title.match(/^(.+?)\s*\(/);e.textContent=o?o[1].trim():n.title}}const tt=1200;function nt(e,t){if(!e)return;let n=null,o=!1;function i(a){a.type==="touchstart"&&a.preventDefault(),!e.disabled&&(o||(o=!0,e.classList.add("holding"),n=setTimeout(()=>{o&&(e.classList.add("hold-complete"),s(),t(),setTimeout(()=>e.classList.remove("hold-complete"),50))},tt)))}function s(){o=!1,e.classList.remove("holding"),n&&(clearTimeout(n),n=null)}e.addEventListener("mousedown",i),e.addEventListener("mouseup",s),e.addEventListener("mouseleave",s),e.addEventListener("touchstart",i,{passive:!1}),e.addEventListener("touchend",s),e.addEventListener("touchcancel",s),e.addEventListener("keydown",a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),i(a))}),e.addEventListener("keyup",a=>{(a.key==="Enter"||a.key===" ")&&s()}),e.addEventListener("blur",s),e.style.setProperty("--hold-duration",`${tt}ms`)}function dt(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("undo-btn"),o=document.getElementById("redo-btn");e&&e.addEventListener("click",()=>Te(!1)),t&&t.addEventListener("click",()=>Te(!0)),n&&n.addEventListener("click",Oe),o&&o.addEventListener("click",Ne);const i=document.getElementById("clear-pencil-btn"),s=document.getElementById("confirm-pencil-btn");i&&i.addEventListener("click",()=>{Ze(),Ce()}),s&&s.addEventListener("click",()=>{He(),Ce()});const a=document.getElementById("reset-btn"),v=document.getElementById("solution-btn");nt(a,Qe),nt(v,et);const C=document.querySelector("#screen-puzzle .header-back-btn");C&&C.addEventListener("click",it);const F=document.querySelector("#screen-collection .header-back-btn");F&&F.addEventListener("click",()=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.HOME)})}function ot(){st(),dt(),H(),U();const e=q();e&&e.updateUI(),Be();const t=te();t&&t.onChange&&t.onChange(i=>{i==="reset"&&(f=[],I=0)});const n=window.Cozy.Collection,o=r();n&&o.length>0&&n.init("collection-screen",o,i=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:i})}),window.addEventListener("screen:puzzle",rt),window.addEventListener("screen:collection",ct),o.length>0&&d(0)}function ft(){const t=r()[I];if(!t||f.length===0)return null;let n=!1;for(let o=0;o<t.height&&!n;o++)for(let i=0;i<t.width&&!n;i++){const s=m(o,i);s.value!==null&&s.value>0&&(n=!0)}return n?k(t.width,t.height,N.STAMP_CANVAS_SIZE,(o,i)=>{const s=m(o,i);if(s.value!==null&&s.value>0){const a=t.color_map[s.value];if(a)return a}return null}):null}function it(){const t=r()[I];if(!t){xe();return}const n=S(t),o=ft();if(!o){xe();return}const i=document.getElementById("grid");if(!i){xe();return}const s=i.getBoundingClientRect(),a=document.createElement("canvas");a.width=o.width,a.height=o.height,a.getContext("2d").drawImage(o,0,0);const C=o.width/o.height,F=s.width/s.height;let Y,K;C>F?(Y=s.width,K=s.width/C):(K=s.height,Y=s.height*C);const oe=(s.width-Y)/2,Le=(s.height-K)/2;a.className="flying-stamp",a.style.left=s.left+oe+"px",a.style.top=s.top+Le+"px",a.style.width=Y+"px",a.style.height=K+"px",document.body.appendChild(a),je(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION,{scrollToPuzzleId:n,animateStamp:!0,flyingStamp:a,quickAnimation:!0})}function mt(){f=[],I=0,E=1,u=!1,Z=null,W=!1;const e=q();e&&e.clear()}function ht(e,t){const o=r()[I];if(!o)return null;const i=ie[e],s=i?i.classList.contains("satisfied"):!1,a=o.row_clues[e].map(Y=>({count:Y.count,color:Y.color,satisfied:s})),v=X[t],C=v?v.classList.contains("satisfied"):!1,F=o.col_clues[t].map(Y=>({count:Y.count,color:Y.color,satisfied:C}));return{rowClues:a,colClues:F}}function pt(e){const n=r()[I];return!n||!n.color_map?null:n.color_map[e]||null}function gt(){return r()[I]||null}window.Cozy.Garden={resetPuzzle:Qe,showSolution:et,performUndo:Oe,performRedo:Ne,togglePencilMode:De,setPencilMode:Te,clearAllPencilMarks:Ze,confirmAllPencilMarks:He,selectColor:M,showCollection:xe,showGame:lt,clearAllState:mt,navigateToCollectionWithStamp:it,getPuzzleId:S,getClueInfo:ht,getColorRgb:pt,getCurrentPuzzle:gt},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ot):ot()}(),function(){"use strict";const{CONFIG:N}=window.Cozy.Utils,S=.35,y=1,k=.97,I=300,P=1500,E=100,f=10;let u=y,Z=y,D=!1,W=0,ne=0,J=null,_=null,re=null,Q=!1,ee=-1,$=-1,ie=!1,X=null,ze=null,p=null,z=null,g=null,b=null,w=null,L=null;function R(d,T,M){return Math.min(Math.max(d,T),M)}function B(d,T){const M=d.clientX-T.clientX,V=d.clientY-T.clientY;return Math.sqrt(M*M+V*V)}function H(d,T){return{x:(d.clientX+T.clientX)/2,y:(d.clientY+T.clientY)/2}}function U(){const d=window.innerWidth;return d<=360?20:d>=768?28:d>=1200?32:24}function l(d,T=!0){const M=X;if(!M)return;const V=u,ce=m(),le=R(d,ce,N.MAX_ZOOM);let ae,de;T&&V!==le&&(ae=M.scrollLeft+M.clientWidth/2,de=M.scrollTop+M.clientHeight/2),u=le;const he=U(),pe=Math.round(he*le);document.documentElement.style.setProperty("--cell-size",`${pe}px`);const Ie=r(),Ae=le>Ie+.01;M.classList.toggle("is-zoomed",Ae),c(),T&&V!==le&&ae!==void 0&&requestAnimationFrame(()=>{const Pe=le/V,ke=ae*Pe-M.clientWidth/2,be=de*Pe-M.clientHeight/2;M.scrollLeft=Math.max(0,ke),M.scrollTop=Math.max(0,be)}),window.dispatchEvent(new CustomEvent("zoomchange",{detail:{zoom:le,oldZoom:V,isZoomed:Ae}}))}function c(){const d=m();if(b&&(b.disabled=u>=N.MAX_ZOOM),w&&(w.disabled=u<=d),L){const T=r(),M=Math.abs(u-T)<.05;L.classList.toggle("highlighted",!M&&u!==T)}}let h=null,A=null;function r(d=!1){var ge;const T=X;if(!T||!((ge=window.Cozy.Garden)!=null&&ge.getCurrentPuzzle))return y;const M=window.Cozy.Garden.getCurrentPuzzle();if(!M)return y;const V=M.title;if(!d&&h!==null&&A===V)return h;const ce=U(),le=Math.max(...M.row_clues.map(fe=>fe.length)),ae=Math.max(...M.col_clues.map(fe=>fe.length)),de=Math.max(2,le*.6+.5),he=Math.max(2,ae*.6+.5),pe=M.width+de+.25,Ie=M.height+he+.25,Ae=T.clientWidth,Pe=T.clientHeight,ke=8,be=(Ae-ke*2)/(pe*ce),Xe=(Pe-ke*2)/(Ie*ce),Ke=Math.min(be,Xe),Ge=R(Ke*k,S,N.MAX_ZOOM);return h=Ge,A=V,Ge}function O(){h=null,A=null}function m(){const d=r();return Math.max(S,d)}function x(){const d=r();return u>d+.01}function G(d){d.touches.length===2&&(D=!0,W=B(d.touches[0],d.touches[1]),Z=u,d.preventDefault())}function se(d){if(D&&d.touches.length===2){const M=B(d.touches[0],d.touches[1])/W,V=m(),ce=R(Z*M,V,N.MAX_ZOOM);Math.abs(ce-u)>.05&&l(ce,!0),d.preventDefault()}}function j(d){if(D&&d.touches.length<2&&(D=!1),d.touches.length===0&&!D){const T=d.target;if(!T.classList.contains("cell")){const V=Date.now();J===T&&V-ne<I?(te(d.changedTouches[0]),ne=0,J=null):(ne=V,J=T)}}}function te(d){x()?l(r(),!0):l(N.COMFORTABLE_ZOOM,!0)}function q(d){if(d.ctrlKey){d.preventDefault();const T=d.deltaY>0?-.15:.15;l(u+T,!0)}}function ye(){p&&x()&&p.classList.add("visible")}function we(){p&&(p.classList.remove("visible"),ee=-1,$=-1)}function me(d,T){var V,ce;if(!p||Q||d===ee&&T===$)return;ee=d,$=T;const M=(ce=(V=window.Cozy.Garden)==null?void 0:V.getClueInfo)==null?void 0:ce.call(V,d,T);M&&(z&&(z.innerHTML=ve(M.rowClues)),g&&(g.innerHTML=ve(M.colClues)))}function ve(d){return!d||d.length===0?'<span class="clue-tooltip-num satisfied">0</span>':d.map(T=>{var ae,de;const M=((de=(ae=window.Cozy.Garden)==null?void 0:ae.getColorRgb)==null?void 0:de.call(ae,T.color))||[128,128,128],V=T.satisfied,le=(M[0]*299+M[1]*587+M[2]*114)/1e3>N.BRIGHTNESS_MIDPOINT?"#333":"#fff";return`<span class="clue-tooltip-num${V?" satisfied":""}"
                    style="background: rgb(${M.join(",")}); color: ${le}">
                ${T.count}
              </span>`}).join("")}function Te(d){if(!p||!X)return;const T=X.getBoundingClientRect(),M=T.top+T.height/2;d>M?(p.classList.add("position-top"),p.classList.remove("position-bottom")):(p.classList.remove("position-top"),p.classList.add("position-bottom"))}function De(){clearTimeout(_),_=setTimeout(()=>{we()},P)}function Be(){clearTimeout(_)}function qe(d,T,M){x()&&(Q=!1,Be(),clearTimeout(re),re=setTimeout(()=>{me(d,T),Te(M),ye()},E))}function Ve(){x()&&(Q=!0,p==null||p.classList.add("dragging"))}function Ce(){x()&&(clearTimeout(re),Q=!1,p==null||p.classList.remove("dragging"),De())}function _e(){b=document.querySelector(".zoom-btn.zoom-in"),w=document.querySelector(".zoom-btn.zoom-out"),L=document.querySelector(".zoom-btn.zoom-fit"),b&&b.addEventListener("click",()=>{l(u+.5,!0)}),w&&w.addEventListener("click",()=>{l(u-.5,!0)}),L&&L.addEventListener("click",()=>{l(r(),!0)}),c()}function Ye(d){const T=document.getElementById("screen-puzzle");!T||T.classList.contains("screen-hidden")||(d.key==="+"||d.key==="="?(d.preventDefault(),l(u+.5,!0)):d.key==="-"||d.key==="_"?(d.preventDefault(),l(u-.5,!0)):d.key==="0"&&(d.preventDefault(),l(r(),!0)))}let Re=null;function ue(){clearTimeout(Re),Re=setTimeout(()=>{const d=document.getElementById("screen-puzzle");if(!d||d.classList.contains("screen-hidden"))return;O();const T=m();u<T&&l(T,!1),c()},150)}function Ze(){var T,M,V,ce;const d=(M=(T=window.Cozy.Garden)==null?void 0:T.getCurrentPuzzle)==null?void 0:M.call(T);d&&(d.width<=N.AUTO_ZOOM_MIN_SIZE&&d.height<=N.AUTO_ZOOM_MIN_SIZE||(V=window.Cozy.Storage)!=null&&V.getFlag("zoomHintShown")||(He(),(ce=window.Cozy.Storage)==null||ce.setFlag("zoomHintShown",!0)))}function He(){let d=document.getElementById("zoom-hint-toast");d||(d=document.createElement("div"),d.id="zoom-hint-toast",d.className="zoom-hint-toast",d.textContent="Tip: Pinch to zoom for easier tapping",document.body.appendChild(d)),d.classList.add("visible"),setTimeout(()=>{d.classList.remove("visible")},4e3)}function Oe(){if(!ie){if(X=document.getElementById("zoom-container"),ze=X==null?void 0:X.querySelector(".board-wrapper"),p=document.getElementById("clue-tooltip"),z=document.getElementById("tooltip-row-clues"),g=document.getElementById("tooltip-col-clues"),!X){console.warn("[Zoom] zoom-container not found, zoom disabled");return}X.addEventListener("touchstart",G,{passive:!1}),X.addEventListener("touchmove",se,{passive:!1}),X.addEventListener("touchend",j,{passive:!0}),X.addEventListener("wheel",q,{passive:!1}),_e(),document.addEventListener("keydown",Ye),window.addEventListener("resize",ue),ie=!0,console.log("[Zoom] Initialized")}}function Ne(){O();const d=r();l(d,!1),setTimeout(Ze,500)}function Ee(){Ue(!1),we(),clearTimeout(_),clearTimeout(re)}function Ue(d=!0){Se(y,d)}function Je(d=!0){const T=r();Se(T,d)}function Se(d,T=!0){if(T&&u!==d){let le=function(ae){const de=ae-ce,he=Math.min(de/V,1),pe=1-Math.pow(1-he,3),Ie=M+(d-M)*pe;l(Ie,!1),he<1&&requestAnimationFrame(le)};const M=u,V=200,ce=performance.now();requestAnimationFrame(le)}else l(d,!1)}window.Cozy.Zoom={init:Oe,initForPuzzle:Ne,destroy:Ee,resetZoom:Ue,zoomToFit:Je,getZoom:()=>u,setZoom:(d,T=!0)=>l(d,!T),zoomIn:(d=.5)=>l(u+d,!0),zoomOut:(d=.5)=>l(u-d,!0),isZoomed:x,onCellTouchStart:qe,onCellTouchMove:Ve,onCellTouchEnd:Ce,getEffectiveMinZoom:m}}();

//# sourceMappingURL=app.min.js.map