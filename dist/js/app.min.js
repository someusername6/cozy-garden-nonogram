(function(){"use strict";const x={STAMP_CANVAS_SIZE:180,VICTORY_CANVAS_SIZE:180,MINI_CANVAS_SIZE:80,OUTLINE_THICKNESS:2,MAX_PUZZLE_DIMENSION:32,MAX_HISTORY:50,MAX_SCREEN_HISTORY:10,MAX_SEARCH_LENGTH:100,TOAST_DURATION:2500,LONG_PRESS_DELAY:400,SEARCH_DEBOUNCE:150,MAX_ZOOM:3,COMFORTABLE_ZOOM:2,AUTO_ZOOM_MIN_SIZE:10,BRIGHTNESS_MIDPOINT:128,BADGE_MAX_DISPLAY:99};function b(P){return(P.t||P.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"")}function w(P){return P.t||P.title}function k(P){const E=P.match(/^(.+?)\s*\((\d+)x(\d+),\s*(\w+)\)$/i);return E?{name:E[1].trim(),width:parseInt(E[2],10),height:parseInt(E[3],10),difficulty:E[4].toLowerCase()}:{name:P,width:0,height:0,difficulty:"unknown"}}function L(P,E,d,c){const R=Math.max(P,E),_=Math.max(2,Math.floor(d/R)),W=x.OUTLINE_THICKNESS*2,ne=x.OUTLINE_THICKNESS,J=document.createElement("canvas");J.width=P*_+W,J.height=E*_+W;const D=J.getContext("2d");if(!D)return console.warn("[Utils] Failed to get 2D context for canvas"),J;try{const le=getComputedStyle(document.documentElement).getPropertyValue("--color-text-muted").trim()||"#8a8a7a";D.fillStyle=le;for(let Q=0;Q<E;Q++)for(let ee=0;ee<P;ee++)if(c(Q,ee)){const ie=ne+ee*_,Y=ne+Q*_;D.fillRect(ie-x.OUTLINE_THICKNESS,Y-x.OUTLINE_THICKNESS,_+W,_+W)}for(let Q=0;Q<E;Q++)for(let ee=0;ee<P;ee++){const $=c(Q,ee);if($){D.fillStyle=`rgb(${$[0]}, ${$[1]}, ${$[2]})`;const ie=ne+ee*_,Y=ne+Q*_;D.fillRect(ie,Y,_,_)}}}catch(le){console.error("[Utils] Failed to render canvas:",le)}return J}window.Cozy=window.Cozy||{},window.Cozy.Utils={CONFIG:x,getPuzzleId:b,getPuzzleTitle:w,parsePuzzleTitle:k,renderOutlinedCanvas:L}})(),function(){"use strict";const x="cozy_garden_data";function w(E){return!(!E||typeof E!="object"||typeof E.version!="number"||E.progress!==null&&typeof E.progress!="object"||E.settings!==null&&typeof E.settings!="object"||E.stats!==null&&typeof E.stats!="object")}function k(){return{version:1,progress:{},settings:{vibration:!0,theme:"light"},stats:{totalCompleted:0,totalAttempts:0,totalPlayTime:0,streak:0,lastPlayDate:null},currentSession:{puzzleIndex:0,difficulty:"easy",grid:null,startTime:null},flags:{tutorialCompleted:!1,helpShown:!1,zoomHintShown:!1},uiState:{collapsedSections:[]}}}class L{constructor(){this.data=null,this.listeners=[]}init(){try{const d=localStorage.getItem(x);if(d){const c=JSON.parse(d);w(c)?this.data=c:(console.warn("[Storage] Invalid data structure, using defaults"),this.data=k(),this.save())}else this.data=k(),this.save()}catch(d){console.warn("[Storage] Failed to load, using defaults:",d),this.data=k(),this.save()}return this}save(){try{return localStorage.setItem(x,JSON.stringify(this.data)),this.notifyListeners("save"),!0}catch(d){return console.error("[Storage] Failed to save:",d),!1}}onChange(d){return this.listeners.push(d),()=>{this.listeners=this.listeners.filter(c=>c!==d)}}notifyListeners(d){this.listeners.forEach(c=>c(d,this.data))}getPuzzleProgress(d){return this.data.progress[d]||{completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}}savePuzzleGrid(d,c){this.data.progress||(this.data.progress={}),this.data.progress[d]||(this.data.progress[d]={completed:!1,bestTime:null,attempts:0,lastPlayed:null,savedGrid:null}),c?this.data.progress[d].savedGrid=c.map(R=>R.map(_=>({value:_.value,certain:_.certain}))):this.data.progress[d].savedGrid=null,this.save()}getPuzzleGrid(d){if(!this.data.progress)return null;const c=this.data.progress[d];return!c||!c.savedGrid?null:c.savedGrid.map(R=>R.map(_=>({value:_.value,certain:_.certain})))}completePuzzle(d){const c=this.getPuzzleProgress(d),R=!c.completed;return c.completed=!0,c.attempts+=1,c.lastPlayed=Date.now(),c.savedGrid=null,this.data.progress[d]=c,R&&(this.data.stats.totalCompleted+=1),this.data.stats.totalAttempts+=1,this.updateStreak(),this.save(),{wasNew:R,progress:c}}isPuzzleCompleted(d){var c;return((c=this.data.progress[d])==null?void 0:c.completed)||!1}getCompletionStats(){return{easy:{completed:0,total:0},medium:{completed:0,total:0},hard:{completed:0,total:0},challenging:{completed:0,total:0},expert:{completed:0,total:0}}}saveSession(d,c,R){let _=null;R&&(_=R.map(W=>W.map(ne=>({value:ne.value,certain:ne.certain})))),this.data.currentSession={puzzleIndex:d,difficulty:c,grid:_},this.save()}getSession(){return this.data.currentSession}clearSession(){this.data.currentSession={puzzleIndex:0,difficulty:"easy",grid:null},this.save()}getSetting(d){return this.data.settings[d]}setSetting(d,c){this.data.settings[d]=c,this.save(),this.notifyListeners("settings")}getSettings(){return{...this.data.settings}}getStats(){return{...this.data.stats}}addPlayTime(d){this.data.stats.totalPlayTime+=d,this.save()}updateStreak(){const d=new Date().toDateString(),c=this.data.stats.lastPlayDate;if(c===d)return;const R=new Date(Date.now()-864e5).toDateString();c===R?this.data.stats.streak+=1:c!==d&&(this.data.stats.streak=1),this.data.stats.lastPlayDate=d}getFlag(d){var c;return((c=this.data.flags)==null?void 0:c[d])||!1}setFlag(d,c=!0){this.data.flags||(this.data.flags={}),this.data.flags[d]=c,this.save()}getUIState(d){var c;return(c=this.data.uiState)==null?void 0:c[d]}setUIState(d,c){this.data.uiState||(this.data.uiState={}),this.data.uiState[d]=c,this.save()}exportData(){return JSON.stringify(this.data,null,2)}importData(d){try{const c=JSON.parse(d);return w(c)?(this.data=c,this.save(),!0):!1}catch(c){return console.error("[Storage] Import failed:",c),!1}}reset(){this.data=k(),this.save(),this.notifyListeners("reset")}}const P=new L().init();window.Cozy.Storage=P}(),function(){"use strict";const{CONFIG:x}=window.Cozy.Utils;let b=[],w=[],k=null;const L={beginAction(P="fill"){k&&k.changes.length>0&&this.commitAction(),k={type:P,changes:[],timestamp:Date.now()}},recordChange(P,E,d,c){if(d.value===c.value&&d.certain===c.certain)return;k||this.beginAction("fill");const R=k.changes.find(_=>_.row===P&&_.col===E);R?R.after={value:c.value,certain:c.certain}:k.changes.push({row:P,col:E,before:{value:d.value,certain:d.certain},after:{value:c.value,certain:c.certain}})},commitAction(){k&&k.changes.length>0&&(k.changes=k.changes.filter(P=>P.before.value!==P.after.value||P.before.certain!==P.after.certain),k.changes.length>0&&(b.push(k),b.length>x.MAX_HISTORY&&b.shift(),w=[]),this.updateUI()),k=null},cancelAction(){k=null},recordBatchAction(P,E){if(E.length===0)return;const d={type:P,changes:E.map(c=>({row:c.row,col:c.col,before:{value:c.before.value,certain:c.before.certain},after:{value:c.after.value,certain:c.after.certain}})),timestamp:Date.now()};b.push(d),b.length>x.MAX_HISTORY&&b.shift(),w=[],this.updateUI()},undo(){if(b.length===0)return null;const P=b.pop();return w.push(P),this.updateUI(),P.changes.map(E=>({row:E.row,col:E.col,state:{value:E.before.value,certain:E.before.certain}}))},redo(){if(w.length===0)return null;const P=w.pop();return b.push(P),this.updateUI(),P.changes.map(E=>({row:E.row,col:E.col,state:{value:E.after.value,certain:E.after.certain}}))},canUndo(){return b.length>0},canRedo(){return w.length>0},clear(){b=[],w=[],k=null,this.updateUI()},updateUI(){const P=document.getElementById("undo-btn"),E=document.getElementById("redo-btn");P&&(P.disabled=!this.canUndo()),E&&(E.disabled=!this.canRedo())},getStats(){return{undoDepth:b.length,redoDepth:w.length,hasPending:k!==null,pendingChanges:k?k.changes.length:0}}};window.Cozy.History=L}();const ScreenManager=function(){"use strict";const{CONFIG:x,renderOutlinedCanvas:b}=window.Cozy.Utils,w={SPLASH:"splash",HOME:"home",COLLECTION:"collection",PUZZLE:"puzzle",VICTORY:"victory",SETTINGS:"settings",TUTORIAL:"tutorial"};let k=null,L=[],P={},E={},d=null;function c(l){const r=document.getElementById("confirm-modal"),f=document.getElementById("confirm-modal-title"),z=document.getElementById("confirm-modal-message"),h=document.getElementById("confirm-modal-confirm"),O=document.getElementById("confirm-modal-cancel");r&&(f.textContent=l.title||"Confirm",z.textContent=l.message||"Are you sure?",h.textContent=l.confirmText||"Confirm",O.textContent=l.cancelText||"Cancel",h.classList.toggle("confirm-modal-btn-danger",!!l.danger),h.classList.toggle("confirm-modal-btn-primary",!l.danger),r.classList.remove("alert-mode"),d=l,r.classList.add("visible"),setTimeout(()=>h.focus(),100))}function R(l){const r=document.getElementById("confirm-modal"),f=document.getElementById("confirm-modal-title"),z=document.getElementById("confirm-modal-message"),h=document.getElementById("confirm-modal-confirm");r&&(f.textContent=l.title||"Notice",z.textContent=l.message||"",h.textContent=l.buttonText||"OK",h.classList.remove("confirm-modal-btn-danger"),h.classList.add("confirm-modal-btn-primary"),r.classList.add("alert-mode"),d={onConfirm:l.onClose},r.classList.add("visible"),setTimeout(()=>h.focus(),100))}function _(){const l=document.getElementById("confirm-modal");l&&l.classList.remove("visible"),d=null}function W(){const l=document.getElementById("confirm-modal"),r=l==null?void 0:l.querySelector(".confirm-modal-backdrop"),f=document.getElementById("confirm-modal-confirm"),z=document.getElementById("confirm-modal-cancel");l&&(f==null||f.addEventListener("click",()=>{const h=d==null?void 0:d.onConfirm;_(),h&&setTimeout(h,200)}),z==null||z.addEventListener("click",()=>{const h=d==null?void 0:d.onCancel;_(),h&&h()}),r==null||r.addEventListener("click",()=>{const h=d==null?void 0:d.onCancel;_(),h&&h()}),document.addEventListener("keydown",h=>{if(h.key==="Escape"&&l.classList.contains("visible")){const O=d==null?void 0:d.onCancel;_(),O&&O()}if(h.key==="Tab"&&l.classList.contains("visible")){const y=l.classList.contains("alert-mode")?[f]:[z,f],N=y[0],Z=y[y.length-1];y.includes(document.activeElement)?h.shiftKey?document.activeElement===N&&(h.preventDefault(),Z.focus()):document.activeElement===Z&&(h.preventDefault(),N.focus()):(h.preventDefault(),N.focus())}}))}function ne(){G(),W(),Object.values(w).forEach(l=>{E[l]=document.getElementById(`screen-${l}`)}),window.addEventListener("popstate",Q),document.addEventListener("keydown",J),D(w.SPLASH,{},!1)}function J(l){if(l.key!=="Escape"||l.target.tagName==="INPUT"||l.target.tagName==="TEXTAREA")return;const r=document.getElementById("confirm-modal"),f=document.getElementById("help-modal");if(!(r!=null&&r.classList.contains("visible")||f!=null&&f.classList.contains("visible")))switch(k){case w.HOME:break;case w.COLLECTION:D(w.HOME);break;case w.PUZZLE:break;case w.VICTORY:D(w.COLLECTION);break;case w.SETTINGS:D(w.HOME);break;case w.TUTORIAL:window.Cozy.Storage&&window.Cozy.Storage.setFlag("tutorialComplete",!0),D(w.HOME);break}}function D(l,r={},f=!0){const z=E[l];if(!z){console.error(`Screen not found: ${l}`);return}P=r,k&&E[k]&&(k===w.PUZZLE&&window.Cozy.Zoom&&window.Cozy.Zoom.destroy(),E[k].classList.remove("screen-active"),E[k].classList.add("screen-hidden")),z.classList.remove("screen-hidden"),z.classList.add("screen-active"),f&&k!==null&&(L.push(k),L.length>x.MAX_SCREEN_HISTORY&&(L=L.slice(-x.MAX_SCREEN_HISTORY)),history.pushState({screen:l},"",`#${l}`));const h=k;k=l,ee(l,r,h)}function le(){if(L.length>0){const l=L.pop();D(l,{},!1),history.back()}}function Q(l){if(l.state&&l.state.screen)D(l.state.screen,{},!1);else if(L.length>0){const r=L.pop();D(r,{},!1)}}function ee(l,r,f){switch(l){case w.SPLASH:Y();break;case w.HOME:pe();break;case w.COLLECTION:p(r);break;case w.PUZZLE:g(r);break;case w.VICTORY:T(r);break;case w.SETTINGS:I();break;case w.TUTORIAL:B();break}}function $(){return P}function ie(){return k}function Y(){setTimeout(()=>{var z;if(new URLSearchParams(window.location.search).get("action")==="continue"){const h=window.location.pathname+window.location.hash;history.replaceState(null,"",h);const O=window.Cozy.Storage;if(O){const y=O.getSession();if(y&&typeof y.puzzleIndex=="number"){D(w.PUZZLE,{puzzleId:y.puzzleIndex});return}}}const f=(z=window.Cozy.Storage)==null?void 0:z.getFlag("tutorialCompleted");D(f?w.HOME:w.TUTORIAL)},1500)}function pe(){var z;const l=document.getElementById("home-play-btn"),r=document.getElementById("home-settings-btn"),f=document.getElementById("home-progress");if(l&&!l.hasAttribute("data-initialized")&&(l.addEventListener("click",()=>D(w.COLLECTION)),l.setAttribute("data-initialized","true")),r&&!r.hasAttribute("data-initialized")&&(r.addEventListener("click",()=>D(w.SETTINGS)),r.setAttribute("data-initialized","true")),f&&window.PUZZLE_DATA){const h=window.PUZZLE_DATA,O=Array.isArray(h)?h.length:0;let y=0;window.Cozy.Storage&&((z=window.Cozy.Garden)!=null&&z.getPuzzleId)&&h.forEach(N=>{const Z=window.Cozy.Garden.getPuzzleId(N);window.Cozy.Storage.isPuzzleCompleted(Z)&&y++}),f.textContent=`${y} / ${O} puzzles solved`}l&&setTimeout(()=>l.focus(),100)}function p(l){window.dispatchEvent(new CustomEvent("screen:collection",{detail:l}));const r=document.getElementById("collection-search-input");r&&setTimeout(()=>r.focus(),100)}function g(l){window.Cozy.Zoom&&window.Cozy.Zoom.init(),window.dispatchEvent(new CustomEvent("screen:puzzle",{detail:l}))}let m=null;function T(l){const r=document.getElementById("victory-puzzle-name"),f=document.getElementById("victory-image"),z=document.getElementById("victory-continue-btn");m=l.puzzleId,r&&l.puzzleName&&(r.textContent=l.puzzleName),f&&l.solution&&v(f,l.solution,l.palette),z&&!z.hasAttribute("data-initialized")&&(z.addEventListener("click",()=>{const h=f?f.querySelector("canvas"):null;if(h){const O=f.getBoundingClientRect(),y=document.createElement("canvas");y.width=h.width,y.height=h.height,y.getContext("2d").drawImage(h,0,0);const Z=h.width,q=h.height,te=h.width/h.height,ae=Math.min(O.width,O.height);let j;te>1?j=ae:j=ae*te;const ge=j/Z,ue=O.left+O.width/2,Ce=O.top+O.height/2;y.className="flying-stamp",y.style.left=ue-Z/2+"px",y.style.top=Ce-q/2+"px",y.style.width=Z+"px",y.style.height=q+"px",y.style.transform="scale("+ge+")",document.body.appendChild(y),D(w.COLLECTION,{scrollToPuzzleId:m,animateStamp:!0,flyingStamp:y})}else D(w.COLLECTION,{scrollToPuzzleId:m})}),z.setAttribute("data-initialized","true")),z&&setTimeout(()=>z.focus(),100)}function v(l,r,f){l.innerHTML="";const z=r.length,h=r[0]?r[0].length:z,O=b(h,z,x.VICTORY_CANVAS_SIZE,(y,N)=>{const Z=r[y][N];return Z>0&&f[Z]?f[Z]:null});l.appendChild(O)}function I(){var Z,q;const l=document.getElementById("settings-back-btn"),r=document.getElementById("settings-vibration"),f=document.getElementById("settings-reset-btn"),z=window.Cozy.Storage;r&&(r.checked=(Z=z==null?void 0:z.getSetting("vibration"))!=null?Z:!0),l&&!l.hasAttribute("data-initialized")&&(l.addEventListener("click",le),l.setAttribute("data-initialized","true")),r&&!r.hasAttribute("data-initialized")&&(r.addEventListener("change",()=>z==null?void 0:z.setSetting("vibration",r.checked)),r.setAttribute("data-initialized","true")),f&&!f.hasAttribute("data-initialized")&&(f.addEventListener("click",()=>{c({title:"Reset Progress",message:"Are you sure you want to reset all progress? This cannot be undone.",confirmText:"Reset",cancelText:"Cancel",danger:!0,onConfirm:()=>{window.Cozy.Garden&&window.Cozy.Garden.clearAllState&&window.Cozy.Garden.clearAllState(),window.Cozy.Storage&&window.Cozy.Storage.reset&&window.Cozy.Storage.reset(),window.Cozy.Collection&&window.Cozy.Collection.refresh(),R({title:"Progress Reset",message:"All progress has been cleared."})}})}),f.setAttribute("data-initialized","true"));const h=document.getElementById("settings-tutorial-btn");h&&!h.hasAttribute("data-initialized")&&(h.addEventListener("click",()=>{D(w.TUTORIAL)}),h.setAttribute("data-initialized","true"));const O=document.querySelectorAll(".theme-option");let y=(q=window.Cozy.Storage)==null?void 0:q.getSetting("theme");(!y||y==="system")&&(y=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),O.forEach(te=>{const j=te.dataset.theme===y;te.classList.toggle("active",j),te.setAttribute("aria-pressed",j?"true":"false")}),O.forEach(te=>{te.hasAttribute("data-initialized")||(te.addEventListener("click",()=>{const ae=te.dataset.theme;O.forEach(j=>{j.classList.remove("active"),j.setAttribute("aria-pressed","false")}),te.classList.add("active"),te.setAttribute("aria-pressed","true"),window.Cozy.Storage&&window.Cozy.Storage.setSetting("theme",ae),U(ae)}),te.setAttribute("data-initialized","true"))});const N=document.getElementById("settings-solve-all-btn");N&&!N.hasAttribute("data-initialized")&&(N.addEventListener("click",()=>{c({title:"Debug: Solve All",message:"Mark all puzzles as solved? This is a debug feature.",confirmText:"Solve All",cancelText:"Cancel",onConfirm:()=>{const te=window.PUZZLE_DATA||[],ae=window.Cozy.Storage;ae&&te.forEach(j=>{var ue;let ge;(ue=window.Cozy.Garden)!=null&&ue.getPuzzleId?ge=window.Cozy.Garden.getPuzzleId(j):ge=(j.t||j.title).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""),ae.completePuzzle(ge)}),window.Cozy.Collection&&window.Cozy.Collection.refresh(),R({title:"All Puzzles Solved",message:`Marked ${te.length} puzzles as solved!`})}})}),N.setAttribute("data-initialized","true")),r&&setTimeout(()=>r.focus(),100)}let H=0;function B(){const l=document.getElementById("tutorial-skip-btn"),r=document.getElementById("tutorial-next-btn"),f=document.querySelectorAll(".tutorial-step"),z=document.querySelectorAll(".tutorial-dot");function h(y){f.forEach((N,Z)=>{N.classList.toggle("active",Z===y)}),z.forEach((N,Z)=>{N.classList.toggle("active",Z===y)}),r&&(r.textContent=y===f.length-1?"Start Playing":"Next")}function O(){var y;(y=window.Cozy.Storage)==null||y.setFlag("tutorialCompleted",!0),D(w.HOME)}l&&!l.hasAttribute("data-initialized")&&(l.addEventListener("click",O),l.setAttribute("data-initialized","true")),r&&!r.hasAttribute("data-initialized")&&(r.addEventListener("click",()=>{H<f.length-1?(H++,h(H)):O()}),r.setAttribute("data-initialized","true")),H=0,h(0),r&&setTimeout(()=>r.focus(),100)}function U(l){document.documentElement.setAttribute("data-theme",l);const r=document.getElementById("theme-color-meta");r&&r.setAttribute("content",l==="dark"?"#0a1018":"#4a7c3f")}function G(){var r;let l=(r=window.Cozy.Storage)==null?void 0:r.getSetting("theme");(!l||l==="system")&&(l=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),U(l)}return{init:ne,showScreen:D,goBack:le,getScreenData:$,getCurrentScreen:ie,applyTheme:U,initTheme:G,showConfirmModal:c,SCREENS:w}}();window.Cozy.Screens=ScreenManager,document.addEventListener("DOMContentLoaded",()=>{ScreenManager.init()}),function(){"use strict";const{CONFIG:x,getPuzzleId:b,getPuzzleTitle:w,parsePuzzleTitle:k,renderOutlinedCanvas:L}=window.Cozy.Utils,P=["easy","medium","hard","challenging","expert"];function E(){var g;const p=(g=window.Cozy.Storage)==null?void 0:g.getUIState("collapsedSections");return p&&typeof p=="object"?p:null}function d(p){var g;(g=window.Cozy.Storage)==null||g.setUIState("collapsedSections",p)}function c(p,g){const m=document.querySelector(`.collection-section[data-difficulty="${p}"]`);if(!m)return;const T=g[p];g[p]=!T,d(g),m.classList.toggle("collapsed",!T);const v=m.querySelector(".collection-grid"),I=m.querySelector(".section-chevron");v&&(v.style.display=T?"flex":"none"),I&&(I.textContent=T?"\u25BC":"\u25B6")}function R(){return window.Cozy.Storage||null}function _(p){const g={};return p.forEach((m,T)=>{const v=k(w(m)),I=v.difficulty;g[I]||(g[I]=[]),g[I].push({index:T,puzzle:m,meta:v,id:b(m)})}),g}function W(p){const g={};return p.forEach(m=>{const T=k(w(m.puzzle)),v=T.difficulty;g[v]||(g[v]=[]),g[v].push({index:m.originalIndex,puzzle:m.puzzle,meta:T,id:b(m.puzzle)})}),g}function ne(p){return Object.keys(p).sort((m,T)=>{const v=P.indexOf(m),I=P.indexOf(T);return v!==-1&&I!==-1?v-I:v!==-1?-1:I!==-1?1:m.localeCompare(T)})}function J(p){return p.charAt(0).toUpperCase()+p.slice(1)}function D(p){const g=R();let m=0;return g&&p.forEach(T=>{g.isPuzzleCompleted(T.id)&&m++}),{completed:m,total:p.length}}function le(p){if(!p)return!1;for(const g of p)for(const m of g)if((typeof m=="object"&&m!==null?m.value:m)!==null)return!0;return!1}function Q(p,g,m={}){const T=R(),v=T?T.isPuzzleCompleted(p.id):!1,I=T?T.getPuzzleGrid(p.id):null,H=!v&&le(I),B=document.createElement("div");B.className="puzzle-card"+(v?" completed":"")+(H?" in-progress":""),B.dataset.puzzleIndex=p.index,B.dataset.puzzleId=p.id,B.tabIndex=-1,B.setAttribute("role","button"),B.setAttribute("aria-label",`${p.meta.name}, ${p.meta.width} by ${p.meta.height}${v?", completed":""}`),B.addEventListener("keydown",f=>{if(f.key==="Enter"||f.key===" "){f.preventDefault(),window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=p.id),g(p.index);return}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(f.key)&&(f.preventDefault(),f.stopPropagation(),window.Cozy.Collection&&window.Cozy.Collection.navigateFromCard(B,f.key))});const U=document.createElement("div");if(U.className="puzzle-card-preview",m.forceBlank){U.classList.add("awaiting-stamp");const f=document.createElement("div");f.className="puzzle-card-placeholder",f.textContent="?",U.appendChild(f)}else if(v)U.appendChild(ee(p.puzzle));else if(H)U.appendChild($(p.puzzle,I));else{const f=document.createElement("div");f.className="puzzle-card-placeholder",f.textContent="?",U.appendChild(f)}B.appendChild(U);const G=document.createElement("div");G.className="puzzle-card-name",G.textContent=p.meta.name,B.appendChild(G);const l=Object.keys(p.puzzle.color_map).length,r=document.createElement("div");return r.className="puzzle-card-badge",r.textContent=`${p.meta.width}\xD7${p.meta.height} \xB7 ${l}c`,B.appendChild(r),B.addEventListener("click",()=>{window.Cozy.Collection&&(window.Cozy.Collection.focusedCardId=p.id),g(p.index)}),B}function ee(p){try{const g=L(p.width,p.height,x.MINI_CANVAS_SIZE,(m,T)=>{var I,H,B;const v=(H=(I=p.solution)==null?void 0:I[m])==null?void 0:H[T];if(v>0){const U=(B=p.color_map)==null?void 0:B[v];if(U&&Array.isArray(U)&&U.length>=3)return U}return null});return g.className="puzzle-mini-canvas",g}catch(g){return console.error("[Collection] Error creating mini solution:",g),null}}function $(p,g){try{const m=L(p.width,p.height,x.MINI_CANVAS_SIZE,(T,v)=>{var B,U;const I=(B=g==null?void 0:g[T])==null?void 0:B[v],H=typeof I=="object"&&I!==null?I.value:I;if(H!==null&&H>0){const G=(U=p.color_map)==null?void 0:U[H];if(G&&Array.isArray(G)&&G.length>=3)return G}return null});return m.className="puzzle-mini-canvas",m}catch(m){return console.error("[Collection] Error creating mini progress:",m),null}}function ie(p,g,m,T={}){p.innerHTML="";const v=(T.searchFilter||"").toLowerCase().trim().slice(0,x.MAX_SEARCH_LENGTH);let I=g.map((l,r)=>({puzzle:l,originalIndex:r}));v&&(I=I.filter(l=>k(w(l.puzzle)).name.toLowerCase().includes(v)));const H=W(I),B=ne(H),U=R();if(B.length===0&&v){const l=document.createElement("div");l.className="collection-empty-state";const r=document.createElement("p");r.className="collection-empty-message",r.textContent=`No puzzles match "${v}"`,l.appendChild(r),p.appendChild(l);return}let G;if(v)G={},B.forEach(l=>{G[l]=!1});else if(G=E(),!G){G={};let l=!1;B.forEach(r=>{const f=D(H[r]);!l&&f.completed<f.total?(G[r]=!1,l=!0):G[r]=!0}),!l&&B.length>0&&(G[B[0]]=!1),d(G)}B.forEach(l=>{const r=H[l],f=D(r),z=G[l],h=document.createElement("div");h.className="collection-section"+(z?" collapsed":""),h.dataset.difficulty=l;const O=document.createElement("div");O.className="collection-section-header",O.style.cursor="pointer";const y=document.createElement("span");y.className="section-chevron",y.textContent=z?"\u25B6":"\u25BC",O.appendChild(y);const N=document.createElement("h3");N.className="collection-section-title",N.textContent=J(l),O.appendChild(N);const Z=document.createElement("span");Z.className="collection-section-stats",Z.textContent=`${f.completed}/${f.total}`,f.completed===f.total&&f.total>0&&Z.classList.add("complete"),O.appendChild(Z),O.addEventListener("click",()=>{c(l,G)}),h.appendChild(O);const q=document.createElement("div");q.className="collection-grid",q.style.display=z?"none":"flex",r.forEach(te=>{const ae={};T.blankPuzzleId&&te.id===T.blankPuzzleId&&(ae.forceBlank=!0);const j=Q(te,m,ae);q.appendChild(j)}),h.appendChild(q),p.appendChild(h)})}class Y{constructor(){this.container=null,this.puzzles=[],this.onPuzzleSelect=null,this.visible=!0,this.searchFilter="",this.searchInput=null,this.searchInputHandler=null,this.searchDebounceTimeout=null,this.focusedCardId=null}init(g,m,T){return this.container=document.getElementById(g),this.puzzles=m,this.onPuzzleSelect=T,this.searchInput=document.getElementById("collection-search-input"),this.searchInput&&(this.searchInputHandler&&this.searchInput.removeEventListener("input",this.searchInputHandler),this.searchInputHandler=v=>{this.searchFilter=v.target.value,this.searchDebounceTimeout&&clearTimeout(this.searchDebounceTimeout),this.searchDebounceTimeout=setTimeout(()=>this.render(),150)},this.searchInput.addEventListener("input",this.searchInputHandler)),this.container&&this.render(),this}render(g={}){if(!this.container)return;const m={...g,searchFilter:this.searchFilter};ie(this.container,this.puzzles,T=>{this.onPuzzleSelect&&this.onPuzzleSelect(T)},m),this.updateRovingTabindex()}show(){this.container&&(this.container.style.display="block",this.visible=!0,this.searchFilter="",this.searchInput&&(this.searchInput.value=""),this.render())}hide(){this.container&&(this.container.style.display="none",this.visible=!1)}isVisible(){return this.visible}refresh(g={}){this.visible&&this.render(g)}getVisibleCards(){if(!this.container)return[];const g=[];return this.container.querySelectorAll(".collection-section").forEach(T=>{const v=T.querySelector(".collection-grid");v&&v.style.display!=="none"&&v.querySelectorAll(".puzzle-card").forEach(H=>g.push(H))}),g}findCardInDirection(g,m){const T=this.getVisibleCards();if(T.length===0)return null;const v=g.getBoundingClientRect(),I=v.left+v.width/2,H=v.top+v.height/2,B=v.height*.5,U=v.width*.5;let G=null,l=1/0;return T.forEach(r=>{if(r===g)return;const f=r.getBoundingClientRect(),z=f.left+f.width/2,h=f.top+f.height/2;let O=!1;switch(m){case"left":O=z<I-U&&Math.abs(h-H)<B;break;case"right":O=z>I+U&&Math.abs(h-H)<B;break;case"up":O=h<H-B;break;case"down":O=h>H+B;break}if(O){let y;if(m==="left"||m==="right")y=Math.abs(z-I);else{const N=Math.abs(h-H),Z=Math.abs(z-I);y=N*1e3+Z}y<l&&(l=y,G=r)}}),G}navigateFromCard(g,m){const v={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[m];if(!v)return;const I=this.findCardInDirection(g,v);I&&(g.tabIndex=-1,I.tabIndex=0,I.focus(),this.focusedCardId=I.dataset.puzzleId,I.scrollIntoView({behavior:"smooth",block:"nearest"}))}updateRovingTabindex(){const g=this.getVisibleCards();if(g.length===0)return;let m=null;if(this.focusedCardId){const T=this.container.querySelector(`.puzzle-card[data-puzzle-id="${this.focusedCardId}"]`);T&&g.includes(T)&&(m=T)}m||(m=g[0],this.focusedCardId=(m==null?void 0:m.dataset.puzzleId)||null),g.forEach(T=>{T.tabIndex=T===m?0:-1})}scrollToPuzzle(g,m={}){if(!this.container)return;const T=this.container.querySelectorAll(".puzzle-card");let v=null,I=-1;for(let U=0;U<this.puzzles.length;U++)if(b(this.puzzles[U])===g){I=U;break}if(I===-1||(T.forEach(U=>{parseInt(U.dataset.puzzleIndex,10)===I&&(v=U)}),!v))return;const H=v.closest(".collection-section");if(H&&H.classList.contains("collapsed")){const U=H.dataset.difficulty,G=H.querySelector(".collection-grid"),l=H.querySelector(".section-chevron");H.classList.remove("collapsed"),G&&(G.style.display="flex"),l&&(l.textContent="\u25BC");let r=E()||{};r[U]=!1,d(r)}const B=m.instant?"instant":"smooth";setTimeout(()=>{v.scrollIntoView({behavior:B,block:"center"})},m.instant?0:100)}animateStampTo(g,m,T={}){if(!this.container||!m)return;const v=this.container.querySelector(`.puzzle-card[data-puzzle-id="${g}"]`);if(!v){m.remove();return}const I=v.querySelector(".puzzle-card-preview");if(!I){m.remove();return}setTimeout(()=>{const B=I.getBoundingClientRect(),U=parseFloat(m.style.width),G=parseFloat(m.style.height),l=this.puzzles.find(y=>b(y)===g);let r,f;if(l){const y=Math.max(l.width,l.height),N=Math.max(2,Math.floor(x.MINI_CANVAS_SIZE/y)),Z=x.OUTLINE_THICKNESS*2;r=l.width*N+Z,f=l.height*N+Z}else{const y=U/G;y>1?(r=B.width,f=B.width/y):(f=B.height,r=B.height*y)}const z=r/U,h=B.left+B.width/2,O=B.top+B.height/2;requestAnimationFrame(()=>{m.style.left=h-U/2+"px",m.style.top=O-G/2+"px",m.style.transform="scale("+z+")",m.classList.add("landed")}),setTimeout(()=>{I.classList.remove("awaiting-stamp"),I.innerHTML="";const y=this.puzzles.find(N=>b(N)===g);if(y){const N=R();if(N?N.isPuzzleCompleted(g):!1)I.appendChild(ee(y));else{const q=N?N.getPuzzleGrid(g):null;q&&I.appendChild($(y,q))}}m.remove()},650)},100)}}const pe=new Y;window.Cozy.Collection=pe}(),function(){"use strict";const x={isInstalled:!1,swRegistration:null,resizeTimeout:null,init(){this.checkInstallState(),this.registerServiceWorker(),this.setupEventListeners(),console.log("[App] Cozy Garden initialized")},checkInstallState(){window.matchMedia("(display-mode: standalone)").matches&&(this.isInstalled=!0),window.navigator.standalone===!0&&(this.isInstalled=!0),this.isInstalled&&(document.body.classList.add("is-installed"),console.log("[App] Running as installed PWA"))},async registerServiceWorker(){if(!("serviceWorker"in navigator)){console.log("[App] Service workers not supported");return}try{this.swRegistration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("[App] Service worker registered:",this.swRegistration.scope),this.swRegistration.addEventListener("updatefound",()=>{const b=this.swRegistration.installing;console.log("[App] New service worker installing..."),b.addEventListener("statechange",()=>{b.state==="installed"&&navigator.serviceWorker.controller&&this.showUpdateNotification()})})}catch(b){console.error("[App] Service worker registration failed:",b)}},showUpdateNotification(){const b=document.createElement("div");b.className="update-banner";const w=document.createElement("span");w.textContent="A new version is available!";const k=document.createElement("button");k.textContent="Update",k.addEventListener("click",()=>this.applyUpdate());const L=document.createElement("button");L.textContent="Later",L.addEventListener("click",()=>b.remove()),b.appendChild(w),b.appendChild(k),b.appendChild(L),document.body.appendChild(b)},applyUpdate(){this.swRegistration&&this.swRegistration.waiting&&this.swRegistration.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload()},setupEventListeners(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?this.onAppFocus():this.onAppBlur()}),window.addEventListener("beforeunload",()=>{this.saveState()}),window.addEventListener("orientationchange",()=>{setTimeout(()=>this.handleResize(),100)}),window.addEventListener("resize",()=>{this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>this.handleResize(),100)})},onAppFocus(){console.log("[App] App focused")},onAppBlur(){console.log("[App] App blurred"),this.saveState()},saveState(){window.Cozy.Garden&&window.Cozy.Storage&&console.log("[App] Saving state...")},handleResize(){const b=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${b}px`)},isPWA(){return this.isInstalled||window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0},async getVersion(){return!this.swRegistration||!navigator.serviceWorker.controller?"unknown":new Promise(b=>{const w=new MessageChannel;w.port1.onmessage=k=>{b(k.data.version||"unknown")},navigator.serviceWorker.controller.postMessage({type:"GET_VERSION"},[w.port2]),setTimeout(()=>b("unknown"),1e3)})},async share(b,w,k){if(navigator.share)try{return await navigator.share({title:b,text:w,url:k}),!0}catch(L){return L.name!=="AbortError"&&console.error("[App] Share failed:",L),!1}return!1},vibrate(b=50){var w;navigator.vibrate&&((w=window.Cozy.Storage)!=null&&w.getSetting("vibration"))&&navigator.vibrate(b)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>x.init()):x.init(),window.Cozy.App=x}(),function(){"use strict";const{CONFIG:x,getPuzzleId:b,getPuzzleTitle:w,renderOutlinedCanvas:k}=window.Cozy.Utils;let L=0,P="easy",E=1,d=[],c=!1,R=null,_=!0,W=!1,ne=!1,J=0,D=0,le=null,Q=null,ee=null,$=[],ie=[],Y=[],pe=null;function p(e,t="info"){const n=document.getElementById("toast");n&&(clearTimeout(pe),n.textContent=e,n.className="toast visible",t==="success"?n.classList.add("toast-success"):t==="info"&&n.classList.add("toast-info"),pe=setTimeout(()=>{n.classList.remove("visible")},x.TOAST_DURATION))}function g(){const e=document.getElementById("toast");e&&(clearTimeout(pe),e.classList.remove("visible"))}function m(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function T(){const e=document.getElementById("help-list");if(!e)return;const t=m();let n=["<li><strong>Select a color</strong> from the palette, then tap cells to fill them</li>","<li><strong>Drag</strong> across cells to fill multiple at once</li>","<li><strong>Long-press</strong> a cell to mark it \u2715 (definitely empty)</li>","<li><strong>Pencil mode</strong> marks uncertain guesses \u2014 confirm or clear them later</li>"];t&&n.push("<li><strong>Pinch to zoom</strong> on larger puzzles for easier tapping</li>"),t||(n.push('<li class="help-section-title">Keyboard Shortcuts</li>'),n.push("<li><strong>Ctrl+Z</strong> / <strong>Ctrl+Y</strong> \u2014 Undo / Redo</li>"),n.push("<li><strong>P</strong> \u2014 Toggle pencil mode</li>"),n.push("<li><strong>1-9</strong> \u2014 Select color by number</li>"),n.push("<li><strong>+</strong> / <strong>-</strong> \u2014 Zoom in / out</li>")),e.innerHTML=n.join("")}function v(){const e=document.getElementById("help-modal");if(!e)return;T(),e.classList.add("visible"),document.body.style.overflow="hidden";const t=e.querySelector(".help-modal-close");t&&setTimeout(()=>t.focus(),100)}function I(){const e=document.getElementById("help-modal");e&&(e.classList.remove("visible"),document.body.style.overflow="")}function H(){const e=document.getElementById("help-btn"),t=document.getElementById("help-modal"),n=t==null?void 0:t.querySelector(".help-modal-backdrop"),o=t==null?void 0:t.querySelector(".help-modal-close");e&&e.addEventListener("click",v),n&&n.addEventListener("click",I),o&&o.addEventListener("click",I),document.addEventListener("keydown",i=>{if(t!=null&&t.classList.contains("visible")){if(i.key==="Escape"){I();return}i.key==="Tab"&&(document.activeElement!==o?(i.preventDefault(),o==null||o.focus()):i.preventDefault())}})}function B(){var e;(e=window.Cozy.Storage)!=null&&e.getFlag("helpShown")||setTimeout(()=>{var t;v(),(t=window.Cozy.Storage)==null||t.setFlag("helpShown",!0)},500)}function U(e){if(!e)return null;if(e.title!==void 0)return!e.width||!e.height||!e.row_clues||!e.col_clues||!e.color_map?(console.warn("[Game] Invalid verbose puzzle format:",e.title),null):e;if(!e.t||!e.w||!e.h||!Array.isArray(e.r)||!Array.isArray(e.c)||!Array.isArray(e.p)||!Array.isArray(e.s))return console.warn("[Game] Invalid concise puzzle format, missing or malformed fields:",e.t),null;if(e.w>x.MAX_PUZZLE_DIMENSION||e.h>x.MAX_PUZZLE_DIMENSION||e.w<1||e.h<1)return console.warn("[Game] Puzzle dimensions out of range:",e.w,"x",e.h),null;function t(s){const u=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(s);return u?[parseInt(u[1],16),parseInt(u[2],16),parseInt(u[3],16)]:[0,0,0]}function n(s){return s.map(u=>u.map(([S,C])=>({count:S,color:C+1})))}function o(s){const u={};return s.forEach((S,C)=>{u[C+1]=t(S)}),u}function i(s){return s.map(u=>u.map(S=>S<0?0:S+1))}try{return{title:e.t,width:e.w,height:e.h,row_clues:n(e.r),col_clues:n(e.c),color_map:o(e.p),solution:i(e.s)}}catch(s){return console.error("[Game] Failed to convert puzzle:",e.t,s),null}}let G=null,l=null;function r(){const e=window.PUZZLE_DATA||[];return(!G||e!==l)&&(G=e.map(U).filter(t=>t!==null),l=e),G}function f(e=null,t=!0){return{value:e,certain:t}}function z(e,t){var n;return((n=d[e])==null?void 0:n[t])||f()}function h(e,t,n,o){d[e][t]={value:n,certain:o}}function O(e){return`rgb(${e[0]}, ${e[1]}, ${e[2]})`}function y(e){return(e[0]*299+e[1]*587+e[2]*114)/1e3}function N(e){const t=e.toLowerCase();return t.includes("easy")?"easy":t.includes("medium")?"medium":t.includes("hard")?"hard":t.includes("challenging")?"challenging":t.includes("expert")?"expert":"easy"}function Z(){return window.Cozy.Storage||null}function q(){return window.Cozy.History||null}function te(){const e=r()[L];if(!e)return!0;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++)if(z(t,n).value!==null)return!1;return!0}function ae(){const e=r()[L];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=z(t,n),i=e.solution[t][n];if(o.value!==i||!o.certain)return!1}return!0}function j(){const e=document.getElementById("reset-btn"),t=document.getElementById("solution-btn");if(e){const n=te();e.disabled=n,e.setAttribute("aria-label",n?"Reset (puzzle is empty)":"Hold to reset puzzle")}if(t){const n=ae();t.disabled=n,t.setAttribute("aria-label",n?"Solution (already shown)":"Hold to reveal solution")}}function ge(e){const t=document.getElementById("sr-announcer");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},50))}function ue(e){W=e,ke(),ge(e?"Pencil mode":"Pen mode"),Ee()}function Ce(){ue(!W)}function ke(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("palette-menu-btn");if(e&&(e.classList.toggle("active",!W),e.setAttribute("aria-checked",String(!W))),t&&(t.classList.toggle("active",W),t.setAttribute("aria-checked",String(W))),n){const o=n.querySelector(".menu-icon-svg");o&&(o.removeAttribute("stroke"),o.removeAttribute("stroke-width"),o.setAttribute("fill","currentColor"),W?o.innerHTML='<path d="M19.07 13.88L13 19.94l-1.41-1.41 6.07-6.06 1.41 1.41zm-5.66-5.66l-6.06 6.07-1.42-1.41 6.07-6.07 1.41 1.41zM17.66 5.99l-2.34 2.34 1.41 1.41 2.34-2.34-1.41-1.41zM3 18v3h3l.01-.01L3 18zm3-3l-1 1 3 3 1-1-3-3z" opacity="0.5"/><path d="M9.17 16.17L7.76 17.59l3.54 3.54 1.41-1.41-3.54-3.55zm10.6-10.6l-3.53-3.54-1.42 1.42 3.54 3.53 1.41-1.41z"/>':o.innerHTML='<path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>')}document.body.classList.toggle("pencil-mode",W)}function Ue(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");if(!e||!t)return;e.classList.contains("open")?Ee():Ge()}function Ge(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");!e||!t||(e.classList.add("open"),t.classList.add("menu-open"),t.setAttribute("aria-expanded","true"),setTimeout(()=>{document.addEventListener("click",Re)},0))}function Ee(){const e=document.getElementById("mode-menu"),t=document.getElementById("palette-menu-btn");e&&(e.classList.remove("open"),t&&(t.classList.remove("menu-open"),t.setAttribute("aria-expanded","false")),document.removeEventListener("click",Re))}function Re(e){const t=document.getElementById("mode-menu"),n=document.getElementById("palette-menu-btn");!t||!n||!t.contains(e.target)&&!n.contains(e.target)&&Ee()}function Fe(){const e=r()[L];if(!e)return!1;for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++){const o=z(t,n);if(!o.certain&&o.value!==null)return!0}return!1}function $e(){const e=r()[L];if(!e)return 0;let t=0;for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=z(n,o);!i.certain&&i.value!==null&&t++}return t}function de(){const e=document.getElementById("pencil-actions-section"),t=document.getElementById("palette-menu-btn"),n=Fe(),o=n?$e():0;if(e&&e.classList.toggle("has-marks",n),t){t.classList.toggle("has-pencil-marks",n);const i=t.querySelector(".pencil-badge");i&&(i.textContent=o>x.BADGE_MAX_DISPLAY?`${x.BADGE_MAX_DISPLAY}+`:String(o))}}function He(){const e=r()[L];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=z(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:null,certain:!0}}),h(n,o,null,!0),he(n,o,e))}if(t.length>0){const n=q();n&&n.recordBatchAction("batch-clear",t),window.Cozy.App&&window.Cozy.App.vibrate(20)}de(),Se()}function Ne(){const e=r()[L];if(!e)return;const t=[];for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=z(n,o);!i.certain&&i.value!==null&&(t.push({row:n,col:o,before:{value:i.value,certain:i.certain},after:{value:i.value,certain:!0}}),h(n,o,i.value,!0),he(n,o,e))}if(t.length>0){const n=q();n&&n.recordBatchAction("batch-confirm",t),window.Cozy.App&&window.Cozy.App.vibrate([20,50,20])}de(),Ye(e),Se()}function xe(){const e=q();if(!e)return;const t=e.undo();if(!t)return;const n=r()[L];for(const o of t)h(o.row,o.col,o.state.value,o.state.certain),he(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),de(),me(n),j(),Se()}function _e(){const e=q();if(!e)return;const t=e.redo();if(!t)return;const n=r()[L];for(const o of t)h(o.row,o.col,o.state.value,o.state.certain),he(o.row,o.col,n);window.Cozy.App&&window.Cozy.App.vibrate(15),de(),me(n),j(),Ye(n),Se()}function Se(){const e=Z();if(!e)return;const n=r()[L];if(!n)return;const o=b(n);e.savePuzzleGrid(o,d),e.saveSession(L,P,d)}function qe(){const e=Z();e&&e.clearSession()}function Ke(){const e=r(),t=document.getElementById("puzzle-select"),n=[...new Set(e.map(S=>N(S.title)))],o=["easy","medium","hard","challenging","expert"];n.sort((S,C)=>o.indexOf(S)-o.indexOf(C));const i=document.createElement("div");i.className="difficulty-tabs",n.forEach(S=>{const C=document.createElement("button");C.className="difficulty-tab"+(S===P?" active":""),C.textContent=S.charAt(0).toUpperCase()+S.slice(1),C.onclick=()=>{P=S,document.querySelectorAll(".difficulty-tab").forEach(F=>F.classList.remove("active")),C.classList.add("active"),Me()},i.appendChild(C)});const s=document.createElement("div");s.className="puzzle-dropdown";const u=document.createElement("select");u.id="puzzle-select-dropdown",u.onchange=S=>{Ie(parseInt(S.target.value))},s.appendChild(u),t.appendChild(i),t.appendChild(s),Me()}function Me(){var i;const e=r(),t=document.getElementById("puzzle-select-dropdown");if(!t)return;const n=Z();if(t.innerHTML="",e.forEach((s,u)=>{if(N(s.title)===P){const S=document.createElement("option");S.value=u;const C=b(s),F=n?n.isPuzzleCompleted(C):!1;S.textContent=(F?"\u2713 ":"")+s.title,u===L&&(S.selected=!0),t.appendChild(S)}}),e.filter(s=>N(s.title)===P).length>0&&!(N((i=e[L])==null?void 0:i.title)===P)){const u=e.findIndex(S=>N(S.title)===P);u>=0&&Ie(u)}}function Ie(e,t=null){if(ne){console.warn("[Game] Puzzle already loading, ignoring request");return}ne=!0;try{const n=r(),o=Z(),i=q();if(e!==L&&d.length>0&&n[L]&&o){const X=b(n[L]);o.savePuzzleGrid(X,d)}i&&i.clear(),W=!1,ke(),J=0,D=0,L=e;const s=n[e];if(!s){ne=!1;return}if(s.width>x.MAX_PUZZLE_DIMENSION||s.height>x.MAX_PUZZLE_DIMENSION||s.width<1||s.height<1){console.error(`[Game] Invalid puzzle dimensions: ${s.width}x${s.height}`),ne=!1;return}const u=b(s);let S=t;!S&&o&&(S=o.getPuzzleGrid(u));const C=S&&S.length===s.height;if(C)d=S.map(X=>X.map(oe=>({value:oe.value,certain:oe.certain})));else{d=[];for(let X=0;X<s.height;X++){d.push([]);for(let oe=0;oe<s.width;oe++)d[X][oe]=f(null,!0)}}if(E=1,Ve(s),A(s),De(s),rt(),C)for(let X=0;X<s.height;X++)for(let oe=0;oe<s.width;oe++)z(X,oe).value!==null&&he(X,oe,s);g();const F=document.getElementById("puzzle-select-dropdown");F&&(F.value=e);const K=N(s.title);K!==P&&(P=K,document.querySelectorAll(".difficulty-tab").forEach(X=>{X.classList.toggle("active",X.textContent.toLowerCase()===K)}),Me()),de(),me(s),window.Cozy.Zoom&&window.Cozy.Zoom.initForPuzzle(s),B(),j()}finally{ne=!1}}function Ve(e){const t=document.getElementById("palette"),n=document.getElementById("mode-menu"),o=n?n.parentNode:null;n&&t.contains(n)&&document.body.appendChild(n),t.innerHTML="";const i=document.createElement("button");i.className="color-btn eraser",i.title="Eraser",i.setAttribute("aria-label","Eraser"),i.setAttribute("aria-pressed",E===0?"true":"false"),i.addEventListener("click",()=>ze(0)),t.appendChild(i),Object.entries(e.color_map).forEach(([C,F])=>{const K=document.createElement("button"),X=parseInt(C)===E;K.className="color-btn"+(X?" selected":""),K.style.background=O(F),K.setAttribute("aria-label",`Color ${C}`),K.setAttribute("aria-pressed",X?"true":"false"),K.addEventListener("click",()=>ze(parseInt(C))),t.appendChild(K)});const s=document.createElement("button");s.className="palette-menu-btn",s.id="palette-menu-btn",s.title="Drawing mode",s.setAttribute("aria-label","Drawing mode menu"),s.setAttribute("aria-haspopup","true"),s.setAttribute("aria-expanded","false"),s.innerHTML=`
      <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>
      </svg>
      <span class="pencil-badge">0</span>
    `,s.addEventListener("click",C=>{C.stopPropagation(),Ue()}),t.appendChild(s);const u=document.getElementById("mode-menu");u&&t.appendChild(u);const S=t.querySelectorAll(".color-btn, .palette-menu-btn").length;t.classList.remove("palette-8-buttons","palette-7-buttons"),S>=8?t.classList.add("palette-8-buttons"):S===7&&t.classList.add("palette-7-buttons")}function ze(e){E=e;const n=r()[L];document.querySelectorAll(".color-btn").forEach((o,i)=>{let s;i===0?s=e===0:s=parseInt(Object.keys(n.color_map)[i-1])===e,o.classList.toggle("selected",s),o.setAttribute("aria-pressed",s?"true":"false")})}function a(e,t,n){const o=document.createElement("div");if(o.className=n,e===null)o.textContent="0",o.style.background="#333";else{const i=t.color_map[e.color];o.textContent=e.count,o.style.background=O(i),o.style.color=y(i)>x.BRIGHTNESS_MIDPOINT?"#000":"#fff",o.style.cursor="pointer",o.onclick=()=>ze(e.color)}return o}function A(e){Y=[],ie=[];const t=document.getElementById("col-clues");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,e.col_clues.forEach((o,i)=>{const s=document.createElement("div");s.className="col-clue",s.dataset.col=i,o.length===0?s.appendChild(a(null,e,"clue-cell")):o.forEach(u=>{s.appendChild(a(u,e,"clue-cell"))}),Y[i]=s,t.appendChild(s)});const n=document.getElementById("row-clues-container");n.innerHTML="",n.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,e.row_clues.forEach((o,i)=>{const s=document.createElement("div");s.className="row-clues",s.dataset.row=i,o.length===0?s.appendChild(a(null,e,"row-clue-cell")):o.forEach(u=>{s.appendChild(a(u,e,"row-clue-cell"))}),ie[i]=s,n.appendChild(s)})}let M=-1,V=-1;function se(e,t){var o;if(m()||e===M&&t===V||(re(),M=e,V=t,e<0||t<0)||!$[e])return;const n=$[e];if(n)for(let i=0;i<n.length;i++){const s=n[i];s&&(s.classList.add("highlight-row"),i===t&&s.classList.add("highlight-cell"))}for(let i=0;i<$.length;i++)i!==e&&((o=$[i])!=null&&o[t])&&$[i][t].classList.add("highlight-col");ie[e]&&ie[e].classList.add("highlight-clue"),Y[t]&&Y[t].classList.add("highlight-clue")}function re(){var n;const e=M,t=V;if(M=-1,V=-1,!(e<0&&t<0)){if(e>=0&&$[e])for(let o=0;o<$[e].length;o++){const i=$[e][o];i&&i.classList.remove("highlight-row","highlight-cell")}if(t>=0)for(let o=0;o<$.length;o++){const i=(n=$[o])==null?void 0:n[t];i&&i.classList.remove("highlight-col")}e>=0&&ie[e]&&ie[e].classList.remove("highlight-clue"),t>=0&&Y[t]&&Y[t].classList.remove("highlight-clue")}}function ce(e,t){var i,s;const n=r()[L];if(!n||e<0||e>=n.height||t<0||t>=n.width)return;(i=$[J])!=null&&i[D]&&($[J][D].tabIndex=-1),J=e,D=t;const o=(s=$[e])==null?void 0:s[t];o&&(o.tabIndex=0,o.focus())}function fe(e,t){const n=document.createElement("div");return n.className="cell",n.dataset.row=e,n.dataset.col=t,n.tabIndex=e===J&&t===D?0:-1,n.setAttribute("role","gridcell"),n.setAttribute("aria-label",`Row ${e+1}, Column ${t+1}`),n}function we(e,t,n){e.onfocus=()=>{var o;(J!==t||D!==n)&&((o=$[J])!=null&&o[D]&&($[J][D].tabIndex=-1),J=t,D=n,e.tabIndex=0),se(t,n)}}function be(e,t,n){e.onkeydown=o=>{if(o.key==="ArrowUp")o.preventDefault(),ce(t-1,n);else if(o.key==="ArrowDown")o.preventDefault(),ce(t+1,n);else if(o.key==="ArrowLeft")o.preventDefault(),ce(t,n-1);else if(o.key==="ArrowRight")o.preventDefault(),ce(t,n+1);else if(o.key==="Enter"||o.key===" "){o.preventDefault();const i=q();i&&i.beginAction("fill"),ye(t,n,E,!W),i&&i.commitAction(),de()}else if(o.key==="x"||o.key==="X"){o.preventDefault(),o.stopPropagation();const i=q();i&&i.beginAction("fill"),ye(t,n,0,!W),i&&i.commitAction(),de()}}}function Le(e,t,n=!1){const o=q();o&&o.beginAction("fill"),c=!0,R=n?0:E,_=!W,ye(e,t,R,_);const i=z(e,t);R=i.value,_=i.certain}function ve(e=!0){if(!c)return;c=!1,R=null;const t=q();t&&(e?t.commitAction():t.cancelAction()),de()}function Be(e,t,n){e.onmousedown=o=>{o.preventDefault(),e.focus(),Le(t,n,o.button===2)},e.onmouseenter=()=>{se(t,n),c&&ye(t,n,R,_,!0)},e.oncontextmenu=o=>{o.preventDefault()}}function Oe(e,t,n){let o=null,i=0,s=!1,u=t,S=n;e.ontouchstart=C=>{var X,oe;if(C.touches.length>1)return;if(C.preventDefault(),C.stopPropagation(),s=!1,i=Date.now(),u=t,S=n,window.Cozy.Zoom){const Pe=(oe=(X=C.touches[0])==null?void 0:X.clientY)!=null?oe:0;window.Cozy.Zoom.onCellTouchStart(t,n,Pe)}const F=q();F&&F.beginAction("fill"),c=!0,R=E,_=!W,o=setTimeout(()=>{if(!s){R=0,ye(u,S,0,_);const Pe=z(u,S);R=Pe.value,_=Pe.certain,window.Cozy.App&&window.Cozy.App.vibrate(50)}},x.LONG_PRESS_DELAY),ye(t,n,R,_);const K=z(t,n);R=K.value,_=K.certain},e.ontouchmove=C=>{if(C.touches.length>1||!c)return;C.preventDefault(),C.stopPropagation(),s=!0,clearTimeout(o);const F=C.touches[0],K=document.elementFromPoint(F.clientX,F.clientY);if(K&&K.classList.contains("cell")){const X=parseInt(K.dataset.row),oe=parseInt(K.dataset.col);!isNaN(X)&&!isNaN(oe)&&(ye(X,oe,R,_,!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchMove(X,oe))}},e.ontouchend=()=>{clearTimeout(o),ve(!0),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()},e.ontouchcancel=()=>{clearTimeout(o),ve(!1),window.Cozy.Zoom&&window.Cozy.Zoom.onCellTouchEnd()}}function De(e){const t=document.getElementById("grid");t.innerHTML="",t.style.gridTemplateColumns=`repeat(${e.width}, var(--cell-size))`,t.style.gridTemplateRows=`repeat(${e.height}, var(--cell-size))`,Q&&t.removeEventListener("mouseleave",Q),ee&&t.removeEventListener("focusout",ee),le&&document.removeEventListener("mouseup",le),$=[];for(let n=0;n<e.height;n++)$[n]=[];Q=()=>re(),t.addEventListener("mouseleave",Q),ee=n=>{t.contains(n.relatedTarget)||re()},t.addEventListener("focusout",ee);for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const i=fe(n,o);we(i,n,o),be(i,n,o),Be(i,n,o),Oe(i,n,o),$[n][o]=i,t.appendChild(i)}le=()=>ve(!0),document.addEventListener("mouseup",le)}function ye(e,t,n,o,i){const s=r()[L],u=z(e,t),S=q();let C=n,F=o;i||(o&&!u.certain&&u.value===n&&n!==null?(C=u.value,F=!0):u.value===n&&u.certain===o&&n!==null&&(C=null,F=!0)),!(u.value===C&&u.certain===F)&&(S&&S.recordChange(e,t,u,{value:C,certain:F}),h(e,t,C,F),he(e,t,s),window.Cozy.App&&window.Cozy.App.vibrate(10),me(s),j(),Ye(s),Se())}function he(e,t,n){var s;const o=(s=$[e])==null?void 0:s[t];if(!o)return;const i=z(e,t);if(o.classList.remove("marked-empty","maybe-empty","maybe-color"),o.style.background="",o.style.setProperty("--cell-color",""),o.style.setProperty("--fold-outline-color",""),i.value===null)o.style.background="var(--color-cell)";else if(i.value===0)i.certain?o.classList.add("marked-empty"):o.classList.add("maybe-empty");else{const u=n.color_map[i.value];if(u){const S=`rgb(${u[0]}, ${u[1]}, ${u[2]})`;if(i.certain)o.style.background=S;else{o.classList.add("maybe-color"),o.style.setProperty("--cell-color",S);const F=y(u)>x.BRIGHTNESS_MIDPOINT?"rgba(0, 0, 0, 0.6)":"rgba(255, 255, 255, 0.7)";o.style.setProperty("--fold-outline-color",F)}}}}function Te(e){const t=[];let n=null,o=0;for(const i of e)i>0?i===n?o++:(n!==null&&t.push({count:o,color:n}),n=i,o=1):n!==null&&(t.push({count:o,color:n}),n=null,o=0);return n!==null&&t.push({count:o,color:n}),t}function Ae(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n].count!==t[n].count||e[n].color!==t[n].color)return!1;return!0}function me(e){for(let t=0;t<e.height;t++){const n=[];for(let C=0;C<e.width;C++){const F=z(t,C);F.certain?n.push(F.value===null?0:F.value):n.push(-1)}const o=n.includes(-1),i=n.map(C=>C===-1?0:C),s=Te(i),u=!o&&Ae(s,e.row_clues[t]),S=ie[t];S&&S.classList.toggle("satisfied",u)}for(let t=0;t<e.width;t++){const n=[];for(let C=0;C<e.height;C++){const F=z(C,t);F.certain?n.push(F.value===null?0:F.value):n.push(-1)}const o=n.includes(-1),i=n.map(C=>C===-1?0:C),s=Te(i),u=!o&&Ae(s,e.col_clues[t]),S=Y[t];S&&S.classList.toggle("satisfied",u)}}function Ye(e){for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++)if(!z(o,i).certain)return;for(let o=0;o<e.height;o++){const i=[];for(let u=0;u<e.width;u++){const S=z(o,u);i.push(S.value===null?0:S.value)}const s=Te(i);if(!Ae(s,e.row_clues[o]))return}for(let o=0;o<e.width;o++){const i=[];for(let u=0;u<e.height;u++){const S=z(u,o);i.push(S.value===null?0:S.value)}const s=Te(i);if(!Ae(s,e.col_clues[o]))return}window.Cozy.App&&window.Cozy.App.vibrate([50,100,50]);const t=Z();if(t){const o=b(e);t.completePuzzle(o),qe(),Me();const i=window.Cozy.Collection;i&&i.refresh()}const n=q();n&&n.clear(),lt(e)}function We(){const e=r()[L];if(!e)return;const t=q(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const s=z(o,i);s.value!==null&&(n.push({row:o,col:i,before:{value:s.value,certain:s.certain},after:{value:null,certain:!0}}),s.value=null,s.certain=!0,he(o,i,e))}if(n.length>0){t&&t.recordBatchAction("reset",n),me(e);const o=Z();if(o){const i=b(e);o.savePuzzleGrid(i,null)}de()}j()}function je(){const e=r()[L];if(!e)return;window.Cozy.Zoom&&window.Cozy.Zoom.zoomToFit();const t=q(),n=[];for(let o=0;o<e.height;o++)for(let i=0;i<e.width;i++){const s=z(o,i),u=e.solution[o][i];(s.value!==u||!s.certain)&&n.push({row:o,col:i,before:{value:s.value,certain:s.certain},after:{value:u,certain:!0}}),s.value=u,s.certain=!0,he(o,i,e)}n.length>0&&t&&t.recordBatchAction("solution",n),me(e),p("Solution revealed","info"),de(),j()}function nt(){document.addEventListener("keydown",e=>{var t,n,o;if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")){if((e.ctrlKey||e.metaKey)&&e.key==="z"&&!e.shiftKey&&(e.preventDefault(),xe()),((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key==="z"||(e.ctrlKey||e.metaKey)&&e.key==="y")&&(e.preventDefault(),_e()),e.key==="p"&&!e.ctrlKey&&!e.metaKey&&(e.preventDefault(),Ce()),e.key>="1"&&e.key<="9"&&!e.ctrlKey&&!e.metaKey){const i=parseInt(e.key),s=r()[L],u=Object.keys(s.color_map).map(Number);i<=u.length&&ze(u[i-1])}if((e.key==="0"||e.key==="x")&&!e.ctrlKey&&!e.metaKey&&ze(0),e.key==="Escape"&&!e.ctrlKey&&!e.metaKey){const i=document.getElementById("help-modal"),s=i==null?void 0:i.classList.contains("visible");((t=window.Cozy.Screens)==null?void 0:t.getCurrentScreen())===((o=(n=window.Cozy.Screens)==null?void 0:n.SCREENS)==null?void 0:o.PUZZLE)&&!s&&(e.preventDefault(),Ze())}}})}function Xe(){const e=r(),t=Z();if(d.length>0&&e[L]&&t){const n=b(e[L]);t.savePuzzleGrid(n,d)}}function Ze(){Xe(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION)}function ot(e){window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:e})}function it(e){const t=e.detail||{},n=r();let o=0;t.puzzleId!==void 0&&(o=t.puzzleId,typeof t.puzzleId=="string"&&(o=n.findIndex(i=>b(i)===t.puzzleId),o===-1&&(o=0))),Ie(o)}function st(e){Xe();const t=e.detail||{},n=window.Cozy.Collection;n&&(t.animateStamp&&t.scrollToPuzzleId?n.refresh({blankPuzzleId:t.scrollToPuzzleId}):n.refresh(),t.scrollToPuzzleId&&setTimeout(()=>{n.scrollToPuzzle(t.scrollToPuzzleId,{instant:t.quickAnimation}),t.animateStamp&&t.flyingStamp&&n.animateStampTo(t.scrollToPuzzleId,t.flyingStamp,{quick:t.quickAnimation})},50))}function lt(e){if(window.Cozy.Screens){const t=b(e),n=e.title.match(/^(.+?)\s*\(/),o=n?n[1].trim():e.title;window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.VICTORY,{puzzleId:t,puzzleName:o,solution:e.solution,palette:e.color_map})}}function rt(){const e=document.getElementById("current-puzzle-title");if(!e)return;const n=r()[L];if(n){const o=n.title.match(/^(.+?)\s*\(/);e.textContent=o?o[1].trim():n.title}}const Je=1200;function Qe(e,t){if(!e)return;let n=null,o=!1;function i(u){u.type==="touchstart"&&u.preventDefault(),!e.disabled&&(o||(o=!0,e.classList.add("holding"),n=setTimeout(()=>{o&&(e.classList.add("hold-complete"),s(),t(),setTimeout(()=>e.classList.remove("hold-complete"),50))},Je)))}function s(){o=!1,e.classList.remove("holding"),n&&(clearTimeout(n),n=null)}e.addEventListener("mousedown",i),e.addEventListener("mouseup",s),e.addEventListener("mouseleave",s),e.addEventListener("touchstart",i,{passive:!1}),e.addEventListener("touchend",s),e.addEventListener("touchcancel",s),e.addEventListener("keydown",u=>{(u.key==="Enter"||u.key===" ")&&(u.preventDefault(),i(u))}),e.addEventListener("keyup",u=>{(u.key==="Enter"||u.key===" ")&&s()}),e.addEventListener("blur",s),e.style.setProperty("--hold-duration",`${Je}ms`)}function ct(){const e=document.getElementById("pen-mode-btn"),t=document.getElementById("pencil-mode-btn"),n=document.getElementById("undo-btn"),o=document.getElementById("redo-btn");e&&e.addEventListener("click",()=>ue(!1)),t&&t.addEventListener("click",()=>ue(!0)),n&&n.addEventListener("click",xe),o&&o.addEventListener("click",_e);const i=document.getElementById("clear-pencil-btn"),s=document.getElementById("confirm-pencil-btn");i&&i.addEventListener("click",()=>{He(),Ee()}),s&&s.addEventListener("click",()=>{Ne(),Ee()});const u=document.getElementById("reset-btn"),S=document.getElementById("solution-btn");Qe(u,We),Qe(S,je);const C=document.querySelector("#screen-puzzle .header-back-btn");C&&C.addEventListener("click",tt);const F=document.querySelector("#screen-collection .header-back-btn");F&&F.addEventListener("click",()=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.HOME)})}function et(){nt(),ct(),H();const e=q();e&&e.updateUI(),ke();const t=Z();t&&t.onChange&&t.onChange(i=>{i==="reset"&&(d=[],L=0)});const n=window.Cozy.Collection,o=r();n&&o.length>0&&n.init("collection-screen",o,i=>{window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.PUZZLE,{puzzleId:i})}),window.addEventListener("screen:puzzle",it),window.addEventListener("screen:collection",st),o.length>0&&Ie(0)}function at(){const t=r()[L];if(!t||d.length===0)return null;let n=!1;for(let o=0;o<t.height&&!n;o++)for(let i=0;i<t.width&&!n;i++){const s=z(o,i);s.value!==null&&s.value>0&&(n=!0)}return n?k(t.width,t.height,x.STAMP_CANVAS_SIZE,(o,i)=>{const s=z(o,i);if(s.value!==null&&s.value>0){const u=t.color_map[s.value];if(u)return u}return null}):null}function tt(){const t=r()[L];if(!t){Ze();return}const n=b(t),o=at();if(!o){Ze();return}const i=document.getElementById("grid");if(!i){Ze();return}const s=i.getBoundingClientRect(),u=document.createElement("canvas");u.width=o.width,u.height=o.height,u.getContext("2d").drawImage(o,0,0);const C=o.width/o.height,F=s.width/s.height;let K,X;C>F?(K=s.width,X=s.width/C):(X=s.height,K=s.height*C);const oe=(s.width-K)/2,Pe=(s.height-X)/2;u.className="flying-stamp",u.style.left=s.left+oe+"px",u.style.top=s.top+Pe+"px",u.style.width=K+"px",u.style.height=X+"px",document.body.appendChild(u),Xe(),window.Cozy.Screens&&window.Cozy.Screens.showScreen(window.Cozy.Screens.SCREENS.COLLECTION,{scrollToPuzzleId:n,animateStamp:!0,flyingStamp:u,quickAnimation:!0})}function ut(){d=[],L=0,E=1,c=!1,R=null,W=!1;const e=q();e&&e.clear()}function dt(e,t){const o=r()[L];if(!o)return null;const i=ie[e],s=i?i.classList.contains("satisfied"):!1,u=o.row_clues[e].map(K=>({count:K.count,color:K.color,satisfied:s})),S=Y[t],C=S?S.classList.contains("satisfied"):!1,F=o.col_clues[t].map(K=>({count:K.count,color:K.color,satisfied:C}));return{rowClues:u,colClues:F}}function ft(e){const n=r()[L];return!n||!n.color_map?null:n.color_map[e]||null}function ht(){return r()[L]||null}window.Cozy.Garden={resetPuzzle:We,showSolution:je,performUndo:xe,performRedo:_e,togglePencilMode:Ce,setPencilMode:ue,clearAllPencilMarks:He,confirmAllPencilMarks:Ne,selectColor:ze,showCollection:Ze,showGame:ot,clearAllState:ut,navigateToCollectionWithStamp:tt,getPuzzleId:b,getClueInfo:dt,getColorRgb:ft,getCurrentPuzzle:ht},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",et):et()}(),function(){"use strict";const{CONFIG:x}=window.Cozy.Utils,b=.35,w=1,k=.97,L=300,P=1500,E=100,d=10;let c=w,R=w,_=!1,W=0,ne=0,J=null,D=null,le=null,Q=!1,ee=-1,$=-1,ie=!1,Y=null,pe=null,p=null,g=null,m=null,T=null,v=null,I=null;function H(a,A,M){return Math.min(Math.max(a,A),M)}function B(a,A){const M=a.clientX-A.clientX,V=a.clientY-A.clientY;return Math.sqrt(M*M+V*V)}function U(a,A){return{x:(a.clientX+A.clientX)/2,y:(a.clientY+A.clientY)/2}}function G(){const a=window.innerWidth;return a<=360?20:a>=768?28:a>=1200?32:24}function l(a,A=!0){const M=Y;if(!M)return;const V=c,se=y(),re=H(a,se,x.MAX_ZOOM);let ce,fe;A&&V!==re&&(ce=M.scrollLeft+M.clientWidth/2,fe=M.scrollTop+M.clientHeight/2),c=re;const we=G(),be=Math.round(we*re);document.documentElement.style.setProperty("--cell-size",`${be}px`);const Le=h(),ve=re>Le+.01;M.classList.toggle("is-zoomed",ve),r(),A&&V!==re&&ce!==void 0&&requestAnimationFrame(()=>{const Be=re/V,Oe=ce*Be-M.clientWidth/2,De=fe*Be-M.clientHeight/2;M.scrollLeft=Math.max(0,Oe),M.scrollTop=Math.max(0,De)}),window.dispatchEvent(new CustomEvent("zoomchange",{detail:{zoom:re,oldZoom:V,isZoomed:ve}}))}function r(){const a=y();if(T&&(T.disabled=c>=x.MAX_ZOOM),v&&(v.disabled=c<=a),I){const A=h(),M=Math.abs(c-A)<.05;I.classList.toggle("highlighted",!M&&c!==A)}}let f=null,z=null;function h(a=!1){var Ae;const A=Y;if(!A||!((Ae=window.Cozy.Garden)!=null&&Ae.getCurrentPuzzle))return w;const M=window.Cozy.Garden.getCurrentPuzzle();if(!M)return w;const V=M.title;if(!a&&f!==null&&z===V)return f;const se=G(),re=Math.max(...M.row_clues.map(me=>me.length)),ce=Math.max(...M.col_clues.map(me=>me.length)),fe=Math.max(2,re*.6+.5),we=Math.max(2,ce*.6+.5),be=M.width+fe+.25,Le=M.height+we+.25,ve=A.clientWidth,Be=A.clientHeight,Oe=8,De=(ve-Oe*2)/(be*se),ye=(Be-Oe*2)/(Le*se),he=Math.min(De,ye),Te=H(he*k,b,x.MAX_ZOOM);return f=Te,z=V,Te}function O(){f=null,z=null}function y(){const a=h();return Math.max(b,a)}function N(){const a=h();return c>a+.01}function Z(a){a.touches.length===2&&(_=!0,W=B(a.touches[0],a.touches[1]),R=c,a.preventDefault())}function q(a){if(_&&a.touches.length===2){const M=B(a.touches[0],a.touches[1])/W,V=y(),se=H(R*M,V,x.MAX_ZOOM);Math.abs(se-c)>.05&&l(se,!0),a.preventDefault()}}function te(a){if(_&&a.touches.length<2&&(_=!1),a.touches.length===0&&!_){const A=a.target;if(!A.classList.contains("cell")){const V=Date.now();J===A&&V-ne<L?(ae(a.changedTouches[0]),ne=0,J=null):(ne=V,J=A)}}}function ae(a){N()?l(h(),!0):l(x.COMFORTABLE_ZOOM,!0)}function j(a){if(a.ctrlKey){a.preventDefault();const A=a.deltaY>0?-.15:.15;l(c+A,!0)}}function ge(){p&&N()&&p.classList.add("visible")}function ue(){p&&(p.classList.remove("visible"),ee=-1,$=-1)}function Ce(a,A){var V,se;if(!p||Q||a===ee&&A===$)return;ee=a,$=A;const M=(se=(V=window.Cozy.Garden)==null?void 0:V.getClueInfo)==null?void 0:se.call(V,a,A);M&&(g&&(g.innerHTML=ke(M.rowClues)),m&&(m.innerHTML=ke(M.colClues)))}function ke(a){return!a||a.length===0?'<span class="clue-tooltip-num satisfied">0</span>':a.map(A=>{var ce,fe;const M=((fe=(ce=window.Cozy.Garden)==null?void 0:ce.getColorRgb)==null?void 0:fe.call(ce,A.color))||[128,128,128],V=A.satisfied,re=(M[0]*299+M[1]*587+M[2]*114)/1e3>x.BRIGHTNESS_MIDPOINT?"#333":"#fff";return`<span class="clue-tooltip-num${V?" satisfied":""}"
                    style="background: rgb(${M.join(",")}); color: ${re}">
                ${A.count}
              </span>`}).join("")}function Ue(a){if(!p||!Y)return;const A=Y.getBoundingClientRect(),M=A.top+A.height/2;a>M?(p.classList.add("position-top"),p.classList.remove("position-bottom")):(p.classList.remove("position-top"),p.classList.add("position-bottom"))}function Ge(){clearTimeout(D),D=setTimeout(()=>{ue()},P)}function Ee(){clearTimeout(D)}function Re(a,A,M){N()&&(Q=!1,Ee(),clearTimeout(le),le=setTimeout(()=>{Ce(a,A),Ue(M),ge()},E))}function Fe(){N()&&(Q=!0,p==null||p.classList.add("dragging"))}function $e(){N()&&(clearTimeout(le),Q=!1,p==null||p.classList.remove("dragging"),Ge())}function de(){T=document.querySelector(".zoom-btn.zoom-in"),v=document.querySelector(".zoom-btn.zoom-out"),I=document.querySelector(".zoom-btn.zoom-fit"),T&&T.addEventListener("click",()=>{l(c+.5,!0)}),v&&v.addEventListener("click",()=>{l(c-.5,!0)}),I&&I.addEventListener("click",()=>{l(h(),!0)}),r()}function He(a){const A=document.getElementById("screen-puzzle");!A||A.classList.contains("screen-hidden")||(a.key==="+"||a.key==="="?(a.preventDefault(),l(c+.5,!0)):a.key==="-"||a.key==="_"?(a.preventDefault(),l(c-.5,!0)):a.key==="0"&&(a.preventDefault(),l(h(),!0)))}let Ne=null;function xe(){clearTimeout(Ne),Ne=setTimeout(()=>{const a=document.getElementById("screen-puzzle");if(!a||a.classList.contains("screen-hidden"))return;O();const A=y();c<A&&l(A,!1),r()},150)}function _e(){var A,M,V,se;const a=(M=(A=window.Cozy.Garden)==null?void 0:A.getCurrentPuzzle)==null?void 0:M.call(A);a&&(a.width<=x.AUTO_ZOOM_MIN_SIZE&&a.height<=x.AUTO_ZOOM_MIN_SIZE||(V=window.Cozy.Storage)!=null&&V.getFlag("zoomHintShown")||(Se(),(se=window.Cozy.Storage)==null||se.setFlag("zoomHintShown",!0)))}function Se(){let a=document.getElementById("zoom-hint-toast");a||(a=document.createElement("div"),a.id="zoom-hint-toast",a.className="zoom-hint-toast",a.textContent="Tip: Pinch to zoom for easier tapping",document.body.appendChild(a)),a.classList.add("visible"),setTimeout(()=>{a.classList.remove("visible")},4e3)}function qe(){if(!ie){if(Y=document.getElementById("zoom-container"),pe=Y==null?void 0:Y.querySelector(".board-wrapper"),p=document.getElementById("clue-tooltip"),g=document.getElementById("tooltip-row-clues"),m=document.getElementById("tooltip-col-clues"),!Y){console.warn("[Zoom] zoom-container not found, zoom disabled");return}Y.addEventListener("touchstart",Z,{passive:!1}),Y.addEventListener("touchmove",q,{passive:!1}),Y.addEventListener("touchend",te,{passive:!0}),Y.addEventListener("wheel",j,{passive:!1}),de(),document.addEventListener("keydown",He),window.addEventListener("resize",xe),ie=!0,console.log("[Zoom] Initialized")}}function Ke(){O();const a=h();l(a,!1),setTimeout(_e,500)}function Me(){Ie(!1),ue(),clearTimeout(D),clearTimeout(le)}function Ie(a=!0){ze(w,a)}function Ve(a=!0){const A=h();ze(A,a)}function ze(a,A=!0){if(A&&c!==a){let re=function(ce){const fe=ce-se,we=Math.min(fe/V,1),be=1-Math.pow(1-we,3),Le=M+(a-M)*be;l(Le,!1),we<1&&requestAnimationFrame(re)};const M=c,V=200,se=performance.now();requestAnimationFrame(re)}else l(a,!1)}window.Cozy.Zoom={init:qe,initForPuzzle:Ke,destroy:Me,resetZoom:Ie,zoomToFit:Ve,getZoom:()=>c,setZoom:(a,A=!0)=>l(a,!A),zoomIn:(a=.5)=>l(c+a,!0),zoomOut:(a=.5)=>l(c-a,!0),isZoomed:N,onCellTouchStart:Re,onCellTouchMove:Fe,onCellTouchEnd:$e,getEffectiveMinZoom:y}}();

//# sourceMappingURL=app.min.js.map