<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <!-- Security: Content Security Policy -->
  <!-- Note: 'unsafe-inline' required for theme detection script that prevents flash -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; manifest-src 'self'; frame-ancestors 'none'">

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#5c6b4a" id="theme-color-meta">
  <meta name="color-scheme" content="light dark">
  <meta name="description" content="Relaxing colored nonogram puzzles. Solve puzzles to reveal beautiful pixel art flowers and garden scenes.">

  <!-- Apply theme early to prevent flash -->
  <script>
    (function() {
      try {
        var stored = localStorage.getItem('cozy_garden_data');
        var theme = 'system';
        if (stored) {
          var data = JSON.parse(stored);
          theme = data.settings && data.settings.theme ? data.settings.theme : 'system';
        }
        document.documentElement.setAttribute('data-theme', theme);
        // Update theme-color meta for dark mode
        if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.getElementById('theme-color-meta').setAttribute('content', '#2a2420');
        }
      } catch (e) {}
    })();
  </script>

  <!-- iOS PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Cozy Garden">
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">

  <!-- Android/Chrome PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/icon-16.png">

  <!-- Preload critical assets for performance -->
  <link rel="preload" href="css/style.css" as="style">
  <link rel="preload" href="data/puzzles.js" as="script">
  <link rel="preload" href="js/storage.js" as="script">
  <link rel="preload" href="js/screens.js" as="script">
  <link rel="preload" href="js/game.js" as="script">

  <title>Cozy Garden - Nonogram Puzzles</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Offline indicator (shown by app.js when offline) -->
  <div id="offline-indicator" class="offline-indicator">Playing offline</div>

  <!-- ============================================ -->
  <!-- SPLASH SCREEN -->
  <!-- ============================================ -->
  <div id="screen-splash" class="screen screen-active">
    <div class="splash-content">
      <div class="splash-logo">
        <span class="splash-icon">&#127793;</span>
      </div>
      <h1 class="splash-title">Cozy Garden</h1>
      <p class="splash-tagline">Nonogram Puzzles</p>
      <div class="splash-loader">
        <div class="splash-loader-bar"></div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- HOME SCREEN (Main Menu) -->
  <!-- ============================================ -->
  <div id="screen-home" class="screen screen-hidden">
    <div class="home-content">
      <div class="home-logo">
        <span class="home-icon">&#127793;</span>
      </div>
      <h1 class="home-title">Cozy Garden</h1>
      <p class="home-tagline">Solve puzzles. Grow your garden.</p>

      <div class="home-menu">
        <button id="home-play-btn" class="home-btn home-btn-primary">
          <span class="btn-icon">&#9658;</span> Play
        </button>
        <button id="home-settings-btn" class="home-btn">
          <span class="btn-icon">&#9881;</span> Settings
        </button>
      </div>

      <div class="home-footer">
        <p class="home-progress" id="home-progress"></p>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- COLLECTION SCREEN (Level Select) -->
  <!-- ============================================ -->
  <div id="screen-collection" class="screen screen-hidden">
    <header class="screen-header">
      <button class="header-back-btn" aria-label="Back to home">
        <span aria-hidden="true">&#8592;</span>
      </button>
      <h1 class="header-title">Collection</h1>
      <div class="header-spacer"></div>
    </header>

    <main class="screen-content">
      <div class="collection-search">
        <input type="text" id="collection-search-input" class="collection-search-input" placeholder="Search puzzles..." autocomplete="off" aria-label="Search puzzles">
      </div>
      <div class="collection-screen" id="collection-screen"></div>
    </main>
  </div>

  <!-- ============================================ -->
  <!-- PUZZLE SCREEN (Gameplay) -->
  <!-- ============================================ -->
  <div id="screen-puzzle" class="screen screen-hidden">
    <header class="screen-header">
      <button class="header-back-btn" aria-label="Back to collection">
        <span aria-hidden="true">&#8592;</span>
      </button>
      <h1 class="header-title" id="current-puzzle-title">Puzzle</h1>
      <div class="header-spacer"></div>
    </header>

    <main class="screen-content app-main">
      <div class="game-container">
        <div class="palette" id="palette" aria-label="Color palette">
          <span class="palette-label visually-hidden">Colors:</span>
        </div>

        <!-- Mode toggle: Pen (certain) vs Pencil (maybe) -->
        <div class="mode-toggle" role="group" aria-label="Drawing mode">
          <button id="pen-mode-btn" class="mode-btn active" aria-pressed="true" aria-label="Pen mode - certain marks">
            Pen
          </button>
          <button id="pencil-mode-btn" class="mode-btn" aria-pressed="false" aria-label="Pencil mode - uncertain marks">
            Pencil
          </button>
        </div>

        <!-- Pencil batch actions (shown when pencil marks exist) -->
        <div id="pencil-actions" class="pencil-actions">
          <button class="pencil-action-btn">
            Clear Pencil
          </button>
          <button class="pencil-action-btn">
            Confirm All
          </button>
        </div>

        <!-- Zoomable/Scrollable puzzle area -->
        <div class="zoom-container" id="zoom-container">
          <div class="board-wrapper">
            <div class="corner"></div>
            <div class="col-clues" id="col-clues" role="group" aria-label="Column clues"></div>
            <div id="row-clues-container" role="group" aria-label="Row clues"></div>
            <div class="grid" id="grid" role="grid" aria-label="Puzzle grid"></div>
          </div>
          <!-- Toast notification (overlays bottom of grid) -->
          <div class="toast" id="toast" role="status" aria-live="polite"></div>
        </div>

        <!-- Contextual clue tooltip (shown when zoomed and touching cells) -->
        <div class="clue-tooltip position-bottom" id="clue-tooltip" aria-live="polite" aria-atomic="true">
          <div class="clue-tooltip-row">
            <span class="clue-tooltip-label">Row:</span>
            <span class="clue-tooltip-clues" id="tooltip-row-clues"></span>
          </div>
          <div class="clue-tooltip-col">
            <span class="clue-tooltip-label">Col:</span>
            <span class="clue-tooltip-clues" id="tooltip-col-clues"></span>
          </div>
        </div>

        <!-- Floating zoom controls -->
        <div class="zoom-controls" id="zoom-controls">
          <button class="zoom-btn zoom-in" aria-label="Zoom in">+</button>
          <button class="zoom-btn zoom-out" aria-label="Zoom out">&minus;</button>
          <button class="zoom-btn zoom-fit" aria-label="Fit to view">&#8862;</button>
        </div>

        <div class="controls">
          <!-- Undo/Redo -->
          <div class="history-controls">
            <button id="undo-btn" class="history-btn" disabled title="Undo (Ctrl+Z)">
              &#8630;
            </button>
            <button id="redo-btn" class="history-btn" disabled title="Redo (Ctrl+Y)">
              &#8631;
            </button>
          </div>

          <button class="btn btn-secondary">Reset</button>
          <button class="btn btn-secondary">Solution</button>
        </div>

        <details class="instructions-collapsible" id="instructions-details">
          <summary class="instructions-summary">How to play</summary>
          <div class="instructions-content">
            Tap a color, then tap/drag to fill cells.
            Long-press to mark X (empty). Use Pencil mode for uncertain guesses.<br>
            <kbd>Ctrl+Z</kbd> undo, <kbd>P</kbd> toggle pencil mode, <kbd>1-9</kbd> select colors.
          </div>
        </details>
      </div>
    </main>
  </div>

  <!-- ============================================ -->
  <!-- VICTORY SCREEN -->
  <!-- ============================================ -->
  <div id="screen-victory" class="screen screen-hidden">
    <div class="victory-content">
      <div class="victory-header">
        <span class="victory-icon">&#127881;</span>
        <h1 class="victory-title">Complete!</h1>
      </div>

      <div class="victory-puzzle-display">
        <div id="victory-image" class="victory-image"></div>
        <h2 id="victory-puzzle-name" class="victory-puzzle-name">Puzzle Name</h2>
      </div>

      <div class="victory-actions">
        <button id="victory-continue-btn" class="victory-btn victory-btn-primary">
          Continue
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- SETTINGS SCREEN -->
  <!-- ============================================ -->
  <div id="screen-settings" class="screen screen-hidden">
    <header class="screen-header">
      <button id="settings-back-btn" class="header-back-btn">
        <span>&#8592;</span>
      </button>
      <h1 class="header-title">Settings</h1>
      <div class="header-spacer"></div>
    </header>

    <main class="screen-content">
      <div class="settings-content">
        <div class="settings-group">
          <h2 class="settings-group-title">Feedback</h2>
          <label class="settings-toggle">
            <span class="toggle-label">Vibration</span>
            <input type="checkbox" id="settings-vibration" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="settings-group">
          <h2 class="settings-group-title">Appearance</h2>
          <div class="settings-theme-selector">
            <span class="toggle-label">Theme</span>
            <div class="theme-options">
              <button class="theme-option" data-theme="light">
                <span class="theme-icon">&#9728;</span>
                <span class="theme-name">Light</span>
              </button>
              <button class="theme-option" data-theme="dark">
                <span class="theme-icon">&#9790;</span>
                <span class="theme-name">Dark</span>
              </button>
              <button class="theme-option" data-theme="system">
                <span class="theme-icon">&#9881;</span>
                <span class="theme-name">Auto</span>
              </button>
            </div>
          </div>
        </div>

        <div class="settings-group">
          <h2 class="settings-group-title">Data</h2>
          <button id="settings-reset-btn" class="settings-danger-btn">
            Reset All Progress
          </button>
          <button id="settings-solve-all-btn" class="settings-debug-btn">
            Solve All Puzzles (Debug)
          </button>
        </div>

        <div class="settings-footer">
          <p class="settings-version">Version 1.0.0</p>
        </div>
      </div>
    </main>
  </div>

  <!-- ============================================ -->
  <!-- TUTORIAL SCREEN -->
  <!-- ============================================ -->
  <div id="screen-tutorial" class="screen screen-hidden">
    <div class="tutorial-content">
      <button id="tutorial-skip-btn" class="tutorial-skip">Skip</button>

      <div class="tutorial-steps">
        <!-- Step 1 -->
        <div class="tutorial-step active" data-step="1">
          <div class="tutorial-illustration">
            <span class="tutorial-emoji">&#127793;</span>
          </div>
          <h2 class="tutorial-heading">Welcome to Cozy Garden!</h2>
          <p class="tutorial-text">
            Solve colorful nonogram puzzles to reveal beautiful pixel art flowers and garden scenes.
          </p>
        </div>

        <!-- Step 2 -->
        <div class="tutorial-step" data-step="2">
          <div class="tutorial-illustration">
            <span class="tutorial-emoji">&#128270;</span>
          </div>
          <h2 class="tutorial-heading">Read the Clues</h2>
          <p class="tutorial-text">
            Numbers on the edges tell you which cells to fill. Each number shows a group of consecutive colored cells.
          </p>
        </div>

        <!-- Step 3 -->
        <div class="tutorial-step" data-step="3">
          <div class="tutorial-illustration">
            <span class="tutorial-emoji">&#127912;</span>
          </div>
          <h2 class="tutorial-heading">Fill with Colors</h2>
          <p class="tutorial-text">
            Select a color from the palette, then tap or drag on the grid to fill cells. Long-press to mark cells as empty.
          </p>
        </div>

        <!-- Step 4 -->
        <div class="tutorial-step" data-step="4">
          <div class="tutorial-illustration">
            <span class="tutorial-emoji">&#127881;</span>
          </div>
          <h2 class="tutorial-heading">Reveal the Art!</h2>
          <p class="tutorial-text">
            When all cells are correctly filled, you'll reveal the hidden picture. Collect them all!
          </p>
        </div>
      </div>

      <div class="tutorial-nav">
        <div class="tutorial-dots">
          <span class="tutorial-dot active"></span>
          <span class="tutorial-dot"></span>
          <span class="tutorial-dot"></span>
          <span class="tutorial-dot"></span>
        </div>
        <button id="tutorial-next-btn" class="tutorial-next-btn">Next</button>
      </div>
    </div>
  </div>


  <!-- Scripts loaded in order (defer ensures execution order is preserved) -->
  <!-- Puzzle data (auto-generated) -->
  <script defer src="data/puzzles.js"></script>
  <!-- Storage layer -->
  <script defer src="js/storage.js"></script>
  <!-- Undo/redo history -->
  <script defer src="js/history.js"></script>
  <!-- Screen manager -->
  <script defer src="js/screens.js"></script>
  <!-- Collection screen -->
  <script defer src="js/collection.js"></script>
  <!-- PWA & App lifecycle -->
  <script defer src="js/app.js"></script>
  <!-- Game logic -->
  <script defer src="js/game.js"></script>
  <!-- Zoom & Pan system -->
  <script defer src="js/zoom.js"></script>
</body>
</html>
