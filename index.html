<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

  <!-- Security: Content Security Policy -->
  <!-- Note: 'unsafe-inline' required for theme detection script that prevents flash -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; manifest-src 'self'; frame-ancestors 'none'">

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4a7c3f" id="theme-color-meta">
  <meta name="color-scheme" content="light dark">
  <meta name="description" content="Relaxing colored nonogram puzzles. Solve puzzles to reveal beautiful pixel art flowers and garden scenes.">

  <!-- Apply theme early to prevent flash -->
  <script>
    (function() {
      try {
        var stored = localStorage.getItem('cozy_garden_data');
        var theme = null;
        if (stored) {
          var data = JSON.parse(stored);
          theme = data.settings && data.settings.theme ? data.settings.theme : null;
        }
        // Default to system preference if no saved theme
        if (!theme || theme === 'system') {
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        document.documentElement.setAttribute('data-theme', theme);
        // Update theme-color meta for dark mode
        if (theme === 'dark') {
          document.getElementById('theme-color-meta').setAttribute('content', '#0a1018');
        }
      } catch (e) {}
    })();
  </script>

  <!-- iOS PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Cozy Garden">
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">

  <!-- Android/Chrome PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/icon-16.png">

  <!-- Preload critical assets for performance -->
  <link rel="preload" href="css/style.css" as="style">
  <link rel="preload" href="data/puzzles.js" as="script">
  <link rel="preload" href="js/storage.js" as="script">
  <link rel="preload" href="js/screens.js" as="script">
  <link rel="preload" href="js/game.js" as="script">

  <title>Cozy Garden - Nonogram Puzzles</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Screen reader announcer for dynamic state changes -->
  <div id="sr-announcer" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>

  <!-- ============================================ -->
  <!-- SPLASH SCREEN -->
  <!-- ============================================ -->
  <div id="screen-splash" class="screen screen-active">
    <div class="splash-content">
      <div class="splash-logo">
        <img class="splash-icon" src="assets/icons/flower-uniform-petals.svg" alt="Cozy Garden" width="80" height="80">
      </div>
      <h1 class="splash-title">Cozy Garden</h1>
      <p class="splash-tagline">Nonogram Puzzles</p>
      <div class="splash-loader">
        <div class="splash-loader-bar"></div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- HOME SCREEN (Main Menu) -->
  <!-- ============================================ -->
  <div id="screen-home" class="screen screen-hidden">
    <div class="home-content">
      <div class="home-logo">
        <img class="home-icon" src="assets/icons/flower-uniform-petals.svg" alt="Cozy Garden" width="64" height="64">
      </div>
      <h1 class="home-title">Cozy Garden</h1>
      <p class="home-tagline">Solve puzzles. Grow your garden.</p>

      <div class="home-menu">
        <button id="home-play-btn" class="home-btn home-btn-primary">
          <span class="btn-icon">&#9658;</span> Play
        </button>
        <button id="home-settings-btn" class="home-btn">
          <span class="btn-icon">&#9881;</span> Settings
        </button>
      </div>

      <div class="home-footer">
        <p class="home-progress" id="home-progress"></p>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- COLLECTION SCREEN (Level Select) -->
  <!-- ============================================ -->
  <div id="screen-collection" class="screen screen-hidden">
    <header class="screen-header">
      <button class="header-back-btn" aria-label="Back to home">
        <span aria-hidden="true">&#8592;</span>
      </button>
      <h1 class="header-title">Collection</h1>
      <div class="header-spacer"></div>
    </header>

    <main class="screen-content">
      <div class="collection-search">
        <input type="text" id="collection-search-input" class="collection-search-input" placeholder="Search puzzles..." autocomplete="off" aria-label="Search puzzles">
      </div>
      <div class="collection-screen" id="collection-screen"></div>
    </main>
  </div>

  <!-- ============================================ -->
  <!-- PUZZLE SCREEN (Gameplay) -->
  <!-- ============================================ -->
  <div id="screen-puzzle" class="screen screen-hidden">
    <header class="screen-header">
      <button class="header-back-btn" aria-label="Back to collection">
        <span aria-hidden="true">&#8592;</span>
      </button>
      <h1 class="header-title" id="current-puzzle-title">Puzzle</h1>
      <div class="header-spacer"></div>
    </header>

    <main class="screen-content app-main">
      <div class="game-container">
        <div class="palette" id="palette" aria-label="Color palette">
          <!-- Color buttons populated by JS -->
          <!-- Menu button added at end by JS -->
        </div>

        <!-- Mode menu popover -->
        <div id="mode-menu" class="mode-menu" role="menu" aria-label="Drawing mode options">
          <div class="mode-menu-section">
            <button id="pen-mode-btn" class="mode-menu-item active" role="menuitemradio" aria-checked="true">
              <svg class="mode-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/>
              </svg>
              <span>Pen</span>
              <span class="mode-hint">Certain</span>
            </button>
            <button id="pencil-mode-btn" class="mode-menu-item" role="menuitemradio" aria-checked="false">
              <svg class="mode-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.07 13.88L13 19.94l-1.41-1.41 6.07-6.06 1.41 1.41zm-5.66-5.66l-6.06 6.07-1.42-1.41 6.07-6.07 1.41 1.41zM17.66 5.99l-2.34 2.34 1.41 1.41 2.34-2.34-1.41-1.41zM3 18v3h3l.01-.01L3 18zm3-3l-1 1 3 3 1-1-3-3zm6.24-8.83l-1.41 1.41 1.41 1.42 1.42-1.42-1.42-1.41zM6.34 14.49l1.41-1.41-1.41-1.42-1.42 1.42 1.42 1.41z" opacity="0.6"/>
                <path d="M9.17 16.17L7.76 17.59l3.54 3.54 1.41-1.41-3.54-3.55zm10.6-10.6l-3.53-3.54-1.42 1.42 3.54 3.53 1.41-1.41z"/>
              </svg>
              <span>Pencil</span>
              <span class="mode-hint">Maybe</span>
            </button>
          </div>
          <div id="pencil-actions-section" class="mode-menu-section pencil-actions-section">
            <button id="clear-pencil-btn" class="mode-menu-item mode-menu-action">
              <svg class="mode-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
              <span>Clear pencil marks</span>
            </button>
            <button id="confirm-pencil-btn" class="mode-menu-item mode-menu-action">
              <svg class="mode-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              <span>Confirm all as certain</span>
            </button>
          </div>
        </div>

        <!-- Zoomable/Scrollable puzzle area -->
        <div class="zoom-container" id="zoom-container">
          <div class="board-wrapper">
            <div class="corner"></div>
            <div class="col-clues" id="col-clues" role="group" aria-label="Column clues"></div>
            <div id="row-clues-container" role="group" aria-label="Row clues"></div>
            <div class="grid" id="grid" role="grid" aria-label="Puzzle grid"></div>
          </div>
          <!-- Toast notification (overlays bottom of grid) -->
          <div class="toast" id="toast" role="status" aria-live="polite"></div>
        </div>

        <!-- Contextual clue tooltip (shown when zoomed and touching cells) -->
        <div class="clue-tooltip position-bottom" id="clue-tooltip" aria-live="polite" aria-atomic="true">
          <div class="clue-tooltip-row">
            <span class="clue-tooltip-label">Row:</span>
            <span class="clue-tooltip-clues" id="tooltip-row-clues"></span>
          </div>
          <div class="clue-tooltip-col">
            <span class="clue-tooltip-label">Col:</span>
            <span class="clue-tooltip-clues" id="tooltip-col-clues"></span>
          </div>
        </div>

        <!-- Floating zoom controls -->
        <div class="zoom-controls" id="zoom-controls">
          <button class="zoom-btn zoom-in" aria-label="Zoom in">+</button>
          <button class="zoom-btn zoom-out" aria-label="Zoom out">&minus;</button>
          <button class="zoom-btn zoom-fit" aria-label="Fit to view">&#8862;</button>
        </div>

        <div class="controls">
          <!-- Undo/Redo -->
          <div class="history-controls">
            <button id="undo-btn" class="history-btn" disabled title="Undo (Ctrl+Z)" aria-label="Undo">
              <svg class="history-icon" viewBox="0 0 1024 1024"><path fill="currentColor" transform="scale(2 2)" d="M170.174 70.0997C181.519 70.7376 178.843 82.1983 178.823 90.1099L178.815 120.169L295.255 120.164C332.297 120.164 359.462 126.523 391.014 148.436C475.689 207.244 472.271 336.227 383.808 389.681C348.213 411.189 328.261 412.424 289.514 412.424L155.69 412.423C109.305 412.422 106.515 357.605 140.315 346.203C146.738 343.89 163.25 344.497 170.854 344.507L309.043 344.428C398.097 343.219 413.667 211.862 322.306 189.501C308.477 186.116 295.026 186.894 280.919 186.901L200.151 186.906C193.492 186.904 185.303 186.649 178.815 186.906C178.465 199.477 179.212 212.227 178.665 224.81C178.264 234.046 170.063 235.268 163.703 230.533L75.1247 166.705C55.7842 152.713 51.0854 153.22 72.4515 137.932L111.251 110.632C120.479 104.057 163.078 70.8301 170.174 70.0997Z"/><path fill="currentColor" transform="scale(2 2)" d="M163.35 92.447L163.612 92.6232C163.187 98.2306 163.247 104.271 163.34 110.274C164.572 132.449 157.247 134.993 183.199 134.995L270.691 134.979C285.598 134.978 301.047 134.323 315.874 135.719C381.971 142.535 433.964 194.106 437.23 261.208C440.749 333.49 383.046 394.275 311.405 397.12C299.78 397.581 287.318 397.178 275.549 397.176L169.305 397.179C162.885 397.179 155.696 397.33 149.346 396.881C129.873 393.669 127.406 365.011 147.497 359.983C151.415 359.003 156.393 359.468 160.484 359.474L178.815 359.481L292.915 359.491C306.196 359.496 317.389 360.041 330.416 356.622C371.128 345.934 399.517 309.884 399.621 267.648C399.755 213.276 355.568 172.565 302.313 172.062L186.692 172.047C165.739 172.033 163.292 167.92 163.336 190.706L163.35 211.276L80.3629 151.303C83.3818 148.848 89.3599 145.053 92.9099 142.505L148.378 102.631C152.444 99.7108 159.146 94.6693 163.35 92.447Z"/></svg>
            </button>
            <button id="redo-btn" class="history-btn" disabled title="Redo (Ctrl+Y)" aria-label="Redo">
              <svg class="history-icon redo-icon" viewBox="0 0 1024 1024"><path fill="currentColor" transform="scale(2 2)" d="M170.174 70.0997C181.519 70.7376 178.843 82.1983 178.823 90.1099L178.815 120.169L295.255 120.164C332.297 120.164 359.462 126.523 391.014 148.436C475.689 207.244 472.271 336.227 383.808 389.681C348.213 411.189 328.261 412.424 289.514 412.424L155.69 412.423C109.305 412.422 106.515 357.605 140.315 346.203C146.738 343.89 163.25 344.497 170.854 344.507L309.043 344.428C398.097 343.219 413.667 211.862 322.306 189.501C308.477 186.116 295.026 186.894 280.919 186.901L200.151 186.906C193.492 186.904 185.303 186.649 178.815 186.906C178.465 199.477 179.212 212.227 178.665 224.81C178.264 234.046 170.063 235.268 163.703 230.533L75.1247 166.705C55.7842 152.713 51.0854 153.22 72.4515 137.932L111.251 110.632C120.479 104.057 163.078 70.8301 170.174 70.0997Z"/><path fill="currentColor" transform="scale(2 2)" d="M163.35 92.447L163.612 92.6232C163.187 98.2306 163.247 104.271 163.34 110.274C164.572 132.449 157.247 134.993 183.199 134.995L270.691 134.979C285.598 134.978 301.047 134.323 315.874 135.719C381.971 142.535 433.964 194.106 437.23 261.208C440.749 333.49 383.046 394.275 311.405 397.12C299.78 397.581 287.318 397.178 275.549 397.176L169.305 397.179C162.885 397.179 155.696 397.33 149.346 396.881C129.873 393.669 127.406 365.011 147.497 359.983C151.415 359.003 156.393 359.468 160.484 359.474L178.815 359.481L292.915 359.491C306.196 359.496 317.389 360.041 330.416 356.622C371.128 345.934 399.517 309.884 399.621 267.648C399.755 213.276 355.568 172.565 302.313 172.062L186.692 172.047C165.739 172.033 163.292 167.92 163.336 190.706L163.35 211.276L80.3629 151.303C83.3818 148.848 89.3599 145.053 92.9099 142.505L148.378 102.631C152.444 99.7108 159.146 94.6693 163.35 92.447Z"/></svg>
            </button>
          </div>

          <button class="btn btn-secondary" aria-label="Reset current puzzle">Reset</button>
          <button class="btn btn-secondary" aria-label="Show puzzle solution">Solution</button>
          <button id="help-btn" class="btn btn-secondary help-btn" title="How to play" aria-label="How to play">?</button>
        </div>

        <!-- Help Modal -->
        <div id="help-modal" class="help-modal" role="dialog" aria-labelledby="help-modal-title" aria-modal="true">
          <div class="help-modal-backdrop"></div>
          <div class="help-modal-content">
            <button class="help-modal-close" aria-label="Close">&times;</button>
            <h2 id="help-modal-title">How to Play</h2>
            <ul class="help-list" id="help-list">
              <!-- Content populated by JS based on device type -->
            </ul>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ============================================ -->
  <!-- VICTORY SCREEN -->
  <!-- ============================================ -->
  <div id="screen-victory" class="screen screen-hidden">
    <div class="victory-content">
      <div class="victory-header">
        <h1 class="victory-title">Complete!</h1>
      </div>

      <div class="victory-puzzle-display">
        <div id="victory-image" class="victory-image"></div>
        <h2 id="victory-puzzle-name" class="victory-puzzle-name">Puzzle Name</h2>
      </div>

      <div class="victory-actions">
        <button id="victory-continue-btn" class="victory-btn victory-btn-primary">
          Continue
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- SETTINGS SCREEN -->
  <!-- ============================================ -->
  <div id="screen-settings" class="screen screen-hidden">
    <header class="screen-header">
      <button id="settings-back-btn" class="header-back-btn">
        <span>&#8592;</span>
      </button>
      <h1 class="header-title">Settings</h1>
      <div class="header-spacer"></div>
    </header>

    <main class="screen-content">
      <div class="settings-content">
        <div class="settings-group">
          <h2 class="settings-group-title">Feedback</h2>
          <label class="settings-toggle" for="settings-vibration">
            <span class="toggle-label">Vibration</span>
            <input type="checkbox" id="settings-vibration" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="settings-group">
          <h2 class="settings-group-title">Appearance</h2>
          <div class="settings-theme-selector">
            <span class="toggle-label">Theme</span>
            <div class="theme-options">
              <button class="theme-option" data-theme="light" aria-pressed="false">
                <span class="theme-icon">&#9728;</span>
                <span class="theme-name">Light</span>
              </button>
              <button class="theme-option" data-theme="dark" aria-pressed="false">
                <span class="theme-icon">&#9790;</span>
                <span class="theme-name">Dark</span>
              </button>
            </div>
          </div>
        </div>

        <div class="settings-group">
          <h2 class="settings-group-title">Help</h2>
          <button id="settings-tutorial-btn" class="settings-btn">
            Show Tutorial
          </button>
        </div>

        <div class="settings-group">
          <h2 class="settings-group-title">Data</h2>
          <button id="settings-reset-btn" class="settings-danger-btn">
            Reset All Progress
          </button>
          <button id="settings-solve-all-btn" class="settings-debug-btn">
            Solve All Puzzles (Debug)
          </button>
        </div>

        <div class="settings-footer">
          <p class="settings-version">Version 1.0.0</p>
        </div>
      </div>
    </main>
  </div>

  <!-- ============================================ -->
  <!-- TUTORIAL SCREEN -->
  <!-- ============================================ -->
  <div id="screen-tutorial" class="screen screen-hidden">
    <div class="tutorial-content">
      <button id="tutorial-skip-btn" class="tutorial-skip">Skip</button>

      <div class="tutorial-steps">
        <!-- Step 1 -->
        <div class="tutorial-step active" data-step="1">
          <div class="tutorial-illustration">
            <img class="tutorial-emoji" src="assets/icons/flower-uniform-petals.svg" alt="Cozy Garden" width="80" height="80">
          </div>
          <h2 class="tutorial-heading">Welcome to Cozy Garden!</h2>
          <p class="tutorial-text">
            Solve colorful nonogram puzzles to reveal beautiful pixel art flowers and garden scenes.
          </p>
        </div>

        <!-- Step 2 -->
        <div class="tutorial-step" data-step="2">
          <div class="tutorial-illustration">
            <img class="tutorial-emoji" src="assets/icons/magnifying-glass.svg" alt="Magnifying glass" width="80" height="80">
          </div>
          <h2 class="tutorial-heading">Read the Clues</h2>
          <p class="tutorial-text">
            Numbers on the edges tell you which cells to fill. Each number shows a group of consecutive colored cells.
          </p>
        </div>

        <!-- Step 3 -->
        <div class="tutorial-step" data-step="3">
          <div class="tutorial-illustration">
            <img class="tutorial-emoji" src="assets/icons/wooden-painters-palette.svg" alt="Artist palette" width="80" height="80">
          </div>
          <h2 class="tutorial-heading">Fill with Colors</h2>
          <p class="tutorial-text">
            Select a color from the palette, then tap or drag on the grid to fill cells. Long-press to mark cells as empty.
          </p>
        </div>

        <!-- Step 4 -->
        <div class="tutorial-step" data-step="4">
          <div class="tutorial-illustration">
            <img class="tutorial-emoji" src="assets/icons/celebration.svg" alt="Celebration" width="80" height="80">
          </div>
          <h2 class="tutorial-heading">Reveal the Art!</h2>
          <p class="tutorial-text">
            When all cells are correctly filled, you'll reveal the hidden picture. Collect them all!
          </p>
        </div>
      </div>

      <div class="tutorial-nav">
        <div class="tutorial-dots">
          <span class="tutorial-dot active"></span>
          <span class="tutorial-dot"></span>
          <span class="tutorial-dot"></span>
          <span class="tutorial-dot"></span>
        </div>
        <button id="tutorial-next-btn" class="tutorial-next-btn">Next</button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- CONFIRM/ALERT MODAL (Global)                -->
  <!-- ============================================ -->
  <div id="confirm-modal" class="confirm-modal" role="dialog" aria-labelledby="confirm-modal-title" aria-modal="true">
    <div class="confirm-modal-backdrop"></div>
    <div class="confirm-modal-content">
      <h2 id="confirm-modal-title" class="confirm-modal-title">Confirm</h2>
      <p id="confirm-modal-message" class="confirm-modal-message">Are you sure?</p>
      <div class="confirm-modal-actions">
        <button id="confirm-modal-cancel" class="confirm-modal-btn confirm-modal-btn-secondary">Cancel</button>
        <button id="confirm-modal-confirm" class="confirm-modal-btn confirm-modal-btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Scripts loaded in order (defer ensures execution order is preserved) -->
  <!-- Puzzle data (auto-generated) -->
  <script defer src="data/puzzles.js"></script>
  <!-- Shared utilities (loads first - provides getPuzzleId, config constants) -->
  <script defer src="js/utils.js"></script>
  <!-- Storage layer -->
  <script defer src="js/storage.js"></script>
  <!-- Undo/redo history -->
  <script defer src="js/history.js"></script>
  <!-- Screen manager -->
  <script defer src="js/screens.js"></script>
  <!-- Collection screen -->
  <script defer src="js/collection.js"></script>
  <!-- PWA & App lifecycle -->
  <script defer src="js/app.js"></script>
  <!-- Game logic -->
  <script defer src="js/game.js"></script>
  <!-- Zoom & Pan system -->
  <script defer src="js/zoom.js"></script>
</body>
</html>
